
output:
  word_document: default
---
```{r background_info, include=FALSE}

# -------------------------------------------------------------------------------------------------------------------- #
#
# Program:AR_descriptive_tables.Rmd                                         
# Project:Observer Program Annual Report Descriptive Chapter                                      
# Location: S:\Observer Program Annual Report\YEAR_Annual_Report\Chap4_Descriptive_Info 
#      or: C:\Teleworking\Obs Annual Report\Ch 4
#
# Objectives:                                                                  
# - Summarize vessels, trips, and % observed by vessel length, strata, gear, and FMP area for Chapter 4 (Table 4-1 and 4-2).    
# - Summarize observed and total catch by FMP area, sector, gear, and retained flag for Chapter 4 (Tables 4-3 and 4-4).
#
# Inputs:      
# Normal locations:                                                                   
#  - S:\Observer Program Annual Report\2019_Annual_Report\Chapt4_Descriptive_Info\AR_descriptive_2019_data.Rdata
#     - catch.tables - 2013-2019 catch tables for posting to the AKRO website (NOT USED in this script)
#     - previous.catch.tables - previous year's version of the catch tables (2013-2018) (NOT USED in this script)
#     - VALHALLA - the original Valhalla data (NOT USED in this script)
#     - warehouse.data - the mortality rates that were applied to the PSC data in the CAS run used in Valhalla's creation 
#                        (NOT USED in this script)
#     - with_totals - summary of total catch of groundfish, directed halibut, and PSC halibut as observed or not observed
#     - work_data - Valhalla dataset following some clean-up and addition of DMRs for halibut PSC
#
# Coronavirus telework locations:
#  - C:\Teleworking\Obs Annual Report\Ch 4\AR_descriptive_2019_data.Rdata
#     - catch.tables - 2013-2019 catch tables for posting to the AKRO website (NOT USED in this script)
#     - previous.catch.tables - previous year's version of the catch tables (2013-2018) (NOT USED in this script)
#     - VALHALLA - the original Valhalla data (NOT USED in this script)
#     - warehouse.data - the mortality rates that were applied to the PSC data in the CAS run used in Valhalla's creation 
#                        (NOT USED in this script)
#     - with_totals - summary of total catch of groundfish, directed halibut, and PSC halibut as observed or not observed
#     - work_data - Valhalla dataset following some clean-up and addition of DMRs for halibut PSC

# Output:  
# Normal locations:  
#   - S:\Observer Program Annual Report\2019_Annual_Report\Chapt4_Descriptive_Info\AR_descriptive_2019_tables.html
#     - catch_wide - summary of catch by FMP area, sector, gear, and retained flag with subtotals. Includes percent observed.
#     - counts_wide - monitored and total trip counts.  Includes percent monitored.
#     - table4_3 - GOA table of monitored catch.
#     - table4.4 - BSAI table of monitored catch.
#     - with_totals - summary of total catch of groundfish, directed halibut, and PSC halibut as observed or not observed
#     - work_data - Valhalla dataset following some clean-up and addition of DMRs for halibut PSC
# Coronavirus telework locations:
#   - C:\Teleworking\Obs Annual Report\Ch 4\AR_descriptive_2019_tables.Rdata
#     - catch_wide - summary of monitored and total catch by FMP area, sector, gear, and retained flag with subtotals. 
#                    Includes percent monitored.
#     - counts_wide - monitored and total trip counts.  Includes percent monitored.
#     - table4_3 - GOA table of monitored catch.
#     - table4.4 - BSAI table of monitored catch.
#     - with_totals - summary of total catch of groundfish, directed halibut, and PSC halibut as observed or not observed
#     - work_data - Valhalla dataset following some clean-up and addition of DMRs for halibut PSC
#
# --------------------------------------------------------------------------------------------------------- #

```

# 4 Descriptive Information

### 4.1  Number of Trips and Vessels by FMP Area, Strata, Gear and Vessel Length

In Chapter 3, Table 3-3 provides trip and vessel counts based on coverage type and strata. However, the Council has previously requested a summary of trip and vessel counts based on criteria which are not, or are no longer, considered when deploying observers on trips (e.g., FMP area and vessel length). Table 4-1 and Table 4-2 provide a summary of the number of vessels and trips by FMP area, strata, gear type, and vessel length category within the full and partial coverage categories. Trips are summarized as the number of monitored trips and the total number of trips.  Monitored trips reflect either trips with an observer or EM fixed gear trips if at least some video was reviewed .  The rationale for defining monitored trips this way for EM fixed gear trips is that it is most similar to the way in which trips in other strata are considered observed (i.e., irrespective of whether or not haul information or usable species composition data were collected). Table 3-6 presents detailed information about the number of hard drives received and reviewed by EM gear type.

Vessels and trips may be counted more than once in a vessel length category in Table 4-1 and Table 4-2 if a vessel is in more than one stratum, fishes in more than one FMP area, or utilizes more than one gear type on a trip or within the year. The table rows titled "BSAI Subtotal", "GOA Subtotal", and "Total Unique" include the number of unique vessels and unique trips in each vessel length category where each vessel or trip is counted only once, in each of the FMP areas or overall, respectively.
 


```{r data_inputs, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# LOAD DATA 

YEAR <- 2020

#Source helper file (libraries, ggplot themes, etc.)
source("AR_descriptive_helper.r")

# Load Ch 4 dataset:
load(paste0("AR_descriptive_", YEAR, "_data.RData"))

#Clean up workspace (Remove everything EXCEPT the objects listed)
rm(list= ls()[!(ls() %in% c('YEAR', 'work_data', 'addl_catch_table', 'fig.theme'))])

```


```{r all_trips, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Summarize ALL trip and vessel counts for three different levels of aggregation:
total_counts <- work_data %>% 
  # Detail summaries for strata, FMP area, gear, and vessel length category:
  group_by(STRATA, FMP, AGENCY_GEAR_CODE, VESSEL_LENGTH_CATEGORY) %>% 
  summarize(TRIP_COUNT = n_distinct(TRIP_ID),
            VESSEL_COUNT = n_distinct(VESSEL_ID)) %>%
  # FMP Area summaries for vessel length category:
  bind_rows(work_data %>% group_by(FMP, VESSEL_LENGTH_CATEGORY) %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = "FMP AREA Subtotal",
                        TRIP_COUNT = n_distinct(TRIP_ID),
                        VESSEL_COUNT = n_distinct(VESSEL_ID))) %>% 
  # Overall summaries for vessel length category:
  bind_rows(work_data %>% group_by(VESSEL_LENGTH_CATEGORY) %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = " ",
                        FMP              = "Total Unique",
                        TRIP_COUNT = n_distinct(TRIP_ID),
                        VESSEL_COUNT = n_distinct(VESSEL_ID))) %>% 
  data.frame()
 

# Convert the trip and vessel counts to a wide format:
total_counts_wide <- total_counts %>% 
  pivot_wider(id_cols = c(STRATA, FMP, AGENCY_GEAR_CODE),
              names_from = VESSEL_LENGTH_CATEGORY,
              values_from = c(TRIP_COUNT, VESSEL_COUNT))

```


```{r observed_trips, message=FALSE, warning=FALSE, include=FALSE, results='asis'}


# Summarize OBSERVED trip and vessel counts for three different levels of aggregation:
obs_counts <- work_data %>% 
  filter(OBSERVED_FLAG == 'Y') %>% 
  # Detail summaries for strata, FMP area, gear, and vessel length category:
  group_by(STRATA, FMP, AGENCY_GEAR_CODE, VESSEL_LENGTH_CATEGORY, OBSERVED_FLAG) %>% 
  summarize(TRIP_COUNT_OBS = n_distinct(TRIP_ID),
            VESSEL_COUNT_OBS = n_distinct(VESSEL_ID)) %>%
  # FMP Area summaries for vessel length category:
  bind_rows(work_data %>% 
              filter(OBSERVED_FLAG == 'Y') %>% 
              group_by(FMP, VESSEL_LENGTH_CATEGORY, OBSERVED_FLAG) %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = "FMP AREA Subtotal",
                        TRIP_COUNT_OBS = n_distinct(TRIP_ID),
                        VESSEL_COUNT_OBS = n_distinct(VESSEL_ID))) %>% 
  # Overall summaries for vessel length category:
  bind_rows(work_data %>% 
              group_by(VESSEL_LENGTH_CATEGORY, OBSERVED_FLAG) %>% 
              filter(OBSERVED_FLAG == 'Y') %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = " ",
                        FMP              = "Total Unique",
                        TRIP_COUNT_OBS = n_distinct(TRIP_ID),
                        VESSEL_COUNT_OBS = n_distinct(VESSEL_ID))) %>% 
  data.frame()
 

# Convert the trip and vessel counts to a wide format:
obs_counts_wide <- obs_counts %>% 
  pivot_wider(id_cols = c(STRATA, FMP, AGENCY_GEAR_CODE, OBSERVED_FLAG),
              names_from = VESSEL_LENGTH_CATEGORY,
              values_from = c(TRIP_COUNT_OBS, VESSEL_COUNT_OBS))

```


```{r pct.trips.obs, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Combine the datasets with total trip counts (total_counts_wide) and observed trip counts (obs_counts_wide)
# and calculate the percent observed:

counts_wide <- total_counts_wide %>%   
  # Combined the trip count and the observed trip count summaries
  left_join(obs_counts_wide, by = c("FMP", "STRATA", "AGENCY_GEAR_CODE")) %>% 
  # Calculate the percent observed:
  mutate(TRIP_COUNT_OBS_LT40 = as.numeric(NA),
         LT40_pct    = as.numeric(NA),
         BT40_57_pct = round((TRIP_COUNT_OBS_BT40_57/TRIP_COUNT_BT40_57)*100,1),
         GT58_pct    = round((TRIP_COUNT_OBS_GT58/TRIP_COUNT_GT58)*100,1)) %>% 
  # Reorder the columns:
  select(FMP, STRATA, AGENCY_GEAR_CODE, VESSEL_COUNT_LT40, TRIP_COUNT_LT40, TRIP_COUNT_OBS_LT40, LT40_pct,
         VESSEL_COUNT_BT40_57, TRIP_COUNT_BT40_57, TRIP_COUNT_OBS_BT40_57, BT40_57_pct,
         VESSEL_COUNT_GT58, TRIP_COUNT_GT58, TRIP_COUNT_OBS_GT58, GT58_pct) %>% 
  # Assign a particular sorting order to the strata:
  mutate(STRATA_ORDER = ifelse(STRATA == 'FULL', 1,
                           ifelse(STRATA=='EM_TRW_EFP_FULL', 2,
                              ifelse(STRATA== 'EM_HAL', 3,
                                ifelse(STRATA=='EM_POT', 4,
                                   ifelse(STRATA=='EM_TRW_EFP_PART', 5,
                                      ifelse(STRATA == 'HAL', 6,
                                         ifelse(STRATA == 'POT', 7,
                                            ifelse(STRATA=='TRW', 8,
                                               ifelse(STRATA=='ZERO', 9,
                                                      ifelse(STRATA=='ZERO_EM_RESEARCH', 10,
                                                         ifelse(STRATA=='FMP AREA Subtotal', 11, 12)))))))))))) %>% 
  # Sort the data:
  arrange(FMP, STRATA_ORDER, AGENCY_GEAR_CODE) %>% 
  data.frame()


```

Table 4-1. Number of vessels (V), total trips (N), monitored trips (n), and percent of trips monitored (%) in `r as.numeric(format(Sys.Date(), "%Y"))-1`  in the BSAI by strata, gear type (hook-and-line (HAL), non-pelagic trawl (NPT), pelagic trawl (PTR), pot, and jig), and vessel length category (based on length overall, in feet) for the full and partial coverage categories.     


```{r flextable_TABLE4_1}

# Clean up the strata descriptions:
bsai <- counts_wide %>% 
  filter(FMP == 'BSAI') %>% 
  select(1:15) %>% 
  mutate(STRATA = ifelse(STRATA == 'FULL', "Full", STRATA)) %>% 
  mutate(STRATA = ifelse(STRATA == 'EM_HAL', "EM HAL", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_POT', "EM POT", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_TRW_EFP_FULL', "EM TRW EFP (Full)", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO', "Zero", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO_EM_RESEARCH', "Zero EM Research", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'FMP AREA Subtotal', "BSAI Subtotal", STRATA)) 
  

# Create a table for the Fee Summaries in All Areas:
flextable(bsai) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(FMP = "Area", 
                    STRATA = "Strata",
                    AGENCY_GEAR_CODE = "Gear",
                    VESSEL_COUNT_LT40 = "V",
                    TRIP_COUNT_LT40 = "N",
                    TRIP_COUNT_OBS_LT40 = "n",
                    LT40_pct = "%",
                    VESSEL_COUNT_BT40_57 = "V",
                    TRIP_COUNT_BT40_57 = "N",
                    TRIP_COUNT_OBS_BT40_57 = "n",
                    BT40_57_pct = "%",
                    VESSEL_COUNT_GT58 = "V",
                    TRIP_COUNT_GT58 = "N",
                    TRIP_COUNT_OBS_GT58 = "n",
                    GT58_pct = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "", "<40'", "40-57.4'", ">=57.5'"),
                 colwidths = c(1,1,1,4,4,4)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(4:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Add top header row:
  add_header_row(values = c("", "", "", "Vessel length category"),
                 colwidths = c(1,1,1,12)) %>% 
  align(align = "center", part = "header") %>% 
  # Add top table border above header:
  hline_top(j = c(1:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 3, j = c(1:3), align = "left", part = "header") %>% 
  align(i = 3, j = c(4:15), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_num(j = c(4,5,6,8,9,10,12,13,14), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(7,11,15), big.mark = ",", digits = 1) %>% 
  # Merge the area labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'FMP AREA Subtotal' label across 2 cells (strata and gear):
  merge_at(i=16, j=c(2:3)) %>% 
  # Add dashed horizontal lines before area subtotals:
  border(i = 15, part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  # Add footer:
  footnote(i = 1, j = 1:2, part = "header",
           value = as_paragraph(c("Monitored trips reflect either trips with an observer or EM fixed gear trips for which some video was reviewed.", "Full coverage in this table includes vessels in both the Regulatory and Voluntary Full Coverage strata described in Ch. 3.")))



```




Table 4-2. Number of vessels (V), total trips (N), monitored trips (n), and percent of trips monitored (%) in `r as.numeric(format(Sys.Date(), "%Y"))-1`  in the GOA and overall by strata, gear type (hook-and-line (HAL), non-pelagic trawl (NPT), pelagic trawl (PTR), pot, and jig), and vessel length category (based on length overall, in feet) for the full and partial coverage categories. 


```{r flextable_TABLE4_1}

# Clean up the strata descriptions:
goa <- counts_wide %>% 
  filter(FMP %in% c('GOA', 'Total Unique')) %>% 
  select(1:15) %>% 
  mutate(STRATA = ifelse(STRATA == 'FULL', "Full", STRATA)) %>% 
  mutate(STRATA = ifelse(STRATA == 'EM_HAL', "EM HAL", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_POT', "EM POT", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_TRW_EFP_PART', "EM TRW EFP (Partial)", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO', "Zero", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO_EM_RESEARCH', "Zero EM Research", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'FMP AREA Subtotal', "GOA Subtotal", STRATA)) 
  

# Create a table for the Fee Summaries in All Areas:
flextable(goa) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(FMP = "Area", 
                    STRATA = "Strata",
                    AGENCY_GEAR_CODE = "Gear",
                    VESSEL_COUNT_LT40 = "V",
                    TRIP_COUNT_LT40 = "N",
                    TRIP_COUNT_OBS_LT40 = "n",
                    LT40_pct = "%",
                    VESSEL_COUNT_BT40_57 = "V",
                    TRIP_COUNT_BT40_57 = "N",
                    TRIP_COUNT_OBS_BT40_57 = "n",
                    BT40_57_pct = "%",
                    VESSEL_COUNT_GT58 = "V",
                    TRIP_COUNT_GT58 = "N",
                    TRIP_COUNT_OBS_GT58 = "n",
                    GT58_pct = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "", "<40'", "40-57.4'", ">=57.5'"),
                 colwidths = c(1,1,1,4,4,4)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(4:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Add top header row:
  add_header_row(values = c("", "", "", "Vessel length category"),
                 colwidths = c(1,1,1,12)) %>% 
  align(align = "center", part = "header") %>% 
  # Add top table border above header:
  hline_top(j = c(1:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 3, j = c(1:3), align = "left", part = "header") %>% 
  align(i = 3, j = c(4:15), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_num(j = c(4,5,6,8,9,10,12,13,14), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(7,11,15), big.mark = ",", digits = 1) %>% 
  # Merge the area labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'FMP AREA Subtotal' label across 2 cells (strata and gear):
  merge_at(i=21, j=c(2:3)) %>% 
  # Merge 'Total Unique' label across 2 cells (area and strata):
  merge_at(i=22, j=c(1:2)) %>% 
  # Add dashed horizontal line before area subtotals:
  border(i = 20, part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  # Add solid horizontal line before unique totals:
  border(i = 21, part = "body", border.bottom = fp_border(style = "solid")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  # Add footer:
  footnote(i = 1, j = 1:2, part = "header",
           value = as_paragraph(c("Monitored trips reflect either trips with an observer or EM fixed gear trips for which some video was reviewed.", "Full coverage in this table includes vessels in both the Regulatory and Voluntary Full Coverage strata described in Ch. 3.")))



```


### 4.2  Total Catch and Discards and Amount of Catch Observed
The ADP does not assign observers or EM coverage by fisheries (because the fishery is not able to be defined before fishing occurs), instead observers or EM are deployed to trips and vessels across all fisheries.  However, there has been interest in comparing observer and EM coverage across resulting fisheries, so this section includes summaries of monitored and total catch by area, gear type, and sector. The total catch of groundfish and halibut (retained and discarded) was summarized from the NMFS CAS in Table 4-3 and Table 4-4 for  `r as.numeric(format(Sys.Date(), "%Y"))-1`. These tables allow for comparisons of the metric of catch weight derived from CAS.  Catch estimation methods are described in detail in Cahalan et al. 2014. 

It is important to note that the proportion of catch weight monitored for a subset of fishing activity (i.e., a fishery) should not a priori be expected to equal the deployment rates (proportion of trips selected for observer or EM coverage) specified in the ADP.  In particular, if there are differences in fishing characteristics between the subsets of fishing activity, specifically differences in catch weights (or discard rates) per trip, those differences will be reflected in the relative proportions of catch monitored. For example, within the partial coverage trawl stratum, trips in the Pollock fishery will have very different total catch weights and discard characteristics than trips in flatfish fisheries. In addition, there are several other factors that will contribute to the apparent inconsistencies between proportion of catch monitored, the proportion of trips monitored, and the deployment rate specified in the ADP. These include the actual number of trips selected (sample size), variability in deployment due to random chance, the ratio of number of trips in each of the fisheries, and lack of independence between the coverage rates within a sampling stratum[^1^].  

In Table 4-3 and Table 4-4, the table columns titled "Monitored" indicate catch that occurred on trips where an observer was present or on EM fixed gear trips for which some video was reviewed. Catch on vessels on EM pot trips are included in the monitored column in these tables for the first time. Beginning with 2019, EM data from pot gear were integrated into the catch estimation process. The columns titled "Total" represents estimates of all catch from all trips regardless of whether it was monitored. The rows title "Retained" indicate catch that was offloaded (minus dockside discard). The rows titled "Discard" are estimated at-sea discard.

All catch and discard information, including halibut, summarized in these tables are in round weight metric tons. If species were landed in a condition other than round weight, then standard product recovery rates (PRRs) were used to obtain round weight. Halibut that were landed in ice and slime were additionally corrected for ice and slime using a standard 2% correction. 

Additional retained and discard catch information, broken down by species for the Gulf of Alaska (GOA) and Bering Sea/Aleutian Islands (BSAI), are available online for 2019 as well as prior years[^2^]. Caution should be exercised when interpreting the results for halibut in the halibut IFQ fishery in these tables, however.  For longline catch, the estimated weight of each species caught is the product of the estimated number of fish, the mean weight per fish, and the proportion of the catch that is discarded. While *these methods provide unbiased estimates of total catch*, the estimate of at-sea discards relies on the assumption that the proportion of the number of discarded is equal to the proportion of the weight discarded. The Pacific halibut fishery is the only federally managed groundfish fishery with a regulatory minimum size limit (32 cm). Because the minimum size limit requires smaller fish to be discarded, this assumption is not valid in the directed halibut fishery.

Starting in 2016, selection sampling methods for halibut were changed so that halibut selection was randomized within sampled hauls, making these data collections consistent with methods used in other fisheries and providing data that was used to assess the magnitude of bias associated with estimates of at-sea halibut discards in the directed fishery. These data were used to develop a model in late 2019 to convert the percent numbers discarded to percent weight discarded, and resolving the potential bias. These results were presented at the 2019 American Fisheries Society Meeting, and they suggest that the weight of halibut discarded on sampled hauls in the directed halibut fishery is overestimated by approximately 35%. This conversion method will be documented in a forthcoming NOAA Tech Memo and incorporated into the estimation process as soon as possible (expected in 2021).

***
 
[^1]: More trips monitored in one subpopulation (fishery) equates to fewer monitored trips in the other subpopulations since all the trips across the different subpopulations must add to the total number of trips selected.

[^2]: Available online at [link]https://www.fisheries.noaa.gov/alaska/fisheries-observers/observed-catch-tables-north-pacific-observer-program 

***


```{r summarize.catch, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Summarize catch by two different aggregations:
catch_detail <- addl_catch_table %>%
  # Define sector using the RPP flag or the processing sector:
  mutate(SECTOR = ifelse(RPP=="RPP", "RPP", PROCESSING_SECTOR)) %>% 
  # Summarize by FMP area, sector, gear, and retained flag:
  group_by(FMP, SECTOR, OBS_FOR_EST, AGENCY_GEAR_CODE, RETAINED) %>% 
  summarise(WEIGHT = sum(as.numeric(TONS))) %>%
  # Summarize by FMP area, gear, and retained flag:
  bind_rows(addl_catch_table %>% group_by(FMP, OBS_FOR_EST, AGENCY_GEAR_CODE, RETAINED) %>% 
             summarize(SECTOR = 'Total',
                       WEIGHT = sum(as.numeric(TONS)))) %>% 
  data.frame()


# Convert the catch summaries to a wide format:
catch_detail_wide <- catch_detail %>% 
  pivot_wider(id_cols = c(FMP, SECTOR, AGENCY_GEAR_CODE, RETAINED),
              names_from = OBS_FOR_EST,
              values_from = WEIGHT) %>% 
  # Calculate the percent observed
  mutate(PCT_OBS = round((Observed/Total),2)*100) %>% 
  # Replace nas with 0:
  replace_na(list('Observed'= 0, 'PCT_OBS' = 0)) %>% 
  # String out EVEN WIDER:
  pivot_wider(id_cols = c(FMP, AGENCY_GEAR_CODE, RETAINED),
              names_from = SECTOR,
              values_from = c("Observed","Total","PCT_OBS")) %>% 
   # Translate the gear and Retained/Discard values:
  mutate(AGENCY_GEAR_CODE = recode(AGENCY_GEAR_CODE,
                                   'HAL'='Hook and Line',
                                   'JIG'='Jig',
                                   'NPT'='Non-Pelagic Trawl',
                                   'POT'='Pot',
                                   'PTR'='Pelagic Trawl')) %>% 
  mutate(RETAINED = recode(RETAINED, 'R'='Retained', 'D'='Discard'))


```



```{r add_jig, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

#Add new rows because JIG doesn't have a discard row and assign the same column names used in catch_wide
jig_rows <- data.frame(cbind(c("GOA", "BSAI"), c("Jig", "Jig"), c("Discard", "Discard")))  
col_names <- names(catch_wide[,1:3])
names(jig_rows) <- col_names  

# The columns in jig_rows need to be character values rather than factors for later formatting:
jig_rows <- jig_rows %>% 
  mutate_all(as.character)

# Append the additional columns:
catch_wide <- rbind.fill(catch_detail_wide, jig_rows)

# Provide a gear order:
catch_wide <- catch_wide %>% 
  mutate(GEARORDER = ifelse(AGENCY_GEAR_CODE == 'Hook and Line', 1,
                            ifelse(AGENCY_GEAR_CODE == 'Jig', 2,
                                   ifelse(AGENCY_GEAR_CODE == 'Non-Pelagic Trawl', 3,
                                          ifelse(AGENCY_GEAR_CODE == 'Pot', 4, 5)))))  %>% 
  arrange(FMP, GEARORDER, desc(RETAINED))


```


**INSERT PAGE BREAK** 

Table 4-3. Monitored catch^1^ (metric tons), total catch, and percent monitored (%) of groundfish and halibut retained and discarded in the groundfish and halibut fisheries in `r as.numeric(format(Sys.Date(), "%Y"))-1` in the *Gulf of Alaska*. Empty cells indicate that no catch occurred.


```{r Table4_3_flextable, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

# Refine to just the GOA data and rearrange the column order:
table4_3 <- catch_wide %>% 
  filter(FMP=='GOA') %>% 
  select(c(2:3,
           4,9,14, #Catcher/Processors
           6,11,16, #Catcher Vessels (PROCESSING_SECTOR=='S')
           7,12,17, #Catcher Vessels: Rockfish Program (GOA only)
           #5,10,15, #Mothership (BSAI only)
           8,13,18  # Gear Totals
           )) 


# Create a table for the Fee Summaries in All Areas:
flextable(table4_3) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(AGENCY_GEAR_CODE = "Gear",
                    RETAINED = "Catch",
                    Observed_CP = "Monitored",
                    Total_CP = "Total",
                    PCT_OBS_CP = "%",
                    Observed_S = "Monitored",
                    Total_S = "Total",
                    PCT_OBS_S = "%",
                    Observed_RPP = "Monitored",
                    Total_RPP = "Total",
                    PCT_OBS_RPP = "%",
                    Observed_Total = "Monitored",
                    Total_Total = "Total",
                    PCT_OBS_Total = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "Catcher/Processor", "Catcher vessel", "Catcher vessel: Rockfish program", "Gear total"),
                 colwidths = c(1,1,3,3,3,3)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(3:14), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 2, j = c(1:2), align = "left", part = "header") %>% 
  align(i = 2, j = c(3:14), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_num(j = c(3,4,6,7,9,10,12,13), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(5,8,11,14), big.mark = ",", digits = 0, suffix = "%" ) %>% 
  bold(j=c(1,2,5,8,11,14), part = "body") %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Add solid horizontal line after each gear:
  border(i = c(2,4,6,8), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  # Add footer:
  footnote(i = 1, j = 1, part = "header",
           value = as_paragraph("Monitored catch is from trips with an observer or EM trips for which some video was reviewed."))



``` 


**INSERT PAGE BREAK** 

Table 4-4. Monitored catch^1^ (metric tons), total catch, and percent monitored (%) of groundfish and halibut retained and discarded in the groundfish and halibut fisheries in `r as.numeric(format(Sys.Date(), "%Y"))-1` in the *Bering Sea/Aleutian Islands*.  Empty cells indicate that no catch occurred.


```{r Table4_4_flextable, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

# Refine to just the GOA data and rearrange the column order:
table4_4 <- catch_wide %>% 
  filter(FMP=='BSAI') %>% 
  select(c(2:3,
           4,9,14, #Catcher/Processors
           5,10,15, #Mothership (BSAI only)
           6,11,16, #Catcher Vessels (PROCESSING_SECTOR=='S')
           #7,12,17, #Catcher Vessels: Rockfish Program (GOA only)
           8,13,18  # Gear Totals
           )) 


# Create a table for the Fee Summaries in All Areas:
flextable(table4_4) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(AGENCY_GEAR_CODE = "Gear",
                    RETAINED = "Catch",
                    Observed_CP = "Monitored",
                    Total_CP = "Total",
                    PCT_OBS_CP = "%",
                    Observed_S = "Monitored",
                    Total_S = "Total",
                    PCT_OBS_S = "%",
                    Observed_RPP = "Monitored",
                    Total_RPP = "Total",
                    PCT_OBS_RPP = "%",
                    Observed_Total = "Monitored",
                    Total_Total = "Total",
                    PCT_OBS_Total = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "Catcher/Processor", "Mothership", "Catcher vessel", "Gear total"),
                 colwidths = c(1,1,3,3,3,3)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(3:14), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 2, j = c(1:2), align = "left", part = "header") %>% 
  align(i = 2, j = c(3:14), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_num(j = c(3,4,6,7,9,10,12,13), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(5,8,11,14), big.mark = ",", digits = 0, suffix = "%" ) %>% 
  bold(j=c(1,2,5,8,11,14), part = "body") %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Add solid horizontal line after each gear:
  border(i = c(2,4,6,8), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  # Add footer:
  footnote(i = 1, j = 1, part = "header",
           value = as_paragraph("Monitored catch is from trips with an observer or EM trips for which some video was reviewed."))

```


```{r workspace, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Clean up workspace (removes everything EXCEPT the objects listed) and save RData
rm(list= ls()[!(ls() %in% c('YEAR','work_data', 'with_totals', 'counts_wide', 'bsai', 'goa', 'catch_wide', 'table4_3', 'table4_4'))])


#save('YEAR', 'work_data', 'with_totals', 'counts_wide', 'bsai', 'goa', 'catch_wide', 'table4_3', 'table4_4',
#     file = paste0("AR_descriptive_", YEAR, "_tables.RData"))

```



