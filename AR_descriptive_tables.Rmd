---
output: word_document
title: "Annual Report Descriptive Data Draft"
---
```{r background_info, include=FALSE}

# -------------------------------------------------------------------------------------------------------------------- #
#
# Program:AR_descriptive_tables.Rmd                                         
# Project:Observer Program Annual Report Descriptive Chapter                                      
# Location: S:\Observer Program Annual Report\YEAR_Annual_Report\Chap4_Descriptive_Info 
#      or: H:\Observer Program\Annual Report Local GIT Project\Descriptive Info
#
# Objectives:                                                                  
# - Summarize vessels, trips, and % observed by vessel length, strata, gear, and FMP area for Chapter 4 (Table 4-1 and 4-2).    
# - Summarize observed and total catch by FMP area, sector, gear, and retained flag for Chapter 4 (Tables 4-3 and 4-4).
#
# Inputs:      
# Normal locations:                                                                   
#  - S:\Observer Program Annual Report\YYYY_Annual_Report\Chapt4_Descriptive_Info\AR_descriptive_YYYY_data.Rdata
#     - catch.tables - 2013-2022 catch tables for posting to the AKRO website (NOT USED in this script)
#     - previous.catch.tables - previous year's version of the catch tables (2013-2021) (NOT USED in this script)
#     - VALHALLA - the original Valhalla data (NOT USED in this script)
#     - warehouse.data - the mortality rates that were applied to the PSC data in the CAS run used in Valhalla's creation 
#                        (NOT USED in this script)
#     - with_totals - summary of total catch of groundfish, directed halibut, and PSC halibut as observed or not observed
#     - work_data - Valhalla dataset following some clean-up and addition of DMRs for halibut PSC
#
# Output:  
# Normal locations:  
#   - S:\Observer Program Annual Report\YYYY_Annual_Report\Chapt4_Descriptive_Info\AR_descriptive_YYYY_tables.html
#     - catch_wide - summary of catch by FMP area, sector, gear, and retained flag with subtotals. Includes percent observed.
#     - counts_wide - monitored and total trip counts.  Includes percent monitored.
#     - table4_3 - GOA table of monitored catch.
#     - table4.4 - BSAI table of monitored catch.
#     - with_totals - summary of total catch of groundfish, directed halibut, and PSC halibut as observed or not observed
#     - work_data - Valhalla dataset following some clean-up and addition of DMRs for halibut PSC
# --------------------------------------------------------------------------------------------------------- #

```

# 3 Descriptive Information

## 3.1  Deployment Summary

In past years, Chapter 3 (the deployment performance review) was prepared by the Fishery
Monitoring Science Committee. However, a full evaluation of 2021 deployment (with FMSC
review) was not completed for this Annual Report, and instead a summary of anticipated and
realized deployment is provided in this chapter (Table 3-1). Not including a full evaluation of
deployment is a temporary situation to facilitate work on evaluating sampling design and cost
efficiencies that may be incorporated into the 2024 ADP. Additionally, changes in sampling
strata and deployment methods are not anticipated for the 2023 ADP. The NMFS plans to
publish the full 2021 Deployment Performance Review as a stand-alone tech memo after
analyses for the 2024 ADP have been completed.

In December 2020, NMFS released the final 2021 ADP (NMFS 2020). Due to limitations on
transportation and health mandates associated with COVID-19, observers were deployed on
randomly selected trips according to a port-based trip selection model in 2021. The port-specific
deployment method excluded trips from observation if they did not depart and land within a port
that was on the list of observable ports.

The observable ports were identified because travel and lodging conditions allowed observers to
meet and maintain applicable health mandates and advisories for deployment into the
commercial fisheries and because there were expected to be enough fishing trips originating and
ending in these ports to make it cost effective to place observers in these communities. These
ports included: 1) Akutan, 2) Dutch Harbor/Unalaska, 3) False Pass, 4) Homer, 5) Juneau, 6)
Ketchikan, 7) King Cove, 8) Kodiak, 9) Nome, 10) Petersburg, 11) Sand Point, 12) Seward, 13)
Sitka, and 14) Yakutat. In statistical terms, prior to COVID-19, all ports were within the
sampling frame, whereas only some ports remained in the sampling frame in response to
COVID-19.

Target deployment rates were as follows:
• Hook-and-Line - 15.13%.
• Pot - 15.04%.
• Trawl vessels not participating in EM - 16.12%.

The programmed rates for the ODDS differed from the ADP target monitoring rates in order to
account for monitoring waivers (NMFS 2020). Initially, the ‘sample frame adjusted rate’ was
estimated as the selection rate required of trips within the sample frame in order to achieve the
target monitoring rate for all trips. The ODDS programmed rates resulted after an additional
adjustment to the sample frame rate accounted for anticipated waivers due to other logistic
limitations of deployment under COVID-19 safety protocols. Consequently, the ODDS was
programmed at the beginning of the year to randomly select logged trips at a rate of 23.35% in 
the HAL stratum, 29.92% in the POT stratum, 19.29% in the TRW stratum. These programmed
rates were expected to result in the target monitoring rates listed above.
In August 2021, NMFS released an Information Bulletin to announce the expansion of observer
deployment for all ports throughout Alaska beginning on 1 September 2021. This change was
consistent with the updated NOAA policy on observer waivers, which states that vessels are no
longer eligible for release from observer coverage under the Emergency Rule if a fully
vaccinated or quarantined/shelter-in-place observer is available. The ODDS programmed rates
therefore had to be updated as the sample frame adjustment was no longer required. Combined
with estimates of the remaining budget, remaining fishing effort, and deployment costs, new
target deployment rates were assigned to the observer sampling strata with the intention of
achieving the yearly monitoring rates originally set in the 2021 ADP by the end of the year.

Target deployment rates were adjusted as follows:
• Hook-and Line - 17.9%.
• Pot - 17.6%.
• Trawl vessels not participating in EM - 21.0%.

Other adjustments to the ODDS trip selection rates were required to achieve these monitoring
rates. Waivers could still be given if the observer provider could not assign an observer who had
quarantined for 14 days with only 3 days of notice to a trip, or if the provider or observers did
not feel safe with the vessel’s quarantine status. Beginning 1 September, selection rates in the
ODDS were programmed to randomly select logged trips at a rate of 19.70% in the HAL stratum,
19.40% in the POT stratum, and 21.00% in the TRW stratum. These programmed rates were
expected to result in the second set of target monitoring rates listed above, for trips that occurred
on or after 1 September.

Following the 2021 ADP, ODDS was programmed to randomly select logged trips at a rate of
30% in the EM HAL and EM POT strata. Because no waivers were expected in EM, the target
monitoring rate (and programmed rate) for these strata was constant at 30%.

### 3.1.1 At-Sea Deployments Rate Summary

This section compares the coverage rate achieved against the expected coverage rates. Data used
in this evaluation are stored within the Catch Accounting System (CAS, managed by the
AKRO), the Observer Program database (NORPAC, managed by the AFSC), and eLandings
(under joint management by Alaska Department of Fish and Game - ADF&G; the International
Pacific Halibut Commission - IPHC; and the NMFS).

The 2021 Observer Program had 13 different deployment strata to be evaluated (Table 3-1).
There was one full coverage observed stratum (Full) comprised of trips taken both by vessels
that were required to have full coverage (e.g., AFA catcher/processor vessels) and those fishing
in the BSAI that opted into full coverage. There was one full coverage trawl EM stratum (EM
TRW EFP) comprised of trips taken by AFA catcher vessels fishing for pollock under the
Exempted Fishing Permit (EFP). There were three partial coverage EM strata: EM HAL, EM
POT, and EM TRW EFP. There were three partial coverage observed strata defined by gear: HAL, POT, and TRW.
There were also two zero coverage strata: one zero coverage EM research stratum and one zero
coverage stratum for jig vessels and vessels under 40 ft. length overall.

Evaluations for the full coverage category and zero-selection pool are straightforward - either the
coverage achieved was equal to 100% or 0%, respectively, or it was not. The program achieved
100% coverage in the Full observed stratum, and 100% coverage in the full coverage EM TRW
EFP stratum (Table 3-1). The program achieved perfect compliance with both zero coverage
strata (Table 3-1). Under the assumption that deployment was randomized, a 95% confidence
interval computed from the realized coverage rates (under the assumption of a binomial
distribution for observed trips) will contain the expected deployment rate 95% of the time. If
expected coverage levels were within the 95% confidence intervals, then we conclude that
realized and expected coverage rates were equal. Coverage rates were consistent with expected
values in seven of the nine partial coverage strata for which they were evaluated. Coverage rates
were lower than expected for HAL during the first time period. Coverage rates were higher than
expected for TRW in the second time period (Table 3-1).

In combination across all strata, coverage levels, and fishery monitoring tools, 3,747 trips
(43.2%) and 423 vessels (44.2%) were successfully monitored among all fishing in federal
fisheries of Alaska in 2021 (Table 3-1).

### 3.1.2  Number of Trips and Vessels by FMP Area, Strata, Gear and Vessel Length

Table 3-1 provides trip and vessel counts based on coverage type and strata. However, the
Council has previously requested a summary of trip and vessel counts based on criteria that are
not, or are no longer, considered when deploying observers on trips (e.g., FMP area and vessel
length). Table 3-2 and Table 3-3 provide a summary of the number of vessels and trips by FMP
area, strata, gear type, and vessel length category within the full and partial coverage categories.
Trips are summarized as the number of monitored trips and the total number of trips. Monitored
trips reflect either trips with an observer, EM fixed gear trips if at least some video was
reviewed, or EM trawl trips where salmon and Pacific halibut were observed at the shoreside
plant. The rationale for defining monitored trips for EM fixed gear or EM trawl trips this way is
that it is most similar to the way in which trips in other strata are considered observed (i.e.,
irrespective of whether or not haul information or usable species composition data were
collected).

Vessels and trips may be counted more than once in a vessel length category in Table 3-2 and
Table 3-3 if a vessel is in more than one stratum, fishes in more than one FMP area, or utilizes
more than one gear type on a trip or within the year. The table rows titled “BSAI Subtotal”,
“GOA Subtotal”, and “Total Unique” include the number of unique vessels and unique trips in
each vessel length category where each vessel or trip is counted only once, in each of the FMP
areas or overall, respectively.


## 3.2  Total Catch and Discards and Amount of Catch Observed

The ADP does not assign observers or EM coverage by fisheries (because the fishery is not able to be defined before fishing occurs), instead observers or EM are deployed to trips and vessels across all fisheries.  However, there has been interest in comparing observer and EM coverage across resulting fisheries, so this section includes summaries of monitored and total catch by area, gear type, and sector. The total catch of groundfish and halibut (retained and discarded) was summarized from the NMFS Catch Accounting System (CAS) in Table 3-4 and Table 3-5 for `r as.numeric(format(Sys.Date(), "%Y"))-1`. These tables allow for comparisons of the metric of catch weight derived from CAS.  Catch estimation methods are described in detail in Cahalan et al. (2014). 

It is important to note that the proportion of catch weight monitored for a subset of fishing activity (i.e., a fishery) should not _a priori_ be expected to equal the deployment rates (proportion of trips selected for observer or EM coverage) specified in the ADP.  In particular, if there are differences in fishing characteristics between the subsets of fishing activity, specifically differences in catch weights (or discard rates) per trip, those differences will be reflected in the relative proportions of catch monitored. For example, within the partial coverage trawl stratum, trips in the Pollock fishery will have very different total catch weights and discard characteristics than trips in flatfish fisheries. In addition, there are several other factors that will contribute to the apparent inconsistencies between proportion of catch monitored, the proportion of trips monitored, and the deployment rate specified in the ADP. These include the actual number of trips selected (sample size), variability in deployment due to random chance, the ratio of number of trips in each of the fisheries, and lack of independence between the coverage rates within a sampling stratum[^1].  

In Table 3-4 and Table 3-5, the table columns titled “Monitored” indicate catch that occurred on trips where an observer was present, on EM fixed gear trips for which some video was reviewed, or on EM trawl trips where salmon or Pacific halibut were observed for at the shoreside plant.  The columns titled “Total” represents estimates of all catch from all trips regardless of whether it was monitored. The rows title “Retained” indicate catch that was offloaded (minus dockside discard). The rows titled “Discard” are estimated at-sea discard.

All catch and discard information, including halibut, summarized in these tables are in round weight metric tons. If species were landed in a condition other than round weight, then standard product recovery rates (PRRs) were used to obtain round weight. Halibut that were landed in ice and slime were additionally corrected for ice and slime using a standard 2% correction.  

These tables can also be used to compare the proportion of catch that occurred in full coverage or
the partial coverage categories or the proportion of catch that was monitored for trips in partial
coverage. For example:

* In the BSAI and GOA combined, 93.4% of pelagic trawl catch was on trips in the full
coverage category and 6.6% was on trips in partial coverage. All partial coverage trips
were in the GOA and 27.2% of their catch was monitored;
* In the BSAI and GOA combined, 94.9% of non-pelagic trawl catch was on trips in full
coverage category and 5.1% was on trips in partial coverage. Partial coverage trips
occurred in both the BSAI and GOA with 44.0% and 20.6% of their catch monitored,
respectively.

Additional retained and discard catch information, broken down by species for the Gulf of Alaska (GOA) and Bering Sea/Aleutian Islands (BSAI), are available online for `r as.numeric(format(Sys.Date(), "%Y"))-1` as well as prior years.[^2] 

#### Discarded Pacific halibut in the IFQ fishery ####

New for the 2021 report were bias-corrected estimates of Pacific halibut discarded in the IFQ halibut
fishery. In 2022, NMFS published a method to adjust for this bias by adjusting the percentage of
halibut retained to reflect the differences in mean weight for retained (and discarded) halibut
(Cahalan and Gasper 2022). This solution was implemented starting in 2021 and continues to be included
in the estimates of directed halibut fishery discard summarized in this report.


***
 
[^1]: More trips monitored in one subpopulation (fishery) equates to fewer monitored trips in the other subpopulations since all the trips across the different subpopulations must add to the total number of trips selected.

[^2]: Available online at [link]https://www.fisheries.noaa.gov/alaska/fisheries-observers/observed-catch-tables-north-pacific-observer-program 

***

```{r data_inputs, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# https://stackoverflow.com/questions/29189663/trying-to-publish-an-r-notebook-and-keep-getting-the-same-error-error-in-contri
chooseCRANmirror(graphics=FALSE, ind=1)    
knitr::opts_chunk$set(echo = TRUE)

# LOAD DATA 

YEAR <- 2022

#Source helper file (libraries, ggplot themes, etc.)
source("AR_descriptive_helper.r")

# Load Ch 4 dataset:
load(paste0("AR_descriptive_", YEAR, "_data.RData"))

#Clean up workspace (Remove everything EXCEPT the objects listed)
rm(list= ls()[!(ls() %in% c('YEAR', 'work_data', 'addl_catch_table', 'fig.theme'))])

```


```{r all_trips, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

#detach(package:plyr)

# Summarize ALL trip and vessel counts for three different levels of aggregation:
total_counts <- work_data %>% 
  # Detail summaries for strata, FMP area, gear, and vessel length category:
  group_by(STRATA, FMP, AGENCY_GEAR_CODE, VESSEL_LENGTH_CATEGORY) %>% 
  summarize(TRIP_COUNT = n_distinct(TRIP_ID),
            VESSEL_COUNT = n_distinct(VESSEL_ID), .groups = 'drop') %>%
  # FMP Area summaries for vessel length category:
  bind_rows(work_data %>% group_by(FMP, VESSEL_LENGTH_CATEGORY) %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = "FMP AREA Subtotal",
                        TRIP_COUNT = n_distinct(TRIP_ID),
                        VESSEL_COUNT = n_distinct(VESSEL_ID), .groups = 'drop')) %>% 
  # Overall summaries for vessel length category:
  bind_rows(work_data %>% group_by(VESSEL_LENGTH_CATEGORY) %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = " ",
                        FMP              = "Total Unique",
                        TRIP_COUNT = n_distinct(TRIP_ID),
                        VESSEL_COUNT = n_distinct(VESSEL_ID), .groups = 'drop')) %>% 
  data.frame()
 

# Convert the trip and vessel counts to a wide format:
total_counts_wide <- total_counts %>% 
  pivot_wider(id_cols = c(STRATA, FMP, AGENCY_GEAR_CODE),
              names_from = VESSEL_LENGTH_CATEGORY,
              values_from = c(TRIP_COUNT, VESSEL_COUNT))

```


```{r observed_trips, message=FALSE, warning=FALSE, include=FALSE, results='asis'}


# Summarize OBSERVED trip and vessel counts for three different levels of aggregation:
obs_counts <- work_data %>% 
  filter(OBSERVED_FLAG == 'Y') %>% 
  # Detail summaries for strata, FMP area, gear, and vessel length category:
  group_by(STRATA, FMP, AGENCY_GEAR_CODE, VESSEL_LENGTH_CATEGORY, OBSERVED_FLAG) %>% 
  summarize(TRIP_COUNT_OBS = n_distinct(TRIP_ID),
            VESSEL_COUNT_OBS = n_distinct(VESSEL_ID), .groups = 'drop') %>%
  # FMP Area summaries for vessel length category:
  bind_rows(work_data %>% 
              filter(OBSERVED_FLAG == 'Y') %>% 
              group_by(FMP, VESSEL_LENGTH_CATEGORY, OBSERVED_FLAG) %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = "FMP AREA Subtotal",
                        TRIP_COUNT_OBS = n_distinct(TRIP_ID),
                        VESSEL_COUNT_OBS = n_distinct(VESSEL_ID), .groups = 'drop')) %>% 
  # Overall summaries for vessel length category:
  bind_rows(work_data %>% 
              group_by(VESSEL_LENGTH_CATEGORY, OBSERVED_FLAG) %>% 
              filter(OBSERVED_FLAG == 'Y') %>% 
              summarize(AGENCY_GEAR_CODE = " ",
                        STRATA           = " ",
                        FMP              = "Total Unique",
                        TRIP_COUNT_OBS = n_distinct(TRIP_ID),
                        VESSEL_COUNT_OBS = n_distinct(VESSEL_ID), .groups = 'drop')) %>% 
  data.frame()
 

# Convert the trip and vessel counts to a wide format:
obs_counts_wide <- obs_counts %>% 
  pivot_wider(id_cols = c(STRATA, FMP, AGENCY_GEAR_CODE, OBSERVED_FLAG),
              names_from = VESSEL_LENGTH_CATEGORY,
              values_from = c(TRIP_COUNT_OBS, VESSEL_COUNT_OBS))

```


```{r pct.trips.obs, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

# Combine the datasets with total trip counts (total_counts_wide) and observed trip counts (obs_counts_wide)
# and calculate the percent observed:

counts_wide <- total_counts_wide %>%   
  # Combined the trip count and the observed trip count summaries
  left_join(obs_counts_wide, by = c("FMP", "STRATA", "AGENCY_GEAR_CODE")) %>% 
  # Calculate the percent observed:
  mutate(TRIP_COUNT_OBS_LT40 = as.numeric(NA),
         LT40_pct    = as.numeric(NA),
         BT40_57_pct = round((TRIP_COUNT_OBS_BT40_57/TRIP_COUNT_BT40_57)*100,1),
         GT58_pct    = round((TRIP_COUNT_OBS_GT58/TRIP_COUNT_GT58)*100,1)) %>% 
  # Reorder the columns:
  select(FMP, STRATA, AGENCY_GEAR_CODE, VESSEL_COUNT_LT40, TRIP_COUNT_LT40, TRIP_COUNT_OBS_LT40, LT40_pct,
         VESSEL_COUNT_BT40_57, TRIP_COUNT_BT40_57, TRIP_COUNT_OBS_BT40_57, BT40_57_pct,
         VESSEL_COUNT_GT58, TRIP_COUNT_GT58, TRIP_COUNT_OBS_GT58, GT58_pct) %>% 
  # Assign a particular sorting order to the strata:
  mutate(STRATA_ORDER = ifelse(STRATA == 'FULL', 1,
                           ifelse(STRATA=='EM_TRW_EFP_FULL', 2,
                              ifelse(STRATA== 'EM_HAL', 3,
                                ifelse(STRATA=='EM_POT', 4,
                                   ifelse(STRATA=='EM_TRW_EFP_PART', 5,
                                      ifelse(STRATA == 'HAL', 6,
                                         ifelse(STRATA == 'POT', 7,
                                            ifelse(STRATA=='TRW', 8,
                                               ifelse(STRATA=='ZERO', 9,
                                                      ifelse(STRATA=='ZERO_EM_RESEARCH', 10,
                                                         ifelse(STRATA=='FMP AREA Subtotal', 11, 12)))))))))))) %>% 
  # Sort the data:
  arrange(FMP, STRATA_ORDER, AGENCY_GEAR_CODE) %>% 
  data.frame()


```

Table 3-2. Number of vessels (V), total trips (N), monitored trips (n), and percent of trips monitored (%) in `r as.numeric(format(Sys.Date(), "%Y"))-1`  in the BSAI by strata, gear type (hook-and-line (HAL), non-pelagic trawl (NPT), pelagic trawl (PTR), pot, and jig), and vessel length category (based on length overall, in feet) for the full and partial coverage categories.     


```{r flextable_TABLE4_1, message=FALSE, warning=FALSE, echo=FALSE}

# Clean up the strata descriptions:
bsai <- counts_wide %>% 
  filter(FMP == 'BSAI') %>% 
  select(1:15) %>% 
  mutate(STRATA = ifelse(STRATA == 'FULL', "Full", STRATA)) %>% 
  mutate(STRATA = ifelse(STRATA == 'EM_HAL', "EM HAL", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_POT', "EM POT", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_TRW_EFP_FULL', "EM TRW EFP (Full)", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO', "Zero", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO_EM_RESEARCH', "Zero EM Research", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'FMP AREA Subtotal', "BSAI Subtotal", STRATA)) 
  

# Create a table for the Fee Summaries in All Areas:
flextable(bsai) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(FMP = "Area", 
                    STRATA = "Strata",
                    AGENCY_GEAR_CODE = "Gear",
                    VESSEL_COUNT_LT40 = "V",
                    TRIP_COUNT_LT40 = "N",
                    TRIP_COUNT_OBS_LT40 = "n",
                    LT40_pct = "%",
                    VESSEL_COUNT_BT40_57 = "V",
                    TRIP_COUNT_BT40_57 = "N",
                    TRIP_COUNT_OBS_BT40_57 = "n",
                    BT40_57_pct = "%",
                    VESSEL_COUNT_GT58 = "V",
                    TRIP_COUNT_GT58 = "N",
                    TRIP_COUNT_OBS_GT58 = "n",
                    GT58_pct = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "", "<40'", "40-57.4'", ">=57.5'"),
                 colwidths = c(1,1,1,4,4,4)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(4:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Add top header row:
  add_header_row(values = c("", "", "", "Vessel length category"),
                 colwidths = c(1,1,1,12)) %>% 
  align(align = "center", part = "header") %>% 
  # Add top table border above header:
  hline_top(j = c(1:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 3, j = c(1:3), align = "left", part = "header") %>% 
  align(i = 3, j = c(4:15), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_num(j = c(4,5,6,8,9,10,12,13,14), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(7,11,15), big.mark = ",", digits = 1) %>% 
  # Merge the area labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'FMP AREA Subtotal' label across 2 cells (strata and gear):
  merge_at(i=18, j=c(2:3)) %>% 
  # Add dashed horizontal lines before area subtotals:
  border(i = 17, part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  add_footer_lines(values = c("1 Monitored reflect either trips with an observer, EM fixed gear trips for which some video was reviewed, or EM trawl trips where observers sampled shoreside.",
                              "2 Full coverage in this table includes vessels in both the Regulatory and Voluntary Full Coverage strata described in Chapter 3."))



```




Table 3-3. Number of vessels (V), total trips (N), monitored trips (n), and percent of trips monitored (%) in `r as.numeric(format(Sys.Date(), "%Y"))-1`  in the GOA and overall by strata, gear type (hook-and-line (HAL), non-pelagic trawl (NPT), pelagic trawl (PTR), pot, and jig), and vessel length category (based on length overall, in feet) for the full and partial coverage categories. 


```{r flextable_TABLE4_2, message=FALSE, warning=FALSE, echo=FALSE}

# Clean up the strata descriptions:
goa <- counts_wide %>% 
  filter(FMP %in% c('GOA', 'Total Unique')) %>% 
  select(1:15) %>% 
  mutate(STRATA = ifelse(STRATA == 'FULL', "Full", STRATA)) %>% 
  mutate(STRATA = ifelse(STRATA == 'EM_HAL', "EM HAL", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_POT', "EM POT", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'EM_TRW_EFP_PART', "EM TRW EFP (Partial)", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO', "Zero", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'ZERO_EM_RESEARCH', "Zero EM Research", STRATA)) %>%
  mutate(STRATA = ifelse(STRATA == 'FMP AREA Subtotal', "GOA Subtotal", STRATA)) 
  

# Create a table for the Fee Summaries in All Areas:
flextable(goa) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(FMP = "Area", 
                    STRATA = "Strata",
                    AGENCY_GEAR_CODE = "Gear",
                    VESSEL_COUNT_LT40 = "V",
                    TRIP_COUNT_LT40 = "N",
                    TRIP_COUNT_OBS_LT40 = "n",
                    LT40_pct = "%",
                    VESSEL_COUNT_BT40_57 = "V",
                    TRIP_COUNT_BT40_57 = "N",
                    TRIP_COUNT_OBS_BT40_57 = "n",
                    BT40_57_pct = "%",
                    VESSEL_COUNT_GT58 = "V",
                    TRIP_COUNT_GT58 = "N",
                    TRIP_COUNT_OBS_GT58 = "n",
                    GT58_pct = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "", "<40'", "40-57.4'", ">=57.5'"),
                 colwidths = c(1,1,1,4,4,4)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(4:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Add top header row:
  add_header_row(values = c("", "", "", "Vessel length category"),
                 colwidths = c(1,1,1,12)) %>% 
  align(align = "center", part = "header") %>% 
  # Add top table border above header:
  hline_top(j = c(1:15), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 3, j = c(1:3), align = "left", part = "header") %>% 
  align(i = 3, j = c(4:15), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_num(j = c(4,5,6,8,9,10,12,13,14), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(7,11,15), big.mark = ",", digits = 1) %>% 
  # Merge the area labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'FMP AREA Subtotal' label across 2 cells (strata and gear):
  merge_at(i=19, j=c(2:3)) %>% 
  # Merge 'Total Unique' label across 2 cells (area and strata):
  merge_at(i=20, j=c(1:2)) %>% 
  # Add dashed horizontal line before area subtotals:
  border(i = 18, part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  # Add solid horizontal line before unique totals:
  border(i = 19, part = "body", border.bottom = fp_border(style = "solid")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  # Add footer:
  add_footer_lines(values = c("1 Monitored reflect either trips with an observer, EM fixed gear trips for which some video was reviewed, or EM trawl trips where observers sampled shoreside.",
                              "2 Full coverage in this table includes vessels in both the Regulatory and Voluntary Full Coverage strata described in Chapter 3."))




```





```{r summarize.catch, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Summarize catch by two different aggregations:
catch_detail <- addl_catch_table %>%
  # Define sector using the RPP flag or the processing sector:
  mutate(SECTOR = ifelse(RPP=="RPP", "RPP", PROCESSING_SECTOR)) %>% 
  # Summarize by FMP area, sector, gear, and retained flag:
  group_by(FMP, SECTOR, OBS_FOR_EST, AGENCY_GEAR_CODE, RETAINED) %>% 
  summarise(WEIGHT = sum(as.numeric(TONS))) %>%
  # Summarize by FMP area, gear, and retained flag:
  bind_rows(addl_catch_table %>% group_by(FMP, OBS_FOR_EST, AGENCY_GEAR_CODE, RETAINED) %>% 
             summarize(SECTOR = 'Total',
                       WEIGHT = sum(as.numeric(TONS)))) %>% 
  data.frame()


# Convert the catch summaries to a wide format:
catch_detail_wide <- catch_detail %>% 
  pivot_wider(id_cols = c(FMP, SECTOR, AGENCY_GEAR_CODE, RETAINED),
              names_from = OBS_FOR_EST,
              values_from = WEIGHT) %>% 
  # Calculate the percent observed
  mutate(PCT_OBS = round((Observed/Total),2)*100) %>% 
  # Replace nas with 0:
  replace_na(list('Observed'= 0, 'PCT_OBS' = 0)) %>% 
  # String out EVEN WIDER:
  pivot_wider(id_cols = c(FMP, AGENCY_GEAR_CODE, RETAINED),
              names_from = SECTOR,
              values_from = c("Observed","Total","PCT_OBS")) %>% 
   # Translate the gear and Retained/Discard values:
  mutate(AGENCY_GEAR_CODE = recode(AGENCY_GEAR_CODE,
                                   'HAL'='Hook and Line',
                                   'JIG'='Jig',
                                   'NPT'='Non-Pelagic Trawl',
                                   'POT'='Pot',
                                   'PTR'='Pelagic Trawl')) %>% 
  mutate(RETAINED = recode(RETAINED, 'R'='Retained', 'D'='Discard'))


```



```{r add_jig, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

#Add new rows because JIG doesn't have a discard row and assign the same column names used in catch_wide
jig_rows <- data.frame(cbind(c("GOA", "BSAI"), c("Jig", "Jig"), c("Discard", "Discard")))  
col_names <- names(catch_detail_wide[,1:3])
names(jig_rows) <- col_names 

# The columns in jig_rows need to be character values rather than factors for later formatting:
jig_rows <- jig_rows %>% 
  mutate_all(as.character)


# Add a filler row for retained jig data in the BSAI (if needed) to the catch_detail_wide data frame: 
bsai_jig_retained <- data.frame(cbind(c("BSAI"), c("Jig"), c("Retained")))                         
names(bsai_jig_retained) <- col_names 
                        
catch_detail_wide <- catch_detail_wide %>% 
  merge(bsai_jig_retained, all = TRUE)
                        

# Append the additional columns:
library(plyr); library(dplyr)
catch_wide <- rbind.fill(catch_detail_wide, jig_rows)

# Provide a gear order:
catch_wide <- catch_wide %>% 
  mutate(GEARORDER = ifelse(AGENCY_GEAR_CODE == 'Hook and Line', 1,
                            ifelse(AGENCY_GEAR_CODE == 'Jig', 2,
                                   ifelse(AGENCY_GEAR_CODE == 'Non-Pelagic Trawl', 3,
                                          ifelse(AGENCY_GEAR_CODE == 'Pot', 4, 5)))))  %>% 
  arrange(FMP, GEARORDER, desc(RETAINED))

#detach(package:plyr)

```


**INSERT PAGE BREAK** 

Table 3-4. Monitored catch^1^ (metric tons), total catch, and percent monitored (%) of groundfish and halibut retained and discarded in the groundfish and halibut fisheries in `r as.numeric(format(Sys.Date(), "%Y"))-1` in the *Gulf of Alaska*. Empty cells indicate that no catch occurred.


```{r Table3_4_flextable, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

# Refine to just the GOA data and rearrange the column order:
table3_4 <- catch_wide %>% 
  filter(FMP=='GOA') %>% 
  select(c(2:3,
           4,9,14, #Catcher/Processors
           6,11,16, #Catcher Vessels (PROCESSING_SECTOR=='S')
           7,12,17, #Catcher Vessels: Rockfish Program (GOA only)
           #5,10,15, #Mothership (BSAI only)
           8,13,18  # Gear Totals
           )) 


# Create a table for the Fee Summaries in All Areas:
flextable(table3_4) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(AGENCY_GEAR_CODE = "Gear",
                    RETAINED = "Catch",
                    Observed_CP = "Monitored",
                    Total_CP = "Total",
                    PCT_OBS_CP = "%",
                    Observed_S = "Monitored",
                    Total_S = "Total",
                    PCT_OBS_S = "%",
                    Observed_RPP = "Monitored",
                    Total_RPP = "Total",
                    PCT_OBS_RPP = "%",
                    Observed_Total = "Monitored",
                    Total_Total = "Total",
                    PCT_OBS_Total = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "Catcher/Processor", "Catcher vessel", "Catcher vessel: Rockfish program", "Gear total"),
                 colwidths = c(1,1,3,3,3,3)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(3:14), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 2, j = c(1:2), align = "left", part = "header") %>% 
  align(i = 2, j = c(3:14), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_double(j = c(3,4,6,7,9,10,12,13), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(5,8,11,14), big.mark = ",", digits = 0, suffix = "%" ) %>% 
  bold(j=c(1,2,5,8,11,14), part = "body") %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Add solid horizontal line after each gear:
  border(i = c(2,4,6,8), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  ## Add footer:
  add_footer_lines(values = c("1 Monitored reflect either trips with an observer, EM fixed gear trips for which some video was reviewed, or EM trawl trips where observers sampled shoreside. EM trawl trips also require 100% at-sea video monitoring for compliance with maximized retention requirements, but that monitoring is not reflected in this table."))



``` 


**INSERT PAGE BREAK** 

Table 3-5. Monitored catch^1^ (metric tons), total catch, and percent monitored (%) of groundfish and halibut retained and discarded in the groundfish and halibut fisheries in `r as.numeric(format(Sys.Date(), "%Y"))-1` in the *Bering Sea/Aleutian Islands*.  Empty cells indicate that no catch occurred.


```{r Table3_5_flextable, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

# Refine to just the GOA data and rearrange the column order:
table3_5 <- catch_wide %>% 
  filter(FMP=='BSAI') %>% 
  select(c(2:3,
           4,9,14, #Catcher/Processors
           5,10,15, #Mothership (BSAI only)
           6,11,16, #Catcher Vessels (PROCESSING_SECTOR=='S')
           #7,12,17, #Catcher Vessels: Rockfish Program (GOA only)
           8,13,18  # Gear Totals
           )) 


# Create a table for the Fee Summaries in All Areas:
flextable(table3_5) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(AGENCY_GEAR_CODE = "Gear",
                    RETAINED = "Catch",
                    Observed_CP = "Monitored",
                    Total_CP = "Total",
                    PCT_OBS_CP = "%",
                    Observed_M = "Monitored",
                    Total_M = "Total",
                    PCT_OBS_M = "%",
                    Observed_S = "Monitored",
                    Total_S = "Total",
                    PCT_OBS_S = "%",
                    Observed_Total = "Monitored",
                    Total_Total = "Total",
                    PCT_OBS_Total = "%")  %>% 
  # Add lower header row:
  add_header_row(values = c("", "", "Catcher/Processor", "Mothership", "Catcher vessel", "Gear total"),
                 colwidths = c(1,1,3,3,3,3)) %>% 
  align(align = "center", part = "header") %>% 
  # Add border between length categories and header row:
  hline_top(j = c(3:14), border = fp_border(color="black", width = 2), part = "header") %>% 
  # Format the header rows:
  bold(bold = TRUE, part = "header") %>% 
  align(i = 2, j = c(1:2), align = "left", part = "header") %>% 
  align(i = 2, j = c(3:14), align = "right", part = "header") %>% 
  # Format the columns:
  colformat_double(j = c(3,4,6,7,9,10,12,13), big.mark = ",", digits = 0) %>% 
  colformat_num(j = c(5,8,11,14), big.mark = ",", digits = 0, suffix = "%" ) %>% 
  bold(j=c(1,2,5,8,11,14), part = "body") %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Add solid horizontal line after each gear:
  border(i = c(2,4,6,8), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  # Add "fix" needed because of cell merges:
  fix_border_issues(part = "body") %>% 
  add_footer_lines(values = c("1 Monitored reflect either trips with an observer, EM fixed gear trips for which some video was reviewed, or EM trawl trips where observers sampled shoreside."))

```


```{r workspace, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

# Clean up workspace (removes everything EXCEPT the objects listed) and save RData
rm(list= ls()[!(ls() %in% c('YEAR','work_data', 'addl_catch_table', 'counts_wide', 'bsai', 'goa', 'catch_wide', 'table3_4', 'table3_5'))])


#save('YEAR', 'work_data', 'addl_catch_table', 'counts_wide', 'bsai', 'goa', 'catch_wide', 'table3_4', 'table3_5',
#     file = paste0("AR_descriptive_", YEAR, "_tables.RData"))

```



