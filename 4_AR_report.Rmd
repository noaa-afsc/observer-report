---
title: "DEPLOYMENT PERFORMANCE REVIEW OF THE 2023 NORTH PACIFIC OBSERVER PROGRAM"
always_allow_html: true
output:
  word_document:
    reference_docx: docs/word-styles-reference-01.docx
    pandoc_args:
      '--lua-filter=pagebreaks.lua'
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# Once report has been run and 4_AR_report.Rdata has been created,
# skip running the code below and load all packages and objects here:
# load("4_AR_report.Rdata")
# source("3_helper.R")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load packages and functions 
source("3_helper.R")
```

```{r, include=FALSE, eval=FALSE}
#' Download data. Run this line manually during development, but it won't run during knitting.
gdrive_download("2_AR_data.Rdata", gdrive_set_dribble("Projects/AnnRpt-Deployment-Chapter"))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#' Load data and set parameters
load("2_AR_data.RData") # This includes the .Random.seed set in 1_AR_data.R

# Avoid showing code
knitr::opts_chunk$set(echo = FALSE)

# Avoid scientific notation
options(scipen = 10000)

# Avoid dplyr summarise warnings
options(dplyr.summarise.inform = FALSE)

# Set table output default settings
set_flextable_defaults(font.family = "Times New Roman", font.size = 11)

# Set order of strata
strata.order <- c("Full", "OB FIXED BSAI", "OB FIXED GOA", "OB TRW BSAI", "OB TRW GOA", "EM FIXED BSAI", "EM FIXED GOA", "EM TRW GOA (EFP)", "Zero coverage", "Total")

# Is this the annual report or the tech memo?
# This will control whether certain text chunks are included and formatting of table/figure captions.
annual.report <- TRUE
tech.memo     <- FALSE

if(annual.report){
  fig_nums <- captioner(prefix = "Figure 3-", auto_space = FALSE)  # In Annual report, deployment analyses make up Chapter 3. 
  tbl_nums <- captioner(prefix = "Table 3-", auto_space = FALSE)
}
```

```{r set-options, message=FALSE, warning=FALSE}
#Total deployment strata:
# 2 full coverage (FULL, EM TRW EFP[BSAI])
# 4 partial coverage observed (OB FIXED BSAI and GOA, OB TRW BSAI and GOA)
# 3 partial coverage EM (EM FIXED BSAI and GOA, EM TRW EFP[GOA]) + 
# 0 zero coverage EM research (Zero EM Research) +
# 1 zero coverage (ZERO)
total.strat <- nrow(unique(work.data[, .(COVERAGE_TYPE, STRATA)]))
```

`r if(tech.memo){'#Abstract'}`  
`r if(tech.memo){'This report contains the analyses and findings of the Alaska Fisheries Science Center’s Fisheries Monitoring and Analysis Division’s Fishery Monitoring Science Committee (FMSC) on the efficiency and effectiveness of observer deployment following the 2023 Annual Deployment Plan (ADP). Responses to comments by the North Pacific Fishery Management Council (Council) from the 2022 version of this report, and recommendations to improve data quality and guide the 2024 Annual Deployment Plan are also included. In 2023, there were 10 strata to evaluate: two full coverage strata, five (*THREE IF TENDER DROPPED*) partial coverage observer strata defined by gear and tender designation (*ARE WE COVERING TENDERS STILL?*), three partial coverage Electronic Monitoring (EM) strata defined by gear designation, one zero coverage EM research stratum, and one zero coverage stratum. Observers were deployed under trip-selection on *UPDATE:*161 full coverage vessels that fished for *UPDATE:*3,343 trips and *UPDATE:*584 unique partial coverage vessel and stratum combinations (vessels can fish in more than one stratum) that fished *UPDATE:*5,016 trips total. This was the *UPDATE:*second year in which data from the *EM HAL* stratum was used in catch accounting, and the *UPDATE:*first year in which data from the *EM POT* stratum was used in catch accounting. *UPDATE:*The *EM HAL* stratum was the third largest stratum by trip count in 2019 with 916 total trips fished. EM systems were deployed onto 21 pot vessels that fished for 165 trips. *UPDATE:*Research EM systems were deployed onto four vessels that fished for 29 trips. *UPDATE:*A total of 393 vessels fished 2,005 trips in the *Zero Coverage* stratum, accounting for 28% of all trips that occurred within the partial coverage category. Realized coverage rates met expectations in *UPDATE:*eight of ten strata in 2023. The *Full* stratum was observed at a rate of 99.9%, falling below the expected rate of 100%. *UPDATE:*The partial coverage *POT – Tender* stratum was observed at a rate of 29.5%, with a 95% confidence interval that fell above the expected coverage rate of 16.1%. *UPDATE:*However, deployment in 2019 generally proceeded as planned, with few missed expectations or signs of potential bias. The FMSC recommends that future ADPs fully integrate EM and observer deployment into one fishery monitoring program. Although EM data are now being used in catch accounting, the funding and selection of EM vessels has so far occurred separately from the processes used to optimize observer deployment in each ADP. Considering EM as a more integral part of those optimization processes will better enable analysts to avoid data gaps and take advantage of the respective abilities of each monitoring method (observers and EM). The FMSC also continues to recommend that NMFS link the ODDS and eLandings database such that fishing trips can be uniquely identified to support the analyses presented to the Council. Such a linkage will better enable analysts to discern the contributing factors behind instances in which intended deployment is inconsistent with realized deployment.'}`  

# Introduction  
`r if(tech.memo){'##Background of the North Pacific Groundfish and Halibut Observer Program'}`  
`r if(tech.memo){'Fisheries observers and electronic monitoring (EM) systems collect independent information that is used to determine the effects of fishing on natural resources. The National Marine Fisheries Service (NMFS) uses its observer program in Alaska to enable the use of tools such as catch quotas to manage against the over- or under-harvest of fishes. Observers and EM are two verifiable methods for collecting fishery discard information used to estimate total catch. Observers (but not the EM systems currently used in the North Pacific) are able to record seabird and marine mammal interactions with fisheries as well. Observers also collect biological information such as length, sex, weight, ageing structures (e.g., otoliths, spines, scales, and vertebrae), and stomachs to support ecosystem studies and stock assessments.'}`

`r if(tech.memo){'The observer program in the North Pacific has a long history. Observers were first deployed onto fishing vessels in the Bering Sea in 1973 and into the remainder of the North Pacific in 1975 (Nelson et al. 1981, Wall et al. 1981). Fisheries in the North Pacific were initially prosecuted exclusively by foreign and later by "joint venture"'}` `r if(tech.memo){"operations where a developing domestic fleet of catcher vessels delivered to foreign-owned processing vessels. During the foreign and joint venture operations, foreign vessels carried fisheries observers at their expense, while domestic vessels were exempted from this observer coverage. As foreign vessels' rights to fish in the U.S. Exclusive Economic Zone (EEZ) were reduced over time and the domestic fishery grew, it became obvious to managers that observer coverage would be necessary for the emerging domestic fleet. At the onset of fully domestic fishery operations in 1990, the North Pacific Groundfish Observer Program was established as an interim observer program with rules governing observer coverage codified in regulations. This interim program would be extended four times over the next 20 years by the North Pacific Fishery Management Council (Council) — the last without a sunset date."}`

`r if(tech.memo){'The regulations established in 1990 required vessels 60-125 feet in length (overall) and all vessels fishing pot gear to carry observers at their own cost for 30% of their fishing days in a calendar quarter plus at least one trip in each fishery they participate in (termed the "30% fleet"), and vessels greater than 125 feet in length to carry an observer for 100% of their fishing days at their expense. Some vessels were not required to carry observers. These included vessels less than 60 feet, vessels fishing jig gear or vessels fishing with trawl gear that deliver unsorted codends to processing vessels (termed "catcher processors" or CPs if the vessel also has catching ability and "mothership" or M if the vessel does not) and vessels that fished for Pacific halibut (*Hippoglossus stenolepis*). For shoreside processors, the rules governing observer coverage were based on the estimated tonnage processed in a calendar month: plants that processed less than 500 metric tons (t) a month were exempted from coverage, those that processed between 500 t and 1,000 t a month were required to be observed for 30% of the calendar days fish, and those that processed more than 1,000 t a month were required to be observed for each day in the month.'}`

`r if(tech.memo){'Soon after the establishment of the domestic observer program, concerns over the ability and incentive for fishers to manipulate observer coverage in a way that might bias catch estimates and other analytic products prompted efforts by NMFS and the Council to provide a mechanism for NMFS to gain control over where and when observers were deployed (Faunce and Barbeaux 2011). From 1992 to 2008, several attempts to “restructure” the program were made. In 2010, the Council unanimously decided to move forward with the restructured observer program. In 2012, the Final Rule 77 FR 70062 was published to implement Amendment 86 to the Fishery Management Plan for Groundfish of the Bering Sea and Aleutian Islands (BSAI) Management Area and Amendment 76 to the Fishery Management Plan for Groundfish of the Gulf of Alaska (GOA). Amendments 86/76 added a funding and deployment system for observer coverage to the existing North Pacific Groundfish Observer Program and amended existing observer coverage requirements for vessels and processing plants. The “restructured” North Pacific Groundfish and Halibut Observer Program (hereafter termed “Observer Program”) began in 2013 with the randomization of deployments among trips and vessels. In 2018, the use of EM was added as an additional catch monitoring tool, with the understanding that some data elements collected by observers would not be collected using EM systems.'}`

`r if(tech.memo){'#The Annual Deployment Plan and Review'}`
`r if(tech.memo){"Analysis and evaluation of the data collected by observers is an ongoing process. The NMFS considers Council input in making decisions as to the amount of coverage (i.e., selection probabilities that are assigned to each partial-coverage category). These decisions are based on available funding, the cost of observer coverage, and anticipated effort. The restructure of the Observer Program established new annual reporting processes. Each June, the NMFS provides the Council with a comprehensive evaluation of past year's observer deployments, costs, sampling levels, and implementation issues as well as recommended changes for the coming year. The June deployment performance review aims to identify areas where improvements are needed to 1) collect the data necessary to manage the groundfish and halibut fisheries; 2) maintain the scientific goals of unbiased data collection; and 3) accomplish the most effective and efficient use of the funds collected through the observer fee. The annual deployment performance review is an opportunity to inform the Council and the public of how well various aspects of the program are working, and consequently lead to recommendations for improvement as appropriate. The NMFS also prepares the Observer Program Annual Deployment Plan (ADP) each fall. The ADP defines deployment strata and establishes selection rates given available budgets and anticipated fishing effort. A draft ADP is released by September of each year to allow review by the Council's Groundfish Plan Teams, as well as the Council and its Scientific and Statistical Committee (SSC). Based on input from its advisory bodies and the public, the Council may choose to clarify objectives and provide recommendations to NMFS for the ADP. Upon analysis of the Council recommendations, NMFS will make any necessary adjustments to finalize the ADP and release it to the public. The ADP is released to the public prior to the December Council meeting."}`    

`r if(tech.memo){'##Fishery Monitoring Science Committee'}`
`r if(tech.memo){'Each year the Alaska Fisheries Science Center’s (AFSC) Fisheries Monitoring and Analysis (FMA) Division establishes a committee to review the scientific elements of the North Pacific Observer Program. This committee, formerly referred to as the Observer Science Committee (OSC), was renamed in 2020 as the Fishery Monitoring Science Committee (FMSC), in order to reflect the addition of EM as a tool being used to monitor fisheries in the North Pacific. Similarly, we use the term ‘monitoring’ in this chapter when referencing fishing activity that has been monitored either by an observer or with EM.'}`  

The goal of the Observer Program is to achieve a random deployment of observers and electronic monitoring (EM) into fisheries to collect representative data used to estimate catch and bycatch, assess stock status, collect fishery-dependent biological information used in population and ecosystem modeling efforts and make salmon bycatch stock-of-origin determinations, among other objectives. This chapter contains a review of the deployment of observers and EM in 2023 relative to the intended sampling plan and goals of the 2023 Annual Deployment Plan (ADP; NMFS 2022). Consistent with its purpose, this chapter focuses on the randomization of observer and EM deployments into primary sampling units and how departures from a random sample affect data quality. This review identifies where possible biases exist and provides recommendations for further evaluation, including potential improvements to the observer deployment process that should be considered during the development of the `r year + 2` ADP.\
\
This review is performed by staff from the Fisheries Monitoring and Analysis / Analytical Services Program (FMA) of the Alaska Fisheries Science Center (AFSC) and the Sustainable Fisheries Division / Catch Analysis and Data Quality Branch of the Alaska Regional Office (AKRO). Catch and monitoring data from the `r year` calendar year as of 15 April 2024 were used in analyses.\
\
The analyses in this chapter benefited from review and recommendations from the Fisheries Monitoring Science Committee (FMSC). The FMSC is established annually to provide scientific advice in the areas of regulatory management, natural science, mathematics and statistics as they relate to observer deployment and sampling in the groundfish and halibut fisheries of the Bering Sea and Aleutian Islands (BSAI) and the Gulf of Alaska (GOA). The FMSC members have analytical and scientific expertise relating to observer sampling of groundfish and halibut fisheries of the BSAI and GOA and use of the collected data. If possible, the FMSC is represented by at least one member of the FMA, one member of the AFSC / Stock Assessment and Multispecies Assessments Program, one member of the AKRO and one member of the International Pacific Halibut Commission (IPHC).\

## The Sampling Design of the Observer Program 
Since 2013, the Observer Program has used a stratified hierarchical sampling design with randomization at all levels (Cahalan and Faunce, 2020). Stratification increases the efficiency of sampling by observers and helps address some logistical issues associated with deployment. By grouping similar fishing activities into strata and sampling those strata appropriately, sampling efficiency increases and the estimated variance decreases relative to unstratified sampling. Sampling strata are defined in the ADP and are designed such that each unit of deployment (e.g., trip) is assigned to only one stratum.\
\
Randomization helps ensure that the data collected from a sample will be representative of the entire fishing fleet (observed and monitored trips are equivalent to unobserved and unmonitored trips within a stratum). Within a stratum, observers are deployed randomly to either: (1) vessels for a predetermined period of time (termed vessel-selection) or (2) to individual fishing trips (termed trip-selection). In both cases, this initial deployment to the fishery is the first level of the sampling hierarchy and defines the primary sampling unit (PSU; either vessel-periods or individual trips). The list of all PSUs in a stratum defines the sampling frame and should equate to the population of interest for that sampling stratum (e.g., all trips taken by trawl vessels fishing in the Alaska Exclusive Economic Zone). If the sampling frame does not contain all elements of the stratum, the resulting information may be biased. The magnitude and direction of the bias will depend on how different the fishing activities in the sample frame are from actual fishing activity.\
\
Although this chapter evaluates whether monitoring goals were met, we include a brief summary of the full sampling hierarchy here for context. For each observed trip, if all hauls cannot be sampled for logistical reasons, hauls are randomly selected to be sampled. This is the next level in the hierarchy; the secondary sampling units are defined as hauls within a trip. Randomization of haul selection is designed to allow observers to record and transmit data, attend to other non-sampling responsibilities and to allow observers time to sleep and eat. Randomization of haul selection also gives EM video reviewers the ability to optimize the amount of video that can be reviewed from each trip. Haul selection is determined using the random sampling tables and random break tables provided by NMFS. For each haul, fishing location and effort (e.g., number of hooks) are recorded, while marine mammal and seabird interactions are primarily recorded on randomly selected hauls. The ability of EM to capture marine mammal and seabird interactions is less than that of observers due to the fixed location in which EM equipment is placed.\
\
For the randomly selected hauls, a random sample of the catch is collected (observers) or selected for video review (EM) and data from those samples are used to determine the species composition and amount of discarded catch. These samples of catch within each haul are the third level of the sampling hierarchy. While observers are trained to collect multiple large samples of catch, the number and size of samples taken from each haul will depend on the vessel configuration, fishing operations and diversity of catch. The size of EM samples is largely determined by the number of video reviewers available relative to the amount of video to be reviewed.\
\
At the fourth level of the sampling hierarchy, a predetermined number of individual fish of predetermined species are randomly selected from the species composition sample and measured. Lastly, at the fifth sampling level, a random selection of fish is used to collect otoliths, reproductive maturity assessments, stomach contents, genetic tissues and other biological specimens. The number and species of fish selected for measurement and biological specimen collection is specified each year by the AFSC’s stock assessment scientists. Sampling rates for genetic tissue collection by observers (e.g., 1 of 10 Chinook salmon [*Oncorhynchus tshawytscha*] caught as bycatch) are set each year by the AFSC’s Auke Bay Laboratory. Sampling at the fourth and fifth levels of the sampling hierarchy does not occur with EM.

`r if(tech.memo){'#The'}` `r if(tech.memo){year}` `r if(tech.memo){'Annual Deployment Plan'}`    
`r if(tech.memo){'The following briefly summarizes the final'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP (NMFS '}` `r if(tech.memo){year - 1}``r if(tech.memo){'). In general, all vessels that participate in cooperatives or act as catcher-processors or motherships are fully observed at the trip-level and constitute the full-coverage category of the fleet. In 2016, NMFS published new regulations to allow the owner of a trawl catcher vessel to annually request that NMFS place requesting vessels in the full coverage category for all directed fishing for groundfish using trawl gear in the Bering Sea and Aleutian Islands management area (BSAI) in the following calendar year. This regulated process has replaced an interim policy. For the '}` `r if(tech.memo){year}` `r if(tech.memo){'calendar year, NMFS received and approved requests and has placed'}` `r if(tech.memo){'32'}` `r if(tech.memo){'catcher vessels in the full coverage category for all directed fishing for groundfish using trawl gear in the BSAI management area (NMFS'}` `r if(tech.memo){year-1}``r if(tech.memo){'). The partial-coverage category includes vessels greater than or equal to 40 feet (ft) length overall (LOA) and not in the full coverage category. The following sampling strata comprised the partial coverage category in'}` `r if(tech.memo){year}` `r if(tech.memo){':'}`  

`r if(tech.memo){'1. Hook-and-line vessels (*OB HAL* stratum).'}`    
`r if(tech.memo){'2. Hook-and-line vessels with EM (*EM HAL* stratum).'}`
`r if(tech.memo){'3. Pot vessels (*OB POT* stratum).'}`
`r if(tech.memo){'4. Pot vessels with EM (*EM POT* stratum).'}`
`r if(tech.memo){'5. Trawl vessels (*OB TRW* stratum).'}`
`r if(tech.memo){'6. Trawl vessels participating in an exempted fishing permit (*EM TRW EFP* stratum).'}`

`r if(tech.memo){'The NMFS used only the trip-selection method (i.e., no vessel-selection) to assign observers and EM to vessels in the partial-coverage category for 2023.'}`

`r if(tech.memo){'In this report we attempt to evaluate the deployment of EM onto fixed gear vessels to the same degree as we evaluate the deployment of observers since catch accounting has used data collected through the *EM HAL* stratum since 2018 and the *EM POT* stratum since 2019. NMFS also sought vessels to participate in EM research and development activities. Vessels that volunteered for the fixed gear EM Program or EM research activities and were selected by the NMFS were not required to carry observers but were required to continue to log their fishing trips into the Observer Declare and Deploy System (ODDS).'}`

`r if(tech.memo){'The *EM TRW EFP* stratum is represented by vessels participating in an Exempted Fishing Permit (EFP) to evaluate the efficacy of EM on pollock catcher vessels using pelagic trawl gear in the Bering Sea and Gulf of Alaska. The EFP allows pollock catcher vessels using pelagic trawl gear to use EM systems *in lieu* of at-sea observers.  While we report some findings on these vessel activities here, we do not evaluate them fully sine the EFP is not part of the regulated fishery monitoring program.'}`

## The 2023 Annual Deployment Plan
The deployment design for the partial coverage component of the program involves three elements: (1) the selection method to accomplish random sampling; (2) division of the population of partial coverage trips into selection pools or strata; and (3) the allocation of deployment among strata.\
\
In `r year`, observers and EM were to be deployed using the trip selection model in all ports throughout Alaska. Trip-selection refers to the method of selecting fishing trips as the sampling unit. Trip selection was to be facilitated through vessel operators and owners logging their trips into the Observer Deploy and Declare System (ODDS) and being notified if the trip is selected for coverage.
In 2023, NMFS implemented an observer deployment allocation strategy of an adjusted 15% baseline, plus optimization based on discarded groundfish, Pacific halibut (*Hippoglossus stenolepis*) prohibited species catch (PSC) and Chinook salmon PSC to determine how many trips were to be monitored in each deployment stratum.\
\
The deployment strata for `r year` (with abbreviation and coverage rate rounded to whole number) were defined as:

- Hook-and-line vessels greater than or equal to 40 ft length overall (LOA) monitored with observers (*OB HAL* - 18%).\
- Pot vessels greater than or equal to 40 ft LOA monitored with observers (*OB POT* - 17%).\
- Trawl vessels making a trip not covered by another stratum (*OB TRW* - 23%).\
- Fixed-gear EM vessels (evaluated separately as *EM HAL* and *EM POT* - 30%). Initiated by the Council in 2018, trips in this stratum are randomly selected for monitoring through ODDS. Species identifications and counts derive from human review of location and video information captured from EM equipment. Weights for catch estimation are supplied from other sources.\
- Vessels when fishing under the Trawl EM Exempted Fishing Permit (EFP). An Exempted Fishing Permit was applied for in 2019 and awarded starting in 2020. In June 2021 the Council took action to implement this as a non-EFP program. This EFP applies to trawl vessels fishing with pelagic gear targeting walleye pollock (*Gadus chalcogrammus*, hereafter referred to as “pollock”) in the BSAI and GOA. Vessels participating in the EFP do not log trips into ODDS. The EFP aims to gain monitoring efficiency by removing at-sea observers and transferring the responsibilities associated with the at-sea collection of PSC data and biological samples to observers stationed at the shoreside plant. Cameras and location EM systems installed on the vessel monitor for compliance with EFP rules. Participating vessels must retain all catch while fishing under the EFP except for: marine mammals, jellyfish, small amounts of discard that occur while cleaning the deck, large individual marine organisms, including large individual rays or skates, sharks except for Pacific spiny dogfish (*Squalus suckleyi*) and discard of catch resulting from an unforeseen and reasonably unforeseeable event that is beyond the control of the vessel operator or crew . Shore-based observers monitor for halibut, salmon and to collect biological tissues to generate estimates of stock of origin. The 2023 ADP had a dockside selection rate for monitoring in the GOA set at 30%. However, since there was no pre-generated selection frame to identify random samples from ODDS, the FMA directed observers to sample one in three deliveries for logistical efficiency. Therefore, this stratum has a 33% monitoring expectancy for dockside in the GOA (*EM TRW EFP* - 100% dockside observation BSAI, 33% dockside observation GOA).\
- Fixed-gear vessels less than 40 ft LOA and vessels fishing with handline, jig, troll and dinglebar troll gear (*Zero coverage* - 0%).\

More information on the sampling design used by observers and the relationship between the sample design and catch estimation can be found in Cahalan and Faunce (2020) and the 2023 Observer Sampling Manual (AFSC 2022). Bycatch estimates of Chinook salmon in the GOA are estimated using methods described in Cahalan et al. (2014). In the event that a delivery cannot be monitored (e.g., the case in a tendered delivery or non-pollock delivery), then estimation of bycatch comes by applying salmon bycatch rates to landed catch. Estimates of stock of origin from salmon bycatch are produced by the AFSC’s Auke Bay Laboratory. 
Although this chapter is focused on the partial coverage component of the fleet, the majority of the catch taken from the Federal waters off Alaska are completely monitored at the level of the trip (*Full coverage* - 100%). Vessels and processors in the full observer coverage category must comply with observer coverage requirements at all times when fish are harvested or processed. Specific requirements are defined in regulation at *50 CFR § 679.51(a)(2)*. The full coverage category includes the following:

- Catcher / processors (with limited exceptions).\
- Motherships.\
- Catcher vessels participating in programs that have transferable PSC allocations as part of a catch share program.\
- Catcher vessels using trawl gear that have requested placement in the full coverage category for all fishing activity in the BSAI for one year.\
- Inshore processors receiving or processing Bering Sea pollock.\
- Catch share programs with transferable PSC allocations include Bering Sea pollock (both American Fisheries Act [AFA] and Community Development Quota [CDQ] programs), the groundfish CDQ fisheries (CDQ fisheries other than Pacific halibut and fixed-gear sablefish [*Anoplopoma fimbria*]; only vessels greater than 46 ft LOA) and the Central GOA Rockfish Program.

## Performance Review Objectives  
`r if(tech.memo){'The following sections contain the FMSC review of the deployment of observers in'}` `r if(tech.memo){year}` `r if(tech.memo){'relative to the intended sampling plan and goals of the'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP (NMFS'}` `r if(tech.memo){year-1}` `r if(tech.memo){'). This report identifies where potential mechanisms for biases exist and provides recommendations for further evaluation, including potential improvements to the observer deployment process that should be considered during the development of the'}` `r if(tech.memo){year + 2}` `r if(tech.memo){'ADP.'}`  
The following items from the `r year` ADP have been identified as objectives for evaluation in this report:

```{r actual_observerdays_paid, include=FALSE}

# Available budget for the year (in days)
OB_DAYS.BUDGET <- mean(bud_tbl$ADP_D)
  
#' Predicted cost for the year (in days)
OB_DOLLARS.BUDGET <- mean(bud_tbl$ADP_C)

# Actual number of observer days paid for
OB_DAYS.ACTUAL <- days_paid %>% 
  replace(is.na(.), 0) %>%
  summarise(Total.Days = sum(Base_Days + na.omit(Option_Days))) %>% 
  unlist() %>% 
  as.vector()

# Percent of budget predicted to be spent
eval <- data.frame(OB_DAYS.ACTUAL, OB_DAYS.BUDGET) %>% #' *CHANGED TO AVAILABLE FROM PREDICTED*
  mutate(
    # Percent of the budget used
    pct.budget.spent = round(OB_DAYS.ACTUAL/OB_DAYS.BUDGET, digits = 3) * 100, #' *CHANGED TO AVAILABLE FROM PREDICTED*
    # Percent of budget remaining
    pct.budget.remain = round(100 - pct.budget.spent, digits = 3),
    # Was it more, less, or equal to the predicted budget?
    more.or.less = ifelse(pct.budget.remain > 0, " lower than ",
                          ifelse(pct.budget.remain == 0, "equal to",
                                 " greater than ")))

# Get total costs
OB_DOLLARS.ACTUAL <- days_paid %>% 
  summarise(Total.Base.Dollars = sum(Base_Dollars, na.rm = TRUE),
            Total.Option.Dollars = sum(Option_Dollars, na.rm = TRUE),
            Total.Travel.Dollars = sum(Travel_Dollars, na.rm = TRUE),
            Total.Quarantine.Dollars = sum(Quarantine_Dollars, na.rm = TRUE),
            Total.Plant.Dollars = sum(Plant_Dollars, na.rm = TRUE)) %>% 
  mutate(Total.Dollars = Total.Base.Dollars + Total.Option.Dollars + Total.Travel.Dollars + Total.Quarantine.Dollars + Total.Plant.Dollars)

```

- **Deploy for the planned number of sea days.** This objective will be considered to be met if the actual number of sea days expended falls within the range of values from simulated sampling provided in the `r year` ADP.\
- **Deploy at the coverage rates specified in the `r year` ADP.** For full and zero coverage, either the rate was equal to 100% or 0%. For stratum under partial selection, coverage selection rates are expected to be within a 95% confidence interval computed from the realized coverage rates (under the assumption of a binomial distribution for observed trips).\
- **Collect tissue samples from Chinook and chum (*Oncorhynchus keta*) salmon as specified in the `r year` Observer Sampling Manual to support the goal of collecting genetic samples from salmon caught as bycatch in groundfish fisheries to identify stock of origin.** The sampling protocol established in the 2014 ADP (NMFS 2013, Faunce 2015) was used in `r year`. Under this protocol, observers on vessels delivering to shoreside processors in the GOA pollock trawl fishery monitor the delivery to enumerate salmon bycatch and obtain tissues for genetic analysis from the salmon bycatch. For trips that are delivered to tender vessels and trips outside of the pollock fishery, observers obtain salmon counts and tissue samples from all salmon found within at-sea samples of the total catch.\
- **Randomize deployment of observers into the partial coverage category of fishing activities.** Evaluation of this objective is focused on the randomization of observer and EM deployments into primary sampling units, and how departures from a random sample affect data quality.      
  
## Observer Deployment Performance Metrics  
Performance metrics have been developed to assess whether the trip-selection process (through the implementation of the `r year` ADP) provides a representative sample of fishing trips in the North Pacific in `r year`. These metrics reflect four mechanisms that can impact the quality of the data: (1) sample frame discrepancies, (2) non-response, (3) differences in trip characteristics, and (4) sample size.\
\
The performance metrics used in this evaluation are as follows:

1. [Deployment rates for each stratum:]{.underline} This is the basic level of evaluation for comparing targeted and achieved sampling rates, where sampling strata are partitions of the entire population about which we want to make inferences (e.g., generate estimates of catch). Specifically, this section assesses the following:\
    a. Sample rates and number of samples relative to intended values.\
    b. Quantification of under- and over-coverage rates (sample frame discrepancies). Over-coverage of a population occurs when the sample frame includes elements that are not part of the target population. When these elements are included in the random sample, effort (i.e., time, cost) is expended needlessly. Under-coverage results from having a sample frame that does not include a portion of the target population which can lead to biased sampling if that portion of the population differs from the population included in the sample frame.\
    c. Non-response rates. Non-response occurs when randomly selected elements (trips or vessels) are not actually sampled. If these trips or vessels have different fishing behavior (e.g., catch, areas fished) than the rest of the population, the data collected will not represent the entire fleet (non-response bias).\
2. [Representativeness of the sample:]{.underline} Randomized sampling is a method used to ensure that the results of sampling reflect the underlying population. Departures from randomization can lead to non-representative data and hence potential bias in estimates of the parameters of interest. A randomized sample design is expected to achieve a rate of monitored events that is similar across both space and time. Representativeness of the sample was divided into four separate components:\
    a. Temporal representativeness. Plots of expected and actual monitoring rates over time, highlighting periods when these two rates deviate from each other are indicative of periods with differential realized sample rates (and potential temporal bias).\
    b. Spatial representativeness. Maps provide a visual depiction of the spatial distribution of monitoring coverage relative to effort in each partial coverage stratum, highlighting areas where more or fewer trips were monitored than expected.\
    c. Spatiotemporal distribution of coverage. The proportions of sample units monitored or nearby in time and space to monitored trips (the proximity indices) are compared to distributions of simulated outcomes to determine whether the realized coverage was distributed evenly in both time and space and whether the achieved coverage met the expectations of the selection rates prescribed by the ADP.\
    d. Representativeness of trip characteristics. Consistency of trip characteristics for monitored and unmonitored portions of the stratum. These metrics are based, in part, on the availability of data for both monitored and unmonitored fishing activities; for example, data that are reported for all trips on landing reports.\

Although these metrics can identify places where observed results differ from expectations, it is ultimately a subjective decision as to whether or not these differences are substantial enough to have management implications. This holds true even for tests that have associated *p*-values. 

# Changes to this report from last year
Abbreviated versions of this chapter have been produced for calendar years 2021 and 2022. This chapter represents a return to the original “full” review format. Analysts have performed the full review of `r year - 1` and `r year` data but focus here on `r year`. However, where trends were notable, results from `r year - 1` have been included in an Appendix (A).\
\
Changes to our analyses for spatial and spatiotemporal representativeness were adopted following the evolution of these analyses in recent years are described in later sections.

# Evaluation of Deployment in `r year`  
The deployment of observers into the `r year` Federal fisheries of Alaska is primarily evaluated at the level of the deployment stratum because each stratum is defined by a different sampling rate or by a different monitoring method (e.g., observers and EM). In this document, trips in the *EM HAL* and *EM POT* strata are considered successfully monitored if at least some video was reviewed. The rationale for defining monitored trips this way is that it is most similar to the way in which trips in other strata are considered observed (i.e., irrespective of whether or not haul information or usable species composition data were collected).

## Evaluating Effort Predictions  
```{r outcomes.plot, include=FALSE}

# Plot effort predictions against actual
outcomes.plot <- ggplot(bud_tbl, aes(x = ADP_D)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 20, alpha = 0.2, fill = "blue", col = "cornflowerblue") +
  geom_vline(xintercept = OB_DAYS.BUDGET, lty = 2, col = "black") +
  geom_vline(xintercept = OB_DAYS.ACTUAL, lty = 1, col = "blue") +
  annotate("text", x = OB_DAYS.BUDGET - 35, y = 0.002,
            label = paste("Available day budget: ", round(OB_DAYS.BUDGET), sep = ""),
            col = "black", angle = 90) + 
  annotate("text", x = OB_DAYS.ACTUAL - 35, y = 0.002,
           label = paste("Actual days paid: ", OB_DAYS.ACTUAL, sep = ""),
           col = "blue", angle = 90) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.line = element_line(linewidth = 0.5, color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = seq(2000, 3500, 500)) +
  #labs(y = paste("Density of simulated outcomes (", year - 1, "ADP)\n", sep = ""),
   #    x = paste("\nTotal days used in ", year - 1, sep = ""))
  labs(y = paste("Density of simulated outcomes"),
       x = paste("\nTotal days used"))

```

```{r costs.plot, include=FALSE}

# Plot predictions of Costs versus actual costs
costs.plot <- ggplot(bud_tbl, aes(x = ADP_C)) +
  geom_histogram(aes(y = after_stat(density)), binwidth = 20000, alpha = 0.2, 
                 fill = "green", col = "darkseagreen2") +
  geom_vline(xintercept = OB_DOLLARS.BUDGET, lty = 2, col = "black") +
  geom_vline(xintercept = OB_DOLLARS.ACTUAL$Total.Dollars, lty = 1, col = "darkgreen") +
  annotate("text", x = OB_DOLLARS.BUDGET - 45000, y = 0.0000015, 
           label = paste("Available contract budget: $", prettyNum(OB_DOLLARS.BUDGET, big.mark = ","), sep = ""), 
           col = "black", angle = 90) +
  annotate("text", x = OB_DOLLARS.ACTUAL$Total.Dollars - 45000, y = 0.0000015, 
           label = paste("Actual contract cost: $", prettyNum(OB_DOLLARS.ACTUAL$Total.Dollars, big.mark = ","), sep = ""), 
           col = "darkgreen", angle = 90) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.line = element_line(linewidth = 0.5, color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(labels = dollar)
  #labs(y = paste("Density of simulated outcomes (", year - 1, " ADP", ")\n", sep = ""),
   #    x = paste("\nTotal contract costs in ", year - 1, sep = ""))
  labs(y = paste("Density of simulated outcomes"),
       x = paste("\nTotal contract costs"))

```

```{r budget_eval, include=FALSE}

#' *Table 3-1 : Comparison between predicted and actual trip days for partial coverage strata.*
#' [Note] we should consider removing `EM TRW EFP` from this table. We haven't quantified actual observer days for 
#' this stratum, and using a 33% of sea days as a proxy for 'plant days' is not a good prediction, nor is adding up
#' sea days of monitored trips a logical estimate of actuals.

# Evaluate why we were off budget
trip.budget.table <- 
  merge(
    # Predicted days by strata
    predicted %>%
      group_by(STRATA),
    # Actual trip days by strata
    rbind(
      # EM strata
      work.data %>%
        filter(
          ADP == year & COVERAGE_TYPE == "PARTIAL" & STRATA %in% c("EM TRW GOA (EFP)", "EM FIXED BSAI", "EM FIXED GOA") & 
          OBSERVED_FLAG == "Y") %>%
        group_by(ADP, TRIP_ID, STRATA) %>%
        summarise(dmin = min(TRIP_TARGET_DATE, LANDING_DATE, na.rm = TRUE),
                  dmax = max(TRIP_TARGET_DATE, LANDING_DATE, na.rm = TRUE)) %>%
        mutate(days = ceiling(as.numeric(difftime(dmax, dmin, units = "days"))) + 1) %>%
        group_by(ADP, STRATA) %>% 
        summarise(act_days = sum(days)),
      # Observer strata
      filter(obs_act_days, ADP == year)), 
    all = TRUE) %>% 
  # Change NAs to 0 for actual days      
  mutate(act_days  = ifelse(is.na(act_days), 0, act_days)) %>% 
  # Percent difference between predicted and actual
  mutate(diff = act_days -  pred_days,
         perc = (diff)/pred_days * 100) %>%
  mutate(perc = ifelse(is.infinite(perc), "-", format(perc, digits = 1, nsmall = 1))) %>%
  select(!c(ADP))

# Append total
trip.budget.table <- 
  rbind(trip.budget.table,
        trip.budget.table %>% 
          summarise(STRATA = "Total", 
                    pred_days = sum(pred_days), 
                    act_days = format(sum(act_days), digits = 1, nsmall = 0), 
                    diff = sum(diff), 
                    perc = format(sum(diff)/sum(pred_days) * 100, digits = 1, nsmall = 1))) %>%
  mutate(pred_days = format(pred_days, digits = 1, nsmall = 0),
         diff = format(diff, digits = 1, nsmall = 0))

```

Each year, the NMFS sets an annual budget for the deployment of partial coverage at-sea observers in terms of cost and observer days. The partial coverage observer budget for `r year` was set at \$`r formatC(bud_scen_lst, format = "d", big.mark = ",")` and `r formatC(OB_DAYS.BUDGET, format = "d", big.mark = ",")` days in the `r year` ADP.\
\
In `r year`, the FMA paid for `r formatC(round(OB_DAYS.ACTUAL), format = "d", big.mark = ",")` observer days, which was `r ifelse(eval$pct.budget.remain != 0, abs(eval$pct.budget.remain), " ")` `r ifelse(eval$pct.budget.remain != 0, "%", "")` `r eval$more.or.less` predicted by the average simulation and within the range of possibilities predicted in the `r year` ADP (`r fig_nums('outcomes.plot', display = "cite")`, top panel). Although there was 16.6% less effort in *OB POT* than predicted, *OB HAL* and *OB TRW* both had higher than predicted effort (`r tbl_nums('trip.budget.tbl', display = "cite")`). Despite observing the number of days predicted, expenditures for partial observer coverage were under budget (`r fig_nums('outcomes.plot', display = "cite")`, bottom panel). Cost savings resulted because the cost of a partial coverage observer day in `r year` was less than the expected cost that was estimated in the `r year` ADP.     

## Performance of the Observer Declare and Deploy System in Trip-Selection  
```{r odds.performance, warning=FALSE, include=FALSE}
#' Perform a check on the random number process in ODDS. `random.assign` is a flag for whether a trip's random number 
#' was less than the trip's selection rate. Since ODDS 3.0 went online in 2023, all trips have `RANDOM_NUMBER_USED` 
#' assigned and will therefore not have NA values. `PLANNED_EMBARK_DATE` is also changed from POSIX.ct to Date class.
odds.dat <- odds.dat %>% mutate(
  # Convert to Date class
  PLANNED_EMBARK_DATE = as.Date(PLANNED_EMBARK_DATE),
  # Compare random number to selection rate
  random.assign = case_when(
    is.na(RANDOM_NUMBER_USED) ~ NA,
    # Trip was randomly selected to NOT be monitored OR not randomly selected (e.g., 100% compliance)
    (RANDOM_NUMBER_USED >= ODDS_SELECTION_PCT / 100) | (ODDS_SELECTION_PCT == 100) ~ 0,
    # Trip was randomly selected to be monitored
    RANDOM_NUMBER_USED < ODDS_SELECTION_PCT / 100 ~ 1,
    .default = -99
  )
)
if(nrow(odds.dat %>% filter(random.assign == -99))) stop("Some records with undefined 'random.assign'")

#' Add a flag for trips that were released (waived) from monitoring
odds.dat <- odds.dat %>%
  mutate(released = ifelse(!is.na(RELEASE_STATUS_DESCRIPTION) & RELEASE_STATUS_DESCRIPTION != "Release Denied", 1, 0))

# Are assignments being performed as programmed?
# TRIP_MONITOR_CODE
#   ND = Not observed (Provider Defaulted)
#   RO = Observer Trip (Require Observer)
#   OA = Observed Trip (Observer Assigned)
#   RL = Not Observed (Provider Release)
#   NO = Not Observed Trip (Observer Not Required or Waiver Granted)
# STRATA_CODE == 98 are EM trips that were marked "OA" only because they fished IFQ in more than one area
# STRATA_CODE == 96 are at-sea compliance trips that fished IFQ in more than one area
# Trip status codes: 
#   CS = Cancel by System 
#   PD = Pending
#   CN = Canceled 
#   CP = Completed 
#   CC = Cancel Cascaded (discontinued with ODDS 3.0 in 2023)
#   CR = Cancel Replaced (introduced with ODDS 3.0 in 2023)

#' Based on a trip's stratum and the outcome of the trip, flag trips trips that were either monitored or intended to be
#' monitored as a result of random selection in `random.test`. Trips whose fate was predetermined by prior trips, e.g., 
#' via inherits and cascade cancels OR were undetermined, e.g., system canceled, are excluded with a value of [`NA`]. 
#' Use `TRIP_MONITOR_CODE` to identify trips in non-100% compliance monitoring strata that were slated for monitoring, 
#' whether it was realized or not, including those where the trip was waived [`1`]. Finally, trips in strata without 
#' random selection and trips marked as not monitored are identified [`0`].
odds.dat <- odds.dat %>% mutate(
  random.test = case_when(
    # Exclude trips that inherited other trips (selection of this record was not random)
    !is.na(INHERIT_TRIP_SEQ) ~ NA, 
    # Exclude trips missing random numbers or cancel cascaded (both instances removed with ODDS 3.0 in 2023)
    TRIP_STATUS_CODE == "CC" | is.na(RANDOM_NUMBER_USED) ~ NA,
    # Exclude trips canceled by system, which have an unknown monitoring outcome and do not become inherits
    TRIP_STATUS_CODE == "CS" ~ NA,

    # Trip was intended to be monitored but was waived OR
    released == 1 ~ 1,
    # Trip was monitored or supposed to be monitored due to random selection (not within compliance monitoring)
    TRIP_MONITOR_CODE %in% c("ND", "RO", "OA", "RL") & ODDS_SELECTION_PCT != 100 ~ 1,
    
    # Trip was not monitored because it was not selected OR the trip was not randomly selected because it had 100% compliance monitoring
    (TRIP_MONITOR_CODE == "NO") | ODDS_SELECTION_PCT == 100 ~ 0,  
    .default = -99
  )
)
if(nrow(odds.dat %>% filter(random.test == -99))) stop("Some records with undefined 'random.test'")

#' Check whether the monitoring outcome matches what was determined by random selection, i.e., trips that were not 
#' monitored when they were supposed to be or vice versa.
odds.dat <- odds.dat %>% mutate(random.test.result = ifelse(random.test - random.assign == 0, "PASS", "FAIL"))
if(nrow(filter(odds.dat, random.test.result == "FAIL"))) {
  stop(paste0("There are trips that failed `random.test.result`!"))
} else {
  odds.dat <- odds.dat %>% select(-c(random.test, random.test.result))
}
```

```{r disposition.tbl, warning=FALSE, include=FALSE}

#' Disposition of trips in the ODDS. This table summarizes the frequency of trip activities.
#' It does not represent the actual trips expected on the grounds. That is the next table.
#' This was Table 3-2 in the 2019 Annual Report, but has not been generated since then. The data.frame is still 
#' referenced in the text.

# Summarize by stratum and random.assign
disposition <- odds.dat %>%
  filter(ODDS_SELECTION_PCT != 100) %>%
  select(YEAR, STRATA, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, released, TRIP_PLAN_NUMBER) %>%
  group_by(YEAR, STRATA, random.assign) %>%
  summarize(Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
            Trips.canceled.bysystem = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE == "CS"]),
            Trips.remaining = Trips.logged.ODDS - Trips.canceled.bysystem,
            Trips.canceled.byusers = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE %in% c("CN", "CC", "CR")]),
            Trips.waived = length(TRIP_PLAN_LOG_SEQ[released == 1]),
            Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)])) 

# Add yearly totals and summary statistics
disposition <- merge(
  disposition,
  disposition %>% 
    group_by(YEAR, random.assign) %>% 
    summarise(STRATA = "Total", across(where(is.integer), sum)) %>%
    data.frame(),
  all = TRUE) %>%
    mutate(Cancellation.Pct = format(round((Trips.canceled.byusers / Trips.remaining) * 100, 1), nsmall = 1),
           Waiver.Pct = format(round((Trips.waived / Trips.remaining) * 100, 1), nsmall = 1)) 

# Redefine values in random.assign
disposition <- disposition %>% mutate(random.assign = case_when(
  is.na(random.assign) | random.assign == 1 ~ "Selected",
  random.assign == 0 ~ "Not selected"
))

# Then rename some columns for the table
# Table 3-2 (2019, cancellation rates AFTER random selection) ---- 

disposition.table <-
  disposition %>%
  arrange(YEAR, match(STRATA, c("OB HAL", "EM HAL", "OB POT", "EM POT", "OB TRW", "Total"))) %>%
  rename("Strata" = STRATA,
         "Year" = YEAR,
         "Random number outcomes" = random.assign,
         "Logged (*a*)" = Trips.logged.ODDS,
         "Canceled by system (*b*)" = Trips.canceled.bysystem,
         "Trips remaining (*c* = *a*-*b*)" = Trips.remaining,
         "Canceled by user (*d*)" = Trips.canceled.byusers,
         "Waived" = Trips.waived,
         "Paper" = Paper.tickets,
         "% User cancellation (*d*/*c* × 100)" = Cancellation.Pct,
         "Waiver (%)" = Waiver.Pct)
```

```{r odds.time_series, warning=FALSE, include=FALSE}

#' Create a time series of trips in ODDS by stratum where the counts of randomly-selected, inherited, and waived trips
#' are totaled for each day. These time series will be totaled for `odds.logged.tbl` and converted to cumulative totals
#' in`odds.ts.daily.cuml`

# These are all logged trips BEFORE cancellations, inherits and waivers
odds.ts.all <- odds.dat %>% 
  # Randomly-selected trips only (omitting any that inherited prior monitoring)
  filter(!ODDS_SELECTION_PCT %in% c(0, 100) & is.na(INHERIT_TRIP_SEQ)) %>%
  transform(Date = as.Date(ORIGINAL_EMBARK_DATE, format = "%Y-%m-%d")) %>% 
  group_by(YEAR, STRATA, Date) %>%
  summarize(
    n = sum(random.assign[is.na(INHERIT_TRIP_SEQ)], na.rm = TRUE),
    N = length(unique(TRIP_PLAN_LOG_SEQ)),
    TYPE = "Original date: All logged trips") %>% 
  arrange(Date) %>% 
  ungroup()

# Completed or pending trips only, including counts for inherits and waivers
odds.ts.cp <- odds.dat %>% 
  filter(!ODDS_SELECTION_PCT %in% c(0, 100) & TRIP_STATUS_CODE %in% c("CP", "PD")) %>%
  transform(Date = as.Date(PLANNED_EMBARK_DATE, format = "%Y-%m-%d")) %>% 
  group_by(YEAR, STRATA, Date) %>%
  summarize(
    n = sum(random.assign[is.na(INHERIT_TRIP_SEQ)], na.rm = TRUE),
    ni = length(unique(TRIP_PLAN_LOG_SEQ[!is.na(INHERIT_TRIP_SEQ)])),
    nr = sum(released, na.rm = TRUE),
    N = length(unique(TRIP_PLAN_LOG_SEQ)),
    TYPE = "Adjusted date: Valid trips only") %>% 
  arrange(Date) %>% 
  ungroup()

#' Get the dates that inherited trips were created (canceled randomly-selected trips where coverage was not waived) and
#' realized
odds.ts.ni.create <- odds.dat %>% 
  filter(!ODDS_SELECTION_PCT %in% c(0, 100) & !(TRIP_STATUS_CODE %in% c("CP", "PD"))) %>%
  transform(Date = as.Date(ORIGINAL_EMBARK_DATE, format = "%Y-%m-%d")) %>%
  group_by(YEAR, STRATA, Date) %>%
  summarize(ni.create = sum(random.assign[is.na(INHERIT_TRIP_SEQ) & released == 0], na.rm = TRUE)) %>%
  filter(ni.create > 0) %>%
  mutate(TYPE = "Original date: All logged trips")

# Get the dates when inherits are realized
odds.ts.ni.real <- odds.dat %>% 
  filter(!ODDS_SELECTION_PCT %in% c(0, 100) & TRIP_STATUS_CODE %in% c("CP", "PD")) %>%
  transform(Date = as.Date(PLANNED_EMBARK_DATE, format = "%Y-%m-%d")) %>%
  group_by(YEAR, STRATA, Date) %>%
  summarize(ni.real = length(unique(TRIP_PLAN_LOG_SEQ[!is.na(INHERIT_TRIP_SEQ) & released == 0]))) %>% 
  filter(ni.real > 0) %>%
  mutate(TYPE = "Adjusted date: Valid trips only")

```

```{r odds.logged.tbl, warning=FALSE, include=FALSE}

#' Summary of ODDS *completed trips* disposition by stratum, with total completed trips, total randomly selected 
#' trips, total inherited trips, and waived trips,where waived trips are not mutually exclusive from the randomly selected
#' or inherited trips and should be subtracted.

logged <- odds.ts.cp %>%
  group_by(YEAR, STRATA) %>%
  summarize(Total.trips = sum(N), Random.selected = sum(n), Inherit.selected = sum(ni), Waived = sum(nr)) %>%
  mutate(
    Total.final.selected = Random.selected + Inherit.selected - Waived,
    Pct.selected.from.inherit = round(Inherit.selected / Total.final.selected * 100, 1),  # Realized inherits, BEFORE waivers
    Pct.allselected.from.waiver = round(Waived / (Total.final.selected + Waived) * 100, 1))  


# Inherits and release rates AFTER random selection and cancellation) ---- 

# Tells us with more granularity how many selected trips were canceled or waived. 

# Disposition of trips - showing only valid trips and categories are exclusive
logged.table <- bind_rows(
  logged, 
  logged %>% 
    group_by(YEAR) %>%          
    summarise(STRATA = "Total",
              Total.trips = sum(Total.trips),
              Random.selected = sum(Random.selected),
              Inherit.selected = sum(Inherit.selected),
              Waived = sum(Waived),
              Total.final.selected = sum(Total.final.selected)) %>% 
    mutate(
      Pct.selected.from.inherit = round((Inherit.selected / Total.final.selected) * 100, 1),
      Pct.allselected.from.waiver = round(((Waived) / (Total.final.selected + Waived)) * 100, 1))
) %>% 
  select("Year" = YEAR, 
         "Strata" = STRATA, 
         "Total Trips" = Total.trips,
         "Random number selection (*r*)" = Random.selected, 
         "Inherited selection** (*i*)" = Inherit.selected,
         "Waived (*w*)" = Waived, 
         "Total final selected (*T*=*r*+*i*-*w*)" = Total.final.selected,
         "% Selected from inherits ((*i*/*T*) × 100)" = Pct.selected.from.inherit, 
         "% Reduction of selected trips due to waivers (*w*/(*T*+*w*) × 100)" = Pct.allselected.from.waiver) %>% 
  arrange(Year, match(Strata, c("OB HAL", "OB POT", "OB TRW", "EM HAL", "EM POT",  "Total")))
```

```{r selection.tbl, warning=FALSE, include=FALSE}
# Table 3-4 (2019) or Table 3-2 (2020) (Full ODDS summary, realized versus expected rates) ----
# This table will show probabilities that selection rates = programmed rates under various assumptions

for.p.wide <- merge(
  # Completed non-100% monitored trips only (after cancellations)
  logged %>% 
    group_by(YEAR, STRATA) %>%
    summarize(random.n = Random.selected,
              # after inherits
              inherit.n = Total.final.selected,
              #'total before waivers*
              inherit.butnowaiver.n = (Total.final.selected + Waived),
              Total.n = Total.trips,
              Source = "Valid trips only"),
  #' Now add in the total trips for the random number only. This includes every trip logged in ODDS (excluding those in 
  #' 100% selection) and counts how many were selected based on the random number and selection rate, `before`
  #' inherits, cancellations, and waivers
  odds.ts.all %>%
    group_by(YEAR, STRATA) %>%
    summarise(random.n = sum(n), Total.n = sum(N), Source = "ODDS random number"),
  all = TRUE) %>%
  arrange(YEAR, Source, STRATA)

# Merge in the selection rates of each stratum for calculating p-values later
for.p.wide <- for.p.wide %>%
  left_join(
    partial %>% select(!GEAR) %>% distinct(), 
    by = c("STRATA", "YEAR")) %>%
  mutate(ODDS_SELECTION_PCT = Rate * 100) %>%
  select(., !c(formatted_strat, Rate))

# Put into long format
p.table <- for.p.wide %>%
  pivot_longer(cols = c(-STRATA, -YEAR, -Total.n, -ODDS_SELECTION_PCT, -Source), names_to = "key", values_to = "value")

# Omit records with missing values
p.table <- p.table[!is.na(p.table$value), ]
p.table$p <- NA_real_
p.table$pct <- NA_real_

# Run the binomial test for each  row to see if realized rates met expectation
for(i in 1:nrow(p.table)){
  # Realized monitoring rate
  p.table$pct[i] = round((p.table$value[i] / p.table$Total.n[i]) * 100, 2)
  # Check out this format - forces digits even if zero value!
  p.table$p[i] = format(round(stats::binom.test(p.table$value[i], p.table$Total.n[i], 
                        p = p.table$ODDS_SELECTION_PCT[i] / 100, 
                        alternative = "two.sided")$p.value, 3), nsmall = 3)}

#' Format programmed and realized monitoring rates as percentages to 2 decimal places.
p.table <- p.table %>% 
  mutate(ODDS_SELECTION_PCT = round(ODDS_SELECTION_PCT, 2), 
         pct = round(pct, 2))

# Cleanup
rm(for.p.wide)

# rename values for one column
p.table$key[p.table$key == "inherit.n"] <- "Expected"
p.table$key[p.table$key == "random.n"] <- "Random Selection Only"
p.table$key[p.table$key == "inherit.butnowaiver.n"] <- "Expected if no waivers"

# Create table
Selection.table <- p.table %>%
  mutate(p = ifelse(p < 0.05, paste0(p, "*"), p)) %>%
  arrange(YEAR, STRATA, Source, desc(key)) %>%
  arrange(match(STRATA, c("OB HAL", "EM HAL", "OB POT", "EM POT", "OB TRW"))) %>% 
  mutate(new_trip_type = 
        derivedFactor("Initial Random Selection, *a*"= Source == "ODDS random number",
                      "After Cancellations, *b* (*a*-*b*)" = key == "Random Selection Only" & Source == "Valid trips only",
                      "With Inherits, *c* (*a*-*b*+*c*)" = key == "Expected if no waivers",
                      "After Waivers, *d* (*a*-*b*+*c*-*d*)" = key == "Expected",
                      .ordered = TRUE, .method = "unique")) %>% 
  select("Year" = YEAR,
        "Strata" = STRATA, 
        "Trip disposition" = new_trip_type,   # UPDATE THESE NAMES
        "n" = value,  # "Selected trips"
        "N" = Total.n,   # "Total trips"
        "Actu" = pct,   # "Actual selection (%)"
        "Prog" = ODDS_SELECTION_PCT,  # "Programmed selection (%)"
        "*p*" = p)    # "*p*-value (H0: Actual = Programmed)"
```

```{r odds.ts.daily.cuml.fig, warning=FALSE, include=FALSE}

# Use the ODDS time series to plot if and when the realized monitoring rates are within the expected range given the
# programmed rates and the binomial distribution. Calculate running totals of trips and monitored trips.
odds.ts.daily.cuml <- bind_rows(
  # Initial random selection
  odds.ts.all, 
  # Final after cancellations, inherits, and waivers
  odds.ts.cp %>% 
    group_by(YEAR, STRATA, Date, TYPE) %>%
    summarise(n = n + ni - nr, N = N)
  ) %>% 
  group_by(YEAR, STRATA, TYPE) %>%
  mutate(
    TYPE = as.factor(TYPE),
    running.n = order_by(Date, cumsum(n)),
    running.N = order_by(Date, cumsum(N)),
    running.pct = round((running.n / running.N) * 100, 2)
  ) %>%
  arrange(STRATA, TYPE, Date) %>%
  right_join(
    partial %>%
      filter(STRATA != "EM TRW GOA (EFP)") %>%
      distinct(YEAR, STRATA, ODDS_SELECTION_PCT = Rate * 100),
    by = c("STRATA", "YEAR")) %>%
  ungroup()

# reorder strata for plot
odds.ts.daily.cuml <- transform(odds.ts.daily.cuml,
                                STRATA = factor(STRATA, levels = c(
                                  "OB FIXED BSAI", "OB FIXED GOA", "OB TRW BSAI", "OB TRW GOA", 
                                  "EM FIXED BSAI", "EM FIXED GOA")),
                                YEAR = as.character(year))

# Generate data for ribbon plots for the random data only.
odds.ts.daily.cuml$L95 <- ifelse(
                          odds.ts.daily.cuml$TYPE == "Adjusted date: Valid trips only", 
                          NA, 
                          round((qbinom(0.025, 
                                        odds.ts.daily.cuml$running.N, 
                                        odds.ts.daily.cuml$ODDS_SELECTION_PCT / 100)) / odds.ts.daily.cuml$running.N, 3))

odds.ts.daily.cuml$H95 <- ifelse(
                          odds.ts.daily.cuml$TYPE == "Adjusted date: Valid trips only", 
                          NA, 
                          round((qbinom(0.975,
                                        odds.ts.daily.cuml$running.N,
                                        odds.ts.daily.cuml$ODDS_SELECTION_PCT / 100)) /
                                        odds.ts.daily.cuml$running.N, 3))

# Calculate the p-values that the realized rates are different from the expected (programmed) rate
for(i in 1:nrow(odds.ts.daily.cuml)){
  odds.ts.daily.cuml$test_stat_random[i] <- ifelse(
    odds.ts.daily.cuml$running.n[i] < 1, NA,
    round(binom.test(odds.ts.daily.cuml$running.n[i],
                     odds.ts.daily.cuml$running.N[i],
                     odds.ts.daily.cuml$ODDS_SELECTION_PCT[i] / 100,
                     alternative = "two.sided")$p.value, 3))
}

rm(i)

for.plot.text <- left_join(
  odds.ts.daily.cuml %>% 
    group_by(YEAR, STRATA, TYPE) %>%
    filter(Date == max(Date)) %>%
    group_by(YEAR, STRATA) %>%
    mutate(label.original = format(running.pct[TYPE == "Original date: All logged trips"], digits = 4, nsmall = 2),
          label.adjusted = format(running.pct[TYPE == "Adjusted date: Valid trips only"], digits = 4, nsmall = 2)) %>% 
    distinct(YEAR, STRATA, label.original, label.adjusted),
  partial %>% 
    filter(STRATA != "EM TRW EFP") %>%
    select(YEAR, STRATA, label.programmed = Rate) %>%
    mutate(STRATA = as.character(STRATA), 
          YEAR = as.factor(YEAR),
          label.programmed = format(label.programmed * 100, digits = 4, nsmall = 2)), 
  by = c("STRATA", "YEAR"))

odds.ts.daily.cuml <- merge(odds.ts.daily.cuml, for.plot.text)

# Custom y axes for each row of the figure
odds.scales <- list(
  scale_y_continuous(limits = c(20, 70), breaks = c(0, 20, 40)),
  scale_y_continuous(limits = c(0, 30), breaks = c(0, 20, 40)),
  scale_y_continuous(limits = c(40, 100)),
  scale_y_continuous(limits = c(0, 40)),
  scale_y_continuous(limits = c(50, 100)),
  scale_y_continuous(limits = c(0, 75))
)

odds.by.date.plot <- 
  ggplot(filter(odds.ts.daily.cuml, YEAR == year), aes(x = Date, col = fct_rev(TYPE))) +
  facet_grid(factor(STRATA, levels = strata.order) ~., scales = "free") +
  # Add lines for selection rates  
  geom_hline(aes(yintercept = ODDS_SELECTION_PCT), lty = 3, linewidth = 1) +
  geom_ribbon(aes(ymin = L95 * 100, ymax = H95 * 100), alpha = 0.1) +
  geom_line(aes(y = running.pct), linewidth = 1.5) +
  scale_color_manual(name = "Rate Type", values = c("gray50", "black")) +
  ylab("Cumulative coverage percent\n") +
  xlab("\nDate") +
  geom_rug(data = odds.ts.ni.create %>% filter(ni.create > 0 & YEAR == year), sides = "b", color = "gray50") + 
  geom_rug(data = odds.ts.ni.real %>% filter(ni.real > 0 & YEAR == year), sides = "t") + 
  geom_text(aes(x = as.Date(Inf), y = Inf, label = paste("Programmed (%) = ", label.programmed, sep = "")), 
            hjust = 1.02, vjust = 2, size = 3, color = "black", check_overlap = TRUE) +
  geom_text(aes(x = as.Date(Inf), y = Inf, label = paste("Original (%) = ", label.original, sep = "")), 
            hjust = 1.02, vjust = 3.2, size = 3, color = "gray50", check_overlap = TRUE) +
  geom_text(aes(x = as.Date(Inf), y = Inf, label = paste("Final (%) = ", label.adjusted, sep = "")), 
            hjust = 1.02, vjust = 4.4, size = 3, color = "black", check_overlap = TRUE) +
  fig.theme + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90),
        strip.text.x = element_text(size = 10),
        legend.position = "none") +
  ggh4x::facetted_pos_scales(y = odds.scales)

```

```{r odds_paragraph, warning=FALSE, include=FALSE}

#' \TODO Not currently used but could/should be?

# Objects that help increase readability of in-text calculations in the following paragraphs

# Total canceled trips (both by ODDS or by users)
totl.canc <- disposition %>% 
  filter(STRATA == "Total" & random.assign == "Selected", YEAR == year) %>%
  summarize(totl.canc = sum(as.numeric(Trips.canceled.bysystem)) + sum(as.numeric(Trips.canceled.byusers))) %>% 
  as.numeric()

# Percent of total trips canceled by the ODDS system
perc.syst.canc <- disposition %>% 
   filter(STRATA == "Total" & random.assign == "Selected", YEAR == year) %>% 
   summarize(
     perc.syst.canc = round(
       (sum(as.numeric(Trips.canceled.bysystem)) / sum(as.numeric(Trips.logged.ODDS))) * 100, 1)) %>% 
   as.numeric()

#Percent of total trips canceled by users
perc.user.canc <- disposition %>% 
  filter(STRATA == "Total" & random.assign == "Selected", YEAR == year) %>% 
  summarize(perc.syst.canc = format(
    (sum(as.numeric(Trips.canceled.byusers)) / sum(as.numeric(Trips.logged.ODDS))) * 100, digits = 1, nsmall = 1)) %>% 
  as.character()

# Lowest and highest cancellation rate/stratum for selected trips by strata
sel.min.canc <- disposition %>% 
                filter(STRATA != "Total" & random.assign == "Selected") %>%
                group_by(YEAR, STRATA) %>% 
                summarize(Cancellation.Pct = (sum(as.numeric(Trips.canceled.byusers)) / sum(as.numeric(Trips.remaining))) * 100) %>%
                slice_min(as.numeric(Cancellation.Pct)) %>% 
                mutate(Cancellation.Pct = round(Cancellation.Pct, 1))

sel.max.canc <- disposition %>% 
                filter(STRATA != "Total" & random.assign == "Selected") %>%
                group_by(YEAR, STRATA) %>% 
                summarize(Cancellation.Pct = (sum(as.numeric(Trips.canceled.byusers)) / sum(as.numeric(Trips.remaining))) * 100) %>%
                slice_max(as.numeric(Cancellation.Pct)) %>% 
                mutate(Cancellation.Pct = round(Cancellation.Pct, 1))
```

```{r odds_paragraph2, warning=FALSE, include=FALSE}

#' \TODO Not currently used but could/should be?
 
# Lowest and highest percentages of valid trips that were selected from the inherit process.
inherit.min <- logged %>%
               group_by(YEAR, STRATA) %>% 
               summarize(Pct.selected.from.inherit = (sum(Inherit.selected) / sum(Total.final.selected)) * 100) %>% 
               slice_min(as.numeric(Pct.selected.from.inherit)) %>% 
               mutate(Pct.selected.from.inherit = format(round(Pct.selected.from.inherit, 1), nsmall = 1)) %>% 
               select(YEAR, STRATA, Pct.selected.from.inherit)

inherit.max <- logged %>%
               group_by(YEAR, STRATA) %>%  
               summarize(Pct.selected.from.inherit = (sum(Inherit.selected) / sum(Total.final.selected)) * 100) %>% 
               slice_max(as.numeric(Pct.selected.from.inherit)) %>% 
               mutate(Pct.selected.from.inherit = format(round(Pct.selected.from.inherit, 1), nsmall = 1)) %>% 
               select(YEAR, STRATA, Pct.selected.from.inherit)

waiver.min <- logged %>% 
              group_by(YEAR, STRATA) %>% 
              summarize(Pct.allselected.from.waiver = (sum(Waived) / (sum(Total.final.selected) + sum(Waived))) * 100) %>% 
              slice_min(as.numeric(Pct.allselected.from.waiver)) %>% 
              mutate(Pct.allselected.from.waiver = format(round(Pct.allselected.from.waiver, 1), nsmall = 1)) %>% 
              select(YEAR, STRATA, Pct.allselected.from.waiver)

waiver.max <- logged %>% 
              group_by(YEAR, STRATA) %>% 
              summarize(Pct.allselected.from.waiver = (sum(Waived) / (sum(Total.final.selected) + sum(Waived))) * 100) %>% 
              slice_max(as.numeric(Pct.allselected.from.waiver)) %>% 
              mutate(Pct.allselected.from.waiver = format(round(Pct.allselected.from.waiver, 1), nsmall = 1)) %>% 
              select(YEAR, STRATA, Pct.allselected.from.waiver)
```

```{r odds_paragraph3, warning=FALSE, include=FALSE}

#' \TODO Not currently used but could/should be?

# Text strings for reporting on the observer initial selection rates by strata
pct_txt <- p.table %>% 
           filter(Source == "ODDS random number") %>% 
           mutate(pct_txt = paste0(pct, "% for the *", STRATA, "* stratum in ", YEAR)) %>%
           distinct(pct_txt) 

# Extract p-values associated with random selection (H0: observed = expected
# rates). Merge to the partial look up table to ensure that things stay in order.
random_pvals <- merge(
  p.table, 
  partial %>% 
    filter(STRATA != "EM TRW EFP") %>% 
    distinct(STRATA, formatted_strat)
) %>% 
  filter(Source == "ODDS random number") %>% 
  select(YEAR, p, formatted_strat)
 
# Text strings for reporting on the observer FINAL selection rates by strata
final_pct_txt <- p.table %>% 
                 filter(key == "Expected") %>% 
                 mutate(pct_txt = paste0(pct, "% for the *", STRATA, "* stratum in ", YEAR)) %>% 
                 distinct(pct_txt) 

# Extract p-values associated with FINAL selection (H0: final observed = expected
# rates).
final_pvals <- merge(
  p.table, 
  partial %>% 
    filter(STRATA != "EM TRW EFP") %>% 
    distinct(STRATA, formatted_strat)
) %>% 
  filter(key == "Expected") %>% 
  select(YEAR, p, formatted_strat)
```

The ODDS facilitates the random selection for monitoring in strata and fishers are required to log anticipated fishing trips. The ODDS generates a random number according to the programmed rates from the ADP and assigns each logged trip to either “selected to be monitored” (selected) or “not selected to be monitored” (not selected) categories. The ODDS is not used to select which deliveries are to be monitored by shoreside observers for the *EM TRW EFP* stratum.\
\
Logged trips have different dispositions. When initially logged, trips are considered pending, and subsequently have two dispositions: closed or canceled. A trip can be closed by (1) selecting landing reports from a menu or (2) manually entering the end of trip information for observed trips. The vessel operator may change the dates of a logged trip regardless of selection status prior to, or in lieu of, cancellation. However, trips that have not been closed at the end of the calendar year are automatically canceled by the ODDS to prevent `r year` ODDS trips from affecting the deployment rates set for the `r year + 1` ADP. Trips that were selected to be monitored by ODDS and are subsequently canceled trigger the next newly-logged trip (for at-sea observers) or next logged trip (for fixed-gear EM) to automatically inherit the selected status. These trips are termed inherited trips.\
\
The number of trips logged in the ODDS in `r year` and their dispositions is summarized in `r tbl_nums('disposition.table.2023', display = "cite")`. Of the 4,482 total trips logged, 987 were selected, and 155 were canceled: five by ODDS (0.5%) and 150 by users (15.2%). The user cancellation rate for selected trips among strata ranged from 6.9% for *EM POT* to 21.2% for *OB HAL* in `r year`. These two strata also had the least and greatest cancellation rates in `r year - 1` (2.6% and 41.7% respectively, (Appendix A, Table A-2).\
\
The number of completed trips that were randomly selected for monitoring or from inherited monitoring as well as the number of trips that were waived are summarized in `r tbl_nums('logged.table', display = "cite")`. It is notable that 29% of monitoried trips in the *OB HAL* stratum and 22.2% of monitored trips in the *OB POT* stratum were inherited. This was a continuation of what was seen in 2022 in which 35.9% of *OB HAL*, 28.2% of *OB POT* and 17.8% of *OB TRW* trips were monitored via the inherit system (Appendix A, Table A-3). This is in contrast to the fixed-gear EM strata where fewer than 10% of monitored trips were inherited in either year.\
\
The extent to which trip-selections are changed from the time they are entered can be determined by comparing the rate of trip observation expected from (1) random selection of all logged trips (initial random selection) and (2) random selection of remaining trips after cancellations, inherits and waivers. In any case, the proportion of trips selected to be monitored should fall within what would be expected given the binomial distribution (since each trip is either selected or not selected). The rates obtained (%, with associated *p*-value based on the binomial distribution) in the initial selection process were within expected ranges with the following exception --- the initial selection rate was 26.50% (*p*-value = 0.012) for the *OB TRW* stratum (`r tbl_nums('Selection.table.2023', display = "cite")`). This means that the *OB TRW* stratum was being over-selected in ODDS. A time series of ODDS initial selection rates and final realized rates is presented in `r fig_nums('odds.by.date.plot.2023', display = "cite")`.\
\
The final selection rate after trips were closed, canceled or waived were within expected bounds with the exception of the *OB HAL* and *OB TRW* strata (`r tbl_nums('Selection.table.2023', display = "cite")`). The *OB HAL* stratum had a programmed rate of 17.87% but through the result of cancellations, inherits and waivers ended up being selected at 21.38% (*p*-value = 0.002). The *OB TRW* stratum had an original selection rate of 22.68% but was selected at 26.5%, and through the process of cancellations, inherits and waivers was selected at 29.26% (*p*-value < 0.001; `r tbl_nums('Selection.table.2023', display = "cite")`). While both strata exhibited an increase in monitoring because of inherits, the impact that inherits had to elevate monitoring rates was greater for *OB HAL* than it was for *OB TRW*. The impact of waivers was small, averaging a 1.4% reduction in monitoring rate among strata with the most waived trips within the *OB POT* stratum (`r tbl_nums('logged.table', display = "cite")`).

## Evaluation of Coverage Rates  
```{r Coverage.tbl, message=FALSE, warning=FALSE, include=FALSE}
# Coverage table has number of total vessels (V), sampled vessels (v), total trips (N), sampled trips (n), and percent observed by deployment method (trip vs. vessel-selection):

#' *FULL COVERAGE*
Coverage.Table.full <- bind_rows(
  # Coverage rates for vessels in the full coverage category (both regulatory
  # and voluntary full coverage)
  work.data %>%
    filter(COVERAGE_TYPE == "FULL") %>% 
    group_by(ADP, COVERAGE_TYPE, STRATA) %>%
    summarize(V = length(unique(VESSEL_ID)),
              v = length(unique(VESSEL_ID[OBSERVED_FLAG == "Y"])),
              N = length(unique(TRIP_ID)),
              n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"]))) %>%
    mutate(Pct.obs = (n/N) * 100,
           deployment.method = "Trip-Selection",
           Rate = 1,
           meets.expected = ifelse(Pct.obs < 100, "No - lower than expected", "Yes")) %>%
    select(ADP, COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, meets.expected),
  # Totals for vessels in the full coverage category
  work.data %>%
    filter(COVERAGE_TYPE == "FULL") %>%
  group_by(ADP) %>%
    summarize(V = length(unique(VESSEL_ID)),
              v = length(unique(VESSEL_ID[OBSERVED_FLAG == "Y"])),
              N = length(unique(TRIP_ID)),
              n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"]))) %>%
    mutate(COVERAGE_TYPE = "Full coverage total",
           Pct.obs = (n/N) * 100,
           deployment.method = "Trip-Selection")
) %>%
  arrange(ADP, desc(STRATA)) %>%
  ungroup()

#' *PARTIAL COVERAGE TRIP-SELECTION*
Coverage.Table.partial <- bind_rows(
  # By strata for vessels in the partial coverage category (trip-selection)
  work.data %>% 
    filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>%
    left_join(select(partial, c(YEAR, STRATA, Rate)), by = join_by(ADP == YEAR, STRATA)) %>%
    group_by(ADP, COVERAGE_TYPE, STRATA) %>%
    summarize(V = length(unique(VESSEL_ID)),
              v = length(unique(VESSEL_ID[OBSERVED_FLAG == "Y"])),
              N = length(unique(TRIP_ID)),
              n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"])),
              Rate = unique(Rate)) %>%
    mutate(Pct.obs = (n/N) * 100,
           deployment.method = "Trip-Selection") %>% 
    # Add binomial distribution upper and lower 95th percentiles for each partial coverage stratum
    group_by(ADP, COVERAGE_TYPE, STRATA) %>%
    mutate(
      min.expected = round(
        stats::binom.test(x = n, 
                          n = N, 
                          p = Rate, 
                          alternative = "two.sided")$conf.int[1], digits = 3) * 100,
      max.expected = round(
        stats::binom.test(x = n, 
                          n = N, 
                          p = Rate,
                          alternative = "two.sided")$conf.int[2], digits = 3) * 100,
      meets.expected = case_when(Rate * 100 > min.expected & Rate * 100 < max.expected ~ "Yes",
                                 Rate * 100 < min.expected ~ "No - higher than expected",
                                 Rate * 100 > max.expected ~ "No - lower than expected")) %>%
    select(ADP, COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, 
           min.expected, max.expected, meets.expected)
  ,
  # Totals for partial coverage category
  Coverage.Table.partial.total <- work.data %>%
    filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>%
    group_by(ADP) %>%
    summarize(V = length(unique(VESSEL_ID)),
              v = length(unique(VESSEL_ID[OBSERVED_FLAG == "Y"])),
              N = length(unique(TRIP_ID)),
              n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"]))) %>%
    mutate(COVERAGE_TYPE = "Partial coverage total",
           Pct.obs = (n/N) * 100,
           deployment.method = "Trip-Selection") 
) %>%
  arrange(ADP, match(STRATA, c("EM HAL", "EM POT", "EM TRW EFP", "OBS HAL", "OBS POT", "OBS TRW"))) %>%
  ungroup()

#' *ZERO COVERAGE* 
Coverage.Table.zero <-
  work.data %>%
    filter(STRATA %in% c("ZERO", "Zero EM Research")) %>% #'
    mutate(STRATA = as.character(STRATA)) %>% 
    mutate(STRATA = ifelse(STRATA == "ZERO", "Zero coverage", STRATA)) %>% 
    group_by(ADP, COVERAGE_TYPE, STRATA) %>%
    summarize(V = length(unique(VESSEL_ID)),
              v = length(unique(VESSEL_ID[OBSERVED_FLAG == "Y"])),
              N = length(unique(TRIP_ID)),
              n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"]))) %>%
    mutate(Pct.obs = (n/N) * 100,
           deployment.method = "Trip-Selection",
           Rate = 0,
           meets.expected = ifelse(Pct.obs > 0, "No - higher than expected", "Yes")) %>%
    select(ADP, COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, meets.expected) %>%
  ungroup()

# Totals with EM (number of vessels is not additive)
Coverage.Table.TOTALS <- work.data %>%
  group_by(ADP) %>%
  summarize(V = length(unique(VESSEL_ID)),
            v = length(unique(VESSEL_ID[OBSERVED_FLAG == "Y"])),
            N = length(unique(TRIP_ID)),
            n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"]))
  ) %>%
  mutate(COVERAGE_TYPE = "Total",
         STRATA = "Total",
         Pct.obs.trips = format((n/N) * 100, digits = 1, nsmall = 1),
         Pct.obs.vessels = format((v/V) * 100, digits = 1, nsmall = 1),
         Pct.obs = paste0(Pct.obs.trips, "% trips; ", Pct.obs.vessels, "% vessels")) %>%
  ungroup()

#' *Combine all the coverage tables*
Coverage.Table <- bind_rows(Coverage.Table.full, 
                            Coverage.Table.partial,
                            Coverage.Table.zero,
                            ) %>%
  mutate(Pct.obs = format(Pct.obs, digits = 1, nsmall = 1)) %>%
  bind_rows(Coverage.Table.TOTALS) %>%
  # Formatting (change things to characters so they knit to Word without weird
  # formatting issues)
  mutate(V = as.character(V),
         v = as.character(v),
         N = as.character(N),
         n = as.character(n),
         #' *FLAG* binom.test method
         #Rate = ifelse(is.na(Rate), NA, format(Rate * 100, digits = 1, nsmall = 1)),
         #' *FLAG* qbinom method
         Rate = ifelse(is.na(Rate), NA, 
                       ifelse(deployment.method == "Trip-Selection", 
                              format(Rate * 100, digits = 1, nsmall = 1),
                              format(Rate, digits = 0, nsmall = 0))),
         min.expected = ifelse(is.na(min.expected), NA, 
                               ifelse(deployment.method == "Trip-Selection", 
                                      format(min.expected, digits = 1, nsmall = 1),
                                      format(min.expected, digits = 0, nsmall = 0))),
         max.expected = ifelse(is.na(max.expected), NA, 
                               ifelse(deployment.method == "Trip-Selection", 
                                      format(max.expected, digits = 1, nsmall = 1),
                                      format(max.expected, digits = 0, nsmall = 0))),
         STRATA = case_when(STRATA == "FULL" ~ "Full", TRUE ~ STRATA),
         COVERAGE_TYPE = case_when(STRATA == "Zero coverage" ~ "Zero coverage",
                                   COVERAGE_TYPE == "FULL" ~ "Full coverage",
                                   COVERAGE_TYPE == "PARTIAL" ~ "Partial coverage",
                                   TRUE ~ COVERAGE_TYPE)) %>%
  mutate(STRATA = as.factor(STRATA),
         COVERAGE_TYPE = as.factor(COVERAGE_TYPE)) %>%
  select(`Year` = ADP,
         `Coverage` = COVERAGE_TYPE, 
         Strata = STRATA,
         V, v, N, n,
         `Expected` = Rate,
         `Realized` = Pct.obs,
         `Lower limit`= min.expected,
         `Upper limit` = max.expected, 
         `Realized meets expected?` = meets.expected) %>%
  arrange(Year)

# Create an empty factor level so that you can get rid of NAs in the table.
Coverage.Table$Coverage = factor(Coverage.Table$Coverage, levels = c(levels(Coverage.Table$Coverage), " "))
Coverage.Table$Strata = factor(Coverage.Table$Strata, levels = c(levels(Coverage.Table$Strata), " "))
Coverage.Table <- replace(Coverage.Table, is.na(Coverage.Table), " ")

rm(Coverage.Table.full, Coverage.Table.partial, Coverage.Table.partial.total, Coverage.Table.TOTALS, Coverage.Table.zero)

# Check full coverage to see why < 100%
full.cover.no.obs <- work.data %>%
  filter(COVERAGE_TYPE == "FULL" & OBSERVED_FLAG == "N") %>%
  select(ADP, TRIP_ID, VESSEL_ID, PERMIT, AGENCY_GEAR_CODE, FMP, MANAGEMENT_PROGRAM_CODE, 
         PROCESSING_SECTOR, TRIP_TARGET_CODE, LENGTH_OVERALL) %>%
  distinct()

```

```{r coverage_paragraph, message=FALSE, warning=FALSE, include=FALSE}
# Objects referenced in-text:

# Coverage trip and vessel totals (including EM)
totl_obs_trips <- Coverage.Table %>% filter(Strata == "Total" & Coverage == "Total" & Year == year) %>% select(n) %>% as.numeric()

perc_trips_obs <- Coverage.Table %>% 
  filter(Strata == "Total" & Coverage == "Total" & Year == year) %>% 
  transmute(percent.obs = format(as.numeric(n)/as.numeric(N) * 100, digits = 1, nsmall = 1)) %>% 
  as.numeric()

totl_obs_vessels <- Coverage.Table %>% filter(Strata == "Total" & Coverage == "Total" & Year == year) %>% select(v) %>% as.numeric()

perc_vessels_obs <- Coverage.Table %>% 
  filter(Strata == "Total" & Coverage == "Total" & Year == year) %>%
  transmute(percent.obs = format(as.numeric(v)/as.numeric(V) * 100, digits = 1, nsmall = 1)) %>% 
  as.numeric()
```

```{r em_times, message=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
# EM review time (aka data timeliness) now performed in "data_timeliness.Rmd" created by Phil Ganz (NOTE: Requires ROracle and
# access to CAS)
```

This section compares the coverage rate achieved against the expected coverage rates. Data used in this evaluation are stored within the Catch Accounting System (CAS; managed by the AKRO), the Observer Program database (NORPAC; managed by the AFSC) and eLandings (under joint management by the Alaska Department of Fish and Game, the IPHC and the NMFS). Separate rate evaluations are conducted depending on whether the unit of observer deployment was at-sea fishing trips or dockside deliveries of pollock.\
\
In combination across all strata, coverage levels and fishery monitoring tools, 3,780 trips (43.7%) and 463 vessels (50.2%) were successfully monitored among all fishing in the Federal fisheries of Alaska in `r year` (`r tbl_nums('Coverage.Table.2023', display = "cite")`). This compares to a total of 3,534 trips (39.7%) and 441 vessels (45.3%) monitored in 2022 (AFSC and AKRO 2023).\
\
The `r year` Observer Program had `r total.strat` different deployment strata to be evaluated (`r tbl_nums('Coverage.Table.2023', display = "cite")`). There were two *Full coverage* strata; vessels that were required to have full coverage (e.g., AFA vessels) and BSAI trawl catcher vessels that opted into full coverage (i.e., *EM TRW EFP* under regulations *50 CFR 679.51(a)(4)*). There were six partial coverage strata: three observed strata and three EM strata, defined by gear designation. There was also one *Zero coverage* stratum that included jig vessels and vessels under 40 ft LOA that are not monitored.\
\
Evaluations for the full coverage category and zero-selection pool are straightforward --- either the coverage achieved was equal to 100% or 0%, respectively, or it was not. The program achieved 99.7% coverage in its full coverage category (`r tbl_nums('Coverage.Table.2023', display = "cite")`). Four trips were not monitored in the full coverage category (three BSAI open acess non-pelagic trawl trips targeting Pacific cod [*Gadus macrocephalus*] on one vessel and one trip on another vessel with identical attributes). The program achieved compliance with the *Zero coverage* stratum (`r tbl_nums('Coverage.Table.2023', display = "cite")`).\
\
Under the assumption that the deployment was randomized, a 95% confidence interval computed from the realized coverage rates (under the assumption of a binomial distribution for monitored trips) will contain the actual deployment rate 95% percent of the time. If expected coverage levels were within the 95% confidence intervals, then we conclude that realized and expected coverage rates were equal.\
\
Coverage rates were consistent with expected values in only half of the six partial coverage strata. Coverage rates were higher than expected for the *EM HAL* and *EM POT* strata (`r tbl_nums('Coverage.Table.2023', display = "cite")`). The high rate in *OB TRW* is again explained by the unexpectedly high selection of trips by the ODDS. However, the low coverage rates in the *EM HAL* and *EM POT* strata can be explained by a lack of reviewed EM data. Unlike observed trips, the coverage rate for EM is based on information provided from the Pacific States Marine Fisheries Commission (PSFMC) that is available to analysts in the NORPAC database at the time of writing. In `r year`, the average time between receipt and completion of review was 167 days for *EM HAL* and 184 days for *EM POT* (`r fig_nums('em.times.figure', display = "cite")`). This was a slight improvement over the average review time of 227 days for the *EM HAL* stratum and 213 days for the *EM POT* stratum in `r year - 1` (Appendix A, Figure A-3).\
\
Note that there are several reasons why the total number of trips and the final monitoring rates presented in this section differ with what was presented earlier within the ODDS. The *OB HAL* stratum had a higher than expected monitoring rate in ODDS (`r tbl_nums('Selection.table.2023', display = "cite")`), but was within the expected range (although elevated) according to the dataset using eLandings and CAS (`r tbl_nums('Coverage.Table.2023', display = "cite")`). There is no robust link between the ODDS database and eLandings, and therefore, trips in ODDS cannot be linked directly to realized landings in eLandings, which inform the trip identification numbers created by CAS. The FMSC has recommended in past reports that this linkage be established. Moreover, ODDS trips are sometimes not logged as required (see Chapter 5, section 1.5.2, Figure 5.5) and records are not created in ODDS after-the-fact.   

### Coverage Rates for Dockside Monitoring
```{r pollock.observed.tbl, message=FALSE, warning=FALSE, include=FALSE}
# Get all pollock landings and label observed status  
# Note: tender is intentionally excluded
Pollock.landing.data <- work.data %>%
  filter(SOURCE_TABLE == "Y" & # Retained catch
         TENDER == "N" &
         AGENCY_GEAR_CODE %in% c("PTR", "NPT") &   
         PROCESSING_SECTOR == "S" &                  
         TRIP_TARGET_CODE %in% c("B", "P") & 
         MANAGEMENT_PROGRAM_CODE != "RPP") %>% 
  distinct(ADP, REPORT_ID, COVERAGE_TYPE, STRATA, FMP, PORT_CODE, TENDER) %>%
  # salmon.landings.obs is a list of REPORT_IDs for which dockside sampling for salmon occurred (all sectors)
  mutate(Observed.type = ifelse(REPORT_ID %in% salmon.landings.obs$REPORT_ID, "Observed", "Not_Observed"),
         FMP = fct_recode(factor(FMP), `Bering Sea` = "BSAI", `Gulf of Alaska` = "GOA"),
         PORT_CODE = fct_recode(factor(PORT_CODE),
                                `Kodiak` = "KOD", 
                                `Dutch Harbor` = "DUT", 
                                `Akutan` = "AKU", 
                                `Sand Point` = "SPT", 
                                `King Cove` = "KCO",
                                `Inshore floating processor` = "IFP"),
         COVERAGE_TYPE = fct_recode(factor(COVERAGE_TYPE), `Full` = "FULL", `Partial` = "PARTIAL")) 

# Summarise landings by FMP, coverage type, port, and observed status
Pollock.monitored <- rbind(
  Pollock.landing.data %>%
    group_by(ADP, FMP, COVERAGE_TYPE, STRATA, PORT_CODE) %>%
    summarize(N.Pollock = n_distinct(REPORT_ID),
              N.Pollock.Obs = n_distinct(REPORT_ID[Observed.type == "Observed"])) %>%
    mutate(Pct.Obs = format((N.Pollock.Obs / N.Pollock) * 100, digits = 1, nsmall = 1)) %>% 
    select(ADP, FMP, COVERAGE_TYPE, STRATA, PORT_CODE, N.Pollock, N.Pollock.Obs, Pct.Obs) %>%
    ungroup()
  ,
  Pollock.landing.data %>%
    group_by(ADP, COVERAGE_TYPE, STRATA) %>%
    summarize(FMP = as.factor("Total"),
              PORT_CODE = as.factor(""),
              N.Pollock = n_distinct(REPORT_ID),
              N.Pollock.Obs = n_distinct(REPORT_ID[Observed.type == "Observed"])) %>%
    mutate(Pct.Obs = format((N.Pollock.Obs / N.Pollock) * 100, digits = 1, nsmall = 1)) %>%
    select(ADP, FMP, COVERAGE_TYPE, STRATA, PORT_CODE, N.Pollock, N.Pollock.Obs, Pct.Obs) %>% 
    ungroup())

# Isolate observed strata
Pollock.observed <- rbind(
  filter(Pollock.monitored, COVERAGE_TYPE == "Full" & STRATA != "EM TRW BSAI (EFP)"),
  filter(Pollock.monitored, COVERAGE_TYPE == "Partial" & STRATA != "EM TRW GOA (EFP)"))

# Rename columns and format
Pollock.observed.table <- Pollock.observed %>% 
  mutate(N.Pollock = as.character(N.Pollock),
         N.Pollock.Obs = as.character(N.Pollock.Obs),
         FMP = case_when(FMP == "Bering Sea" ~ "BSAI",
                         COVERAGE_TYPE == "Full" ~ "BSAI total",
                         FMP == "Gulf of Alaska" ~ "GOA",
                         COVERAGE_TYPE == "Partial" ~ "GOA total",
                         TRUE ~ FMP)) %>% 
  mutate(COVERAGE_TYPE = case_when(FMP %like% "total" ~ "", TRUE ~ COVERAGE_TYPE) ) %>%
  #mutate(COVERAGE_TYPE = case_when(FMP == "Total" ~ "", TRUE ~ FMP))
  select(`Year` = ADP,
         `FMP` = FMP, 
         `Coverage category` = COVERAGE_TYPE,
         `Port` = PORT_CODE, 
         `Total deliveries (*N*)` = N.Pollock,
         `Observed deliveries (*n*)` = N.Pollock.Obs,
         `% observed` = Pct.Obs) %>%
  arrange(Year)

# Isolate EFP strata
Pollock.efp <- rbind(
  filter(Pollock.monitored, COVERAGE_TYPE == "Full" & STRATA == "EM TRW BSAI (EFP)"),
  filter(Pollock.monitored, COVERAGE_TYPE == "Partial" & STRATA == "EM TRW GOA (EFP)"))

# Rename columns and format
Pollock.efp.table <- Pollock.efp %>% 
  mutate(N.Pollock = as.character(N.Pollock),
         N.Pollock.Obs = as.character(N.Pollock.Obs),
         FMP = case_when(FMP == "Bering Sea" ~ "BSAI",
                         COVERAGE_TYPE == "Full" ~ "BSAI total",
                         FMP == "Gulf of Alaska" ~ "GOA",
                         COVERAGE_TYPE == "Partial" ~ "GOA total",
                         TRUE ~ FMP)) %>% 
  mutate(COVERAGE_TYPE = case_when(FMP %like% "total" ~ "", TRUE ~ COVERAGE_TYPE) ) %>%
  select(`Year` = ADP,
         `FMP` = FMP, 
         `Coverage category` = COVERAGE_TYPE,
         `Port` = PORT_CODE, 
         `Total deliveries (*N*)` = N.Pollock,
         `Observed deliveries (*n*)` = N.Pollock.Obs,
         `% observed` = Pct.Obs) %>%
  arrange(Year)
```

For this analysis, pollock deliveries were defined as any delivery where the predominant species is pollock in eLandings. In `r year`, 100% of full coverage pollock deliveries were monitored in both strata, meeting expectations (`r tbl_nums('Pollock.observed.table.2023', display = "cite")`, `r tbl_nums('Pollock.efp.table.2023', display = "cite")`).\
\
Evaluations of the partial coverage category for dockside monitoring are not as straightforward as for full or zero coverage. As a matter of policy, no tender deliveries are monitored and these deliveries are not included in this chapter. While it may seem intuitive that the expected coverage rate for non-tendered deliveries within the *OB TRW* stratum should be equal to the programmed trip selection rate of 22.68%, this assumption is likely untrue because observers are not deployed specifically into the pollock fishery, but into the entire trawl fishery, and the relationship between the number of deliveries and trips is not expected to be constant, especially when measured across ports. Therefore, we present the dockside observation rates for non-tendered *OB TRW* pollock deliveries and non-tendered *EM TRW EFP* deliveries but make no comparison to the expected deployment rates (`r tbl_nums('Pollock.observed.table.2023', display = "cite")`, `r tbl_nums('Pollock.efp.table.2023', display = "cite")`).

# Sample Quality
## Temporal Patterns in Trip-Selection  
```{r temporal_bias, message=FALSE, warning=FALSE, include=FALSE}
# Changed significantly for 2020 to incorporate multiple time periods  
# Some changes might be worth keeping though  
Max.ts.date <- work.data %>% 
  filter(STRATA %in% partial$STRATA &  STRATA != "EM TRW GOA (EFP)") %>%
  select(TRIP_ID, TRIP_TARGET_DATE, OBSERVED_FLAG, STRATA) %>%
  distinct() %>%
  group_by(TRIP_ID, OBSERVED_FLAG, STRATA) %>%
  mutate(MAX_TARGET_DATE = max(TRIP_TARGET_DATE)) %>%
  select(TRIP_ID, MAX_TARGET_DATE, OBSERVED_FLAG, STRATA) 

# Count the number of total and monitored trips that occurred at each date
For.ts.temporal.plot <- Max.ts.date  %>%
  group_by(STRATA, Date = MAX_TARGET_DATE) %>%
  summarise(N = length(unique(TRIP_ID)), # Number of total trips
            n = length(unique(TRIP_ID[OBSERVED_FLAG == "Y"]))) %>% # Number of observed trips 
  ungroup()

# Fill in missing dates using tidyr::complete()
For.ts.temporal.plot <- For.ts.temporal.plot %>% 
  mutate(Date = as.Date(Date)) %>% 
  complete(nesting(STRATA), Date = seq(as.Date(paste0(year, "-01-01")), as.Date(paste0(year, "-12-31")), by = "day")) %>%
  mutate(YEAR = year(Date))

# Fill in rates
For.ts.temporal.plot <- left_join(For.ts.temporal.plot,
                                  partial %>%
                                    select(c(YEAR, STRATA, Rate)) %>%
                                    distinct(),
                                  by = c("YEAR", "STRATA"))

# Count cumulative number of trips by stratum and year
For.ts.temporal.plot <- 
  For.ts.temporal.plot %>% 
  group_by(YEAR, STRATA) %>%
  mutate(N = ifelse(is.na(N), 0, N),
         n = ifelse(is.na(n), 0, n)) %>% 
  mutate(N.cuml = cumsum(N),
         n.cuml = cumsum(n)) %>% 
  ungroup()

# Calculate the expected number of trips  
# The number of trips that occured prior to the third time period
# is used as a vertical adjustment for the expectations on the plot  
For.ts.temporal.plot <- 
  For.ts.temporal.plot %>%
  group_by(YEAR) %>%
  mutate(n.expected = round((N.cuml * Rate), 0),
         Low95 = qbinom(0.025, N.cuml, Rate),
         High95 = qbinom(0.975, N.cuml, Rate),
         Outside.bounds = ifelse(n.cuml > High95 | n.cuml < Low95, 1, 0),
         Observed.days = ifelse(n > 0, 1, NA)) %>% 
  data.frame()

# Summarise days and portion of the year outside of expected
For.ts.temporal.summary <- 
  For.ts.temporal.plot %>% 
  group_by(YEAR, STRATA) %>% 
  reframe(N.outside = sum(Outside.bounds, na.rm = TRUE),
          Days = sum() ) %>%
  distinct() %>% 
  mutate(`% Outside` = round(N.outside / Days * 100, 1))

# Calculate and store the p.value from a binomial
for.binom <- 
  For.ts.temporal.plot %>% 
  group_by(YEAR, STRATA, Rate) %>% 
  summarize(n = sum(n), 
            N = sum(N)) %>% 
  mutate(p = format(round(stats::binom.test(n, N, Rate)$p.value[1], 3), nsmall = 3),
         estimate = format(round(stats::binom.test(n, N, Rate)$estimate[1], 3), digits = 3, nsmall = 3),
         # Results text with probability of success (estimate) & p-value
         text = paste0("*", STRATA, "* stratum expected rate = ", round(Rate, 3), 
                       ", realized rate = ", estimate, ", *p*-value = ", p)) %>% 
  ungroup()

# Interpretive text indicating whether the strata "were" or "were not" within
# expectations of the binomial distribution
passfail <- ifelse(any(for.binom$p < 0.05), "were not", "were")

```

```{r cum.temporal.plot, message=FALSE, warning=FALSE, include=FALSE}
# Add p-value to data.frame
For.ts.temporal.plot <- left_join(For.ts.temporal.plot,
                                  select(for.binom, c(YEAR, STRATA, p)), by = c("YEAR", "STRATA"))

# Order strata for plot
For.ts.temporal.plot <- transform(For.ts.temporal.plot,
                                  STRATA = factor(STRATA,levels = c("EM FIXED BSAI", "EM FIXED GOA", 
                                                                    "OB FIXED BSAI", "OB FIXED GOA",
                                                                    "OB TRW BSAI", "OB TRW GOA")))

# Add column for dates where coverage is outside expectation, and format p-values
For.ts.temporal.plot <- For.ts.temporal.plot %>%
                        mutate(Date.outside = if_else(Outside.bounds == 1, Date, as.Date(NA))) %>% 
                        mutate(p = ifelse(as.numeric(p) < 0.05, paste0(p, "*"), p)) %>%
                        mutate(p = ifelse(p == "0.000*", paste0("italic(p) < '0.001*'"), paste0("italic(p) == '", p, "'")))

# Create "dummy" dataframe to set limits for x axes
Temporal.plot.x_range <- data.frame(YEAR = rep(year + -1:0, each = 2)) %>%
  mutate(Date = as.Date(paste0(YEAR, c("-01-01", "-12-31"))))

# Single-Year Plot

Temporal.plot <- 
  ggplot(filter(For.ts.temporal.plot, YEAR == year), aes(x = Date)) +
  # Add lines for coverage rates
  geom_line(aes(y = n.cuml), col = "black", linewidth = 2) +
  geom_line(aes(y = n.expected), col = "gray") +
  geom_ribbon(aes(ymin = Low95, ymax = High95), alpha = 0.2) +
  geom_rug(aes(x = Date.outside), sides = "b") +
  facet_grid(factor(STRATA, levels = strata.order) ~., scales = "free", space = "free_x") +
    # Annotate p-values
  geom_text(aes(x = as.Date(-Inf), y = Inf, vjust = 1.25, label = p), 
            hjust = -0.1, size = 4, parse = TRUE, check_overlap = TRUE) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("Cumulative trips in trip-selection strata\n") +
  xlab("\nDate")

```

The cumulative number of fishing trips in each stratum was multiplied by the stratum-specific selection rate to obtain the expected number of observed trips. Under the assumption that there is no temporal bias in observer coverage, 2.5% of values should be larger than the upper 95% confidence limit and 2.5% should be smaller than the lower limit. At the end of `r year` the number of observed trips was outside of this expected range in three of the six partial coverage strata: *OB TRW* (expected rate = 22.7%, realized rate = 32.3%, *p*-value < 0.001), *EM HAL* (expected rate: 30.0%, realized rate: 22.5%, *p*-value < 0.001), and *EM POT* (expected rate = 30.0%, realized rate = 18.7%, *p*-value < 0.001; `r tbl_nums('Coverage.Table.2023', display = "cite")` and `r fig_nums('Temporal.plot', display = "cite")`). The *OB HAL* stratum was outside of the expected range earlier in the year but fell within the expected range by the end of April. Coverage rates were within their expected ranges for 100% of the year for the *OB POT* stratum (expected rate = 17.1%, realized rate = 17.8%, *p*-value = 0.543).

## Spatial Patterns in Trip-Selection  
```{r spatial_bias_analysis, message=FALSE, warning=FALSE, include=FALSE, eval=FALSE}
# Spatial analyses now completed by "spatiotemp_analysis.Rmd" created by Geoff Mayhew (circa 2024)
```

Under a random selection of trips / deliveries the spatial distribution of monitored trips should reflect the spatial distribution of all trips / deliveries. To evaluate whether the actual spatial distribution of monitoring matched what would be expected from random selection or exhibited unlikely spatial patterns, the sample units of each stratum were divided into 200 km wide hexagonal spatial cells (“cells”). The total count of trips actually monitored in each cell was compared to results of 10,000 simulations of randomized trip selection using the actual monitored rate. The difference in the count of actually monitored trips versus the median count was calculated for each simulation. Cells where the count of actually monitored trips in a spatial cell were more extreme than 95% of simulations were identified to represent unlikely outcomes under the assumption of random sampling. By graphically viewing where the spatial distribution of actual monitoring deviated from the distribution provided by the simulations, regional patterns in the over- or under-representation by monitoring could be identified. Maps summarizing these patterns are provided in `r fig_nums('spatial.2023', display = "cite")`.\
\
The only obvious spatial bias in the distribution of monitored trips was in the *OB HAL* stratum, where an unexpectedly high number of trips were monitored in the central GOA near Kodiak and fewer trips were monitored in the western and eastern GOA. Other strata exhibited spatial patterns that were not as pronounced or unexpected. In the *OB POT* stratum, the western GOA was overrepresented in the sample. In the *OB TRW* stratum, there were some slight localized biases in the central GOA, but no spatial cells had an unlikely number of monitored trips. In the *EM HAL* stratum, the central GOA was underrepresented and the eastern GOA was overrepresented. The spatial distribution of monitoring was as expected in the *EM POT* and *EM TRW EFP* strata, with no spatial cells with an unlikely number of monitored trips / deliveries (`r fig_nums('spatial.2023', display = "cite")`).

## Spatiotemporal Distribution of Monitoring Coverage
Under a random selection of trips / deliveries the spatiotemporal distribution of monitoring in a stratum should reflect the spatiotemporal distribution of all trips / deliveries in the stratum. The evaluation methods here are adapted from the proximity index described in the `r year + 1` Draft ADP (NMFSa 2023). The proximity index was defined as the proportion of sample units in a stratum that were either monitored or near a monitored sample unit in space or time. By considering sample units that were neither monitored nor neighboring a monitored trip as a gap in monitoring, the proximity index quantifies the spatiotemporal extent of monitoring coverage.\
\
To calculate the proximity index, sample units were placed into spatiotemporal boxes defined by 200-km hexagonal cells and 1-week time periods. Sample units were allowed to span multiple spatiotemporal boxes and contribute equally to each box (e.g., a trip that crosses three boxes is counted as 0.33 trips in each box). Sample units were identified as monitored or unmonitored using actual or simulated outcomes, and then unsampled trips / deliveries were identified as either neighboring monitored units or not (i.e., in an adjacent spatial cell or week). Lastly, the proximity index was calculated as the sum of the weight of monitored or neighboring sample units divided by the total number of sample units in the stratum. Simulations of random sampling were repeated 10,000 times each using the programmed selection rates and realized monitoring rates. The proportion of sampling iterations that were more extreme than the actual value was calculated to indicate the likelihood of the achieved outcome.\
\
Comparing the proximity indices obtained from real data within each stratum to those obtained by simulated random sampling at rates achieved and rates programmed into ODDS, we can determine how well the distribution of monitoring matched what was expected under random sampling at the actual rates that were achieved and how well the distribution of actual monitoring matched what was expected from selection rates specified in the `r year` ADP.\
\
Proximity indices were calculated for each stratum to evaluate whether coverage met expectations overall (`r fig_nums('interspersion.2023', display = "cite")`), and for the BSAI and GOA separately following the use of Fishery Management Plan (FMP) in the stratum definition for the `r year + 1` ADP (NMFS 2023b, `r fig_nums('interspersion_fmp.2023', display = "cite")`).\
\
The spatiotemporal distributions of monitoring coverage in strata were within the expected ranges (the upper, green distributions of Figures `r fig_nums('interspersion.2023', display = "num")` and `r fig_nums('interspersion_fmp.2023', display = "num")`) with only one exception. The proximity value of the EM HAL stratum was lower than expected (`r fig_nums('interspersion.2023', display = "cite")`), particularly in the GOA (`r fig_nums('interspersion_fmp.2023', display = "cite")`). Therefore, a spatiotemporal bias was apparent in the EM HAL stratum based on the available data. The proximity value for the EM TRW EFP stratum was low but not unexpected, and resulting proximity values were very close to 1 (indicating good spatiotemporal overlap).\
\
The achieved proximity values were within the expected ranges from the sampling rates defined by the ADP (the lower, blue distributions of Figures `r fig_nums('interspersion.2023', display = "num")` and `r fig_nums('interspersion_fmp.2023', display = "num")`) for the *OB HAL*, *OB POT* and *EM TRW EFP* strata. The *OB TRW* stratum had a higher proximity index than expected because it had an unexpectedly high realized monitoring rate. Both fixed-gear EM strata, *EM HAL* and *EM POT*, had lower proximity indices than expected due to the lower than expected realized monitoring rates. At the FMP-level, proximity values for these strata were lower than expected except for in the BSAI of the *EM HAL* stratum, which had a very wide expected range due to low fishing effort and low expected sample size (`r fig_nums('interspersion_fmp.2023', display = "cite")`).

## Trip Metrics  
This section analyzes whether monitored trips are similar to unmonitored trips using a permutation test (a.k.a., randomization test). This test evaluates the question “How likely is the difference we found if these two groups have the same distribution (in the metric we are comparing)?” Permutation tests compare the actual difference found between two groups to the distribution of many differences derived by randomizing the labels defining the two groups (e.g., monitored and unmonitored). Difference values in the permutation test were calculated by subtracting the mean metric value for the “No” condition from the mean metric value for the “Yes” condition. For example, the difference between vessel lengths in a permutation test for a monitoring effect would be the mean value for unmonitored trips subtracted from the mean value for all monitored trips. By randomizing group assignments, the combined distribution of randomized differences represents the sampling distribution under the null hypothesis that the two groups are equal. In this report, 1,000 randomized trials were run for the permutation test. The *p*-value from the test is calculated as the number of randomized trials with greater absolute differences than the actual difference divided by the number of randomized trials. Similar to the other statistical tests used in this report, low *p*-values indicate unlikely events under the hypothesis of equality and are therefore considered evidence against that hypothesis. Unlike other statistical tests used in this report, a Bonferroni adjustment has been applied to the significance threshold of 0.05 by dividing it by the number of metrics being tested. This results in an adjusted significance threshold of 0.05 / 6 = 0.00833. The *p*-values are then compared to the adjusted significance threshold. In an attempt to improve clarity, five values are calculated in the test: (1) the difference between groups, (2) the mean difference between groups from randomized trials, (3) #1 expressed as a percentage of the mean value of the metric being tested, (4) #2 expressed as a percentage of the mean value of the metric being tested and (5) the *p*-value of the test; however, only values (1), (3) and (5) are presented.\
\
Six trip metrics were examined in the permutation test. These metrics were as follows: the number of NMFS Areas visited in a trip, trip duration (days), the weight of the landed catch (t), the vessel length (ft), the number of species in the landed catch and the proportion (0 to 1) of the total catch that is made up of the most predominant species (pMax). The metric ‘vessel length’ is used to help interpret the results from ‘weight of landed catch’ since fishing power is positively correlated to vessel length. Specifically, differences in weight and length are interpreted as a failure to achieve a random sample of vessels of different sizes, whereas differences in weight only lend more evidence that there was a monitoring effect. The number of species within the landed portion of the catch is a measure of species richness. Our pMax metric follows the concepts behind Hill’s diversity number *N*~1~ that depicts the number of abundant species (Hill 1973) and is a measure of how “pure” catch is since a value of one would indicate that only the predominant (and presumed desirable) species was landed.  

### Were monitored trips similar to unmonitored trips?  

```{r perm_results, set.seed(49), message=FALSE, warning=FALSE, include=FALSE}

dat <- 
  work.data %>% 
  filter(ADP == year & STRATA %in% partial$STRATA)

# Identify the field to permute by
YN_var = "OBSERVED_FLAG"

# Identify the fields to group by (don't include TRIP_ID or the YN_var)
gp_vec = c("STRATA")

# Run permutation tests
perm <- permutation.fxn(dat, YN_var, gp_vec, 1000)

# Decompose the output
assign(paste(YN_var, "YN_perm", sep = "."), data.frame(perm[1]))
assign(paste(YN_var, "summary", sep = "."), data.frame(perm[3]))
assign(paste(YN_var, "results", sep = "."), data.frame(perm[4], check.names = FALSE))
assign(paste(YN_var, "Ntable", sep = "."), data.frame(perm[5]))

names(OBSERVED_FLAG.Ntable) <- c("Strata", "Observed", "Unobserved")
OBSERVED_FLAG.Ntable <- arrange(OBSERVED_FLAG.Ntable, match(Strata, c("OB FIXED BSAI", "OB FIXED GOA", "OB TRW BSAI", "OB TRW GOA",
                                                                      "EM FIXED BSAI", "EM FIXED GOA", "EM TRW GOA (EFP)")))
OBSERVED_FLAG.summary <- arrange(OBSERVED_FLAG.summary, match(STRATA, c("OB FIXED BSAI", "OB FIXED GOA", "OB TRW BSAI", "OB TRW GOA", 
                                                                        "EM FIXED BSAI", "EM FIXED GOA", "EM TRW GOA (EFP)")), variable)
perm_sum <- filter(OBSERVED_FLAG.summary, STRATA != "EM TRW EFP")

# See helper.r documentation on interpret_trip_metrics() 
perm_sum <- interpret_trip_metrics(dat = perm_sum)

OBSERVED_FLAG.results <- OBSERVED_FLAG.results %>% mutate(Metric = replace(Metric, Metric == "Observed difference", "OD"))  # Shorten metric
OBSERVED_FLAG.results <- OBSERVED_FLAG.Ntable %>% 
  merge(OBSERVED_FLAG.results, by = "Strata") %>%           # Merge in trip counts of observed/unobserved
  mutate(Observed = formatC(Observed, big.mark = ","),      # Format trip counts
         Unobserved = formatC(Unobserved, big.mark = ","))

# REFORMAT RESULTS TABLE:
OBSERVED_FLAG.results <- rbind(
  OBSERVED_FLAG.results %>% 
    filter(Metric %in% c("OD", "OD (%)")) %>% 
    mutate(across(unique(OBSERVED_FLAG.YN_perm$variable), ~ format(.x, nsmall = 3, digits = 3))),
  OBSERVED_FLAG.results %>% 
    filter(Metric %in% c("p-value")) %>% 
    # Test against Bonferroni-adjusted alpha (0.05/ number of metrics)
    mutate(across(unique(OBSERVED_FLAG.YN_perm$variable), ~ ifelse(as.numeric(.x) < 0.05/length(unique(OBSERVED_FLAG.YN_perm$variable)),
                                                                   paste0(format(.x, nsmall = 3, digits = 3), "*"), 
                                                                   format(.x, nsmall = 3, digits = 3))))) %>% 
  arrange(match(Strata, c("OB FIXED BSAI", "OB FIXED GOA",  "OB TRW BSAI", "OB TRW GOA", 
                          "EM FIXED BSAI", "EM FIXED GOA","EM TRW GOA (EFP)")), Metric)

# Replace "0" p-values; extra space in character is an artifact of the previous format()

OBSERVED_FLAG.results[OBSERVED_FLAG.results == "0.000*"] <- "< 0.001*"
OBSERVED_FLAG.results[OBSERVED_FLAG.results$Metric == "p-value",]$Metric <- "*p*-value"
OBSERVED_FLAG.results <- OBSERVED_FLAG.results %>% filter(Strata != "EM TRW GOA (EFP)")
```

The sample sizes available and the results of permutation tests are presented in `r tbl_nums('perm.summary.table.2023', display = "cite")`. A visual depiction of individual results of this permutation test is given in `r fig_nums('Obs.perm.plot', display = "cite")` for illustration purposes. Observed trips in the *OB HAL* stratum were 16.1% (0.94 days) shorter in duration and landed catch that weighed 22.4% (1.56 metric tons) less than unobserved trips. This pattern was also evident in 2022 (Appendix A, Table A-8). Observed trips in the *EM HAL* stratum landed 12.9% (0.53) more species than unobserved trips. Observed trips in the *OB TRW* stratum landed catch that was 2.3% more diverse than unobserved trips.

# Response to Council and SSC Comments

The Council reviewed the `r year` ADP as part of their 11 June 2022 meeting and made the following recommendation:\
\
*The Council supports maintaining the stratification and allocation strategy from the 2022 ADP in 2023. The Council also supports (1) additional fixed gear EM vessels (30% coverage) in the EM pool in 2023 (up to 200 total vessels) provided they opt-in prior to 1 November 2022, additional funding for EM equipment is secured, and they meet the criteria in the ADP and (2) continuation of the pelagic trawl EM project with 100% at-sea monitoring in addition to shoreside observer coverage.*\
\
The SSC has requested that a specific section with responses to SSC comments be provided in the written report, as is done for SAFE documents. The SCC last reviewed the results of this chapter during the presentation of the 2017 Annual Report made at the June 2018 Council meeting.\
\
In January 2022, the SSC reviewed a presentation made by industry and the AKRO on the proposed elements of what is now the *EM TRW EFP* stratum. Items raised related to the replacement of at-sea observers with EM included:

1. The pollock stock assessment team should be closely consulted concerning whether loss of haul level spatial information will impact any ongoing or future analyses and how the data changes will be treated in the assessment (e.g., effective sample sizes for biological collections, weighting of samples from tenders vs individual vessels). It will be essential that authors are prepared to incorporate these new data streams before they become permanent rather than being done in a post hoc manner.\
2. Provide details on how catches and biological data could be assigned to trip- or haul-level information when catches from multiple catcher vessels are mixed on tenders, or how pooled data can be tracked and analyzed appropriately.\
3. Confirmation that this program will not result in a loss of overall specimen and biological samples, particularly in the GOA where this can be most challenging.\
4. Evaluate the potential for large shifts in discard estimates during the year within CAS as compliance monitoring is completed on video review.\
5. Provide more detailed numbers in the next iteration, including examples of biological samples before and after the EFP.\
6. An illustrative example of how salmon PSC calculations would be different under this program would be helpful, including a GOA and BSAI example.

The data used in this and prior Annual Reports are available to answer items 2, 3, 5 and 6 should staff resources at the AKRO and FMA be allocated to this task.

# FMSC Recommendations to Improve Data Quality
  
## Recommendations from the `r year` Annual Deployment Review

The Fisheries Monitoring Science Committee (formerly the Observer Science Committee) reviewed the results off ODDS and EM data timeliness from this report on 30 April 2024, and made the following recommendations to be considered in developing the `r year + 2` ADP.  

- ODDS\
**Work with the Partial Coverage Fishery Monitoring Advisory Committee to find an ODDS trip cancellation policy that will not significantly impede industry, affords the observer provider adequate time, and reduces impacts to coverage rates and non-random monitoring. This new policy should be decided on in time for implementation as part of the 2025 Annual Deployment Plan.**\
- Fixed-gear EM review times:\
**The NMFS should work with the EM review agency PSMFC to find a selection rate that provides timely data that achieves the goals of the monitoring program in a cost-effective manner.** The FMA needs all data reviewed by April of the following year for annual reports (a three month delay maximum) while stock assessors need data from the prior year by September (a eight month delay maximum).\
\
The FMSC recognizes that EM review times are not fast enough for the purposes of in-season management and suggests that **the NMFS perform an analysis of impacts of missing EM data and risks to management and the stocks of not having these data available (e.g., risk of exceeding Total Allowable Catch and PSC, risk of premature or late fishery closures, etc.)**

\newpage

# Citations
AFSC (Alaska Fisheries Science Center) and AKRO (Alaska Regional Office). 2023. North Pacific Observer Program 2022 Annual Report. Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 7600 Sand Point Way N.E., Seattle, Washington 98115. Available online at: https://meetings.npfmc.org/CommentReview/DownloadFile?p=fc3716c4-6d4a-486e-9de1-e9f224d905da.pdf&fileName=North%20Pacific%20Observer%20Program%202022%20Annual%20Report.pdf

AFSC (Alaska Fisheries Science Center). 2022. 2023 Observer Sampling Manual. Fisheries Monitoring and Analysis Division, North Pacific Groundfish Observer Program. AFSC, 7600 Sand Point Way N.E., Seattle, Washington, 98115. Available online at: https://s3.amazonaws.com/media.fisheries.noaa.gov/2023-06/2023-Observer-Sampling-Manual-508-5-3-23.pdf

Cahalan, J. and C. Faunce. 2020. Development and Implementation of a Fully Randomized Sampling Design for a Fishery Monitoring Program. Fishery Bulletin 118:87–99. doi: 10.7755/FB.118.1.8.

Cahalan, J., J. Mondragon, and J. Gasper. 2014. Catch Sampling and Estimation in the Federal Groundfish Fisheries Off Alaska: 2015 Edition. U.S. Dep. Commer., NOAA Tech. Memo. NMFS-AFSC-286, 46 p.

Faunce, C. H. 2015. Evolution of Observer Methods to Obtain Genetic Material from Chinook Salmon Bycatch in the Alaska Pollock Fishery. U.S. Dep. Commer., NOAA Tech. Memo. NMFS-AFSC-288, 28 p.

`r if(tech.memo){'Faunce, C. H., and Barbeaux, S. J. 2011. The frequency and quantity of Alaskan groundfish catcher-vessel landings made with and without an observer. ICES J. Mar. Sci. 68:1757-1763.'}`  

Hill, M.O. 1973. Diversity and Evenness: A Unifying Notation and Its Consequences. Ecology 61:225–236. doi: 10.2307/1934352.

`r if(tech.memo){'Nelson Jr., R., R. French, R. and J. Wall. 1981. Sampling by U.S. observers on foreign fishing vessels in the eastern Bering Sea and Aleutian Island region, 1977-78. Mar. Fish. Rev. 43:1-19.'}`  

NMFS (National Marine Fisheries Service). 2023a. Draft 2024 Annual Deployment Plan for Observers and Electronic Monitoring in the Partial Coverage Groundfish and Halibut Fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street, Juneau, Alaska 99802. Available online at: https://www.fisheries.noaa.gov/resource/document/draft-2024-annual-deployment-plan-and-partial-coverage-cost-efficiencies-analysis

NMFS (National Marine Fisheries Service). 2023b. 2024 Annual Deployment Plan for Observers and Electronic Monitoring in the Groundfish and Halibut Fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street, Juneau, Alaska 99802. Available online at: https://www.fisheries.noaa.gov/s3//2023-11/Final-2024-ADP.pdf

NMFS (National Marine Fisheries Service). 2022. 2023 Annual Deployment Plan for Observers and Electronic Monitoring in the Groundfish and Halibut Fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street, Juneau, Alaska 99802. Available online at: https://www.fisheries.noaa.gov/resource/document/2023-annual-deployment-plan-observers-and-electronic-monitoring-groundfish-and

NMFS. 2013. 2014 Annual Deployment Plan for Observers in the Groundfish and Halibut Fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street, Juneau, Alaska 99802. Available online at: https://media.fisheries.noaa.gov/dam-migration/final2014adp.pdf

\newpage

`r if(tech.memo){'# Tables'}`

`r tbl_nums('trip.budget.tbl', caption = paste0('Comparison between predicted and actual trip days for partial coverage strata in ', year,'.  Predicted values come from the ', year,' Annual Deployment Plan (ADP).'))`  

```{r trip.budget.tbl, tab.cap=""}

trip.budget.table <- trip.budget.table %>%
  mutate(pred_days = as.numeric(pred_days),
         act_days = as.numeric(act_days)) %>%
  arrange(factor(STRATA, levels = strata.order))

flextable(trip.budget.table) %>%
  italic(j = 1, i = 1:(nrow(trip.budget.table) - 1)) %>%
  bold(bold = TRUE, part = "header") %>%
  hline(i = v_diff(trip.budget.table$STRATA, 1, 2)) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  add_header_row(values = c("", "Trip days", "Difference"), colwidths = c(1, 2, 2)) %>%
  align(j = 2:5, part = "all", align = "right") %>%
  align(i = 1, part = "header", align = "center") %>%
  width(j = 1, 1.5, unit = "in") %>%
  set_header_labels(values = list(
    STRATA = "Strata",
    pred_days = "Predicted",
    act_days = "Actual",
    diff = "Actual",
    perc = "Percent")) %>%
  width(j = 2, 0.8, unit = "in")
```

\endLandscape

`r tbl_nums('disposition.table' , caption = paste0('Trip cancellation rates in the ODDS for ', year, '. A trip is canceled by the system if the user did not identify whether fishing had occurred by the end of the year. “Paper” indicates that a trip was logged when the ODDS was not available.'))` 
  
```{r disposition.table, tab.cap=""}
# Table 2 from 2019 Annual Report

disposition.table <- disposition.table %>%
  mutate(Year = as.factor(Year),
         `Logged (*a*)` = as.numeric(`Logged (*a*)`),
         `Trips remaining (*c* = *a*-*b*)` = as.numeric(`Trips remaining (*c* = *a*-*b*)`)) %>%
  arrange(factor(Strata, levels = strata.order))

disposition.table <- disposition.table %>%
  filter(Year == year) %>%
  select(-Year)

flextable(disposition.table) %>%
  mk_par(j = 3, part = "header",
         value = as_paragraph("Logged (", as_i("a"), ")")) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Canceled by system (", as_i("b"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Trips remaining (", as_i("c"), " = ", as_i("a"), " - ", as_i("b"), ")")) %>%
  mk_par(j = 6, part = "header",
         value = as_paragraph("Canceled by user (", as_i("d"), ")")) %>%
  mk_par(j = 9, part = "header",
         value = as_paragraph("% user cancellation (", as_i("d"), "/", as_i("c"), " \U00D7 100)")) %>%
  italic(j = 1, i = 1:10) %>%
  align(j = 3:10, part = "all", align = "right") %>%
  valign(part = "header", valign = "bottom") %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = 1) %>%
  hline(i = seq(2, nrow(disposition.table), 2)) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 1.23, unit = "in") %>%
  width(j = 2, 1.38, unit = "in") %>%
  width(j = 3, 0.88, unit = "in") %>%
  width(j = 4, 1, unit = "in") %>%
  width(j = c(5:6, 9), 0.94, unit = "in") %>%
  width(j = 7, 0.69, unit = "in") %>%
  width(j = 8, 0.56, unit = "in") %>%
  width(j = 10, 0.63, unit = "in")
```

\newpage

`r tbl_nums('logged.table', caption = paste0('Number of remaining trips after cancellation in each trip-selection stratum that were selected using the initial random number generator ("Random number selection") and those that remained after user manipulation ("Total final selected") in ', year, '. The relative impact of waivers in trip-selection is also shown ("% reduction of selected trips due to waivers). **Selections not from random numbers.'))` 

```{r logged.table, tab.cap=""}
# Table 3 from 2019 Annual Report

logged.table <- logged.table %>%
  mutate(Year = as.factor(Year),
         `Total Trips` = as.numeric(`Total Trips`)) %>%
  arrange(factor(Strata, levels = strata.order)) %>%
  ungroup() #' *SHOULD PROBABLY DEAL WITH THIS GROUPING EARLIER*

logged.table <- logged.table %>%
  filter(Year == year) %>%
  select(-Year)

flextable(logged.table) %>%
  mk_par(j = 3, part = "header", 
         value = as_paragraph("Random number selection (", as_i("r"), ")")) %>%
  mk_par(j = 4, part = "header", 
         value = as_paragraph("Inherited selection **(", as_i("i"), ")")) %>%
  mk_par(j = 5, part = "header", 
         value = as_paragraph("Waived (", as_i("w"), ")")) %>%
  mk_par(j = 6, part = "header", 
         value = as_paragraph("Total final selected\n (", as_i("T"), " = ", as_i("r"), " + ", as_i("i"), " - ",
                              as_i("w"), ")")) %>%
  mk_par(j = 7, part = "header", 
         value = as_paragraph("% selected from inherits ((", as_i("i"), "/", as_i("T"), ") \U00D7 100)")) %>%
  mk_par(j = 8, part = "header",
         value = as_paragraph("% reduction of selected trips due to waivers\n (", as_i("w"), "/(", as_i("T"), " + ",
                              as_i("w"), ") \U00D7 100)")) %>%
  align(j = ~ . - Strata, part = "all", align = "right") %>%
  valign(part = "header", valign = "bottom") %>%
  italic(j = 1, i = 1:6) %>%
  bold(bold = TRUE, part = "header") %>%
  hline(i = v_diff(logged.table$Strata, 1, 2)) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 1.23, unit = "in") %>%
  width(j = c(2, 5), 0.94, unit = "in") %>%
  width(j = 3, 1.31, unit = "in") %>%
  width(j = c(4, 6:7), 1.06, unit = "in") %>%
  width(j = 8, 1.69, unit = "in")
```

\newpage

`r tbl_nums('Selection.table', caption = paste0('Number of logged trips in each partial coverage stratum in ', year, ' that were selected using the initial random number generator ("Initial random selection") and those that remained after user manipulation ("After cancellations"). The relative impact of inherits and waivers in trip-selection is also shown ("With inherits", "After waivers").'))`  

```{r Selection.table, tab.cap=""}

Selection.table <- Selection.table %>%
  mutate(Year = as.factor(Year)) %>%
  arrange(factor(Strata, levels = strata.order))

Selection.table <- Selection.table %>%
  filter(Year == year) %>%
  select(-Year)

flextable(Selection.table) %>%
  set_header_labels(values = list(
    n = "Selected trips",
    N = "Total trips",
    Actu = "Actual (%)",
    Prog = "Programmed (%)")) %>%
  mk_par(j = 7, part = "header",
         value = as_paragraph(as_i("p"), "-value")) %>%
  mk_par(j = 2, i = seq(1, nrow(Selection.table), 4), part = "body",
         value = as_paragraph("Initial random selection, ", as_i("a"))) %>%
  mk_par(j = 2, i = seq(2, nrow(Selection.table), 4), part = "body",
         value = as_paragraph("After cancellations, ", as_i("b"), " (", as_i("a"), " - ", as_i("b"), ")")) %>%
  mk_par(j = 2, i = seq(3, nrow(Selection.table), 4), part = "body",
         value = as_paragraph("With inherits, ", as_i("c"), " (", as_i("a"), " - ", as_i("b"), " + ", as_i("c"), ")")) %>%
  mk_par(j = 2, i = seq(4, nrow(Selection.table), 4), part = "body",
         value = as_paragraph("After waivers, ", as_i("d"), " (", as_i("a"), " - ", as_i("b"), " + ", 
                              as_i("c"), " - ", as_i("d"), ")")) %>%
  align(j = 3:7, part = "all", align = "right") %>%
  valign(part = "header", valign = "bottom") %>%
  align(j = 2, align = "left") %>%
  bold(bold = TRUE, part = "header") %>%
  italic(j = 1) %>%
  merge_v(j = 1) %>%
  hline(i = seq(4, nrow(Selection.table), 4)) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 1.23, unit = "in") %>%
  width(j = 2, 2.06, unit = "in") %>%
  width(j = 3, 1.06, unit = "in") %>%
  width(j = 4:5, 0.88, unit = "in") %>%
  width(j = 6, 1.31, unit = "in") %>%
  width(j = 7, 0.69, unit = "in")
```

\newpage

`r tbl_nums('Coverage.Table', caption = paste0('Number of total vessels (*V*), sampled vessels (*v*), total trips (*N*) and sampled trips (*n*) for each stratum in ', year, '. The coverage and 95% confidence interval columns are expressed as percentages of the total number of trips taken within each stratum.'))`  

```{r Coverage.Table, tab.cap=""}

Coverage.Table <- Coverage.Table %>% 
  mutate(Strata = as.character(Strata),
         Year = as.factor(Year),
         V = as.numeric(V),
         v = as.numeric(v),
         N = as.numeric(N),
         n = as.numeric(n)) %>% 
  mutate(Strata = ifelse(Coverage %in% c("Full coverage total", "Partial coverage total"), as.character(Coverage), Strata)) %>%
  mutate(Coverage = case_when(Coverage == "Partial coverage total" ~ "Partial coverage",
                              Coverage == "Full coverage total" ~ "Full coverage",
                              Coverage == "Total" ~ "Zero coverage",
                              TRUE ~ Coverage)) %>%
  arrange(factor(Strata, levels = strata.order)) %>%
  arrange(factor(Coverage, levels = c("Full coverage", "Partial coverage", "Zero coverage")))
 
Coverage.Table <- Coverage.Table %>%
  filter(Year == year) %>%
  select(-Year)

as_grouped_data(Coverage.Table, groups = "Coverage") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  bold(bold = TRUE, part = "header") %>%
  bold(i = ~ !is.na(Coverage)) %>%
  bold(j = 1, i = ~ Strata == "Total") %>%
  italic(j = 1, i = ~ !is.na(Strata) & !(Strata %like% "total")) %>%
  italic(j = c("V", "v", "N", "n"), part = "header") %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  flextable::surround(i = ~ !is.na(Coverage) | Strata == "Total",
                      border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  flextable::surround(i = ~ Strata %like% "total", border.top = fp_border(width = 1, style = "dashed")) %>%
  add_header_row(values = c("", "Coverage", "95% confidence interval", ""), colwidths = c(5, 2, 2, 1)) %>%
  width(j = 1, 1.5, unit = "in") %>%
  width(j = 2:3, 0.38, unit = "in") %>%
  width(j = 4:5, 0.5, unit = "in") %>%
  width(j = 6:7, 0.75, unit = "in") %>%
  width(j = 8:9, 0.58, unit = "in") %>%
  width(j = 10, 1.77, unit = "in") %>%
  align(j = 2:10, part = "all", align = "right") %>%
  align(j = 7, i = 15, align = "left") %>%
  align(i = 1, part = "header", align = "center") %>%
  valign(part = "header", valign = "bottom") %>%
  merge_at(j = 7:10, i = 15) %>%
  padding(j = 7, i = 15, part = "body", padding.left = 35)
```

\newpage

`r tbl_nums('Pollock.observed.table.2023', caption = paste0('The number of pollock deliveries made by vessels in the *OB TRW* stratum during ', year, ', separated by port and coverage category. Trips that made a delivery to a tender have been excluded. Observed deliveries denote deliveries that were observed shoreside for salmon.'))`  

```{r Pollock.observed.table, tab.cap=""}

Pollock.observed.table <- 
  Pollock.observed.table %>%
  mutate(Year = as.factor(Year),
         `Total deliveries (*N*)` = as.numeric(`Total deliveries (*N*)`),
         `Observed deliveries (*n*)` = as.numeric(`Observed deliveries (*n*)`))

Pollock.observed.table <- Pollock.observed.table %>% filter(Year == year) %>% select(-Year)

flextable(Pollock.observed.table) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Total deliveries (", as_i("N"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Observed deliveries (", as_i("n"), ")")) %>%
  align(j = 4:6, part = "all", align = "right") %>%
  align(j = 1:3, part = "all", align = "left") %>%
  valign(part = "header", valign = "bottom") %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = c("FMP", "Coverage category")) %>%
  flextable::surround(i = ~FMP %like% "total", border.bottom = fp_border(width = 1), border.top = fp_border(style = "dashed")) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.81, unit = "in") %>%
  width(j = 2, 1.39, unit = "in") %>%
  width(j = 3, 1, unit = "in") %>%
  width(j = 4, 1.44, unit = "in") %>%
  width(j = 5, 1.69, unit = "in") %>%
  width(j = 6, 0.94, unit = "in")
```

\newpage

`r tbl_nums('Pollock.efp.table.2023', caption = paste0('The number of pollock deliveries made by vessels in the *EM TRW EFP* stratum during ', year, ', separated by port and coverage category. Trips that made a delivery to a tender have been excluded. Observed deliveries denote deliveries that were observed shoreside for salmon.'))`  

```{r Pollock.efp.table, tab.cap=""}

Pollock.efp.table <-
  Pollock.efp.table %>%
    mutate(Year = as.factor(Year),
         `Total deliveries (*N*)` = as.numeric(`Total deliveries (*N*)`),
         `Observed deliveries (*n*)` = as.numeric(`Observed deliveries (*n*)`))

Pollock.efp.table <- Pollock.efp.table %>% filter(Year == year) %>% select(-Year)

flextable(Pollock.efp.table) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Total deliveries (", as_i("N"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Observed deliveries (", as_i("n"), ")")) %>%
  align(j = 4:6, part = "all", align = "right") %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = c("FMP", "Coverage category")) %>%
  flextable::surround(i = ~FMP %like% "total", border.bottom = fp_border(width = 1), border.top = fp_border(style = "dashed")) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.81, unit = "in") %>%
  width(j = 2, 1.39, unit = "in") %>%
  width(j = 3, 1, unit = "in") %>%
  width(j = 4, 1.44, unit = "in") %>%
  width(j = 5, 1.69, unit = "in") %>%
  width(j = 6, 0.94, unit = "in")
```

\newpage

`r tbl_nums('perm.summary.table', caption = paste0('Results of permutation tests between monitored and unmonitored trips in the ', year, ' trip-selection strata. OD: Observed difference (monitored - unmonitored). Observed and unobserved columns are in units of trips. Statistically significant results are in bold italics.'))`  

```{r perm.summary.table, tab.cap=""}

OBSERVED_FLAG.results.sig <- lapply(OBSERVED_FLAG.results, function(x) grepl("[*]", x))

flextable(OBSERVED_FLAG.results) %>%
  bold(bold = TRUE, part = "header") %>%
  italic(j = 1, part = "body") %>%
  hline(i = seq(3, nrow(OBSERVED_FLAG.results), 3)) %>%
  flextable::surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
   mk_par(j = 4, i = seq(3, nrow(OBSERVED_FLAG.results), 3), part = "body",
         value = as_paragraph(as_i("p"), "-value")) %>%
  merge_v(j = c("Strata", "Observed", "Unobserved")) %>%
  align(j = 2:10, part = "all", align = "right") %>%
  valign(j = 1:3, part = "body", valign = "top") %>%
  valign(part = "header", valign = "bottom") %>%
  fix_border_issues() %>%
  width(j = 1, 1.23, unit = "in") %>%
  width(j = 2, 0.81, unit = "in") %>%
  width(j = c(3, 6), 0.94, unit = "in") %>%
  width(j = 4, 0.69, unit = "in") %>%
  width(j = 5, 1, unit = "in") %>%
  width(j = c(7, 10), 1.25, unit = "in") %>%
  width(j = 8, 1.13, unit = "in") %>%
  width(j = 9, 1.03, unit = "in") %>%
  bold(j = 5, i = OBSERVED_FLAG.results.sig[[5]]) %>%
  bold(j = 6, i = OBSERVED_FLAG.results.sig[[6]]) %>%
  bold(j = 7, i = OBSERVED_FLAG.results.sig[[7]])%>%
  bold(j = 8, i = OBSERVED_FLAG.results.sig[[8]])%>%
  bold(j = 9, i = OBSERVED_FLAG.results.sig[[9]])%>%
  bold(j = 10, i = OBSERVED_FLAG.results.sig[[10]])
```

\endPortrait

`r if(tech.memo){'# Figures'}`

```{r outcomes.plot, warning=FALSE, fig.width=7.5, fig.height=9, dpi = 600}

# Make a list of grobs of your figures, set the widths as the maximum among the figures.
arrange.plot.fxn <- function(plotA, plotB){
  plot_grobs <- lapply(list(plotA, plotB), ggplotGrob)
  
  lst <- vector(mode = "list", length = 2)
  for(i in seq_along(plot_grobs)) {
  lst[[i]] <- plot_grobs[[i]]$widths
  }
  
  for(i in 1:length(plot_grobs)) plot_grobs[[i]]$widths <- do.call(grid::unit.pmax, lst)
  grid.arrange(plot_grobs[[1]], plot_grobs[[2]], nrow = 2)
}

arrange.plot.fxn(outcomes.plot, costs.plot)
```

`r fig_nums('outcomes.plot', caption = paste0('Total number of observer sea days purchased (top panel) and total cost of observing those sea days (bottom panel). Vertical bars signify the range of potential outcomes predicted by the ', year, ' Annual Deployment Plan. Dashed lines signify expected outcomes. Solid lines signify what actually occurred in ', year, '.'))`  

\newpage

```{r odds.by.date.plot, fig.width=7.5, fig.height=8, dpi=600}
suppressWarnings(print(odds.by.date.plot))
```

`r fig_nums('odds.by.date.plot', caption = paste0('Rate of selected trips logged into ODDS during ', year, ' organized by original date entered for all trips (gray line and gray text), and final date considering only non-canceled trips (black line and black text). The programmed selection rate is depicted as the dotted line. Gray shaded areas denote the range of coverage rate corresponding to the 95% confidence intervals expected from the binomial distribution. Vertical tick marks on the x-axis depict dates when selected trips were canceled (gray, on the bottom) and when inherited trips were monitored (black, on the top).'))` 

\newpage

```{r em.times.figure, warning=FALSE, fig.width=7.5, fig.height=6, dpi=600, eval=FALSE}
suppressMessages(print(em.times.figure))
```

`r fig_nums('em.times.figure', caption = "Distributions of data timeliness (the time between a trip or delivery ending and those monitoring data being available for catch accounting) by stratum. Dashed red lines and annotations show mean data timeliness.")`  

\newpage

```{r Temporal.plot, warning=FALSE, fig.width=7.5, fig.height=8, dpi=600}
print(Temporal.plot)
```

`r fig_nums('Temporal.plot', caption = paste0('Cumulative number of trips monitored during ', year, ' (black line) compared to the expected range of observed trips (shaded ribbon) given fishing effort and sampling rates. Dates where the monitored number of trips is outside of expected (less or more than the range) are depicted as tick marks on the x-axis. Test results (using a binomial distribution) determining if the observed rate was sampled at the selection rate are denoted as *p*-values.'))`  

\newpage

`r fig_nums('spatial', caption = paste0('Spatial patterns of the distribution of monitoring in partial coverage in ', year, '. Each hexagonal spatial cell is 200 km wide. The numbers in the cells represent the difference in the number of trips / deliveries actually monitored relative to the median of 10,000 simulations of random sampling using the stratum’s realized monitoring rate. Cells without a number had the same number of monitored trips / deliveries as the median of the simulations (difference of zero). Cells where the actual number of monitored trips / deliveries was more extreme than 80% of simulated outcomes are colored pink (fewer trips / deliveries than expected) or green (more), and those cells with a more extreme outcome than 95% of simulated outcomes are outlined in blue with bold text.'))`

\newpage

`r fig_nums('interspersion', caption = paste0('Stratum-level proximity indices in partial coverage in ', year, '. The purple vertical dashed line represents actual proximity indices. The distributions show the proximity values obtained from 10,000 simulations of random sampling, where the upper (green) distribution sampled using the realized monitoring rate and the lower (blue) distribution used the programmed monitoring rate. The 2.5% tails of the distributions are shaded darker to represent unlikely outcomes. The number of sample units in each stratum is displayed in the upper-left of each facet. Note the varying scales of the x-axes between facets.'))`

\newpage

`r fig_nums('interspersion_fmp', caption = paste0('Stratum and FMP-level proximity indices in partial coverage in ', year, '. The purple vertical dashed line represents actual proximity indices. The distributions show the proximity values obtained from 10,000 simulations of random sampling, where the upper (green) distribution sampled using the realized monitoring rate and the lower (blue) distribution used the programmed monitoring rate. The 2.5% tails of the distributions are shaded darker to represent unlikely outcomes. The number of sample units in each stratum and FMP is displayed in the upper-left of each facet. Note the varying scales of the x-axes between facets.'))`

\newpage

```{r Obs.perm.plot, fig.height=11, fig.width=8, message=FALSE, warning=FALSE, dpi=600}
# Plot results
OBSERVED_FLAG.YN_perm_plot <- ungroup(OBSERVED_FLAG.YN_perm) %>% mutate(STRATA = as.character(STRATA)) 
OBSERVED_FLAG.summary_plot <- ungroup(OBSERVED_FLAG.summary) %>% mutate(STRATA = as.character(STRATA)) %>% 
  # Apply Bonferroni adjustment to alpha value and format significant p-values  
  mutate(p = ifelse(p < (0.05 / length(unique(OBSERVED_FLAG.summary$variable))), paste0(formatC(p,digits = 3, format = "f"), "*"), formatC(p, digits = 3, format = "f"))) %>%
  mutate(p = ifelse(p == "0.000*", 
                    paste0("italic(p) < '0.001*'"), 
                    ifelse(p < (0.05 / length(unique(OBSERVED_FLAG.summary$variable))), paste0("italic(p) == '", p, "*'"), paste0("italic(p) == '", p, "'"))))

# Filter out EM TRW EFP stratum
OBSERVED_FLAG.YN_perm_plot <- OBSERVED_FLAG.YN_perm_plot %>% filter(STRATA != "EM TRW EFP")
OBSERVED_FLAG.summary_plot <- OBSERVED_FLAG.summary_plot %>% filter(STRATA != "EM TRW EFP")

# Generate permutation plot 
Obs.perm.plot <- ggplot(OBSERVED_FLAG.YN_perm_plot, aes(x = perm_result_pct)) +
  geom_histogram(aes(y = ..density..), col = "white", fill = "gray", bins = 30) +
  geom_density(fill = "gray", alpha = 0.5, adjust = 3) +
  geom_vline(aes(xintercept = 0), col = "black", lty = 3, linewidth = 1) +
  geom_vline(aes(xintercept = obs.diff_pct), col = "red") +
  facet_wrap(factor(STRATA, levels = c("OB FIXED BSAI", "OB FIXED GOA", 
  "OB TRW BSAI", "OB TRW GOA", "EM FIXED BSAI", "EM FIXED GOA")) ~ variable, scales = "free", 
             # Make number of cols in facet_wrap = to number of strata
             ncol = length(unique(OBSERVED_FLAG.YN_perm_plot$STRATA)), dir = "v") +
  geom_label(data = OBSERVED_FLAG.summary_plot, aes(label = paste(p), fill = factor(p %like% "\\*", levels = c(TRUE, FALSE))), 
             x = -Inf, y = Inf, hjust = -0.1, vjust = 1.2, size = 3, parse = TRUE, label.padding = unit(0.15, "lines")) +
  scale_fill_manual(values = c("pink", "white"), guide = FALSE) + 
  fig.theme +
  xlab("\nDifference (%) of observed minus unobserved trips relative to the mean") +
  ylab("Density of outcomes\n") + 
  theme(strip.text.x = element_text(size = 8, margin = margin(0.1, 0.1, 0.1, 0.1, unit = "lines")))

Obs.perm.plot
```

`r fig_nums('Obs.perm.plot', caption = paste0('Results from permutation tests depicting percent differences between monitored and unmonitored trips by strata in the partial coverage category. Gray bars depict the distribution of differences between monitored and unmonitored trips when the assignment of monitoring status has been randomized (this represents the sampling distribution under the null hypothesis that monitored and unmonitored trips are the same). The vertical red solid line denotes the actual difference between monitored and unmonitored trips. Values on the x-axis have been scaled to reflect the relative (%) differences in each metric. The *p*-value for each test is denoted in the upper left corner. Low *p*-values (shaded pink) are reason to reject the null hypothesis and conclude that there is an observer effect.'))`  

\newpage

This page intentionally blank

\newpage

# Appendix A: Deployment Performance Results in `r year - 1`
This appendix presents tables and figures from analyses performed in Chapter 3 using `r year - 1` data that were not included in the `r year - 1` Annual Report.

Table A-1. -- Comparison between predicted and actual trip days for partial coverage strata in `r year - 1`. Predicted values come from the `r year - 1` Annual Deployment Plan (ADP). 

```{r trip.budget.tbl.2022, tab.cap=""}

trip.budget.table.2022 <- trip.budget.table.2022 %>%
  mutate(pred_days = as.numeric(pred_days),
         act_days = as.numeric(act_days)) %>%
  arrange(factor(STRATA, levels = strata.order))

# 2022

flextable(trip.budget.table.2022) %>%
  italic(j = 1, i = 1:6) %>%
  bold(bold = TRUE, part = "header") %>%
  hline(i = c(3, 6, nrow(trip.budget.table.2023)), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  add_header_row(values = c("", "Trip days", "Difference"), colwidths = c(1, 2, 2)) %>%
  align(j = 2:5, part = "all", align = "right") %>%
  align(i = 1, part = "header", align = "center") %>%
  width(j = 1, 1.125, unit = "in") %>%
    set_header_labels(values = list(
    STRATA = "Strata",
    pred_days = "Predicted",
    act_days = "Actual",
    diff = "Actual",
    perc = "Percent")) %>%
  width(j = 2, 0.8, unit = "in")
```

\endLandscape

Table A-2. -- Trip cancellation rates in the ODDS for `r year - 1`. A trip is canceled by the system if the user did not identify whether fishing had occurred by the end of the year. “Paper” indicates that a trip was logged when the ODDS was not available. 
  
```{r disposition.table.2022, tab.cap=""}
# Table 2 from 2019 Annual Report

# 2022

disposition.table.2022 <- disposition.table %>%
  filter(Year == 2022) %>%
  select(-Year)

flextable(disposition.table.2022) %>%
  mk_par(j = 3, part = "header",
         value = as_paragraph("Logged (", as_i("a"), ")")) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Canceled by system (", as_i("b"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Trips remaining (", as_i("c"), " = ", as_i("a"), " - ", as_i("b"), ")")) %>%
  mk_par(j = 6, part = "header",
         value = as_paragraph("Canceled by user (", as_i("d"), ")")) %>%
  mk_par(j = 9, part = "header",
         value = as_paragraph("% user cancellation (", as_i("d"), "/", as_i("c"), " \U00D7 100)")) %>%
  italic(j = 1, i = 1:10) %>%
  align(j = 3:10, part = "all", align = "right") %>%
  valign(part = "header", valign = "bottom") %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = 1) %>%
  hline(i = seq(2, nrow(disposition.table.2023), 2)) %>%
  hline(i = c(6, 10, nrow(disposition.table.2023)), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.76, unit = "in") %>%
  width(j = 2, 1.38, unit = "in") %>%
  width(j = 3, 0.88, unit = "in") %>%
  width(j = 4, 1, unit = "in") %>%
  width(j = c(5:6, 9), 0.94, unit = "in") %>%
  width(j = 7, 0.69, unit = "in") %>%
  width(j = 8, 0.56, unit = "in") %>%
  width(j = 10, 0.63, unit = "in")
```

\newpage

Table A-3. -- Number of remaining trips after cancellation in each trip-selection stratum that were selected using the initial random number generator ("Random number selection") and those that remained after user manipulation ("Total final selected") in `r year - 1`. The relative impact of waivers in trip-selection is also shown ("% reduction of selected trips due to waivers"). **Selections not from random numbers. 

```{r logged.table.2022, tab.cap=""}
# Table 3 from 2019 Annual Report

# 2022

logged.table.2022 <- logged.table %>%
  filter(Year == 2022) %>%
  select(-Year)

flextable(logged.table.2022) %>%
  mk_par(j = 3, part = "header",
         value = as_paragraph("Random number selection (", as_i("r"), ")")) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Inherited selection **(", as_i("i"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Waived (", as_i("w"), ")")) %>%
  mk_par(j = 6, part = "header",
         value = as_paragraph("Total final selected\n (", as_i("T"), " = ", as_i("r"), " + ", 
                              as_i("i"), " - ", as_i("w"), ")")) %>%
  mk_par(j = 7, part = "header",
         value = as_paragraph("% selected from inherits ((", as_i("i"), "/", as_i("T"), ") \U00D7 100)")) %>%
  mk_par(j = 8, part = "header",
         value = as_paragraph("% reduction of selected trips due to waivers\n (", as_i("w"), "/(", 
                              as_i("T"), " + ", as_i("w"), ") \U00D7 100)")) %>%
  align(j = 2:8, part = "all", align = "right") %>%
  valign(part = "header", valign = "bottom") %>%
  italic(j = 1, i = 1:5) %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = 1) %>%
  hline(i = c(3, 5, nrow(logged.table)), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.71, unit = "in") %>%
  width(j = c(2, 5), 0.94, unit = "in") %>%
  width(j = 3, 1.31, unit = "in") %>%
  width(j = c(4, 6:7), 1.06, unit = "in") %>%
  width(j = 8, 1.69, unit = "in")
```

\newpage

Table A-4. -- Number of logged trips in each partial coverage stratum in `r year - 1` that were selected using the initial random number generator ("Initial random selection") and those that remained after user manipulation ("After cancellations"). The relative impact of inherits and waivers in trip-selection is also shown ("With inherits", "After waivers").

```{r Selection.table.2022, tab.cap="", tab.width=11}

# 2022

Selection.table.2022 <- Selection.table %>%
  filter(Year == 2022) %>%
  select(-Year)

flextable(Selection.table.2022) %>%
  set_header_labels(values = list(
    n = "Selected trips",
    N = "Total trips",
    Actu = "Actual (%)",
    Prog = "Programmed (%)")) %>%
  mk_par(j = 7, part = "header",
         value = as_paragraph(as_i("p"), "-value")) %>%
  mk_par(j = 2, i = seq(1, nrow(Selection.table.2023), 4), part = "body",
         value = as_paragraph("Initial random selection, ", as_i("a"))) %>%
  mk_par(j = 2, i = seq(2, nrow(Selection.table.2023), 4), part = "body",
         value = as_paragraph("After cancellations, ", as_i("b"), " (", as_i("a"), " - ", as_i("b"), ")")) %>%
  mk_par(j = 2, i = seq(3, nrow(Selection.table.2023), 4), part = "body",
         value = as_paragraph("With inherits, ", as_i("c"), " (", as_i("a"), " - ", as_i("b"), " + ", as_i("c"), ")")) %>%
  mk_par(j = 2, i = seq(4, nrow(Selection.table.2023), 4), part = "body",
         value = as_paragraph("After waivers, ", as_i("d"), " (", as_i("a"), " - ", as_i("b"), " + ", 
                              as_i("c"), " - ", as_i("d"), ")")) %>%
  align(j = 3:7, part = "all", align = "right") %>%
  valign(part = "header", valign = "bottom") %>%
  align(j = 2, align = "left") %>%
  bold(bold = TRUE, part = "header") %>%
  italic(j = 1) %>%
  merge_v(j = 1) %>%
  hline(i = seq(4, nrow(Selection.table.2023), 4)) %>%
  hline(i = c(12, nrow(Selection.table.2023)), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.81, unit = "in") %>%
  width(j = 2, 2.06, unit = "in") %>%
  width(j = 3, 1.06, unit = "in") %>%
  width(j = 4:5, 0.88, unit = "in") %>%
  width(j = 6, 1.31, unit = "in") %>%
  width(j = 7, 0.69, unit = "in")
```

\newpage

Table A-5. -- Number of total vessels (*V*), sampled vessels (*v*), total trips (*N*) and sampled trips (*n*) for each stratum in `r year - 1`. The coverage and 95% confidence interval columns are expressed as percentages of the total number of trips taken within each stratum. Reproduced from the `r year - 1` Annual Report (in review).

```{r Coverage.Table.2022, tab.cap=""}

# 2022
Coverage.Table.2022 <- Coverage.Table %>%
  filter(Year == 2022) %>%
  select(-Year)

as_grouped_data(Coverage.Table.2022, groups = "Coverage") %>%
  as_flextable(hide_grouplabel = TRUE) %>%
  bold(bold = TRUE, part = "header") %>%
  bold(i = ~ !is.na(Coverage)) %>%
  bold(j = 1, i =15) %>%
  italic(j = 1, i = c(2:4, 6:12, 14)) %>%
  italic(j = 2:5, part = "header") %>%
  hline(i = c(3, 8, 11)) %>%
  hline(i = c(14, 15), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1)) %>%
  surround(i = ~ !is.na(Coverage), border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  add_header_row(values = c("", "Coverage", "95% confidence interval", ""), colwidths = c(5, 2, 2, 1)) %>%
  width(j = 1, 1.5, unit = "in") %>%
  width(j = 2:3, 0.38, unit = "in") %>%
  width(j = 4:5, 0.5, unit = "in") %>%
  width(j = 6:7, 0.75, unit = "in") %>%
  width(j = 8:9, 0.58, unit = "in") %>%
  width(j = 10, 1.77, unit = "in") %>%
  align(j = 2:10, part = "all", align = "right") %>%
  align(j = 7, i = 15, align = "left") %>%
  align(i = 1, part = "header", align = "center") %>%
  valign(part = "header", valign = "bottom") %>%
  merge_at(j = 7:10, i = 15) %>%
  padding(j = 7, i = 15, part = "body", padding.left = 35)
```

\newpage

Table A-6. -- The number of pollock deliveries made by vessels in the *OB TRW* stratum during `r year - 1`, separated by port and coverage category. Trips that made a delivery to a tender have been excluded. Observed deliveries denote deliveries that were observed shoreside for salmon.

```{r Pollock.observed.table.2022, tab.cap=""}

Pollock.observed.table.2022 <- Pollock.observed.table %>% filter(Year == year - 1) %>% select(-Year)

flextable(Pollock.observed.table.2022) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Total deliveries (", as_i("N"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Observed deliveries (", as_i("n"), ")")) %>%
  align(j = 4:6, part = "all", align = "right") %>%
  align(j = 1:3, part = "all", align = "left") %>%
  valign(part = "header", valign = "bottom") %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = c("FMP", "Coverage category")) %>%
  hline(i = c(4, 8)) %>%
  hline(i = nrow(Pollock.observed.table.2022), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.81, unit = "in") %>%
  width(j = 2, 1.39, unit = "in") %>%
  width(j = 3, 1, unit = "in") %>%
  width(j = 4, 1.44, unit = "in") %>%
  width(j = 5, 1.69, unit = "in") %>%
  width(j = 6, 0.94, unit = "in")
```

\newpage

Table A-6. -- The number of pollock deliveries made by vessels in the *EM TRW EFP* stratum during `r year - 1`, separated by port and coverage category. Trips that made a delivery to a tender have been excluded. Observed deliveries denote deliveries that were observed shoreside for salmon.

```{r Pollock.efp.table.2022, tab.cap=""}

Pollock.efp.table.2022 <- Pollock.efp.table %>% filter(Year == year - 1) %>% select(-Year)

flextable(Pollock.efp.table.2022) %>%
  mk_par(j = 4, part = "header",
         value = as_paragraph("Total deliveries (", as_i("N"), ")")) %>%
  mk_par(j = 5, part = "header",
         value = as_paragraph("Observed deliveries (", as_i("n"), ")")) %>%
  align(j = 4:6, part = "all", align = "right") %>%
  bold(bold = TRUE, part = "header") %>%
  merge_v(j = c("FMP", "Coverage category")) %>%
  hline(i = c(5, 10)) %>%
  hline(i = nrow(Pollock.efp.table.2022), border = fp_border(width = 1)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
  fix_border_issues() %>%
  width(j = 1, 0.81, unit = "in") %>%
  width(j = 2, 1.39, unit = "in") %>%
  width(j = 3, 1.75, unit = "in") %>%
  width(j = 4, 1.44, unit = "in") %>%
  width(j = 5, 1.69, unit = "in") %>%
  width(j = 6, 0.94, unit = "in")
```

\newpage

Table A-8. -- Results of permutation tests between monitored and unmonitored trips in the `r year -1` trip-selection strata. OD: Observed difference (monitored - unmonitored). Observed and unobserved columns are in units of trips. Statistically significant results are in bold italics.

```{r perm.summary.table.2022, tab.cap=""}
flextable(OBSERVED_FLAG.results_2022) %>%
  bold(bold = TRUE, part = "header") %>%
  italic(j = 1, part = "body") %>%
  hline(i = seq(3, nrow(OBSERVED_FLAG.results_2022), 3)) %>%
  surround(part = "header", border.top = fp_border(width = 1), border.bottom = fp_border(width = 1)) %>%
   mk_par(j = 4, i = seq(3, nrow(OBSERVED_FLAG.results_2022), 3), part = "body",
         value = as_paragraph(as_i("p"), "-value")) %>%
  merge_v(j = c("Strata", "Observed", "Unobserved")) %>%
  align(j = 2:10, part = "all", align = "right") %>%
  valign(j = 1:3, part = "body", valign = "top") %>%
  valign(part = "header", valign = "bottom") %>%
  fix_border_issues() %>%
  width(j = 1, 0.75, unit = "in") %>%
  width(j = 2, 0.81, unit = "in") %>%
  width(j = c(3, 6), 0.94, unit = "in") %>%
  width(j = 4, 0.69, unit = "in") %>%
  width(j = 5, 1, unit = "in") %>%
  width(j = c(7, 10), 1.25, unit = "in") %>%
  width(j = 8, 1.13, unit = "in") %>%
  width(j = 9, 1.03, unit = "in") %>%
  # Highlight significant factors
  bold(j = 6, i = c(1:3, 7:9), bold = TRUE, part = "body") %>%
  bold(j = 8, i = 4:6, bold = TRUE, part = "body") %>%
  bold(j = 10, i = c(1:3, 10:12), bold = TRUE, part = "body") %>%
  italic(j = 6, i = c(1:3, 7:9), part = "body") %>%
  italic(j = 8, i = 4:6, part = "body") %>%
  italic(j = 10, i = c(1:3, 10:12), part = "body")
```

\endPortrait

```{r outcomes.plot.2022, warning=FALSE, fig.width=7.5, fig.height=9, dpi=600}
arrange.plot.fxn(outcomes.plot.2022, costs.plot.2022)
```

Figure A-1. -- Total number of observer sea days purchased (top panel) and total cost of observing those sea days (bottom panel). Vertical bars signify the range of potential outcomes predicted by the `r year - 1` Annual Deployment Plan. Dashed lines signify expected outcomes. Solid lines signify what actually occurred in `r year - 1`.  

\newpage

```{r odds.by.date.plot.2022, fig.width=7.5, fig.height=8, dpi=600}
suppressWarnings(print(odds.by.date.plot.2022))
```

Figure A-2. -- Rate of selected trips logged into ODDS during `r year - 1` organized by original date entered for all trips (gray line and gray text), and final date considering only non-canceled trips (black line and black text). The programmed selection rate is depicted as the dotted line. Gray shaded areas denote the range of coverage rate corresponding to the 95% confidence intervals expected from the binomial distribution. Vertical tick marks on the x-axis depict dates when selected trips were canceled (gray, on the bottom) and when inherited trips were monitored (black, on the top).

\newpage

Figure A-3. -- Distributions of data timeliness (the time between a trip or delivery ending and those monitoring data being available for catch accounting) by stratum. Dashed red lines and annotations show mean data timeliness.

\newpage

```{r Temporal.plot.2022, warning=FALSE, fig.width=7.5, fig.height=8, dpi=600}
print(Temporal.plot.2022)
```

Figure A-4. -- Cumulative number of trips monitored during `r year - 1` (black line) compared to the expected range of observed trips (shaded ribbon) given fishing effort and sampling rates. Dates where the monitored number of trips is outside of expected (less or more than the range) are depicted as tick marks on the x-axis. Test results (using a binomial distribution) determining if the observed rate was sampled at the selection rate are denoted as *p*-values.

\newpage

Figure A-5. -- Spatial patterns of the distribution of monitoring in partial coverage in `r year - 1`. Each hexagonal spatial cell is 200 km wide. The numbers in the cells represent the difference in the number of trips / deliveries actually monitored relative to the median of 10,000 simulations of random sampling using the stratum’s realized monitoring rate. Cells without a number had the same number of monitored trips / deliveries as the median of the simulations (difference of zero). Cells where the actual number of monitored trips / deliveries was more extreme than 80% of simulated outcomes are colored pink (fewer trips / deliveries than expected) or green (more), and those cells with a more extreme outcome than 95% of simulated outcomes are outlined in blue with bold text.

\newpage

Figure A-6. -- Stratum-level proximity indices in partial coverage in `r year - 1`. The purple vertical dashed line represents actual proximity indices. The distributions show the proximity values obtained from 10,000 simulations of random sampling, where the upper (green) distribution sampled using the realized monitoring rate and the lower (blue) distribution used the programmed monitoring rate. The 2.5% tails of the distributions are shaded darker to represent unlikely outcomes. The number of sample units in each stratum is displayed in the upper-left of each facet. Note the varying scales of the x-axes between facets.

\newpage

Figure A-7. -- Stratum and FMP-level proximity indices in partial coverage in `r year -1`. The purple vertical dashed line represents actual proximity indices. The distributions show the proximity values obtained from 10,000 simulations of random sampling, where the upper (green) distribution sampled using the realized monitoring rate and the lower (blue) distribution used the programmed monitoring rate. The 2.5% tails of the distributions are shaded darker to represent unlikely outcomes. The number of sample units in each stratum and FMP is displayed in the upper-left of each facet. Note the varying scales of the x-axes between facets.

\newpage

```{r perm_plot_2022, fig.height=11, fig.width=8, message=FALSE, warning=FALSE}
# Plot results
OBSERVED_FLAG.YN_perm_plot <- ungroup(OBSERVED_FLAG.YN_perm.2022) %>% mutate(STRATA = as.character(STRATA)) 
OBSERVED_FLAG.summary_plot <- ungroup(OBSERVED_FLAG.summary.2022) %>% mutate(STRATA = as.character(STRATA)) %>% 
  # Apply Bonferroni adjustment to alpha value and format significant p-values  
  mutate(p = ifelse(p < (0.05 / length(unique(OBSERVED_FLAG.summary$variable))), paste0(formatC(p,digits = 3, format = "f"), "*"), formatC(p, digits = 3, format = "f"))) %>%
  mutate(p = ifelse(p == "0.000*", 
                    paste0("italic(p) < '0.001*'"), 
                    ifelse(p < (0.05 / length(unique(OBSERVED_FLAG.summary$variable))), paste0("italic(p) == '", p, "*'"), paste0("italic(p) == '", p, "'"))))

# Filter out EM TRW EFP stratum
OBSERVED_FLAG.YN_perm_plot <- OBSERVED_FLAG.YN_perm_plot %>% filter(STRATA != "EM TRW EFP")
OBSERVED_FLAG.summary_plot <- OBSERVED_FLAG.summary_plot %>% filter(STRATA != "EM TRW EFP")

# Generate permutation plot 
Obs.perm.plot.2022 <- ggplot(OBSERVED_FLAG.YN_perm_plot, aes(x = perm_result_pct)) +
  geom_histogram(aes(y = ..density..), col = "white", fill = "gray", bins = 30) +
  geom_density(fill = "gray", alpha = 0.5, adjust = 3) +
  geom_vline(aes(xintercept = 0), col = "black", lty = 3, linewidth = 1) +
  geom_vline(aes(xintercept = obs.diff_pct), col = "red") +
  facet_wrap(factor(STRATA, levels = c("OB HAL", "EM HAL", "OB POT", "EM POT", "OB TRW")) ~ variable, scales = "free", 
             # Make number of cols in facet_wrap = to number of strata
             ncol = length(unique(OBSERVED_FLAG.YN_perm_plot$STRATA)), dir = "v") +
  geom_label(data = OBSERVED_FLAG.summary_plot, aes(label = paste(p), fill = factor(p %like% "\\*", levels = c(TRUE, FALSE))), 
             x = -Inf, y = Inf, hjust = -0.1, vjust = 1.2, size = 3, parse = TRUE, label.padding = unit(0.15, "lines")) +
  scale_fill_manual(values = c("pink", "white"), guide = FALSE) + 
  fig.theme +
  xlab("\nDifference (%) of observed minus unobserved trips relative to the mean") +
  ylab("Density of outcomes\n") + 
  theme(strip.text.x = element_text(size = 8, margin = margin(0.1, 0.1, 0.1, 0.1, unit = "lines")))

Obs.perm.plot.2022
```

Figure A-8. -- Results from permutation tests depicting percent differences between monitored and unmonitored trips by strata in the partial coverage category. Gray bars depict the distribution of differences between monitored and unmonitored trips when the assignment of monitoring status has been randomized (this represents the sampling distribution under the null hypothesis that monitored and unmonitored trips are the same). The vertical red solid line denotes the actual difference between monitored and unmonitored trips. Values on the x-axis have been scaled to reflect the relative (%) differences in each metric. The *p*-value for each test is denoted in the upper left corner. Low *p*-values (shaded pink) are reason to reject the null hypothesis and conclude that there is a monitoring effect.

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
save.image(file = "4_AR_report.Rdata")
```


```{r, compliance check, eval=FALSE}
#' Check of full coverage vessels that failed to take an observer to provide to OLE 
#' Alex Perry - Compliance Analyst - Anchorage [Alex.Perry@noaa.gov]

not_observed <- work.data %>%
  filter(STRATA == "FULL" & ADP == 2023 & OBSERVED_FLAG == "N") %>%
  select(TRIP_ID, VESSEL_ID, PERMIT, LANDING_DATE) %>%
  unique()
```