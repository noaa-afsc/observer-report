---
title: "Deployment Performance Review of the 2019 North Pacific Observer Program"
author: "Fishery Monitoring Science Committee"
always_allow_html: true
output:
  word_document:
    reference_docx: word-styles-reference-01.docx
  pdf_document: default
---

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# Once report has been run and 4_AR_report.Rdata has been created,
# skip running the code below and load all packages and objects here:
# load("4_AR_report.Rdata")
# source("3_helper.R")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load data
load("2_AR_data.RData") # This includes the .Random.seed set in 1_AR_data.R

# Load packages and functions 
source("3_helper.R")

# Avoid scientific notation
options(scipen=10000)

# Avoid dplyr summarise warnings
options(dplyr.summarise.inform = FALSE)

# Is this the annual report or the tech memo?
# This will control whether certain text chunks are included
annual.report <- TRUE
tech.memo     <- FALSE
```

```{r set-options, echo=FALSE, message=FALSE, warning=FALSE}
#Total deployment strata:
# 2 full coverage (FULL, EM TRW EFP)
# 3 partial coverage observed (HAL, POT, TRW)
# 3 partial coverage EM (EM HAL, EM POT, EM TRW EFP) + 
# 1 zero coverage EM research (Zero EM Research) +
# 1 zero coverage (ZERO)
total.strat <- nrow(unique(work.data[, .(COVERAGE_TYPE, STRATA)]))
```

`r if(tech.memo){'#Abstract'}`  
`r if(tech.memo){'This report contains the analyses and findings of the Alaska Fisheries Science Center’s Fisheries Monitoring and Analysis Division’s Fishery Monitoring Science Committee (FMSC) on the efficiency and effectiveness of observer deployment following the 2019 Annual Deployment Plan (ADP). Responses to comments by the North Pacific Fishery Management Council (Council) from the 2018 version of this report, and recommendations to improve data quality and guide the 2021 Annual Deployment Plan are also included. In 2019, there were 10 strata to evaluate: one full coverage stratum, five partial coverage observer strata defined by gear and tender designation, two partial coverage Electronic Monitoring (EM) strata defined by gear designation, one zero coverage EM research stratum, and one zero coverage stratum. Observers were deployed under trip-selection on 161 full coverage vessels that fished for 3,343 trips and 584 unique partial coverage vessel and stratum combinations (vessels can fish in more than one stratum) that fished 5,016 trips total. This was the second year in which data from the EM HAL stratum were used in catch accounting, and the first year in which data from the EM POT stratum were used in catch accounting. The EM HAL stratum was the third largest stratum by trip count in 2019 with 916 total trips fished. EM systems were deployed onto 21 pot vessels that fished for 165 trips. Research EM systems were deployed onto four vessels that fished for 29 trips. A total of 393 vessels fished 2,005 trips in the zero coverage stratum, accounting for 28% of all trips that occurred within the partial coverage category. Realized coverage rates met expectations in eight of ten strata in 2019. The full coverage stratum was observed at a rate of 99.9%, falling below the expected rate of 100%. The partial coverage POT – Tender stratum was observed at a rate of 29.5%, with a 95% confidence interval that fell above the expected coverage rate of 16.1%. However, deployment in 2019 generally proceeded as planned, with few missed expectations or signs of potential bias. The FMSC recommends that future ADPs fully integrate EM and observer deployment into one fishery monitoring program. Although EM data are now being used in catch accounting, the funding and selection of EM vessels has so far occurred separately from the processes used to optimize observer deployment in each ADP. Considering EM as a more integral part of those optimization processes will better enable analysts to avoid data gaps and take advantage of the respective abilities of each monitoring method (observers and EM). The FMSC also continues to recommend that NMFS link the ODDS and eLandings database such that fishing trips can be uniquely identified to support the analyses presented to the Council. Such a linkage will better enable analysts to discern the contributing factors behind instances in which intended deployment is inconsistent with realized deployment.'}`  

#Introduction  
`r if(tech.memo){'##Background of the North Pacific Groundfish and Halibut Observer Program'}`  
`r if(tech.memo){'Fisheries observers and electronic monitoring (EM) systems collect independent information that is used to determine the effects of fishing on natural resources. The National Marine Fisheries Service (NMFS) uses its observer program in Alaska to enable the use of tools such as catch quotas to manage against the over- or under-harvest of fishes. Observers and EM are two verifiable methods for collecting fishery discard information used to estimate total catch. Observers (but not the EM systems currently used in the North Pacific) are able to record seabird and marine mammal interactions with fisheries as well. Observers also collect biological information such as length, sex, weight, ageing structures (e.g., otoliths, spines, scales, and vertebrae), and stomachs to support ecosystem studies and stock assessments.'}`

`r if(tech.memo){'The observer program in the North Pacific has a long history. Observers were first deployed onto fishing vessels in the Bering Sea in 1973 and into the remainder of the North Pacific in 1975 (Nelson et al. 1981, Wall et al. 1981). Fisheries in the North Pacific were initially prosecuted exclusively by foreign and later by "joint venture"'}` `r if(tech.memo){"operations where a developing domestic fleet of catcher vessels delivered to foreign-owned processing vessels. During the foreign and joint venture operations, foreign vessels carried fisheries observers at their expense, while domestic vessels were exempted from this observer coverage. As foreign vessels' rights to fish in the U.S. Exclusive Economic Zone (EEZ) were reduced over time and the domestic fishery grew, it became obvious to managers that observer coverage would be necessary for the emerging domestic fleet. At the onset of fully domestic fishery operations in 1990, the North Pacific Groundfish Observer Program was established as an interim observer program with rules governing observer coverage codified in regulations. This interim program would be extended four times over the next 20 years by the North Pacific Fishery Management Council (Council) - the last without a sunset date."}`

`r if(tech.memo){'The regulations established in 1990 required vessels 60-125 feet in length (overall) and all vessels fishing pot gear to carry observers at their own cost for 30% of their fishing days in a calendar quarter plus at least one trip in each fishery they participate in (termed the "30% fleet"), and vessels greater than 125 feet in length to carry an observer for 100% of their fishing days at their expense. Some vessels were not required to carry observers. These included vessels less than 60 feet, vessels fishing jig gear or vessels fishing with trawl gear that deliver unsorted codends to processing vessels (termed "catcher processors" or CPs if the vessel also has catching ability and "mothership" or M if the vessel does not) and vessels that fished for Pacific halibut (*Hippoglossus stenolepis*). For shoreside processors, the rules governing observer coverage were based on the estimated tonnage processed in a calendar month: plants that processed less than 500 metric tons (t) a month were exempted from coverage, those that processed between 500 t and 1,000 t a month were required to be observed for 30% of the calendar days, and those that processed more than 1,000 t a month were required to be observed for each day in the month.'}`

`r if(tech.memo){'Soon after the establishment of the domestic observer program, concerns over the ability and incentive for fishers to manipulate observer coverage in a way that might bias catch estimates and other analytic products prompted efforts by NMFS and the Council to provide a mechanism for NMFS to gain control over where and when observers were deployed (Faunce and Barbeaux 2011). From 1992 to 2008, several attempts to “restructure” the program were made. In 2010, the Council unanimously decided to move forward with the restructured observer program. In 2012, the Final Rule 77 FR 70062 was published to implement Amendment 86 to the Fishery Management Plan for Groundfish of the Bering Sea and Aleutian Islands (BSAI) Management Area and Amendment 76 to the Fishery Management Plan for Groundfish of the Gulf of Alaska (GOA). Amendments 86/76 added a funding and deployment system for observer coverage to the existing North Pacific Groundfish Observer Program and amended existing observer coverage requirements for vessels and processing plants. The “restructured” North Pacific Groundfish and Halibut Observer Program (hereafter termed “Observer Program”) began in 2013 with the randomization of deployments among trips and vessels. In 2018, the use of EM was added as an additional catch monitoring tool, with the understanding that some data elements collected by observers would not be collected using EM systems.'}`

`r if(tech.memo){'#The Annual Deployment Plan and Review'}`
`r if(tech.memo){"Analysis and evaluation of the data collected by observers is an ongoing process. The NMFS considers Council input in making decisions as to the amount of coverage (i.e., selection probabilities that are assigned to each partial-coverage category). These decisions are based on available funding, the cost of observer coverage, and anticipated effort. The restructure of the Observer Program established new annual reporting processes. Each June, the NMFS provides the Council with a comprehensive evaluation of past years' observer deployments, costs, sampling levels, and implementation issues as well as recommended changes for the coming year. The June deployment performance review aims to identify areas where improvements are needed to 1) collect the data necessary to manage the groundfish and halibut fisheries; 2) maintain the scientific goals of unbiased data collection; and 3) accomplish the most effective and efficient use of the funds collected through the observer fee. The annual deployment performance review is an opportunity to inform the Council and the public of how well various aspects of the program are working, and consequently lead to recommendations for improvement as appropriate. The NMFS also prepares the Observer Program Annual Deployment Plan (ADP) each fall. The ADP defines deployment strata and establishes selection rates given available budgets and anticipated fishing effort. A draft ADP is released by September of each year to allow review by the Council's Groundfish Plan Teams, as well as the Council and its Scientific and Statistical Committee (SSC). Based on input from its advisory bodies and the public, the Council may choose to clarify objectives and provide recommendations to NMFS for the ADP. Upon analysis of the Council recommendations, NMFS will make any necessary adjustments to finalize the ADP and release it to the public. The ADP is released to the public prior to the December Council meeting."}`    

`r if(tech.memo){'##Fishery Monitoring Science Committee'}`
`r if(tech.memo){'Each year the Alaska Fisheries Science Center’s (AFSC) Fisheries Monitoring and Analysis (FMA) Division establishes a committee to review the scientific elements of the North Pacific Observer Program. This committee, formerly referred to as the Observer Science Committee (OSC), was renamed in 2020 as the Fishery Monitoring Science Committee (FMSC), in order to reflect the addition of EM as a tool being used to monitor fisheries in the North Pacific. Similarly, we use the term ‘monitoring’ in this chapter when referencing fishing activity that has been monitored either by an observer or with EM.'}`  

`r if(annual.report){'Each year the Alaska Fisheries Science Center’s (AFSC) Fisheries Monitoring and Analysis (FMA) Division establishes a committee to review the scientific elements of the North Pacific Observer Program. This committee, formerly referred to as the Observer Science Committee (OSC), was renamed in 2020 as the Fishery Monitoring Science Committee (FMSC), in order to reflect the addition of electronic monitoring (EM) as a tool being used to monitor fisheries in the North Pacific. Similarly, we use the term ‘monitoring’ in this chapter when referencing fishing activity that has been monitored either by an observer or with EM.'}`  

The FMSC provides scientific advice in the areas of regulatory management, natural science, mathematics, and statistics as they relate to observer deployment and sampling in the groundfish and Halibut fisheries of the BSAI and the GOA. The FMSC members have analytical and scientific expertise relating to observer sampling of groundfish and halibut fisheries of the BSAI and GOA and use of the collected data. If possible, the FMSC is represented by at least one member of the AFSC/FMA (Observer Program) Division, one member of the AFSC/Stock Assessment and Multispecies Assessments Program, one member of the Alaska Regional Office (AKRO) Sustainable Fisheries Division, and one member of the International Pacific Halibut Commission (IPHC).

`r if(annual.report){'This chapter contains the FMSC review of the deployment of observers and EM in'}` `r if(annual.report){year}` `r if(annual.report){'relative to the intended sampling plan and goals of the'}` `r if(annual.report){year}` `r if(annual.report){'Annual Deployment Plan (ADP, NMFS'}` `r if(annual.report){year-1}` `r if(annual.report){'a). This review identifies where possible biases exist and provides recommendations for further evaluation, including potential improvements to the observer deployment process that should be considered during the development of the'}` `r if(annual.report){year+2}` `r if(annual.report){'ADP.'}`    

`r if(annual.report){'The goal of the Observer Program is to achieve a random deployment of observers and EM into fisheries to collect representative data used to estimate catch and bycatch, assess stock status, collect fishery-dependent biological information used in population and ecosystem modeling efforts, and make salmon bycatch stock-of-origin determinations, among other objectives. Therefore, this evaluation focuses on the randomization of observer and EM deployments into primary sampling units, and how departures from a random sample affect data quality.'}`  

##The Sampling Design of the Observer Program 
Since 2013, the Observer Program has used a stratified hierarchical sampling design with randomization at all levels. Stratification is used to increase the efficiency of sampling by observers and to address logistical issues associated with deployment. By grouping similar fishing activities into strata and sampling those strata appropriately, sampling efficiency is increased and the variance of resulting estimates may also be decreased. Sampling strata are defined in the ADP and are designed such that each unit of deployment (trip) is assigned to only one stratum.

Within a stratum, observers are deployed randomly to either vessels for a predetermined period of time (termed vessel-selection), or to individual fishing trips (termed trip-selection). In both cases, this initial deployment to the fishery is the first level of the sampling hierarchy and defines the primary sampling unit (PSU; either vessel-periods or individual trips). The list of all PSUs in a stratum defines the sampling frame and should equate to the population of interest for that sampling stratum (e.g., all trips taken by trawl vessels fishing in the Alaska EEZ).  If the sampling frame does not contain all elements of the stratum, the resulting information may be biased.  The magnitude and direction of the bias will depend on how different the fishing activities in the sample frame are from actual fishing activity.

Although this report evaluates whether monitoring goals were met, we include a brief summary of the full sampling hierarchy here for context.  For each observed trip, if all hauls cannot be sampled for logistical reasons, hauls are randomly selected to be sampled. This is the next level in the hierarchy; the secondary sampling units are defined as hauls within a trip. Randomization of haul selection is designed to allow observers to record and transmit data, attend to other non-sampling responsibilities, and to allow observers time to sleep and eat. Randomization of haul selection also gives EM video reviewers the ability to optimize the amount of video that can be reviewed from each trip. Haul selection is determined using the random sampling tables and random break tables provided by NMFS. For each haul, fishing location and effort (e.g., number of hooks) are recorded, while marine mammal and seabird interactions are primarily recorded on randomly selected hauls. The ability of EM to capture marine mammal and seabird interactions is less than that of observers due to the fixed location in which EM equipment is placed.

For the randomly selected hauls, a random sample of the catch is collected (observers) or selected for video review (EM), and data from those samples are used to determine the species composition and amount of discarded catch. These samples of catch within each haul are the third level of the sampling hierarchy. While observers are trained to collect multiple large samples of catch, the number and size of samples taken from each haul will depend on the vessel configuration, fishing operations, and diversity of catch. The size of EM samples is largely determined by the number of video reviewers available relative to the amount of video to be reviewed.

At the fourth level of the sampling hierarchy, a predetermined number of individual fish of predetermined species is randomly selected from the species composition sample and measured. Lastly, at the fifth sampling level, a random selection of fish is used to collect otoliths, reproductive maturity assessments, stomach contents, genetic tissues, and other biological specimens. The number and species of fish selected for measurement and biological specimen collection is specified each year by the AFSC’s stock assessment scientists. Sampling rates for genetic tissue collection by observers (e.g., 1 of 10 Chinook salmon caught as bycatch) are set each year by the AFSC’s Auke Bay Laboratory. Sampling at the fourth and fifth levels of the sampling hierarchy does not occur with EM. 
      
`r if(annual.report){'More information on the sampling design used by observers and the relationship between the sample design and catch estimation can be found in Cahalan and Faunce (2020) and the 2019 Observer Sampling Manual (AFSC 2018).  A summary of the'}` `r if(annual.report){year}` `r if(annual.report){'ADP can be found in Section 1.3. The focus of this report is related to deployment, and the evaluation is at the trip level of the sampling hierarchy.'}`

`r if(tech.memo){'More information on the sampling design used by observers and the relationship between the sample design and catch estimation can be found in Cahalan and Faunce (2020) and the 2019 Observer Sampling Manual (AFSC 2018).  A summary of the'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP is included below. The focus of this report is related to deployment, and the evaluation is at the trip level of the sampling hierarchy.'}`

`r if(tech.memo){'#The'}` `r if(tech.memo){year}` `r if(tech.memo){'Annual Deployment Plan'}`    
`r if(tech.memo){'The following briefly summarizes the final 2019 ADP (NMFS 2018). In general, all vessels that participate in cooperatives or act as catcher-processors or motherships are fully observed at the trip-level and constitute the full-coverage category of the fleet. In 2016, NMFS published new regulations to allow the owner of a trawl catcher vessel to annually request that NMFS place requesting vessels in the full coverage category for all directed fishing for groundfish using trawl gear in the Bering Sea and Aleutian Islands management area (BSAI) in the following calendar year. This regulated process has replaced an interim policy. For the 2019 calendar year, NMFS received and approved requests and has placed 18 catcher vessels in the full coverage category for all directed fishing for groundfish using trawl gear in the BSAI management area (NMFS 2018). The NMFS used only the trip-selection method (i.e., no vessel-selection) to assign observers and EM to vessels in the partial-coverage category for 2019. The partial-coverage category includes vessels greater than or equal to 40 feet (ft) length overall (LOA) and not in the full coverage category. There were seven sampling strata in the partial coverage category in 2019:'}`  

`r if(tech.memo){'1.  Hook-and-line vessels (*HAL* stratum).'}`    
`r if(tech.memo){'2.  Hook-and-line vessels with EM (*EM HAL* stratum).'}`     
`r if(tech.memo){'3.  Pot vessels not delivering to tenders (*POT - No Tender* stratum).'}`     
`r if(tech.memo){'4.	Pot vessels delivering to tenders (*POT - Tender* stratum).'}`
`r if(tech.memo){'5.  Pot vessels with EM (*EM POT* stratum).'}`
`r if(tech.memo){'6.	Trawl vessels not delivering to tenders (*TRW - No Tender* stratum).'}`     
`r if(tech.memo){'7.	Trawl vessels delivering to tenders (*TRW - Tender* stratum).'}`      
  
`r if(tech.memo){'Data collected through EM was first used in catch accounting in 2018, with the inclusion of *EM HAL* data. In 2019, data from the *EM POT* stratum were also used in catch accounting. Vessels had to volunteer to participate in the fixed gear EM Program by 1 November, 2018. The NMFS then selected vessels to be included in the EM Program following an evaluation of available funding (NMFS 2018, Appendix C). NMFS also sought vessels to participate in EM research and development activities. Vessels that volunteered for the fixed gear EM Program or EM research activities and were selected by the NMFS were not required to carry observers but were required to continue to log their fishing trips into the Observer Declare and Deploy System (ODDS). In this report, we attempt to evaluate the deployment of EM onto fixed gear vessels to the same degree as we evaluate the deployment of observers.'}`    

#Performance Review Objectives  
`r if(tech.memo){'The following sections contain the FMSC review of the deployment of observers in'}` `r if(tech.memo){year}` `r if(tech.memo){'relative to the intended sampling plan and goals of the'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP (NMFS'}` `r if(tech.memo){year-1}` `r if(tech.memo){'). This report identifies where potential mechanisms for biases exist and provides recommendations for further evaluation, including potential improvements to the observer deployment process that should be considered during the development of the'}` `r if(tech.memo){year+2}` `r if(tech.memo){'ADP.'}`  
The following items from the `r year` ADP have been identified as objectives for evaluation in this report:  

```{r actual_observerdays_paid, include=FALSE}
# Available budget for the year (in days)
AvailableYR <- adp_out$ADJ %>% 
               filter(ALLO == "min_plus_opt") %>% 
               group_by(SIM_ITER, STEP) %>% 
               summarise(OB_D = sum(OB_D)) %>% 
               ungroup() %>% 
               summarise(OB_D = mean(OB_D)) %>% 
               unlist() %>% 
               as.vector()
  
# Predicted cost for the year (in days)
PredictedYR <- adp_out$BUD %>% 
               filter(ALLO == "min_plus_opt") %>% 
               summarise(ADP_D = mean(ADP_D)) %>% 
               unlist() %>% 
               as.vector()

# Get actual costs from spreadsheet provided by FMA (make sure spreadsheet is up-to-date!)
days_paid <- read.csv("data/FMA Days Paid.csv")
days_paid <- filter(days_paid, Calendar == year)

# Actual number of observer days paid for
ActualYR <- days_paid %>% 
            replace(is.na(.), 0) %>%
            summarise(Total.Days = sum(Base.Days + na.omit(Option.Days))) %>% 
            unlist() %>% 
            as.vector()

# Percent of budget predicted to be spent
eval <- data.frame(ActualYR, PredictedYR) %>%
        mutate(
        #Percent of the budget used
        pct.budget.spent = round(ActualYR/PredictedYR,3)*100,
        #Percent of budget remaining
        pct.budget.remain = round(100 - pct.budget.spent, 3),
        #Was it more, less, or equal to the predicted budget?
        more.or.less = ifelse(pct.budget.remain > 0, " lower than ",
                       ifelse(pct.budget.remain == 0, "equal to",
                                 " greater than ")))
```

* Deploy for the planned number of sea days. This objective will be considered to be met if the actual number of sea days expended falls within the range of values from simulated sampling provided in the `r year` ADP. The Observer Program’s budget was expected to cover `r formatC(AvailableYR, format="d", big.mark=",")` days in `r year`.      
  
* Deploy at the coverage rates specified in the `r year` ADP. Following the `r year` ADP, ODDS was programmed to randomly select logged trips at a rate of 23.70% in the *TRW - No Tender* stratum, 17.71% in the *HAL* stratum, 15.43% in the *POT - No Tender* stratum, 27.12% in the *TRW - Tender* stratum, 16.11% in the *POT - Tender* stratum, and 30% in the EM strata. Under a randomized deployment scheme, these partial coverage selection rates are expected to be within a 95% confidence interval computed from the realized coverage rates (under the assumption of a binomial distribution for observed trips).    
  
* Collect tissue samples from Chinook and chum salmon as specified in the `r year` Observer Sampling Manual to support the goal of collecting genetic samples from salmon caught as bycatch in groundfish fisheries to identify stock of origin. The sampling protocol established in the 2014 ADP (NMFS 2013) was used in `r year`. Under this protocol, observers on vessels delivering to shoreside processors in the GOA trawl walleye pollock (*Gadus chalcogrammus*, hereafter referred to as simply ‘pollock’) fishery monitor the offload to enumerate salmon bycatch and obtain tissues for genetic analysis from the salmon bycatch. For trips that are delivered to tender vessels and trips outside of the pollock fishery, observers obtain salmon counts and tissue samples from all salmon found within at-sea samples of the total catch.    
  
* Randomize deployment of observers into the partial coverage category of fishing activities. This randomization is used to collect observer and EM samples that are representative of the entire fishing fleet (observed and monitored trips are equivalent to unobserved and unmonitored trips within a stratum). Evaluation of this objective is focused on the randomization of observer and EM deployments into primary sampling units, and how departures from a random sample affect data quality.      
  
##Observer Deployment Performance Metrics  
Performance metrics have been developed to assess whether the trip-selection process (through the implementation of the `r year` ADP) provides a representative sample of fishing trips in the North Pacific in `r year`. These metrics reflect four mechanisms that can impact the quality of the data: sample frame discrepancies, non-response, differences in trip characteristics, and sample size.        

The performance metrics used in this evaluation are as follows:  

1. Deployment rates for each stratum: This is the basic level of evaluation for comparing targeted and achieved sampling rates, where sampling strata are partitions of the entire population about which we want to make inferences (e.g., generate estimates of catch). Implementation challenges can be identified in this step, such as sample frame inadequacy, selection biases, and issues with sample unit definitions. Specifically, this section assesses the following:        

+ a.  Sample rates and number of samples relative to intended values.   
  
+ b.  Quantification of under- and over-coverage rates (sample frame discrepancies). Over-coverage of a population occurs when the sample frame includes elements that are not part of the target population. When these elements are included in the random sample, effort (time, cost) is expended needlessly. Under-coverage results from having a sample frame that does not include a portion of the target population which can lead to biased data if that portion of the population differs from the population included in the sample frame.   
  
+ c.  Non-response rates. Non-response occurs when randomly selected elements (trips or vessels) are not actually sampled. If these trips or vessels have different fishing behavior (e.g., catch, areas fished) than the rest of the population, the data collected will not represent the entire fleet (non-response bias).  
  
2.  Representativeness of the sample: Randomized sampling is a method used to ensure that the results of sampling reflect the underlying population. Departures from randomization can lead to non-representative data and hence potential bias in estimates of the parameters of interest. A randomized sample design is expected to achieve a rate of monitored events that is similar across both space and time. Representativeness of the sample was divided into three separate components:   

+ a.	Temporal representativeness
  
+ + i.	Effort plots: plots of expected and actual monitoring effort over time. Areas where these two lines deviate from each other are indicative of periods with differential realized sample rates (and potential temporal bias).  
    
+ b.	Spatial representativeness
  
+ + i.	Maps: Maps provide a visual depiction of the spatial distribution of monitoring coverage relative to effort in each partial coverage stratum, as well as where low or high coverage rates occurred.  
    
+ + ii.	Probability of monitoring a fewer or greater number of trips within an area than would be expected given the realized sample rate for the entire stratum. These data are used to identify departures from anticipated sampling rates.  
    
+ c.	Representativeness of trip characteristics
  
+ + i.	Consistency of trip characteristics for monitored and unmonitored portions of the stratum. These metrics are based, in part, on the availability of data for both monitored and unmonitored fishing activities; for example, data that are reported for all trips on landing reports. Attributes tested in this report include the following:     
    
+ + + * Trip duration (days).
        
+ + + * Vessel length (feet).
        
+ + + * The number of NMFS Areas visited during the trip.
        
+ + + * The amount of landed catch (metric tons).
        
+ + + * The number of species in the landed catch (also known as species richness).
        
+ + + * The proportion of the total landed catch that was due to the most prevalent species (pMax, an inverse a measure of species diversity where an increase in pMax indicates a decline in diversity).  
        
3.  Adequacy of sample size: A well-designed sampling program will have a sample large enough to reasonably ensure that the characteristics of interest in the entire target population are represented in the data. Whether the sample size collected was adequate was determined through an examination of the probability of deploying observers at the implemented rate and having no monitoring coverage in one or more cells (e.g., defined by NMFS Reporting Area and strata).     

Although these metrics can identify places where observed results differ from expectations, it is ultimately a subjective decision as to whether or not these differences are substantial enough to have management implications. This holds true even for tests that have associated p-values. Additionally, our focus on landed catch is due to the fact that total catch is comprised of retained and discarded portions, and since discarded catch is not available from unmonitored trips, landed catch represents the only portion of the catch that is available from all trips.  

#Changes to This Report from Last Year  
<!-- Manually update this section -->  
This year we made several updates to our analyses.  These include two major and several minor changes.  The first major change this year is the addition of a new analysis of data gaps (Appendix B).  Following the methods used in the gap analysis in Appendix C of the Draft 2020 Annual Deployment Plan (NMFS 2019a), Appendix B serves to evaluate the extent to which monitoring coverage within deployment strata was distributed proportionately to post-strata defined by FMP and trip target (predominant species) by evaluating the spatiotemporal proximity of monitored trips to unmonitored trips and assesses the likelihood of acquiring the achieved coverage in 2019 given the assumption of random deployment. It is the intent that elements of this Appendix be included in future Annual Reports.  The second major change is how we calculate p-values in the permutation tests that assess whether or not observed or unobserved trips were different in a given metric.  In recognition that these tests are not independent within a stratum, this year we adjust p-values to account for multiple comparisons by multiplying by the number of tests performed.  In this way we inflate each p-value in a way that reduces the chances of making a false interpretation of differences where there are none.  This is known as a Bonferroni adjustment, and is also applied to permutation test p-values in Appendix A. The result should be a more narrow focus on only large differences.  Minor changes to the tables in this chapter include the addition of a table showing the average review times for fixed gear EM video (Table 3-7), the realized cost of the partial coverage monitoring program in dollars with the expected cost of the program (Figure 3 1, bottom panel), and more information on when trips in ODDS were selected due to the cancellation of prior trips (Figure 3 2).    

#Evaluation of Deployment in `r year`  
The deployment of observers into the `r year` Federal fisheries in Alaska is primarily evaluated at the level of the deployment stratum because each stratum is defined by a different sampling rate or by a different monitoring method (e.g., observers and EM). In this document, trips in the *EM HAL* and *EM POT* strata are considered successfully monitored if at least some video was reviewed from a trip. The rationale for defining monitored trips this way is that it is most similar to the way in which trips in other strata are considered observed (i.e., irrespective of whether or not haul information or usable species composition data were collected).                

##Evaluating Effort Predictions  
```{r outcomes.plot}
# Isolate ADP budget predictions for the chosen design
sample_budget_out <- adp_out$BUD[ALLO == "min_plus_opt"]

# Plot effort predictions against actual
outcomes.plot <-
  ggplot(sample_budget_out, aes(x = ADP_D)) +
  geom_histogram(aes(y = ..density..), binwidth = 20, alpha=0.2, fill="blue", col="cornflowerblue") +
  geom_vline(xintercept = AvailableYR, lty=2, col="black") +
  geom_vline(xintercept = ActualYR, lty=1, col="blue") +
  annotate("text", x=AvailableYR + 20, y=0.002,
            label=paste("Available Day Budget: ", AvailableYR, sep=""),
            col="black", angle = 90) + 
  annotate("text", x=ActualYR - 30, y=0.002,
           label=paste("Actual Days Paid: ", ActualYR, sep=""),
           col="blue", angle = 90) +
  theme_bw() +
  theme(text = element_text(size=14),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
        axis.line=element_line(size=.5, color="black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_x_continuous(limits = c(1100, 3100), breaks=seq(1500, 3000, 500)) +
  labs(y=paste("Density of simulated outcomes (", year, " ADP", ")\n", sep = ""),
       x=paste("\nTotal days used in ", year, sep = ""))
```

```{r costs.plot, include=FALSE}
# Get the budget used in the ADP
BUDGET <- dp_res$BUD$BUD

# Get total costs
days_paid_sum <- days_paid %>% 
                 summarise(Total.Base.Dollars = sum(Base.Dollars, na.rm = TRUE),
                           Total.Option.Dollars = sum(Option.Dollars, na.rm = TRUE),
                           Total.Travel.Dollars = sum(Travel.Dollars, na.rm = TRUE),
                           Total.Quarantine.Dollars = sum(Quarantine..Dollars, na.rm = TRUE),
                           Total.Plant.Dollars = sum(Plant..Dollars, na.rm = TRUE)) %>% 
                 mutate(Total.Dollars = Total.Base.Dollars + Total.Option.Dollars + Total.Travel.Dollars + Total.Quarantine.Dollars + Total.Plant.Dollars)

# Plot
costs.plot <- ggplot(sample_budget_out, aes(x = ADP_C)) +
              geom_histogram(aes(y = ..density..), binwidth = 20000, alpha=0.2, 
                             fill="green", col="darkseagreen2") +
              geom_vline(xintercept = BUDGET, lty=2, col="black") +
              geom_vline(xintercept = days_paid_sum$Total.Dollars, lty=1, col="darkgreen") +
              annotate("text", x=BUDGET + 30000, y=0.000001, 
                       label=paste("Available Contract Budget: $", prettyNum(BUDGET, big.mark=","), sep=""), col="black", angle = 90) +
              annotate("text", x=days_paid_sum$Total.Dollars - 30000, y=0.000001, 
                       label=paste("Actual Contract Cost: $", prettyNum(days_paid_sum$Total.Dollars, big.mark=","), sep=""), 
                       col="darkgreen", angle = 90) +
              theme_bw() +
              theme(text = element_text(size=14),
                    axis.title.x = element_text(size=12),
                    axis.title.y = element_text(size=12),
                    axis.line=element_line(size=.5, color="black"),
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank()) +
              scale_x_continuous(limits = c(2600000, 4250000), breaks=c(3000000, 4000000, 5000000),
                                 labels = dollar) +
              labs(y=paste("Density of simulated outcomes (", year, " ADP", ")\n", sep = ""), 
                   x=paste("\nTotal contract costs in ", year, sep = ""))
```

```{r budget_eval, include=FALSE}
# Isolate ADP rate predictions for the chosen design
sample_pops_out <- adp_out$ADJ[ALLO == "min_plus_opt"]

# Evaluate why we were off budget
trip.budget.table <- merge(
                     # Predicted trips days by strata
                     sample_pops_out %>%
                     group_by(STRATA) %>%
                     summarise(pred_days = round(mean(STRATA_N) * mean(TRP_DUR)))
                     ,
                     # Actual trip days by strata
                     work.data %>%
                     filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>%
                     group_by(TRIP_ID, STRATA) %>%
                     summarise(dmin = min(TRIP_TARGET_DATE, LANDING_DATE, na.rm=TRUE),
                     dmax = max(TRIP_TARGET_DATE, LANDING_DATE, na.rm=TRUE)) %>%
                     mutate(days = ceiling(as.numeric(difftime(dmax, dmin, units="days")))+1) %>%
                     group_by(STRATA) %>% 
                     summarise(act_days = sum(days))
                     , all = TRUE) %>% 
                     # Calculate total predicted days for EM strata from final  
                     # ADP document, since their trip duration isn't in ADP output 
                     mutate(pred_days = ifelse(STRATA == "EM HAL", round(806 * (1204/242)), pred_days),
                            pred_days = ifelse(STRATA == "EM POT", round(113 * (159/34)), pred_days),
                            pred_days = ifelse(STRATA == "EM TRW EFP", round(496 * (401/149)), pred_days)) %>% 
                     # Change NAs to 0 for actual days      
                     mutate(act_days  = ifelse(is.na(act_days), 0, act_days)) %>% 
                     # Percent difference between predicted and actual
                     mutate(diff = act_days -  pred_days,
                            perc = (diff)/pred_days * 100) %>%
                     mutate(perc = ifelse(is.infinite(perc), "-", format(perc, digits = 1, nsmall = 1)))

# Append total
trip.budget.table <- rbind(trip.budget.table,
                           trip.budget.table %>% 
summarise(STRATA = "Total", pred_days = sum(pred_days), act_days = sum(act_days), diff = sum(diff), perc = format(sum(diff)/sum(pred_days) * 100, digits = 1, nsmall = 1)))
```

Each year, the NMFS sets an annual budget for the Observer Program in terms of cost and observer days. The partial coverage observer day budget for `r year` was set at \$`r formatC(BUDGET, format="d", big.mark=",")` and `r formatC(AvailableYR, format="d", big.mark=",")` days in the `r year` ADP, and the NMFS expected to spend \$`r formatC(days_paid_sum$Total.Dollars, format="d", big.mark=",")` observing `r formatC(PredictedYR, format="d", big.mark=",")` days (NMFS `r year-1`). The expected number of observer days is determined by the expected number of fishing days and the rate at which trips are selected for coverage. The number of fishing days expected to occur in `r year` was estimated using data on annual fishing effort from 2013 to 2018 (Ganz and Faunce 2019). Based on simulations using trip durations from 2017 and 2018, the NMFS then set selection rates so that the average cost from simulations was equal to the available budget (NMFS `r year-1`).  

In `r year`, the FMA paid for `r formatC(round(ActualYR), format="d", big.mark=",")` observer days, which was `r ifelse(eval$pct.budget.remain != 0, abs(eval$pct.budget.remain), " ")` `r ifelse(eval$pct.budget.remain != 0, "%", "")` `r eval$more.or.less` predicted by the average simulation, but well within the range of possibilities predicted in the `r year` ADP (`r fig_nums('outcomes.plot', display = "cite")`, top panel). This is explained by the fact that there was more effort in *HAL*, *POT – Tender*, and *TRW – Tender* than expected (`r tbl_nums('trip.budget.table', display="cite")`). Despite observing more days than predicted, expenditures for partial observer coverage were under budget (`r fig_nums('outcomes.plot', display = "cite")`, bottom panel). This resulted because the cost of a partial coverage observer day in `r year` was less than the expected cost that was estimated in the `r year` ADP.     

#Performance of the Observer Declare and Deploy System in Trip-Selection  
The random selection of trips for monitoring is made by the ODDS for logged trips within the observer and EM trip selection pools. The ODDS generates a random number according to the pre-determined rates and assigns each logged trip to either “selected to be monitored” (selected) or “not selected to be monitored” (not selected) categories. For observer pool trips, the NMFS observer provider has access to all selected trip information necessary to schedule observer logistics. Up to three trips may be logged in advance of fishing to provide industry users with flexibility to accommodate their fishing operations.        

```{r odds.performance, warning=FALSE, include=FALSE}
# Calculate a test metric for the random number process in ODDS
# Trips outside of trip-selection do not have random numbers in ODDS_MONITOR (e.g. voluntary 100%)
# There may or may not be NAs in RANDOM_NUMBER_USED, depending on the stratification used
# This analysis needs to be done regardless of whether there are NAs in RANDOM_NUMBER_USED
odds.dat <- mutate(odds.dat, random.assign = NA) %>% 
            mutate(random.assign = ifelse(!is.na(RANDOM_NUMBER_USED), 0, random.assign)) %>% 
            mutate(random.assign = ifelse(!is.na(RANDOM_NUMBER_USED) & RANDOM_NUMBER_USED < (ODDS_SELECTION_PCT / 100), 1, random.assign)) 

# Are assignments being performed as programmed?
# ND = Not observed (Provider Defaulted)
# RO = Observer Trip (Require Observer)
# OA = Observed Trip (Observer Assigned)
# RL = Not Observed (Provider Release)
# NO = Not Observed Trip (Observer Not Required or Waiver Granted)
# SAMPLE_PLAN_SEQ == 98 are EM trips that were marked "OA" only because they fished IFQ in more than one area 
odds.dat <- mutate(odds.dat, random.test = 0) %>% 
            mutate(random.test = ifelse(TRIP_OBS_CODE %in% c("ND", "RO", "OA", "RL") & SAMPLE_PLAN_SEQ != 98, 1, random.test)) %>% 
            mutate(random.test = ifelse(!is.na(WAIVER_TYPE), 1, random.test)) %>%  # Waived trips
            mutate(random.test = ifelse(!is.na(INHERIT_OBS_TRIP_SEQ), NA, random.test)) %>% # Inherited trips aren't truely 'selected'
            mutate(random.test = ifelse(TRIP_STATUS_CODE == "CC", NA, random.test)) %>% # CC = 'cascade cancel'
            mutate(random.test = ifelse(is.na(RANDOM_NUMBER_USED), NA, random.test))
            
# Make NA all 1) RANDOM_NUMBER_USED = NA or 2) INHERIT_OBS_TRIP_SEQ is not an NA OR the trip was a 'cascade cancel'
# odds.dat$random.test[is.na(odds.dat$RANDOM_NUMBER_USED) | !is.na(odds.dat$INHERIT_OBS_TRIP_SEQ) | odds.dat$TRIP_STATUS_CODE == "CC"] <- NA

#Perform the test
odds.dat <- mutate(odds.dat, random.test = random.test - random.assign) %>% 
            mutate(random.test.result = ifelse(random.test == 0, "PASS", "FAIL"))

filter(odds.dat, random.test.result == "FAIL")

table(odds.dat$random.assign, useNA = "always")
```

```{r disposition.tbl, warning=FALSE, include=FALSE}
# Table 3-2 ----
# Disposition of trips in the ODDS. This table summarizes the frequency of trip activities.  
# It does not represent the actual trips expected on the grounds. That is the next table.
disposition <- # Merging two elements:
  merge(
    # The first is by strata
    odds.dat %>%  
      select(STRATA, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, WAIVER_TYPE, TRIP_PLAN_NUMBER) %>%
      filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>% 
      group_by(STRATA, random.assign) %>%
      summarize(Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
                Trips.cancelled.bysystem = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE=="CS"]),
                Trips.remaining = Trips.logged.ODDS - Trips.cancelled.bysystem,
                Trips.cancelled.byusers = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE %in% c("CN", "CC")]),
                # Trips.waived= length(TRIP_PLAN_LOG_SEQ[!is.na(WAIVER_TYPE)]),
                Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)])) %>%
      mutate(Cancellation.Pct = format(round((Trips.cancelled.byusers / Trips.remaining) * 100, 1), nsmall=1)) %>% 
                # Waiver.Pct = format(round((Trips.waived / Trips.remaining) * 100, 1), nsmall=1)) %>%
      data.frame(),
     # The second is the grand total
     # odds.dat %>%
     #   filter(STRATA %in% partial$STRATA) %>% 
     #   summarize(STRATA = "Total",
     #             Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
     #             # Only include "Selected" for cancellations summaries
     #             Trips.cancelled.bysystem = length(unique(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE=="CS" & random.assign==1])),
     #             Trips.selected = length(unique(TRIP_PLAN_LOG_SEQ[random.assign==1])),
     #             Trips.remaining = Trips.logged.ODDS - Trips.cancelled.bysystem,
     #             # Only include "Selected" for cancellations summaries
     #             Trips.cancelled.byusers = length(TRIP_PLAN_LOG_SEQ[(TRIP_STATUS_CODE %in% c("CN", "CC")) & random.assign==1]),
     #             # Trips.waived = length(TRIP_PLAN_LOG_SEQ[!is.na(WAIVER_TYPE)]),
     #             Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)]),
     #             random.assign = "") %>%
     #    mutate(Cancellation.Pct = format(round((Trips.cancelled.byusers / Trips.selected) * 100, 1), nsmall=1)) %>% 
     #    select(-Trips.selected) %>% 
     #    data.frame(), 
    odds.dat %>%  
      select(STRATA, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, WAIVER_TYPE, TRIP_PLAN_NUMBER) %>%
      filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>% 
      group_by(random.assign) %>%
      summarize(STRATA = "Total",
                Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
                Trips.cancelled.bysystem = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE=="CS"]),
                Trips.remaining = Trips.logged.ODDS - Trips.cancelled.bysystem,
                Trips.cancelled.byusers = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE %in% c("CN", "CC")]),
                # Trips.waived= length(TRIP_PLAN_LOG_SEQ[!is.na(WAIVER_TYPE)]),
                Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)])) %>%
      mutate(Cancellation.Pct = format(round((Trips.cancelled.byusers / Trips.remaining) * 100, 1), nsmall=1)) %>% 
                # Waiver.Pct = format(round((Trips.waived / Trips.remaining) * 100, 1), nsmall=1)) %>%
      data.frame(),
     # Merge type
     all=T)

# Don't include Not Selected trips (random.assign==0) in cancellation summaries since its not required by user. 
disposition$Trips.cancelled.bysystem[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""
disposition$Trips.remaining[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""
disposition$Trips.cancelled.byusers[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""
disposition$Cancellation.Pct[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""

#define values in the random.assign  
disposition$random.assign[is.na(disposition$random.assign) | disposition$random.assign == 1] <- "Selected"
disposition$random.assign[disposition$random.assign == 0] <- "Not Selected"

# Then rename some columns for the table
disposition.table <- 
  disposition %>%
  arrange(match(STRATA, c("HAL", "EM HAL", "POT", "EM POT", "TRW", "Total"))) %>% 
  rename('Strata' = STRATA, 
         'Random number outcomes' = random.assign, 
         'Logged (*a*)' = Trips.logged.ODDS, 
         'Cancelled by system (*b*)' = Trips.cancelled.bysystem,
         'Trips remaining (*c* = *a*-*b*)' = Trips.remaining, 
         'Cancelled by user (*d*)' = Trips.cancelled.byusers, 
         #'Waived' = Trips.waived, 
         'Paper' = Paper.tickets, 
         '% User cancellation (*d*/*c* * 100)' = Cancellation.Pct)
         #'Waiver (%)' = Waiver.Pct)
```

```{r odds.logged.tbl, warning=FALSE, include=FALSE}
# Table 3-3 ---- 
#Disposition of trips - showing only valid trips and categories are exclusive
logged <-
  odds.dat %>% 
  # only pull in partial coverage
  filter(!ODDS_SELECTION_PCT %in% c(0, 100), !is.na(TRIP_SELECTED_OBS)) %>%  
  filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>% 
  group_by(STRATA) %>% 
  summarize(Total.trips = length(unique(TRIP_PLAN_LOG_SEQ)),
            Random.selected = sum(random.assign, na.rm = TRUE), 
            # Number of trips that are not selected by a random number but were 
            # selected by inherits instead and were not subsequently waived
            # (EXTRA TRIPS BEYOND RANDOM SELECTION DUE TO INHERITS)
            Inherit.selected = length(unique(TRIP_PLAN_LOG_SEQ[random.assign == 0 & 
                                                               !is.na(INHERIT_OBS_TRIP_SEQ) &
                                                                is.na(WAIVER_TYPE)])),
            # Randomly selected trips that were waived.
            Waivers.selected = length(unique(TRIP_PLAN_LOG_SEQ[random.assign == 1 & 
                                                               !is.na(WAIVER_TYPE)])),
            # Below are the outcomes of inherits and waivers
            Total.final.selected = length(unique(TRIP_PLAN_LOG_SEQ[TRIP_SELECTED_OBS == "Y"])),
            # Percent of total selected trips due to inherits
            Pct.selected.from.inherit = format(round((Inherit.selected / Total.final.selected) * 100, 1), nsmall = 1),
            # % Reduction in Selected Trips due to Waivers
            Pct.allselected.from.waiver = format(round((Waivers.selected / (Total.final.selected + Waivers.selected)) * 100, 1), nsmall = 1)) %>% 
  arrange(match(STRATA, c("HAL", "EM HAL", "POT ", "EM POT", "TRW")))

logged.table <- rbind(logged, 
                      logged %>% 
                      summarise(STRATA = "Total",
                                Total.trips = sum(Total.trips),
                                Random.selected = sum(Random.selected),
                                Inherit.selected = sum(Inherit.selected),
                                Waivers.selected = sum(Waivers.selected),
                                Total.final.selected = sum(Total.final.selected)) %>% 
                      mutate(Pct.selected.from.inherit = format(round((Inherit.selected / Total.final.selected) * 100, 1), nsmall = 1),
                             Pct.allselected.from.waiver = format(round((Waivers.selected / (Total.final.selected + Waivers.selected)) * 100, 1), nsmall = 1))) %>% 
                      select(`Strata`=STRATA, `Total Trips`=Total.trips,
                             `Random number selection (*r*)`=Random.selected, 
                             `Inherited selection** (*i*)`=Inherit.selected,
                             `Randomly selected but waived (*w*)`=Waivers.selected, 
                             `Total final selected (*T*=*r*+*i*-*w*)`=Total.final.selected,
                             `% Selected from inherits ((*i*/*T*)*100)`=Pct.selected.from.inherit, 
                             `% Reduction of selected trips due to waivers (*w*/(*T*+*w*)*100)`=Pct.allselected.from.waiver)
```

```{r selection.tbl, warning=FALSE, include=FALSE}
# Table 3-4 ----
# This table will show probabilities that selection rates = programmed rates
# under various assumptions
for.p.wide <- merge(
  logged %>% 
  group_by(STRATA) %>% 
  summarize(random.n = Random.selected,
            inherit.n = Total.final.selected,
            inherit.butnowaiver.n = (Total.final.selected + Waivers.selected),
            Total.n = Total.trips,
            Source = "Valid trips only"
            ),
  # Now add in the total trips for the random number only
  odds.dat %>% 
  filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>%
  filter(!is.na(random.assign)) %>% 
  group_by(STRATA) %>%
  summarize(random.n = length(unique(TRIP_PLAN_LOG_SEQ[random.assign == 1])),
            Total.n = length(unique(TRIP_PLAN_LOG_SEQ)),
            Source = "ODDS random number"), 
  all = TRUE) %>% 
  arrange(Source, STRATA)

# Need to merge in the selection rates for calculating p-values later
for.p.wide <- merge(
  for.p.wide, 
  partial %>%
  filter(Effective_Date == min(Effective_Date) & STRATA != "EM TRW EFP") %>% 
  distinct(STRATA, ODDS_SELECTION_PCT = Rate * 100), 
  all = TRUE)

# Put into long format
p.table <- gather(data = for.p.wide, key, value, -STRATA, -Total.n, -ODDS_SELECTION_PCT, -Source)

# Omit records with missing values
p.table <- p.table[!is.na(p.table$value), ]

for(i in 1:nrow(p.table)){
  p.table$pct[i] = round((p.table$value[i] / p.table$Total.n[i]) * 100, 2)
  # Check out this format - forces digits even if zero value!
  p.table$p[i] = format(round(stats::binom.test(p.table$value[i], p.table$Total.n[i], 
                        p = p.table$ODDS_SELECTION_PCT[i] / 100, 
                        alternative = "two.sided")$p.value, 3), nsmall = 3)}

# Format percentages with the same nuber of significant figures as 
p.table <- p.table %>% 
           mutate(ODDS_SELECTION_PCT = format(ODDS_SELECTION_PCT, nsmall=1), pct = format(pct, nsmall=1))

# Cleanup
rm(for.p.wide)

# rename values for one column
p.table$key[p.table$key == "inherit.n"] <- "Expected"
p.table$key[p.table$key == "random.n"] <- "Random Selection Only"
p.table$key[p.table$key == "inherit.butnowaiver.n"] <- "Expected if no waivers"

# Create table
Selection.table <- p.table %>% 
                   arrange( STRATA, Source, desc(key)) %>%
                   arrange(match(STRATA, c("HAL", "EM HAL", "POT", "EM POT", "TRW"))) %>% 
                   mutate(new_trip_type = 
                          derivedFactor('Initial Random Selection, *a*'= Source=="ODDS random number",
                                        'After Cancellations, *b* (*a*-*b*)' = key=="Random Selection Only" & Source=="Valid trips only",
                                        'With Inherits, *c* (*a*-*b*+*c*)' = key=="Expected if no waivers",
                                        'After Waivers, *d* (*a*-*b*+*c*-*d*)' = key=="Expected",
                                        .ordered=TRUE, .method="unique")) %>% 
                   select("Strata" = STRATA, 
                          "Trip disposition" = new_trip_type, 
                          "Selected trips" = value,
                          "Total trips" = Total.n, 
                          "Actual selection (%)" = pct,
                          "Programmed selection (%)" = ODDS_SELECTION_PCT,
                          "p-value (H0: Actual = Programmed)" = p)
```

```{r odds.ts.daily.cuml.fig, warning=FALSE, include=FALSE}
odds.ts.daily.cuml <- odds.dat %>% # These are all logged trips
     filter(!ODDS_SELECTION_PCT %in% c(0, 100)) %>%
     transform(Date = as.Date(ORIGINAL_EMBARK_DATE, format="%Y-%m-%d")) %>% 
     filter(STRATA %in% partial$STRATA) %>% 
     group_by(STRATA, Date) %>%
     summarize(n = sum(random.assign, na.rm=TRUE),
               ni = length(unique(TRIP_PLAN_LOG_SEQ[!is.na(INHERIT_OBS_TRIP_SEQ)])),
               N = length(unique(TRIP_PLAN_LOG_SEQ)),
               TYPE="Original date: All logged trips") %>% 
     arrange(Date) %>% 
     ungroup() %>% 
     bind_rows(
          odds.dat %>% # These are the 'valid trips' only
               filter(!ODDS_SELECTION_PCT %in% c(0, 100), !is.na(TRIP_SELECTED_OBS)) %>%
               transform(Date = as.Date(PLANNED_EMBARK_DATE, format="%Y-%m-%d")) %>% 
               filter(STRATA %in% partial$STRATA) %>% 
               group_by(STRATA, Date) %>%
               summarize(n = length(unique(TRIP_PLAN_LOG_SEQ[TRIP_SELECTED_OBS == "Y"])),
                         ni = length(unique(TRIP_PLAN_LOG_SEQ[!is.na(INHERIT_OBS_TRIP_SEQ)])),
                         N = length(unique(TRIP_PLAN_LOG_SEQ)),
                         TYPE = "Adjusted date: Valid trips only") %>% 
               arrange(Date) %>% 
               ungroup()) %>% 
     mutate(TYPE = as.factor(TYPE)) %>% 
     group_by(STRATA, TYPE) %>%
     mutate(running.n = order_by(Date, cumsum(n)),
            running.N = order_by(Date, cumsum(N)), 
            rug_ni = if_else(ni != 0, Date, as.Date(NA)),
            running.pct = round((running.n / running.N) * 100, 2)) %>% 
     arrange(STRATA, TYPE, Date) %>%
     right_join(
          partial %>%
          filter(Effective_Date == min(Effective_Date) & STRATA != "EM TRW EFP") %>% 
          distinct(STRATA, ODDS_SELECTION_PCT = Rate * 100), 
          by = "STRATA") %>% 
     ungroup()

# reorder strata for plot
odds.ts.daily.cuml <- transform(odds.ts.daily.cuml,
                                STRATA = factor(STRATA, levels=c("EM HAL", "EM POT", "HAL", "POT", "TRW")))

# Generate data for ribbon plots for the random data only.
odds.ts.daily.cuml$L95 <- ifelse(
                          odds.ts.daily.cuml$TYPE=="Adjusted date: Valid trips only", 
                          NA, 
                          round((qbinom(0.025, 
                                        odds.ts.daily.cuml$running.N, 
                                        odds.ts.daily.cuml$ODDS_SELECTION_PCT / 100)) / odds.ts.daily.cuml$running.N, 3))

odds.ts.daily.cuml$H95 <- ifelse(
                          odds.ts.daily.cuml$TYPE=="Adjusted date: Valid trips only", 
                          NA, 
                          round((qbinom(0.975,
                                        odds.ts.daily.cuml$running.N,
                                        odds.ts.daily.cuml$ODDS_SELECTION_PCT / 100)) /
                                        odds.ts.daily.cuml$running.N, 3))

for(i in 1:nrow(odds.ts.daily.cuml)){
  odds.ts.daily.cuml$test_stat_random[i] <- ifelse(
    odds.ts.daily.cuml$running.n[i] < 1, NA,
    round(binom.test(odds.ts.daily.cuml$running.n[i],
                     odds.ts.daily.cuml$running.N[i],
                     odds.ts.daily.cuml$ODDS_SELECTION_PCT[i] / 100,
                     alternative='two.sided')$p.value, 3))
}

rm(i)

# Text to annotage figure
for.plot.text <- left_join(
                 odds.ts.daily.cuml %>% 
                 group_by(STRATA, TYPE) %>% 
                 filter(Date == max(Date)) %>%
                 group_by(STRATA) %>% 
                 mutate(label.original = format(running.pct[TYPE=="Original date: All logged trips"], digits = 4, nsmall = 2),
                        label.adjusted = format(running.pct[TYPE=="Adjusted date: Valid trips only"], digits = 4, nsmall = 2)) %>% 
                 distinct(STRATA, label.original, label.adjusted)
                 ,
                 partial %>% 
                 filter(Effective_Date == min(Effective_Date) & STRATA != "EM TRW EFP") %>%
                 select(STRATA, label.programmed = Rate) %>% 
                 mutate(STRATA = as.character(STRATA), 
                        label.programmed = format(label.programmed * 100, digits = 4, nsmall = 2))
                 , by="STRATA")

odds.ts.daily.cuml <- merge(odds.ts.daily.cuml, for.plot.text)

#ODDS by date plot (Cumulative coverage percent by strata over the year)
odds.by.date.plot <- 
  ggplot(odds.ts.daily.cuml, aes(Date, running.pct, col=TYPE)) +
     geom_hline(aes(yintercept = ODDS_SELECTION_PCT), lty=3, size=1) +
     geom_ribbon(aes(ymin=L95 * 100, ymax=H95 * 100), alpha=0.1) +
     geom_line(size = 1.5) +
     scale_color_manual(name="Rate Type", values=c("black", "gray70")) +
     ylab('Cumulative Coverage Percent\n') +
     coord_cartesian(ylim=c(0, 70)) +
     xlab('\nDate') +
     geom_rug(data = odds.ts.daily.cuml %>% filter(TYPE=="Original date: All logged trips"),
                 aes(x = rug_ni), length = unit(0.1, "npc"), sides = "b") +
     geom_rug(data = odds.ts.daily.cuml %>% filter(TYPE!="Original date: All logged trips"),
                 aes(x = rug_ni), length = unit(0.1, "npc"), sides = "t") +
     facet_wrap(~ STRATA, ncol = 2) +
     geom_text(aes(x = as.Date(paste(year, "-8-01", sep = "")), y = 60, 
                   label = paste("Programmed (%) = ", label.programmed, sep = "")), size = 3, color = "black") + 
     geom_text(aes(x = as.Date(paste(year, "-8-01", sep = "")), y = 54, 
                   label = paste("Original (%) = ", label.original, sep = "")), size = 3, color = "gray70") + 
     geom_text(aes(x = as.Date(paste(year, "-8-01", sep = "")), y = 48, 
                   label = paste("Final (%) = ", label.adjusted, sep = "")), size = 3, color = "black") + 
     fig.theme + 
     theme_bw() +
     theme(axis.text.x = element_text(angle = 90),
           strip.text.x = element_text(size = 10),
           legend.position = "none")
```

```{r odds_paragraph, warning=FALSE, include=FALSE}
# Objects that help increase readability of in-text calcs in the following paragraphs

#Total cancelled trips (both by ODDS or by users)
totl.canc <- disposition %>% 
             filter(STRATA=="Total" & random.assign == "Selected") %>% 
             transmute(totl.canc = as.numeric(Trips.cancelled.bysystem) + as.numeric(Trips.cancelled.byusers)) %>% 
             as.numeric()

#Percent of total trips cancelled by the ODDS system
perc.syst.canc <- disposition %>% 
                  filter(STRATA=="Total" & random.assign == "Selected") %>% 
                  transmute(perc.syst.canc = round((as.numeric(Trips.cancelled.bysystem) / as.numeric(Trips.logged.ODDS)) * 100, 2)) %>% 
                  as.numeric()

#Percent of total trips cancelled by users
perc.user.canc <- disposition %>% 
                  filter(STRATA=="Total" & random.assign == "Selected") %>% 
                  transmute(perc.syst.canc = format((as.numeric(Trips.cancelled.byusers) / as.numeric(Trips.logged.ODDS)) * 100, digits=1, nsmall=1)) %>% 
                  as.character()

# Lowest and highest cancellation rate/stratum for selected trips by strata
sel.min.canc <- disposition %>% 
                filter(STRATA!="Total" & random.assign == "Selected") %>%
                slice_min(as.numeric(Cancellation.Pct)) %>% 
                select(STRATA, Cancellation.Pct)

sel.max.canc <- disposition %>% 
                filter(STRATA!="Total" & random.assign == "Selected") %>%
                slice_max(as.numeric(Cancellation.Pct)) %>% 
                select(STRATA, Cancellation.Pct)
```

Logged trips have different dispositions. When initially logged, trips are considered pending and can be either closed or cancelled. Whether changes can be made by the user (person logging the trip) or must be made by the monitoring provider (or the NMFS) depends on whether or not the trip is selected to be monitored, the stratum the trip belongs to, and the timing of the activity. Trips can be closed (marked as complete) by the ODDS user after the planned trip departure date by either entering the dates of the trip and the port processor of the landing, or by selecting from a list of pre-populated landing reports. For partial coverage strata monitored by observers, the observer provider is given 72 hours prior to the trip start to provide for an observer to board the vessel. While a trip may be entered into ODDS that is scheduled to start earlier than 72 hours from the time of entry, if selected for observer coverage, the observer provider can opt to delay the start of the trip up to, but not exceeding 72 hours from the time of trip entry. This helps protect the observer provider from the high cost of deploying an observer with short notice. The vessel operator is protected as well by guaranteeing the assigned observer to the vessel up to 48 hours past the planned start of the fishing trip. This rule helps ensure that an observer is available to the boat in case of unforeseen events such as weather. If, however, the trip start date and time has passed by more than 48 hours, then the observer provider can cancel the trip and release the observer from the vessel and trip, and the vessel would need to log a new trip with a new 72-hour notice in place prior to fishing. These ‘forced cancellations’ are not present in trips that are not selected for observation since the logging, closing, or cancellation of the trip is entirely under vessel control. The vessel operator may change the dates of a logged trip regardless of selection status prior to, or in lieu of cancellation. However, trips that have not been closed at the end of the calendar year are automatically cancelled by the ODDS to prevent `r year` ODDS trips from affecting the deployment rates set for the `r year+1` ADP.  

The number of trips logged in the ODDS in `r year` and their dispositions is summarized in `r tbl_nums('disposition.table', display = "cite")`, `r tbl_nums('logged.table', display = "cite")`, and `r tbl_nums('Selection.table', display = "cite")`. The forced cancellation rate by users and by the ODDS is summarized for selected trips in each stratum (`r tbl_nums('disposition.table', display = "cite")`).  Of the `r formatC(sum(disposition$Trips.logged.ODDS[disposition$STRATA=="Total"]), format="d", big.mark=",")` total trips logged, `r sum(disposition$Trips.logged.ODDS[disposition$STRATA == "Total" & disposition$random.assign=="Selected"])` were selected, and `r formatC(totl.canc, format="d", big.mark=",")` were cancelled: `r formatC(disposition$Trips.cancelled.bysystem[disposition$STRATA=="Total" & disposition$random.assign=="Selected"], format="d", big.mark=",")` by ODDS (`r perc.syst.canc`%) and `r formatC(disposition$Trips.cancelled.byuser[disposition$STRATA=="Total" & disposition$random.assign=="Selected"], format="d", big.mark=",")` by users (`r perc.user.canc`%).  The user cancellation rate for selected trips ranged from 1.9% for *EM POT* to 26.7% for *TRW - Tender*.          

```{r odds_paragraph2, warning=FALSE, include=FALSE}
# Lowest and highest percentages of valid trips that were selected from the inherit process. 
inherit.min <- logged %>% 
               slice_min(as.numeric(Pct.selected.from.inherit)) %>% 
               select(STRATA, Pct.selected.from.inherit)

inherit.max <- logged %>% 
               slice_max(as.numeric(Pct.selected.from.inherit)) %>% 
               select(STRATA, Pct.selected.from.inherit)


# Waiver impact
waiver.min <- logged %>% 
              slice_min(as.numeric(Pct.allselected.from.waiver)) %>% 
              select(Pct.allselected.from.waiver) %>% as.character()

waiver.max <- logged %>% 
              slice_max(as.numeric(Pct.allselected.from.waiver)) %>% 
              select(Pct.allselected.from.waiver) %>% as.character()
```

The flexibility offered by the ODDS means that the outcome of random selection is known to the vessel operator for up to three logged trips in advance of fishing. In the case where ODDS users disproportionately cancel selected trips, one would expect monitoring coverage to be lower than the programmed selection rates. To reduce this potential bias, the ODDS is programmed to automatically select the vessel’s next logged trip if a previously selected trip was cancelled by the user. Although these “inherited” trips preserve the *number* of selected trips in the year, they cannot prevent the *delay* of selected trips during the year. Therefore, the potential for temporal bias is still present. The percentages of selected trips from either inherits or waivers are found in `r tbl_nums('logged.table', display = "cite")`. The relative percentage of selected trips that inherited their final selected-status due to a previous cancellation ranged from 3.8% for *EM POT* to 26.7% for *POT - Tender* (`r tbl_nums('logged.table', display = "cite")`). Within the same gear-type, cancellation rates and the proportion of inherited trips were much larger for strata that used observers for at-sea monitoring than those that used EM.       

```{r odds_paragraph3, warning=FALSE, include=FALSE}
#Text strings for reporting on the observered initial selection rates by strata
pct_txt <- p.table %>% 
           filter(Source=="ODDS random number") %>% 
           mutate(pct_txt = paste0(pct, "% for the *", STRATA, "* stratum")) %>% 
           distinct(pct_txt) 

#Extract p-values associated with random selection (H0: observed=expected
#rates). Merge to the partial look up table to ensure that things stay in order.
random_pvals <- merge(p.table
                      , 
                      partial %>% 
                      filter(STRATA != "EM TRW EFP") %>% 
                      distinct(STRATA, formatted_strat)) %>% 
                filter(Source=="ODDS random number") %>% 
                select(p, formatted_strat)
 
#Text strings for reporting on the observered FINAL selection rates by strata
final_pct_txt <- p.table %>% 
                 filter(key=="Expected") %>% 
                 mutate(pct_txt = paste0(pct, "% for the *", STRATA, "* stratum")) %>% 
                 distinct(pct_txt) 

#Extract p-values associated with FINAL selection (H0: final observed=expected
#rates).
final_pvals <- merge(p.table
                      , 
                      partial %>% 
                      filter(STRATA != "EM TRW EFP") %>% 
                      distinct(STRATA, formatted_strat)) %>% 
               filter(key=="Expected") %>% 
               select(p, formatted_strat)
```

The extent to which trip-selections are changed from the time they are entered can be determined by comparing the rate of trip observation expected from 1) random selection of all logged trips (initial random selection) and 2) random selection of remaining trips after cancellations, waivers, and inherited trips. In any case, the proportion of trips selected to be observed should fall within what would be expected given the binomial distribution (since each trip is either selected or not selected). The rates obtained (%, with associated p-value based on the binomial distribution) in the initial selection process were within expected ranges with the following exceptions – the initial selection rate was 33.91% (p-value = 0.011) for the *EM HAL* stratum, and 39.47% (p-value = 0.020) for the *TRW - Tender* stratum (`r tbl_nums('Selection.table', display = "cite")`). This means that the *EM HAL* and *TRW - Tender* strata were being over-selected in ODDS, and that we should interpret high final coverage rates in these strata with caution.  

The final selection rate after trips were closed, cancelled, or waived were within expected bounds with the exception of the *HAL* stratum 20.47% (p-value = 0.006), the *EM HAL* stratum, 34.80% (p-value = 0.002)  and the *TRW - Tender* stratum 46.55% (p-value = 0.002; `r tbl_nums('Selection.table', display = "cite")`). Given the high initial selection rates, we can safely disregard these final selection rates with the exception of the *HAL* stratum.    

Differences in the initial selection rates of ODDS and those that result after cancellation and trip changes can also be looked at over time (`r fig_nums('odds.by.date.plot', display="cite")`). In this plot, we are mostly concerned when the lines representing the two selection rates in this plot diverge substantially.  Deviations appeared in the *HAL* stratum during January, March – April, and October – November (`r fig_nums('odds.by.date.plot', display="cite")`). This pattern can occur when cancelled trips that were originally selected for coverage are preserved through the inherit process, while cancelled trips that were not originally selected for coverage are not.       

In addition to the inherit process, the lack of linkage between the ODDS and eLandings contributes to the differences between programmed selection rates in ODDS and trips that are ultimately observed. Currently, ODDS provides users with a list of Report IDs from eLandings from which to close their logged trips. However, these data are not validated, or error checked, making them unreliable in their current state. This linkage between the logged (ODDS) trip (with its selection probability) and its associated landing information is necessary to evaluate potential improvements in deployment efficiency within the partial coverage fleet.            

##Evaluation of Deployment Rates  
This section compares the coverage rate achieved against the expected coverage rates. Data used in this evaluation are stored within the Catch Accounting System (CAS, managed by the AKRO), the Observer Program database (NORPAC, managed by the AFSC), and eLandings (under joint management by Alaska Department of Fish and Game - ADF&G; the International Pacific Halibut Commission - IPHC; and the NMFS). Separate rate evaluations are conducted depending on whether the unit of observer deployment was at-sea fishing trips or dockside deliveries of pollock.            

###At-sea Deployments  
```{r Coverage.tbl, message=FALSE, warning=FALSE, include=FALSE}
# Coverage table has number of total vessels (V), sampled vessels (v), total trips (N), sampled trips (n), and percent observed by deployment method (trip vs. vessel-selection):


#FULL COVERAGE
Coverage.Table.full <- plyr::rbind.fill(
  #Coverage rates for vessels in the full coverage category (both regulator full
  #cov or voluntary)
  work.data %>%
    filter(COVERAGE_TYPE == "FULL") %>% 
    group_by(COVERAGE_TYPE, STRATA) %>%
    summarize(V=length(unique(VESSEL_ID)),
                     v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                     N=length(unique(TRIP_ID)),
                     n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(Pct.obs= format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection",
           Rate = 1,
           meets.expected = "") %>% 
    select(COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, meets.expected) %>% 
    arrange(desc(STRATA))
    ,
    # Totals for vessels in the full coverage category
    work.data %>%
      filter(COVERAGE_TYPE == "FULL") %>%
      summarize(V=length(unique(VESSEL_ID)),
                v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                N=length(unique(TRIP_ID)),
                n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
      mutate(COVERAGE_TYPE = "Full Coverage Total",
             Pct.obs=format((n/N)*100, digits=1, nsmall=1),
             deployment.method = "Trip-Selection")
)

#PARTIAL COVERAGE TRIP-SELECTION
Coverage.Table.partial <- plyr::rbind.fill(
  #By strata for vessels in the partial coverage category (trip-selection)
  work.data %>%
    filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>% 
    group_by(COVERAGE_TYPE, STRATA) %>%
    summarize(V=length(unique(VESSEL_ID)),
                     v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                     N=length(unique(TRIP_ID)),
                     n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(Pct.obs = format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection") %>% 
    #Merge the target sampling rate from the partial look up table
    full_join(partial %>% 
              filter(Effective_Date == min(Effective_Date)) %>% 
              distinct(STRATA, Rate)
              , by = "STRATA") %>% 
    group_by(COVERAGE_TYPE, STRATA) %>%
    mutate(#Add binomial distribution upper and lower 95th percentiles to for each
      #partial coverage stratum
      min.expected = round(
        stats::binom.test(x = n, n = N, p = Rate, 
                          alternative = "two.sided")$conf.int[1], 3)*100,
      max.expected = round(
        stats::binom.test(x = n, n = N, p = Rate,
                          alternative = "two.sided")$conf.int[2], 3)*100,
      meets.expected = ifelse(Rate*100 > min.expected & Rate*100 < max.expected,
                              "Yes", "No")) %>% 
    select(COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, min.expected, max.expected, meets.expected) %>% 
    arrange(match(STRATA, c("HAL", "EM HAL", "POT", "EM POT", "TRW", "EM TRW EFP")))
  ,
  # Totals for partial coverage category (in 2016, "Gear-based total")
  Coverage.Table.partial.total <- work.data %>%
    filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>% 
    summarize(V=length(unique(VESSEL_ID)),
                     v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                     N=length(unique(TRIP_ID)),
                     n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(COVERAGE_TYPE = "Gear-based Total",
           Pct.obs=format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection") 
)

#ZERO COVERAGE 
Coverage.Table.zero <- # plyr::rbind.fill(Coverage.Table.zero <-
    work.data %>%
    filter(STRATA %in% c("ZERO", "Zero EM Research")) %>% 
    mutate(STRATA=as.character(STRATA)) %>% 
    mutate(STRATA=ifelse(STRATA=="ZERO", "Zero Coverage", STRATA)) %>% 
    group_by(COVERAGE_TYPE, STRATA) %>%
    summarize(V=length(unique(VESSEL_ID)),
                     v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                     N=length(unique(TRIP_ID)),
                     n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(Pct.obs=format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection",
           Rate = 0,
           meets.expected = "") %>%  
    select(COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, meets.expected)
    # ,
    # Totals for zero coverage category 
  #   Coverage.Table.zero.total <- work.data %>%
  #   filter(STRATA %in% c("ZERO", "Zero EM Research")) %>%
  #   dplyr::summarize(V=length(unique(VESSEL_ID)),
  #                    v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
  #                    N=length(unique(TRIP_ID)),
  #                    n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
  #   mutate(COVERAGE_TYPE = "Zero Coverage Total",
  #          Pct.obs=format((n/N)*100, digits=1, nsmall=1),
  #          deployment.method = "Trip-Selection")
  # )

# Totals with EM (number of vessels is not additive)
Coverage.Table.TOTALS <- work.data %>%
  summarize(V=length(unique(VESSEL_ID)),
                   v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                   N=length(unique(TRIP_ID)),
                   n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))
  ) %>%
  mutate(COVERAGE_TYPE = "Total",
         STRATA = "Total",
         Pct.obs.trips = format((n/N)*100, digits=1, nsmall=1),
         Pct.obs.vessels = format((v/V)*100, digits=1, nsmall=1),
         Pct.obs = paste0( Pct.obs.trips, "% Trips; ", Pct.obs.vessels, "% Vessels")) 

# Totals without EM pre-implementation (number of vessels is not additive)
# The code below could be adapted in 2020 Annual Report for EM TRW
# Coverage.Table.TOTALS.sansEM <- work.data %>%
#   summarize(V=length(unique(VESSEL_ID)),
#                    v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y" & !(STRATA %in% c("EM POT - No Tender", "EM POT - Tender"))])),
#                    N=length(unique(TRIP_ID)),
#                    n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y" & !(STRATA %in% c("EM POT - No Tender", "EM POT - Tender"))]))
#   ) %>%
#   mutate(COVERAGE_TYPE = "Total Fleet (without EM POT)",
#          STRATA = "Total",
#          Pct.obs.trips = format((n/N)*100, digits=1, nsmall=1),
#          Pct.obs.vessels = format((v/V)*100, digits=1, nsmall=1),
#          Pct.obs = paste0( Pct.obs.trips, "% Trips; ", Pct.obs.vessels, "% Vessels")) 

#Combine all the coverage tables
Coverage.Table <- plyr::rbind.fill(Coverage.Table.full, 
                                   Coverage.Table.partial,
                                   Coverage.Table.zero,
                                   Coverage.Table.TOTALS # ,
                                   # Coverage.Table.TOTALS.sansEM
                                   ) %>% 
  #Formatting (change things to characters so they knit to Word without weird
  #formatting issues)
  mutate(V = as.character(V),
         v = as.character(v),
         N = as.character(N),
         n = as.character(n),
         #*FLAG* binom.test method
         #Rate = ifelse(is.na(Rate), NA, format(Rate*100, digits=1, nsmall=1)),
         
         #*FLAG* qbinom method
         Rate = ifelse(is.na(Rate), NA, 
                       ifelse(deployment.method=="Trip-Selection", 
                              format(Rate*100, digits=1, nsmall=1),
                              format(Rate, digits=0, nsmall=0))),
         min.expected = ifelse(is.na(min.expected), NA, 
                               ifelse(deployment.method=="Trip-Selection", 
                                      format(min.expected, digits=1, nsmall=1),
                                      format(min.expected, digits=0, nsmall=0))),
         max.expected = ifelse(is.na(max.expected), NA, 
                               ifelse(deployment.method=="Trip-Selection", 
                                      format(max.expected, digits=1, nsmall=1),
                                      format(max.expected, digits=0, nsmall=0))),
          # 
         COVERAGE_TYPE = fct_recode(factor(COVERAGE_TYPE), 
                                    Full = "FULL", #New.name="Old.name"
                                    Partial = "PARTIAL"),
         STRATA = fct_recode(factor(STRATA),
                             Full = "FULL",
                             Regulatory = "REGULATORY", 
                             Voluntary = "VOLUNTARY", 
                             `Zero Coverage` = "ZERO")) %>% 
  select(`Coverage` = COVERAGE_TYPE, Strata = STRATA, 
         `*V*` = V, `*v*` = v, `*N*` = N, `*n*` = n,
         `Expected` = Rate,
         `Realized` = Pct.obs,
         `Lower limit`= min.expected,
         `Upper limit` = max.expected, 
         `Realized meets expected?` = meets.expected)

#Create an empty factor level so that you can get rid of NAs in the table.
Coverage.Table$Coverage = factor(Coverage.Table$Coverage, levels=c(levels(Coverage.Table$Coverage), " "))
Coverage.Table$Strata = factor(Coverage.Table$Strata, levels=c(levels(Coverage.Table$Strata), " "))
Coverage.Table <- replace(Coverage.Table, is.na(Coverage.Table), " ")

rm(Coverage.Table.full, Coverage.Table.partial, Coverage.Table.TOTALS, Coverage.Table.zero)
```

```{r coverage_paragraph, message=FALSE, warning=FALSE, include=FALSE}
# Objects referenced in-text:

#Coverage trip and vessel totals (including EM)
totl_obs_trips <- Coverage.Table %>% filter(Strata == "Total" & Coverage == "Total") %>% select(`*n*`) %>% as.numeric()

perc_trips_obs <- Coverage.Table %>% 
  filter(Strata == "Total" & Coverage == "Total") %>% 
    transmute(percent.obs = format(as.numeric(`*n*`)/as.numeric(`*N*`) * 100, 
                                   digits=1, nsmall=1)) %>% 
  as.numeric()

totl_obs_vessels <- Coverage.Table %>% filter(Strata == "Total" & Coverage == "Total") %>% select(`*v*`) %>% as.numeric()

perc_vessels_obs <- Coverage.Table %>% 
  filter(Strata == "Total" & Coverage == "Total") %>%
  transmute(percent.obs = format(as.numeric(`*v*`)/as.numeric(`*V*`) * 100, 
                                 digits=1, nsmall=1)) %>% 
  as.numeric()

```

The `r year` Observer Program had `r total.strat` different deployment strata to be evaluated (`r tbl_nums('Coverage.Table', display = "cite")`). There was one full coverage stratum comprised of trips taken both by vessels that were required to have full coverage (e.g., AFA vessels) and those fishing in the BSAI that opted into full coverage. There were seven partial coverage strata: five observed strata defined by gear and tender designation and two EM strata defined by gear designation. There were also two zero coverage strata: one zero coverage EM research stratum and one zero coverage stratum for jig vessels and vessels under 40 ft. length overall.      

```{r em_times, message=FALSE, warning=FALSE, include=FALSE}
em_times <- EM.review %>% 
            filter(EM_DATA_REVIEWED=="YES") %>% 
            distinct(EM_REVIEWED_TRIP_NUMBER, 
                     GEAR_TYPE_LOGGED, 
                     ACTUAL_EM_TRIP_END_DATE_TIME = as.Date(ACTUAL_EM_TRIP_END_DATE_TIME), 
                     DATE_HD_RECEIVED_BY_PSMFC = as.Date(DATE_HD_RECEIVED_BY_PSMFC), 
                     DATE_EXPORTED_TO_AFSC = as.Date(DATE_EXPORTED_TO_AFSC)) %>% 
            mutate(REVIEW_TIME_FROM_LANDING = as.numeric(DATE_EXPORTED_TO_AFSC - ACTUAL_EM_TRIP_END_DATE_TIME),
                   REVIEW_TIME_FROM_HD_RECEIVED = as.numeric(DATE_EXPORTED_TO_AFSC - DATE_HD_RECEIVED_BY_PSMFC)) %>% 
            group_by(GEAR_TYPE_LOGGED) %>% 
            summarise(MEAN_REVIEW_TIME_FROM_LANDING = round(mean(REVIEW_TIME_FROM_LANDING)), 
                      MEAN_REVIEW_TIME_FROM_HD_RECEIVED = round(mean(REVIEW_TIME_FROM_HD_RECEIVED))) %>% 
            mutate(GEAR_TYPE_LOGGED = ifelse(GEAR_TYPE_LOGGED=="LONGLINE", "EM HAL", GEAR_TYPE_LOGGED)) %>% 
            mutate(GEAR_TYPE_LOGGED = ifelse(GEAR_TYPE_LOGGED=="POT", "EM POT", GEAR_TYPE_LOGGED)) %>% 
            rename(Strata = GEAR_TYPE_LOGGED,
                   `Mean number of days between end of trip and data exported to NMFS` = MEAN_REVIEW_TIME_FROM_LANDING,
                   `Mean number of days between hard drive received and data exported to NMFS` = MEAN_REVIEW_TIME_FROM_HD_RECEIVED)

em_times
```

Evaluations for the full coverage category and zero-selection pool are straightforward - either the coverage achieved was equal to 100% or 0%, respectively, or it was not. The program achieved 99.9% coverage in its full coverage category (`r tbl_nums('Coverage.Table', display = "cite")`). Five trips were not monitored in the full coverage category – four of these occurred on a single catcher vessel fishing CDQ halibut with hook and line gear that retained Pacific cod above the Maximum Retainable Amount and therefore met the criteria for full coverage fishing but failed to obtain a full coverage observer. The program achieved perfect compliance with the zero coverage stratum (`r tbl_nums('Coverage.Table', display = "cite")`). Under the assumption that the deployment was randomized, a 95% confidence interval computed from the realized coverage rates (under the assumption of a binomial distribution for observed trips) will contain the actual deployment rate 95% percent of the time.  If expected coverage levels were within the 95% confidence intervals, then we conclude that realized and expected coverage rates were equal. Coverage rates were consistent with expected values in six of the seven partial coverage strata, but were higher than expected within the *POT - Tender* stratum (`r tbl_nums('Coverage.Table', display = "cite")`). There are two reasons why this result is of little concern.  First, there is no clear evidence of trip manipulation in ODDS data from this stratum.  Secondly, the achieved rate was only slightly outside of the 95% range of expected outcomes (16.1% achieved vs. a lower bound of 16.8%).  Given the low number of total trips in this stratum (44), a change in a single observed trip, from 13 observed to 12 would have resulted in an expected result for this stratum since new confidence bounds would have included the expected rate.  

Unlike observed trips, the coverage rate for EM is based on information provided from the Pacific States Marine Fisheries Commission (PSMFC) that is available to analysts in the NORPAC database. By the end of `r year`, the PSMFC had reviewed nearly all of the EM hard drives received (`r tbl_nums('em.summary.table', display = "cite")`). In `r year`, the mean time between receipt and completion of review was 58 days for *EM HAL* and 79 days for *EM POT* (`r tbl_nums('em.times.table', display = "cite")`). This is compared to an average of 8.8 days during pre-implementation in 2016 (NMFS 2017a, p. 87).  

In combination across all strata, coverage levels, and fishery monitoring tools, 4,497 trips (43.3%) and 510 vessels (47.0%) were successfully monitored at-sea among all fishing in Federal fisheries of Alaska in 2019 (`r tbl_nums('Coverage.Table', display = "cite")`).  

###Coverage Rates for Dockside Monitoring
Observers were assigned to monitor shoreside deliveries of pollock. The objective of this monitoring was to obtain a count of the number of salmon caught as bycatch and to obtain tissue samples for genetic analysis from these fish in each observed pollock delivery. The sampling design used for this objective in 2019 remained unchanged from that used since 2011 (Faunce 2015); all deliveries of pollock that were observed at sea were also observed dockside. While all Bering Sea pollock trips and deliveries are observed, this is not the case in the GOA (NMFS 2015), where pollock trips randomly selected for at-sea monitoring are also expected to be sampled shoreside for salmon. For this analysis, pollock deliveries are defined as any delivery where the predominant species is pollock in eLandings.     

```{r pollock.observed.tbl, message=FALSE, warning=FALSE, include=FALSE, eval= TRUE}
# Defining a pollock trip (see 2015 AR script 'AR_2015_3_flags.r' for notes on 
# evolution of pollock trip definition): 
Pollock.landings.BP <-  work.data %>%
  filter(SOURCE_TABLE == "Y" &                     # Retained catch
         TENDER == "N" &
         AGENCY_GEAR_CODE %in% c("PTR", "NPT") &   # PTR = Pelagic trawl & NPT = Non-pelagic trawl
         PROCESSING_SECTOR=="S" &                  # Shoreside processing
         TRIP_TARGET_CODE %in% c("B", "P")) %>%    # B = Bottom pollock & P = Midwater pollock
  select(REPORT_ID) %>%                            # REPORT_ID is auto-generated by e-landing when a processor enters a landing (akin to a "trip")
  distinct(REPORT_ID)

#salmon.landings.obs is a list of REPORT_IDs (code generated by e-landings when a
#processor logs a landing) where dockside sampling for salmon occurred (all
#sectors).
Pollock.landing.data <- work.data %>%
  filter(TENDER == "N") %>% 
  select(REPORT_ID, COVERAGE_TYPE, AGENCY_GEAR_CODE, FMP, PORT_CODE, TENDER) %>%
  mutate(GEAR = ifelse(AGENCY_GEAR_CODE == "PTR" | AGENCY_GEAR_CODE == "NPT", "TRW", AGENCY_GEAR_CODE)) %>% 
  select(-AGENCY_GEAR_CODE) %>% 
  distinct() %>%
  mutate(Pollock.trips.BP = ifelse(REPORT_ID %in% Pollock.landings.BP$REPORT_ID, "Y", "N")) %>% 
  filter(Pollock.trips.BP == "Y") %>% 
  mutate(Observed.type = ifelse(REPORT_ID %in% salmon.landings.obs$REPORT_ID,
                                "Observed", "Not_Observed"),
         FMP = fct_recode(factor(FMP),
                          `Bering Sea` = "BSAI", `Gulf of Alaska` = "GOA"),
         PORT_CODE = fct_recode(factor(PORT_CODE),
                                # One 2018 trip that delivered to Kodiak was labeled as delivering to St. Mary's (LOL)
                                # FLAG: Remove this in future years or if it's changed in the database
                                `Kodiak` = "STM",
                                `Kodiak` = "KOD", 
                                `Dutch Hbr.` = "DUT", 
                                `Akutan` = "AKU", 
                                `Sand Point` = "SPT", 
                                `King Cove` = "KCO", 
                                `IFP` = "IFP"),
         COVERAGE_TYPE = fct_recode(factor(COVERAGE_TYPE),
                                    `Full` = "FULL", `Partial` = "PARTIAL")) 

# View(Pollock.landing.data)
# table(Pollock.landing.data$COVERAGE_TYPE, Pollock.landing.data$Observed.type, Pollock.landing.data$TENDER)

# Number of pollock deliveries by observation and tendering
# status. IFP: Inshore Floating Processor, Hbr: Harbor.
Pollock.observed <- rbind(
          Pollock.landing.data %>%
          group_by(FMP, COVERAGE_TYPE, PORT_CODE) %>%
          summarize(N.Pollock = n_distinct(REPORT_ID[Pollock.trips.BP == "Y"]),
                    N.Pollock.Obs = n_distinct(REPORT_ID[Observed.type == "Observed"]),
                    N.Tender = sum(TENDER=="Y")) %>%
          mutate(Pct.Obs = format((N.Pollock.Obs / N.Pollock)*100, digits=1, nsmall=1),
                 Pct.Tender = format((N.Tender / N.Pollock)*100, digits=1, nsmall=1)) %>% 
          select(FMP, COVERAGE_TYPE, PORT_CODE, N.Pollock, N.Pollock.Obs, Pct.Obs, Pct.Tender) %>%
          ungroup(),
          Pollock.landing.data %>%
          group_by(COVERAGE_TYPE) %>%
          summarize(FMP = as.factor("Total"),
                    PORT_CODE = as.factor(""),
                    N.Pollock = n_distinct(REPORT_ID[Pollock.trips.BP == "Y"]),
                    N.Pollock.Obs = n_distinct(REPORT_ID[Observed.type == "Observed"]),
                    N.Tender = sum(TENDER=="Y")) %>%
          mutate(Pct.Obs = format((N.Pollock.Obs / N.Pollock)*100, digits=1, nsmall=1),
                 Pct.Tender = format((N.Tender / N.Pollock)*100, digits=1, nsmall=1)) %>%
          select(FMP, COVERAGE_TYPE, PORT_CODE, N.Pollock, N.Pollock.Obs, Pct.Obs, Pct.Tender) %>% 
          ungroup()) 

# order rows
# Pollock.observed <- rbind(
# Pollock.observed %>% filter(FMP=="Bering Sea"),
# Pollock.observed %>% filter(FMP=="Total" & COVERAGE_TYPE=="Full"),
# Pollock.observed %>% filter(TENDER=="N" & COVERAGE_TYPE=="Partial"),
# Pollock.observed %>% filter(TENDER=="Y" & COVERAGE_TYPE=="Partial"))

Pollock.observed <- rbind(
Pollock.observed %>% filter(FMP=="Bering Sea"),
Pollock.observed %>% filter(FMP=="Total" & COVERAGE_TYPE=="Full"),
Pollock.observed %>% filter(COVERAGE_TYPE=="Partial"))

# add programmed rate
# Pollock.observed <- Pollock.observed %>% 
#   mutate(`Programmed coverage rate`=ifelse(COVERAGE_TYPE=="Full", 100.00,"")) %>% 
#   mutate(`Programmed coverage rate`=ifelse(COVERAGE_TYPE=="Partial" & TENDER=="N", partial$Rate[partial$STRATA=="TRW - No Tender"] * 100,`Programmed coverage rate`)) %>% 
#   mutate(`Programmed coverage rate`=ifelse(COVERAGE_TYPE=="Partial" & TENDER=="Y", partial$Rate[partial$STRATA=="TRW - Tender"] * 100,`Programmed coverage rate`))


#Rename cols and do formatting (change integers and numbers to characters so the
#tables knit without weird formatting)
Pollock.observed.table <- Pollock.observed %>% 
  mutate(N.Pollock = as.character(N.Pollock),
         N.Pollock.Obs = as.character(N.Pollock.Obs)) %>% 
  select(`FMP` = FMP, 
         `Coverage category` = COVERAGE_TYPE,
         `Port` = PORT_CODE, 
         `Total deliveries (*N*)` = N.Pollock,
         `Observed deliveries (*n*)` = N.Pollock.Obs,
         `% Observed` = Pct.Obs)

#View(Pollock.observed.table)
# Objects referenced in-text:
perc_unobs_fullcov <- 100 - Pollock.observed.table %>% filter(FMP == "Total" & `Coverage category` == "Full") %>% select(`% Observed`) %>%  as.numeric()

perc_trips_obs <- Pollock.observed.table %>% filter(FMP == "Total" & `Coverage category`== "Partial") %>% select(`% Observed`) %>% as.character() 

```

Given the design, the level of dockside observation of walleye pollock deliveries should be 100% in the full coverage category. In 2019, 100% of full coverage walleye pollock deliveries were observed (`r tbl_nums('Pollock.observed.table', display = "cite")`).   

While expectations of the full coverage category are straightforward, evaluations of the partial coverage category are more complex. As a matter of policy, no tender deliveries are observed. While it may seem intuitive that the expected coverage rate for deliveries within the *TRW - No Tender* stratum should be equal to the programmed trip selection rate of 23.70%, this assumption is likely untrue because observers are not deployed into the pollock fishery but into the entire trawl fishery, and the relationship between the number of deliveries and trips is not expected to be constant, especially when measured across ports. Therefore, we present the dockside observation rates for *TRW - No Tender* pollock landings but make no comparison to deployment rates (`r tbl_nums('Pollock.observed.table', display = "cite")`).    

Bycatch estimates of Chinook salmon in the GOA are estimated using methods described in Cahalan et al. (2014). In the event that a delivery cannot be monitored (e.g., the case in a tendered delivery or non-pollock delivery), then estimation of bycatch comes by applying salmon bycatch rates to landed catch. Estimates of stock of origin from salmon bycatch are produced by the AFSC’s Auke Bay Laboratory (e.g., Guthrie et al. 2019).               

#Sample Quality
##Temporal Patterns in Trip-Selection  
```{r temporal_bias, message=FALSE, warning=FALSE, include=FALSE}
# Changed from 2013 & 2014. 
# Changed again for 2017 annual report to include all dates (not just those for which trips exist)
# This analysis is a bit tricky, because trips are not necessarily constrained to one landing date.  Esp. when tendering.
Max.ts.date <- work.data %>% 
  filter(STRATA %in% partial$STRATA) %>%
  select(TRIP_ID, TRIP_TARGET_DATE, OBSERVED_FLAG, STRATA) %>%
  distinct() %>%
  group_by(TRIP_ID, OBSERVED_FLAG, STRATA) %>%
  mutate(MAX_TARGET_DATE = max(TRIP_TARGET_DATE)) %>%
  select(TRIP_ID, MAX_TARGET_DATE, OBSERVED_FLAG, STRATA) 

Max.ts.date <- merge(Max.ts.date, select(partial, c(STRATA, Rate)))

For.ts.temporal.plot <- Max.ts.date  %>%
  group_by(STRATA, Date=MAX_TARGET_DATE) %>%
  summarize(N=length(unique(TRIP_ID)),
                   n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"])),
                   Rate = unique(Rate)) %>%
  mutate(N.cuml = cumsum(N),
         n.cuml = cumsum(n),
         n.expected = round(N.cuml * Rate, 0),
         Low95 = qbinom(0.025, N.cuml, Rate),
         High95 = qbinom(0.975,N.cuml, Rate),
         Outside.bounds = ifelse(n.cuml > High95 | n.cuml < Low95, 
                                 1, 0),
         Observed.days = ifelse(n > 0, 1, NA)) %>% data.frame()

# Fill in missing dates using tidyr::complete()
For.ts.temporal.plot <- For.ts.temporal.plot %>% 
         mutate(Date=as.Date(Date)) %>% 
         complete(nesting(STRATA), Date=seq(as.Date(paste0(year, "-01-01")), as.Date(paste0(year, "-12-31")), by="day")) 

# If no trips taken on 1/1, make values = 0
For.ts.temporal.plot <- mutate(For.ts.temporal.plot, 
                               N.cuml=ifelse(Date==paste0(year, "-01-01") & is.na(Outside.bounds), 0, N.cuml),
                               n.cuml=ifelse(Date==paste0(year, "-01-01") & is.na(Outside.bounds), 0, n.cuml),
                               n.expected=ifelse(Date==paste0(year, "-01-01") & is.na(Outside.bounds), 0, n.expected),
                               Low95=ifelse(Date==paste0(year, "-01-01") & is.na(Outside.bounds), 0, Low95),
                               High95=ifelse(Date==paste0(year, "-01-01") & is.na(Outside.bounds), 0, High95),
                               Outside.bounds=ifelse(Date==paste0(year, "-01-01") & is.na(Outside.bounds), 0, Outside.bounds))

# Fill in values for dates during which no trips were logged
For.ts.temporal.plot <- mutate(For.ts.temporal.plot,
                               N.cuml=na.locf(N.cuml),
                               n.cuml=na.locf(n.cuml),
                               n.expected=na.locf(n.expected),
                               Low95=na.locf(Low95),
                               High95=na.locf(High95),
                               Outside.bounds=na.locf(Outside.bounds))

# Summarise days and portion of the year outside of expected
For.ts.temporal.summary <- For.ts.temporal.plot %>% 
                           group_by(STRATA) %>% 
                           summarise(N.outside=sum(Outside.bounds), Days=n(), `% Outside`=round(100*N.outside/Days, 1))

#Calculate and store the p.value from a binomial
for.binom <- merge(For.ts.temporal.plot %>% 
                     group_by(STRATA) %>% 
                     dplyr::summarize(n = max(n.cuml, na.rm=TRUE), 
                                      N = max(N.cuml, na.rm=TRUE)),
                   select(partial, c(STRATA, Rate))) %>% 
  group_by(STRATA) %>% 
  mutate(p = format(round(stats::binom.test(n, N, Rate)$p.value[1],3), nsmall=3),
         estimate = format(round(stats::binom.test(n, N, Rate)$estimate[1],3), digits=3, nsmall=3),
         #Results text with probability of success (estimate) & p-value
         text = paste0("*", STRATA, "* stratum expected rate = ", round(Rate, 3), ", realized rate = ", estimate, ", p-value = ", p)) %>% ungroup()

#Interpretive text indicating whether the strata "were" or "were not" within
#expectations of the binomial distribution
passfail <- ifelse(any(for.binom$p < 0.05), "were not", "were")

```

```{r cum.temporal.plot, message=FALSE, warning=FALSE, include=FALSE}
# Add p-value to data.frame
For.ts.temporal.plot <- merge(For.ts.temporal.plot, select(for.binom, STRATA, p))

# Order strata for plot
For.ts.temporal.plot <- transform(For.ts.temporal.plot,
                                STRATA=factor(STRATA,levels=c("EM HAL", "EM POT", "POT - No Tender", "POT - Tender", "TRW - No Tender", "TRW - Tender", "HAL")))

# Add column for dates where coverage is outside expectation
For.ts.temporal.plot <- mutate(For.ts.temporal.plot, Date.outside=if_else(Outside.bounds==1, Date, as.Date(NA)))

# Plot
Temporal.plot <- ggplot(For.ts.temporal.plot, aes(x=Date)) +
  geom_line(aes(y = n.cuml), col="black", size=2) +
  geom_line(aes(y = n.expected), col = "gray") +
  geom_ribbon(aes(ymin = Low95, ymax = High95), alpha=0.2) +
  geom_rug(aes(x = Date.outside), sides="b") +
  #Annotate p-values
  geom_text(aes(x=as.Date(paste0(year, "-04-01"), format = "%Y-%m-%d"),
                y = Inf, vjust = 1.25, 
                label = paste("p = ", p, sep = "")), size = 4) +
  facet_wrap(~ STRATA, ncol=2, scale="free_y") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  ylab("Cumulative Trips in Trip-selection Strata\n") +
  xlab("\nDate")

Temporal.plot

```

The cumulative number of fishing trips in each stratum was multiplied by the stratum-specific selection rate to obtain the expected number of observed trips. Under the assumption that there is no temporal bias in observer coverage, 2.5% of values should be larger than the upper 95% confidence limit and 2.5% should be smaller than the lower limit. At the end of `r year` the number of observed trips was outside of this expected range in only one of the seven partial coverage strata: *POT - Tender* (expected rate = 0.161, realized rate = 0.295, p-value = 0.023; `r tbl_nums('Coverage.Table', display = "cite")` and `r fig_nums('Temporal.plot', display = "cite")`). Coverage rates were outside of the expected range for 15.9%, 9.3%, 31.2%, 28.2%, and 7.9% of the year for the *EM HAL*, *EM POT*, *POT – No Tender*, *POT - Tender* and *TRW – No Tender* strata, respectively. The *EM HAL*, *POT – No Tender*, and *TRW – No Tender* strata were outside of the expected range earlier in the year but fell within the expected range by the end of April. Coverage rates were within their expected ranges for 100% of the year for the *HAL* (expected rate = 0.177, realized rate = 0.176, p-value = 0.925) and *TRW - Tender* (expected rate = 0.271, realized rate = 0.357, p-value = 0.175) strata. Overall, there appeared to be less temporal bias in 2019 than in 2018, when three of six partial coverage strata had coverage rates outside of the expected range at the end of the year (AFSC and AKRO 2019).         

##Spatial Patterns in Trip-Selection  
Under a strictly random selection of trips and with a large enough sample size, the spatial distribution of monitored trips should reflect the spatial distribution of all trips. The hypergeometric distribution was used to describe the results of sampling from a population of items (fishing trips) with different characteristics (NMFS Area fished). Based on this distribution, the expected number of monitored trips in a stratum and area is the realized monitoring rate (not selection rate) for the stratum multiplied by the total number of trips from that stratum that occurred in the area of interest. Using this method, we compared the expected number of monitored trips to the realized number of monitored trips in each NMFS Area and stratum combination and found that in most cases, the realized number of monitored trips was close to the expected result (`r fig_nums('cell.plot', display="cite")`). As part of this evaluation, we calculated the probability of monitoring the realized number of monitored trips within each stratum and NMFS Area. For the purposes of the following discussion, NMFS Areas with an unexpected number of trips (probability of our result is less than 0.05) are referred to as “low-p” areas.  

```{r spatial_bias_analysis, message=FALSE, warning=FALSE, include=FALSE}
trips.within.cells <- work.data %>%
  select(STRATA,TRIP_ID,VESSEL_ID,PERMIT,REPORTING_AREA_CODE,SOURCE_TABLE,OBSERVED_FLAG) %>%
  filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP" & SOURCE_TABLE=='Y') %>%  
  distinct() %>% 
  group_by(STRATA, REPORTING_AREA_CODE) %>% 
  summarize(obs.in.cell = length(TRIP_ID[OBSERVED_FLAG=="Y"]),
            not.obs.in.cell = length(TRIP_ID[OBSERVED_FLAG=="N"]),
            totl.in.cell=length(TRIP_ID))

trip.totls <- work.data %>%
  select(STRATA,TRIP_ID,VESSEL_ID,PERMIT,REPORTING_AREA_CODE,SOURCE_TABLE,OBSERVED_FLAG) %>%
  filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP" & SOURCE_TABLE=='Y') %>%  
  distinct() %>% 
  group_by(STRATA) %>%
  summarize(totl.obs.samp.units = length(unique(TRIP_ID[OBSERVED_FLAG=="Y"])),
            totl.samp.units=length(unique(TRIP_ID)))

strata.cell.dat <- merge(trips.within.cells, trip.totls, by=intersect(names(trips.within.cells), names(trip.totls)), all=TRUE) %>%                         filter(STRATA %in% partial$STRATA)

strata.cell.dat <- strata.cell.dat %>%
  mutate(
    # actual sampling rate in a cell 
    cell.rate = round(obs.in.cell / totl.in.cell, 5), # observed trips in cell/total trips in cell
    # actual sampling rate across all cells
    Hyper.rate = round(totl.obs.samp.units / totl.samp.units, 5), # observed trips / total trips
    # expected number of observed trips in a cell
    Hyper.expect = (totl.obs.samp.units / totl.samp.units) * totl.in.cell, # (observed trips / total trips) * total trips in cell
    # probability of observing no trips in a cell
    Hyper.P.0 = round(phyper(q=0, 
                               m=totl.in.cell, #trips in a cell by stratum
                               n=totl.samp.units - totl.in.cell, #total trips by stratum - trips in a cell by stratum
                               k=totl.obs.samp.units, #total observed trips by stratum
                               lower.tail = TRUE, log.p = FALSE),6),
    # probability of observing less than the observed number of trips in a cell
    Hyper.P.obs.less = phyper(q=obs.in.cell, 
                              m=totl.in.cell, #trips in a cell by stratum
                              n=totl.samp.units - totl.in.cell, #total trips by stratum - trips in a cell by stratum 
                              k=totl.obs.samp.units, #total observed trips by stratum
                              lower.tail = TRUE, log.p = FALSE),
    # probability of observing less than the expected number of trips in a cell
    Hyper.expect.less = phyper(q=Hyper.expect, 
                               m=totl.in.cell, #trips in a cell by stratum
                               n=totl.samp.units - totl.in.cell, #total trips by stratum - trips in a cell by stratum
                               k=totl.obs.samp.units, #total observed trips by stratum
                               lower.tail = TRUE, log.p = FALSE),
    # if the number of observed trips is less than expected...
    P.extreme.more = ifelse(obs.in.cell < Hyper.expect,
    # ...then the probability of observing a more extreme outcome is the probability of observing even FEWER trips
                            Hyper.P.obs.less, 
    # otherwise, the probability of observing a more extreme outcome is the probability of observing MORE trips
                            1-Hyper.P.obs.less),
    # if the number of observed trips in a cell is equal to the expected number...
    P.diff = ifelse(obs.in.cell == Hyper.expect, 
    # ...then the difference in probability between observed and expected is equal to 0...                    
                    0, 
    # if the number of OBSERVED trips in a cell is GREATER than the EXPECTED number...
                    ifelse(obs.in.cell > Hyper.expect,
    # ...then the difference in probability between observed and expected is equal to:
    # the probability of observing less than the OBSERVED number of trips in a cell...
    # minus the probability of observing less than the EXPECTED number of trips in a cell
                           Hyper.P.obs.less - Hyper.expect.less,
    # if the number of EXPECTED trips in a cell is GREATER than the OBSERVED number...
    # ...then the difference in probability between observed and expected is equal to:
    # the probability of observing less than the EXPECTED number of trips in a cell...
    # minus the probability of observing less than the OBSERVED number of trips in a cell
                           Hyper.expect.less- Hyper.P.obs.less)),
    # the probability of observing a more extreme outcome, categorized into bins
    P_extreme_more_cat = derivedFactor('< 0.05' = P.extreme.more  < 0.05,
                                       '0.05 - 0.10' = P.extreme.more >=0.05 & P.extreme.more <= 0.10,
                                       '0.11 - 0.25' = P.extreme.more >0.10 & P.extreme.more <= 0.25,
                                       '> 0.25' = P.extreme.more > 0.25,
                                       .ordered=TRUE),
    # variance of the expected value
    expected.var = (Hyper.expect * (totl.samp.units - totl.in.cell) * ((totl.samp.units - totl.obs.samp.units)) /
                      (totl.samp.units * (totl.samp.units - 1))),
    # z-score of observed outcome (i.e. how many standard deviations the observed outcome is from the mean)
    Hyper.Z = round(obs.in.cell - Hyper.expect / sqrt(expected.var), 5),
    # probability of observing no trips in a cell, categorized into bins
    Hyper.P.0.cat = derivedFactor( 'Prob.Zero < 0.05' = Hyper.P.0 < 0.05,
                                   '0.05 >= Prob.Zero < 0.20' = Hyper.P.0 >= 0.05 & Hyper.P.0 <0.20,
                                   'Prob.Zero >= 0.20' = Hyper.P.0 >= 0.20,
                                   .ordered=TRUE))

strata.cell.dat <- left_join(strata.cell.dat, partial %>% filter(Effective_Date == min(Effective_Date)), by="STRATA")
```
                 
```{r cell.pot, message=FALSE, warning=FALSE, include=FALSE}
# Reorder strata for plotting
strata.cell.dat <- transform(strata.cell.dat, STRATA=factor(STRATA,levels=c("HAL", "EM HAL", "POT", "EM POT", "TRW")))

#Comparison plots depicting the number of observed sample units
#compared to the number of expected observed sample units for each partial
#coverage stratum. Each point on a plot represents a NMFS Area. The darker the
#point, the more unusual the result.
cell.plot <- ggplot(filter(strata.cell.dat), 
                    aes(x = Hyper.expect, 
                        y = obs.in.cell,#,size = P_extreme_more_cat
                        fill = P_extreme_more_cat)) + 
  facet_wrap(~ STRATA, scales='free', ncol=2) +
  geom_abline(intercept=0, slope=1) +
  geom_point(colour = "black", 
             pch=21,size=2) +
  scale_fill_brewer(name="Probability of Monitored Sample Units\nor a More Extreme Value", 
                    palette="Reds", direction = -1, drop=FALSE) +
  labs(y = 'Number of Monitored Sample Units\n', 
       x = '\nExpected Number of Monitored Sample Units if Selection was Random') +
  fig.theme +
  theme(strip.text.x = element_text(size = 10))

# How many NMFS Areas fell into the different p-value categories for each stratum?
#table(strata.cell.dat$P_extreme_more_cat, strata.cell.dat$STRATA)
```

```{r map_generation, message=FALSE, warning=FALSE, include=FALSE}
# Map generation
# This chunk only needs to be run for initial figure generation, then use eval=FALSE
for (i in unique(partial$STRATA[!partial$STRATA == "EM TRW EFP"])) {

  STRAT <- i

  sub <- strata.cell.dat %>%
    filter(STRATA==STRAT) %>%
    rename(REP_AREA=REPORTING_AREA_CODE) %>%
    mutate(
      #Create new column that says whether Actual < Expected or vice versa
      #for statistically significant cells
      direction = derivedFactor("Actual < Expected" = P.extreme.more < 0.05 & obs.in.cell < Hyper.expect,
                                "Actual > Expected" = P.extreme.more < 0.05 & obs.in.cell > Hyper.expect,
                                " " = P.extreme.more >= 0.05,
                                "Low Sample Size" = Hyper.expect == 0),
      #Difference between observered and expected
      difference = round((obs.in.cell - Hyper.expect), 0),
      #Create new columns for lower and upper CI around expected coverage
      #rate using the binomial distribution (should match up with the
      #coverage table)
      lowerCI = round(stats::binom.test(x=unique(totl.obs.samp.units), n=unique(totl.samp.units),
                                        p=unique(Rate), alternative="two.sided")$conf.int[1]*100, 3),
      upperCI = round(stats::binom.test(x=unique(totl.obs.samp.units), n=unique(totl.samp.units),
                                        p=unique(Rate), alternative="two.sided")$conf.int[2]*100, 3),
      #Use percent observed instead of rate.
      perc_obs = round(cell.rate*100,1),
      #Make percent_obs a factor level
      percent = perc_obs)

  #Label the stratum-specific confidence intervals for proportion trips observed maps 
  # (1) join summary data from sub to nmfs areas shapefile
  nmfs_prob <- merge(sub, shp_nmfs, by="REP_AREA", all = TRUE)
  nmfs_prob <- st_as_sf(nmfs_prob)
  
  # (2) join summary data from sub to centroid shapefile and extract x/y coordinates
  centroid_trips <- merge(sub, shp_centroids, by="REP_AREA", all=TRUE)
  centroid_trips <- mutate(centroid_trips, COORDS = map(geometry, st_coordinates), COORDS_X = map_dbl(COORDS, 1), COORDS_Y = map_dbl(COORDS, 2))
  centroid_trips <- st_as_sf(centroid_trips)
  
  # Probability maps: direction object will help label probability maps,
  # identify whether areas where an extreme events occurred were Actual <
  # Expected or Actual > Expected by the number of trips ('difference')
  direction1 <- rbind(
    sub %>%
    filter(direction %in% c("Actual < Expected", "Actual > Expected")) %>%
    mutate(new_direction = interaction(REP_AREA, direction, sep=": "),
           new_direction = paste0(new_direction, " by ", abs(difference), " trips")) %>%
    select(new_direction),
    sub %>%
    filter(direction %in% c("Low Sample Size")) %>%
    mutate(new_direction = interaction(REP_AREA, direction, sep=": "),
           new_direction = paste(new_direction, "=", totl.in.cell, " trips")) %>%
    select(new_direction))
  
  if(length(direction1$new_direction)>=1) {
    direction <- direction1 %>%
      mutate(x.coord = -1569049.2, 
             y.coord = 2184356.2 - 0:(length(direction1$new_direction)-1) * 100000)
  }  else {
    direction <- data.frame(new_direction = NA) %>% # %>%
      mutate(x.coord = -1569049.2, #these coords make it so labels print nicely in ggplot.
             y.coord = 2184356.2)
  }

  # Probability plot
  p <- ggplot() + 
  geom_sf(data = shp_land, fill = "white", color = "gray60") +
  geom_sf(data = shp_nmfs, fill = NA, color = "gray60") +
  geom_sf(data = nmfs_prob, aes(fill = P_extreme_more_cat), color = "gray60") +
  geom_count(data = centroid_trips, aes(COORDS_X, COORDS_Y-60000, size = totl.in.cell), shape=21, fill=NA, stroke=1) +
  geom_text(data = centroid_trips, aes(COORDS_X, COORDS_Y+60000, label = REP_AREA), size = 2, fontface="bold") +
  map_theme +
  coord_sf(crs = st_crs(shp_nmfs), datum = NA) +   
  scale_fill_brewer(name="Probability", palette="Reds", direction = -1, drop=FALSE) +
  scale_size_area(name="Total Number\nof Trips", breaks=c(5,50,200,500,800)) +
  geom_text(data = direction, aes(x.coord, y.coord, label=new_direction), check_overlap = FALSE, size=2.5) +  
  labs(title=paste(STRAT, year), x="", y="") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position="bottom")
  
  assign(paste0("probability_", STRAT), p)

  # Save plot  
  png(paste0("figures/probability_", STRAT, ".png"), height = 5,
      width = 11, units = 'in', res=300)
  plot(p)
  dev.off()
  
}

```
  
```{r spatial_patterns_by_stratum, message=FALSE, warning=FALSE, include=FALSE, results="asis"}
#Prep summary stats for by stratum paragraphs
results <- merge(
  strata.cell.dat %>% 
  group_by(STRATA) %>% 
  summarise(nmfs_areas = n_distinct(REPORTING_AREA_CODE), # number areas fished
                   #expect number of small data points
                   exp_sm_dat = round(0.05 * nmfs_areas,0),
                   #observed number of small data points
                   obs_sm_dat = n_distinct(REPORTING_AREA_CODE[P.extreme.more < 0.05]),
                   # min, max, median coverage rates
                   min_cov_rt = round(min(cell.rate)*100, 1),
                   max_cov_rt = round(max(cell.rate)*100, 1),
                   med_cov_rt = round(median(cell.rate)*100, 1)) %>% 
  mutate(probt_file = paste0("probability_", STRATA),
         perc_obs_file = paste0("perc_obs_", STRATA)),
  partial %>% select(STRATA, Rate)
)

#*FLAG* Once report is stabilized, add stratum-specific interpretive text. This will change each year!
results <- cbind(results, strat_interp = c(
  "These results mean that there was no clustering of observed trips among NMFS Areas that was different from expected.  No spatial bias appears to have occurred in the *EM HAL* stratum.",
  "These results mean that there was no clustering of observed trips among NMFS Areas that was different from expected.  No spatial bias appears to have occurred in the *EM POT* stratum.",
  "These results mean that there was some clustering of observed trips among NMFS Areas that was different from expected.  Some spatial bias appears to have occurred in the *HAL* stratum.",
    "These results mean that there was no clustering of observed trips among NMFS Areas that was different from expected.  No spatial bias appears to have occurred in the *POT - No Tender* stratum.",
  "These results mean that there was no clustering of observed trips among NMFS Areas that was different from expected.  No spatial bias appears to have occurred in the *POT - Tender* stratum.",
  "These results mean that there was some clustering of observed trips among NMFS Areas that was different from expected.  Some spatial bias appears to have occurred in the *TRW - No Tender* stratum.",
    "These results mean that there was no clustering of observed trips among NMFS Areas that was different from expected.  No spatial bias appears to have occurred in the *TRW - Tender* stratum."))

# Add formatted strata column
results <- mutate(results, formatted_strat=paste0("*", STRATA, "*"))

# Rearrange results
results <- arrange(results, match(probt_file, c("probability_EM HAL", 
                                                "probability_EM POT", 
                                                "probability_HAL", 
                                                "probability_POT - No Tender", 
                                                "probability_TRW - No Tender", 
                                                "probability_POT - Tender", 
                                                "probability_TRW - Tender")))

```

```{r strata_patterns_by_stratum_text, message=FALSE, warning=FALSE, include=FALSE}

#This for loop creates the sections of markdown text for the stratum-specific spatial bias summary...  knit_expand() is the work-horse here.
out <- NULL #create empty object
for (i in as.character(unique(results$STRATA))) {
  #Extract results for stratum i
  current <- results[results$STRATA==i, ]
  #use knit_expand to create a template for each paragraph. In-line r chunks that are usually defined with `r ...` are instead defined with {{...}}. The '\n' is a line break, giving the paragraph proper formatting. 
  out <- c(out, 
           knit_expand(
             text=c('### The *{{i}}* stratum',
                    '\n',
                    'Given that there were {{current$nmfs_areas}} NMFS Areas fished in *{{i}}*, we would expect there to be 0.05 $\\times$ {{current$nmfs_areas}} = {{current$exp_sm_dat}} low-p {{ifelse(current$exp_sm_dat == 1, "area", "areas")}} for this stratum.  There {{ifelse(current$obs_sm_dat == 1, "was", "were")}} {{numbers2words(current$obs_sm_dat)}}.  The percent of trips observed among NMFS Areas in this stratum ranged from {{current$min_cov_rt}}% to {{current$max_cov_rt}}% (median = {{current$med_cov_rt}}%).  The probability of these coverage rates or rates that deviated further from expected values is depicted in {{fig_nums(current$probt_file, display="cite")}}.  {{current$strat_interp}}',
                    '\n'
             )))
}

```

<!-- Now knit and paste 'out' to create the paragraphs of text. -->
`r paste(knit(text = out), collapse = '\n')`

##Trip Metrics  
This section analyses whether monitored trips are similar to unmonitored trips using a permutation test (a.k.a., randomization test). This test evaluates the question “How likely is the difference we found if these two groups have the same distribution (in the metric we are comparing)?” Permutation tests compare the actual difference found between two groups to the distribution of many differences derived by randomizing the labels defining the two groups (e.g., monitored and unmonitored). Difference values in the permutation test were calculated by subtracting the mean metric value for the “No” condition from the mean metric value for the “Yes” condition. For example, the difference between vessel lengths in a permutation test for a monitoring effect would be the mean value for unmonitored trips subtracted from the mean value for all monitored trips. By randomizing group assignments, the combined distribution of randomized differences represents the sampling distribution under the null hypothesis that the two groups are equal. In this report, 1,000 randomized trials were run for the permutation test. The p-value from the test is calculated as the number of randomized trials with greater absolute differences than the actual difference divided by the number of randomized trials. Similar to the other statistical tests used in this report, low p-values (< 0.05) indicate unlikely events under the hypothesis of equality and are therefore considered evidence against that hypothesis. As stated previously, a Bonferroni adjustment has been applied to these p-values by multiplying original p-values by the number of metrics being tested (six in this case). These adjusted p-values are then compared to the 0.05 significance level. In an attempt to improve clarity, although five values are calculated in the test; 1) the difference between groups, 2) the mean difference between groups from randomized trials, 3) #1 expressed as a percentage of the mean value of the metric being tested, 4) #2 expressed as a percentage of the mean value of the metric being tested, and 5) the p-value of the test, only values (1), (3) and (5) are presented.      

Six trip metrics were examined in the permutation test. These metrics were as follows: the number of NMFS Areas visited in a trip, trip duration (days), the weight of the landed catch (t), the vessel length (ft), the number of species in the landed catch, and the proportion (0 to 1) of the total catch that is made up of the most predominant species (pMax). The metric ‘vessel length’ is used to help interpret the results from ‘weight of landed catch’ since fishing power is positively correlated to vessel length. Specifically, differences in weight *and* length are interpreted as a failure to achieve a random sample of vessels of different sizes, whereas differences in weight only lend more evidence that there was a monitoring effect. The number of species within the landed portion of the catch is a measure of species richness. Our pMax metric follows the concepts behind Hill’s diversity number N1 that depicts the number of abundant species (Hill 1973) and is a measure of how “pure” catch is since a value of one would indicate that only the predominant (and presumed desirable) species was landed.  

###Were monitored trips similar to unmonitored trips?  
The sample sizes available to the permutation test are presented in `r tbl_nums('OBSERVED_FLAG.Ntable', display = "cite")`. Results of permutation tests are presented in `r tbl_nums('OBSERVED_FLAG.results', display = "cite")`.  A visual depiction of individual results of this permutation test for the *HAL*, *POT - No Tender*, and *TRW - No Tender* strata is given in `r fig_nums('Obs.perm.plot', display="cite")` for illustration purposes.     
 
```{r observed_flag_permutation, message=FALSE, warning=FALSE, include=FALSE}

#Filter the data you want
dat <- 
  work.data %>% 
  filter(STRATA %in% partial$STRATA)

#Identify the field to permute by
YN_var = "OBSERVED_FLAG"

#Identify the fields to group by (don't include TRIP_ID or the YN_var)
gp_vec = c("STRATA")

#RUN FUNCTION - see helper.R
detach(package:mosaic) #must be detached *outside* of the permutation fxn
perm <- permutation.fxn(dat, YN_var, gp_vec, 1000)
# Decompose the output
assign(paste(YN_var, "YN_perm", sep = "."), data.frame(perm[1]))
# Not used
# assign(paste(YN_var1, "YN_melt", sep = "."), data.frame(perm[2]))
assign(paste(YN_var, "summary", sep = "."), data.frame(perm[3]))
#check.names=FALSE prevents data.frame() from replacing the space in colname with '.'
assign(paste(YN_var, "results", sep = "."), data.frame(perm[4],
                                                       check.names=FALSE))
assign(paste(YN_var, "Ntable", sep = "."), data.frame(perm[5]))

names(OBSERVED_FLAG.Ntable) <- c("Strata", "Observed", "Unobserved")
OBSERVED_FLAG.Ntable <- arrange(OBSERVED_FLAG.Ntable, match(Strata, c("HAL", "EM HAL", "POT - No Tender", "POT - Tender", "EM POT", "TRW - No Tender", "TRW - Tender")))

#interpret_trip_metrics() see helper.r documentation
perm_sum <- interpret_trip_metrics(OBSERVED_FLAG.summary)

#REFORMAT RESULTS TABLE:
OBSERVED_FLAG.results <- rbind(
  OBSERVED_FLAG.results %>% 
    filter(Metric %in% c("Observed difference", "OD (%)")) %>% 
    mutate_each(funs(round(., 3)), -c(Strata, Metric)) %>%
    #Keep the zero's for sig figs
    mutate_each(funs(format(., nsmall=3, digits=3)), -c(Strata, Metric))
  ,
  OBSERVED_FLAG.results %>% 
    filter(Metric %in% c("p-value")) %>% 
    #Apply Bonferroni adjustment to p-values
    group_by(Strata) %>% 
    mutate_if(is.numeric, function(x)(x*6)) %>% 
    mutate_if(is.numeric, function(x)(if(x>=1)(1)else(x))) %>%
    ungroup() %>%
    mutate_each(funs(round(., 3)), -c(Strata, Metric)) %>% 
    mutate_each(funs(format(., nsmall=3, digits=3)), -c(Strata, Metric))
) %>% arrange(match(Strata, c("HAL", "EM HAL", "POT - No Tender", "POT - Tender", "EM POT", "TRW - No Tender", "TRW - Tender")), Metric)

#Replace "0" p-values; extra space in character is an artifact of the previous format()
OBSERVED_FLAG.results[OBSERVED_FLAG.results=="0.000"] <- "< 0.001"

rm(perm)

```

```{r strata_observed_flag_text, message=FALSE, warning=FALSE, include=FALSE}

#This for loop creates the sections of markdown text for the stratum-specific results of the permutation test (H0: Observed trips = Unobserved trips).

#Get rid of rows with NAs
perm_sum <- na.omit(perm_sum)
out <- NULL #create empty object

for (i in as.character(unique(perm_sum$STRATA))) {
    #Extract 'significant' metrics *with* Bonferroni adjustment
  signif <- perm_sum %>% filter(STRATA==i & p < (0.05 / 6)) 
  #The results section language changes depending on how many metrics are signficant. See helpfile for documentation of wordlist():
  results_text <- ifelse(
    length(signif$p)==0,
    #If none of the metrics are significant:
    paste0("* Of the six metrics compared in the *", i, "* stratum, there were no metrics with low p-values."),
    #If some are significant, say how many and list the results:
    paste0( "* Of the six metrics compared in the *", i, "* stratum, ", numbers2words(length(signif$p)), " had low p-values. Observed trips in this stratum ", wordlist(signif$interpretation), " than unobserved trips."))
  #use knit_expand to create a template for each paragraph. In-line r chunks that are usually defined with `r ...` are instead defined with {{...}}. The '\n' is a line break, giving the paragraph proper formatting. 
  out <- c(out, knit_expand(text=c('{{results_text}}', '\n\n')))
}

rm(perm_sum)
```

<!-- Now knit and paste 'out' to create the paragraphs of text. -->
`r paste(knit(text = out), collapse = '\n')`

```{r observed_permutation_plot, message=FALSE, warning=FALSE, include=FALSE}
OBSERVED_FLAG.YN_perm_plot <- ungroup(OBSERVED_FLAG.YN_perm) %>% mutate(STRATA=as.character(STRATA)) %>% 
  filter(STRATA=="HAL" | STRATA=="POT - No Tender" | STRATA=="TRW - No Tender")

OBSERVED_FLAG.summary_plot <- ungroup(OBSERVED_FLAG.summary) %>% mutate(STRATA=as.character(STRATA)) %>% 
  filter(STRATA=="HAL" | STRATA=="POT - No Tender" | STRATA=="TRW - No Tender")

#Generate permutation plot 
Obs.perm.plot <- ggplot(OBSERVED_FLAG.YN_perm_plot, aes(x = perm_result_pct)) +
  geom_histogram(aes(y=..density..), col = "white", fill = "gray") +
  geom_density(fill="gray", alpha = 0.5, adjust=3) +
  geom_vline(aes(xintercept = 0), col = "black", lty = 3, size = 1) +
  geom_vline(aes(xintercept = obs.diff_pct), col = "red") +
  facet_wrap(variable ~ STRATA, scales = "free", 
             #Make number of cols in facet_wrap = to number of strata
             ncol = length(unique(OBSERVED_FLAG.YN_perm_plot$STRATA))) +
  geom_label(data = OBSERVED_FLAG.summary_plot, 
             aes(label = paste("p = ", round(p,3), sep = "")),
             x=-Inf, y=Inf, hjust=-.2, vjust=1.2, size = 4) +
  fig.theme +
  xlab("\nDifference (%) of Observed minus Unobserved Trips Relative to the Mean") +
  ylab("Density of Outcomes\n")

```

Based on these results, differences between monitored and unmonitored trips were found for species richness, trip duration, areas fished, and landed catch (`r tbl_nums('OBSERVED_FLAG.results', display = "cite")`). Monitored EM trips of both hook and line and pot gear types resulted in greater species numbers reported in the landings data than unmonitored trips.  If monitored and unmonitored trips occur in the same fisheries, it is possible that species are lacking on unmonitored trips or are being incorrectly accounted for on monitored trips, or that there is more at-sea discard of species on unmonitored trips. The *HAL*, *POT - Tender*, and *TRW – No Tender* strata also exhibited observer effects, although the magnitude of differences for *TRW – No Tender* was small.  Of these, the *POT – Tender* result is the most striking due to the large magnitude of difference, but also the easiest to explain.  Landings of tendered trips can be quite large on rare occasions, and when rare large landings occur, whether they are observed or unobserved, these single trips can ‘tip the scales’ for permutation tests across the entire strata.  In 2019, one of these very large-landing trips was observed.  However, we cannot dismiss the possibility that we incorrectly accounted for the linkages between landings and trips, and some tendered trips were actually larger, or smaller, than we calculated.  More on this topic is discussed in our recommendations section.  

### Gear, tender, and observed status combinations  
``` {r freq_geartender, message=FALSE, warning=FALSE, include=FALSE} 

# Frequency histograms facetted by gear (& strata if different from gear), tender, and observation status.

library(mosaic)
geartender <-
  work.data %>%
  filter(STRATA %in% partial$STRATA) %>% 
  #*FLAG* 3/25/19: A couple of AGENCY_GEAR_CODE == "JIG" trips have
  # STRATA == "HAL". Drop these.
  filter(AGENCY_GEAR_CODE!="JIG") %>% 
  group_by(STRATA, TRIP_ID, AGENCY_GEAR_CODE, TENDER, OBSERVED_FLAG) %>%
  summarize(start.date = min(TRIP_TARGET_DATE),
            end.date = max(LANDING_DATE)) %>%
  mutate(days.fished = as.numeric(end.date - start.date) + 1,
         Tender = derivedFactor(
         "Tendered Trip" = TENDER =="Y",
         "Non-tendered Trip" = TENDER =="N",
         .ordered = TRUE)) %>% 
  #days.fished has NAs!  this is bc kruzof (vessel id = 6039), trident (662), and cerulean (33530) act as CPs .
  select(-c(start.date, end.date))

#Recode AGENCY_GEAR_CODE to lump PTR and NPT as TRW
geartender <- geartender %>% 
  ungroup() %>% 
  mutate(AGENCY_GEAR_CODE = 
           fct_recode(factor(AGENCY_GEAR_CODE),
                             TRW = 'PTR',
                             TRW = 'NPT'))

#Trip duration by observed, tender, and strata.
freq_geartender <-
  ggplot(geartender, aes(x = days.fished, fill = factor(OBSERVED_FLAG))) +
  geom_histogram(aes(y = ..density..), position = "identity", alpha = 0.5, col = "black", binwidth = 1) +
  #Drop STRAT (makes sense since 2016 and beyond strata are by gear)
  facet_grid(AGENCY_GEAR_CODE ~ Tender) +
  fig.theme + 
  theme(strip.text.y = element_text(angle = 360, size = 12, face = "bold")) +
  theme(strip.text.x = element_text(angle = 360, size = 12, face = "bold")) +
  scale_fill_manual(values = c("black", "white"), name = "Observed?") +
  labs(x = "\nTrip duration (Days)", y = "Relative Frequency (Density)\n")
```

One of the analyses done by the permutation test is to compare trip lengths (in days) between monitored and unmonitored trips and determine whether there were significant differences. However, these permutation tests do not visually map the data for monitored and tendered states together. To accomplish this, a plot of the trip durations for these states is included as `r fig_nums('freq_geartender', display = "cite")`. These plots illustrate *HAL* non-tendered trips were shorter in duration when observed, which was also seen in permutation tests.  In addition, tendered *POT* and *TRW* trips of more than ten days appear to have been observed at a greater frequency than unobserved trips.  If these longer trips also were associated with greater landed weight, then this would explain the permutation results for these strata that showed greater landed weights on observed trips compared to unobserved trips.    

#Adequacy of the Sample Size

In a well-designed sampling program, the monitoring rate should be large enough to reasonably ensure that the range of fishing activities and characteristics are represented in the sample data. The Catch Accounting System post-stratifies data into groups of fishing activities with similar trip characteristics such as gear, trip targets, and NMFS Area (Cahalan et al. 2014). At low numbers of trips and low sampling rates, the probability of no monitoring data within a particular post-stratum is increased and may result in expansions of bycatch rates from one type of fishing activity against landings for a different type of fishing activity. This will result in biased estimates of bycatch. For this reason, it is important to have a large enough sample (monitored trips and vessels) to have reasonable expectation of monitoring all types of fishing.           

``` {r prob.bynumber.plot, message=FALSE, warning=FALSE, include=FALSE}
# Scatterplot of probability of having *no* observed sample units (fishing
# trips) against total number of sample units by stratum. This is a decaying
# relationship, where the fewer the number of fishing trips in a cell, the
# higher the probability of not observing any trips in the unit. See
# {spatial_bias_analysis} code chunk for analysis used to generate
# strata.cell.dat.

# Create a generalized subset that includes relevant data points (cells where there is a probability of not observing a trip due to low sample sizes)
sub <- strata.cell.dat %>% 
       filter(totl.in.cell < round(min(totl.in.cell[Hyper.P.0==0])+50, -1))

#sub <- strata.cell.dat %>% filter(totl.in.cell < 200)
prob.bynumber.plot <- ggplot(sub, aes(y=Hyper.P.0, x=totl.in.cell, group= STRATA, col = STRATA, shape= STRATA)) +
                      geom_point(size=3) +
                      geom_line(size=1) +
                      scale_color_manual("Stratum", values = gray.colors(n = length(partial$STRATA), start = 0, end = 0.8)) +
                      scale_shape_discrete("Stratum") +
                      ylab('Probability of No Observed Trips\n') +
                      xlab('\nNumber of Trips') +
                      fig.theme +
                      theme(legend.text=element_text(size=10))
                 
prob.bynumber.plot

rm(trip.strata.dat, trips.within.cells, trip.totls)

```

```{r trips_by_tolerance, message=FALSE, warning=FALSE, include=FALSE}
#Set your tolerance level for the probability of not observing trips and solve for the number of trips in a cell it would take in order to satisfy your chosen tolerance level.
tolerance <- 0.05

trips_by_tolerance <- data.frame(matrix(ncol = 1, nrow = 0))
#"interp" will be the stratum-specific text chunks that can be passed into the wordlist() fxn
names(trips_by_tolerance) <- c("interp")

for (i in as.character(unique(strata.cell.dat$STRATA))) {
    temp <- strata.cell.dat %>% 
    filter(STRATA %in% i) 
  #Dataframe "dat" that estimates Hyper.P.0 over all possibilities of number of trips in a given cell (tripsincell)
  dat <- data.frame(tripsincell = seq(0, 299, 1)) %>% 
    mutate(STRATA = rep(unique(temp$STRATA), 300),
           totl.samp.units = rep(unique(temp$totl.samp.units), 300),
           totl.obs.samp.units = rep(unique(temp$totl.obs.samp.units), 300),
           Hyper.P.0 = round(1- phyper(q = 0,
                                       #trips in a cell by stratum        
                                       m = tripsincell,
                                       #total trips by stratum - trips in a cell by stratum
                                       n = totl.samp.units - tripsincell,
                                       #total observed trips by stratum
                                       k = totl.obs.samp.units,
                                       lower.tail = FALSE, log.p = FALSE), 2),
           #The text for reporting the results
           interp = paste0(tripsincell, " trips in the *", i , "* stratum")) %>% 
    #Filter by chosen tolerance level, if there's two, take the smaller trips in
    #cell value
    filter(Hyper.P.0 >= tolerance) %>%
    filter(Hyper.P.0 == min(Hyper.P.0)) %>% 
    filter(tripsincell == min(tripsincell)) %>% 
    select(interp)

  #Each row in trips by tolerance is stratum-specific text
  trips_by_tolerance <- rbind(trips_by_tolerance, dat)
}

rm(trip.strata.dat, trips.within.cells, trip.totls)
```

Over the course of an entire year, some NMFS Areas have low fishing effort and as a result have a relatively high probability of being missed by the simple random sampling represented by observer deployments and EM. The fishing effort data for each stratum and the number of monitored trips over the course of `r year` were used to illustrate their combined effect on the probability of a NMFS Area containing monitoring data using the hypergeometric distribution (`r fig_nums('prob.bynumber.plot', display = "cite")`). From this figure it can be seen how 1) the likelihood of at least one monitored trip is increased with fishing effort and 2) is also increased with an increase in the selection rate. Given our sampling rates in the `r length(partial$STRATA)` partial coverage trip-selection strata, the probability of having no monitored trips in a NMFS Reporting Areas increases quickly above `r tolerance` when there are fewer than `r wordlist(trips_by_tolerance$interp)` in a given area. Including additional factors such as week, gear, and target will decrease the number of trips with the same characteristics and hence increase the probabilities of obtaining no monitoring data of that character (post-strata of the CAS).  

A new analysis presented in Appendix B – Gap Analysis examines the deployment of observers and EM systems at finer spatiotemporal scales than presented in Chapter 3. This analysis evaluates the availability of monitoring coverage within and between the partial coverage selection pools and highlights instances where sampling effort was disproportionately distributed in space and time between post-strata defined by gear, NMFS Area, and dominant species landed (trip target). For example, the spatial patterns in the *HAL* stratum appear to be due to disproportionately high monitoring rates in the GOA for trips targeting halibut and lower monitoring rates for halibut-target trips in the BSAI, especially in the Aleutian Island areas. Additionally, the low number of observed trips in area 620 in the *TRW – No Tender* stratum was due to disproportionately low monitoring rates among arrowtooth-target trips where only 2 of 42 trips were observed (Appendix B – Gap Analysis).  

#Response to Council and SSC Comments

The SSC has requested that a specific section with responses to SSC comments be provided in the written report, as is done for SAFE documents. This section addresses FMSC responses (in italics) to comments relative to this chapter made by the Council and the SSC after the presentation of the `r year-1` Annual Report during the June `r year` Council meeting.  

##Council comments:    
In the 2019 Annual Report (to be presented in June, 2020), the Council recommends that NMFS:  

* Continue to include an evaluation of observer effects in pelagic and non-pelagic trawl within the trawl stratum.  
*This evaluation is included as Appendix A.*  

##SSC recommendations:   
The SSC offered the following recommendations to the Observer Program:  
* The analysts to initiate a comparison of the likely magnitude of bias that has been detected between monitored and unmonitored trips with the overall magnitude and precision of discard or PSC that is being monitored for compliance by management.  
*While some differences were detected between monitored and unmonitored trips, the impact that these types of differences have on estimates of discard is not known at this time. We note that in 2019, the detected differences occurred primarily within the hook and line stratum where fishing activity is not limited by PSC or bycatch quotas.*  

* Consider [EM] coverage for the under-40’-no coverage fleet for 2019.  
*This was not considered in the 2020 ADP.*  

* In cases where there are multiple gear types in a stratum (e.g., pelagic and non-pelagic trawls) the SSC recommends analysis of the results by gear type separately in addition to analysis aggregated to the stratum level. Such disaggregation will avoid masking of gear-specific differences in catch composition and other factors that could provide justification for possible further subdivision of strata.  
*We included an evaluation of observer effect tests for different types of trawl gear in Appendix A.  In response to the SSC recommendation, we note that further subdivision of strata may not be feasible as total sample size continues to decline.  For example, from 2019 to 2020 the ability of observer data to adequately sample tendered and non-tendered strata was compromised to the point that the designation was no longer supported, and these trip types are now combined for a gear-based stratum.*  

* The SSC looks forward to seeing a full evaluation of this [EM] program as soon as is practical, as well as an evaluation of the tradeoffs between use of EM and the existing partially observed coverage category. As the Council considers continued growth of the EM program, it will be important to conduct appropriate cost comparisons, specifically including video review costs, as well as an evaluation of the ability of EM versus onboard observer data to meet program needs.  
*While costs are addressed outside of this chapter, we have included deployment performance review of both fishery monitoring tools (observers and EM) used by FMA. Information about the cost of EM is included in Chapter 2 and information about video review and data quality is included in Chapter 4.*  

#FMSC Recommendations to Improve Data Quality  
  
##Recommendations from the `r year-1` Annual Deployment Review

The Fisheries Monitoring Science Committee (formerly the Observer Science Committee) made the following recommendations in its `r year-1` review of observer deployment to be considered in developing the `r year+1` ADP (NMFS `r year`b). Following each recommendation is the italicized outcome of that recommendation.  

The Fishery Monitoring Science Committee’s Recommendations to improve the `r year+1` ADP were as follows:  

* The ODDS trip logging and cancellation rules be re-evaluated and communicated to the Council and industry as soon as possible.   
*No formal public action has been taken by the NMFS.*  

* The draft 2020 ADP stratification designs include a re-examination of tendering strata.  
*The distinction between tendered and non-tendered strata was eliminated in the 2020 ADP.*  

* Do not stratify by type of trawl gear (i.e., NPT and PTR strata).   
*These gear types were not separated in the 2020 ADP. The rationale for not creating separate NPT and PTR strata is included in Appendix A.*  

* Continue the baseline + optimization approach for determining coverage levels among strata.   
*The 15% baseline + optimization approach for determining coverage levels among strata for observer coverage was used in the 2020 ADP.*  

* We recommend that EM review rates be set to ensure that the entire year is sampled and review is timely enough so that data from EM can be used for catch accounting and fisheries monitoring as envisioned by the Council.   
*EM review included the entire year for 2019, which was an improvement over 2018.  There was about a two-month lag between data collection and data availability in 2019.  Whether this is timely enough for catch accounting and fishery monitoring is not clear to the FMSC.*  

##Recommendations to Improve Data Quality and Guide the `r year+2` ADP    
**1. We recommend that the ADP fully integrate EM and observer deployment into one fishery monitoring program.**  This recommendation echoes the SSC recommendation made at their June 2019 meeting, and is based on the recognition that EM and observers are two tools at the disposal of the NMFS to monitor fisheries and each has its advantages and disadvantages. Issues due to incomplete integration of fishery monitoring tools occurred in 2019 when only EM trips were monitored in the pot gear Pacific cod Central Gulf (Area 630) fishery, introducing a data gap for the GOA Pacific cod stock assessment. In 2020, observer coverage has been reduced further as a result of COVID-19 precautions.  

**2. We continue to recommend that NMFS link the ODDS and eLandings database such that fishing trips can be uniquely identified to support the analyses presented to the Council.** The analyses contained in the Annual Report attempt to identify fishing trips, which is the unit of measurement for deployment.  However, there are some instances when realized deployments do not match intended deployments. In some cases, it may be that there were no differences, but the accounting of trips between ODDS and eLandings data are incongruent. We note that the temporal bias issue identified (Figure 3) in the observed tendered pot stratum and differences between the observed and unobserved landed weight (Table 10) in this stratum was potentially an artifact of the analysis. This artifact could have been caused by the difficulty in identifying observed and unobserved trips, especially for tendered strata.  

#####

# Citations
AFSC and AKRO. 2019. North Pacific Observer Program 2018 Annual Report. AFSC Processed Rep. 2019-04, 148 p. Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 7600 Sand Point Way NE, Seattle WA 98115. Available at http://www.afsc.noaa.gov/Publications/ProcRpt/PR2019-04.pdf  

Alaska Fisheries Science Center. 2018. 2019 Observer Sampling Manual. Fisheries Monitoring and Analysis Division, North Pacific Groundfish Observer Program. AFSC, 7600 Sand Point Way N.E., Seattle, Washington, 98115.  

`r if(tech.memo){'Faunce, C. H., and Barbeaux, S. J. 2011. The frequency and quantity of Alaskan groundfish catcher-vessel landings made with and without an observer. ICES J. Mar. Sci. 68:1757-1763.'}`  

Cahalan, J., J. Mondragon, and J. Gasper. 2014. Catch sampling and estimation in the Federal groundfish fisheries off Alaska: 2015 Edition. NOAA Tech. Memo. NMFS-AFSC-286, 46 p.  

Cahalan J., J. Gasper, and J. Mondragon. 2015. Catch estimation in the federal trawl fisheries off Alaska: a simulation approach to compare the statistical properties of three trip-specific catch estimators. Can J. Fish. 72(7):1024:1036.  

Faunce, C. H. 2015. Evolution of observer methods to obtain genetic material from Chinook salmon bycatch in the Alaska pollock fishery. U.S. Dep. Commer., NOAA Tech. Memo. NMFS-AFSC-288, 28 p.  

Ganz, P., and C. Faunce. 2019. An evaluation of methods used to predict commercial fishing effort in Alaska. U.S. Dep. Commer., NOAA Tech. Memo. NMFS-AFSC-395, 19 p.  

Guthrie III, C. M., Hv. T. Nguyen, M. Marsh, J. T. Watson, and J. R. Guyon. 2019. Genetic stock composition analysis of the Chinook salmon bycatch samples from the 2017 Bering Sea trawl fisheries. U.S. Dep. Commer., NOAA Tech. Memo. NMFS-AFSC-391, 36 p.    

Hill, M.O. 1973. Diversity and evenness: A unifying notation and its consequences. Ecology 61: 225-236.  

`r if(tech.memo){'Nelson Jr., R., R. French, R. and J. Wall. 1981. Sampling by U.S. observers on foreign fishing vessels in the eastern Bering Sea and Aleutian Island region, 1977-78. Mar. Fish. Rev. 43:1-19.'}`  

NMFS (National Marine Fisheries Service). 2019. 2020 Annual Deployment Plan for Observers and Electronic Monitoring in the Groundfish and Halibut Fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street. Juneau, Alaska 99802.  

NMFS (National Marine Fisheries Service). 2018. 2019 Annual Deployment Plan for Observers in the Groundfish and Halibut Fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street. Juneau, Alaska 99802.  

NMFS. 2017. Final Environmental Assessment/ Regulatory Impact Review for Amendment 114 to the Fishery Management Plan for Groundfish of the Bering Sea and Aleutian Islands Management Area and Amendment 104 to the Fishery Management Plan for Groundfish of the Gulf of Alaska, and Regulatory Amendments: Analysis to Integrate Electronic Monitoring into the North Pacific Observer Program. National Oceanic and Atmospheric Administration, 709 West 9th Street. Juneau, Alaska 99802. Available online at https://www.fisheries.noaa.gov/resource/document/ea-rir-amendment-114-fmp-groundfish-bsai-and-amendment-104-fmp-groundfish-goa-and  

NMFS. 2015. Draft supplement to the Environmental Assessment for restructuring the program for observer procurement and deployment in the North Pacific. NMFS, Alaska Regional Office, Juneau. May 2015. Available online at https://alaskafisheries.noaa.gov/sites/default/files/analyses/finalea_restructuring0915.pdf.  

NMFS. 2013. 2014 Annual deployment plan for observers in the groundfish and halibut fisheries off Alaska. National Oceanic and Atmospheric Administration, 709 West 9th Street. Juneau, Alaska 99802. Available online at https://alaskafisheries.noaa.gov/sites/default/files/adp2014.pdf   
  
#####

`r if(tech.memo){'# Tables'}`  

####`r tbl_nums('trip.budget.table', caption = paste0('Comparison between predicted and actual trip days for partial coverage strata in ', year,'.  Predicted values come from the ', year,' Annual Deployment Plan (ADP).'))`  

```{r trip.budget.tbl, echo=FALSE}
# Add commas to numbers >= 1000
trip.budget.table[2:4] <- lapply(trip.budget.table[,2:4], prettyNum, trim=TRUE, big.mark=",")

# Italicize strata
trip.budget.table$Strata <- cell_spec(trip.budget.table$STRATA, italic = ifelse(trip.budget.table$STRATA != "Total", TRUE, FALSE))

# Print table
kbl(
  select(trip.budget.table, Strata, pred_days, act_days, diff, perc) %>% 
  rename(Predicted = pred_days, Actual = act_days, `Actual ` = diff, Percent = perc), escape = FALSE) %>% 
  kable_paper() %>%
  # Group columns 
  add_header_above(c(" " = 1, "Trip Days" = 2, "Difference" = 2))
```

#####

####`r tbl_nums('disposition.table' , caption = paste0('Trip cancellation rates in the ODDS for ', year, '. A trip is cancelled by the system if the user did not identify whether fishing had occurred by the end of the year. “Paper” indicates that a trip was logged when the ODDS was not available.'))`  

```{r disposition.table, echo=FALSE}
disposition.table[c(3,5,6)] <- lapply(disposition.table[,c(3,5,6)], prettyNum, trim=TRUE, big.mark=",")
disposition.table$`Trips remaining (*c* = *a*-*b*)`[disposition.table$`Trips remaining (*c* = *a*-*b*)`==" NA"] <- " "
disposition.table$`Cancelled by user (*d*)`[disposition.table$`Cancelled by user (*d*)`==" NA"] <- " "
kable(disposition.table)
```

#####

####`r tbl_nums('logged.table', caption = paste0('Number of remaining trips after cancellation in each trip-selection stratum that were selected using the initial random number generator (Random Number Selection) and those that remained after user manipulation (Total Final Selected). The relative impact of waivers in trip-selection is also shown (% Reduction of Selected Trips due to Waivers). **Not from random numbers.'))`  

```{r logged.table, echo=FALSE, tab.cap=""}
logged.table[c(2:6)] <- lapply(logged.table[,2:6], prettyNum, trim=TRUE, big.mark=",")

kable(logged.table)
```

#####

####`r tbl_nums('Selection.table', caption = paste0('Number of logged trips in each partial coverage stratum that were selected using the initial random number generator (Random Selection OnlyInitial Random Selection) and those that remained after user manipulation (Final ExpectedAfter Cancellations). The relative impact of inherits and waivers in trip-selection is also shown (With Inherits, No After Waivers).'))`  

```{r Selection.table, echo=FALSE, tab.cap=""}
Selection.table[c(3:4)] <- lapply(Selection.table[,3:4], prettyNum, trim=TRUE, big.mark=",")

kable(Selection.table)
```

#####

####`r tbl_nums('Coverage.Table', caption = paste0('Number of total vessels (V), sampled vessels (v), total trips (N), sampled trips (n) for each stratum in ', year, '. The coverage and 95% confidence interval columns are expressed as percentages of the total number of trips taken within each stratum.'))`  

```{r Coverage.Table, echo=FALSE, tab.cap=""}
Coverage.Table[c(5:8)] <- lapply(Coverage.Table[,5:8], prettyNum, trim=TRUE, big.mark=",")

# Italicize strata
Coverage.Table$Strata <- cell_spec(Coverage.Table$Strata, italic = ifelse(Coverage.Table$Strata != "Total", TRUE, FALSE))

# Print table
kbl(Coverage.Table, escape = FALSE) %>% 
  kable_paper() %>% 
  # Group columns
  add_header_above(c(" " = 6, "Coverage" = 2, "95% Confidence interval" = 2, " " = 1))
```

#####

####`r tbl_nums('em.summary.table', caption = "The number of EM hard drives received and reviewed by gear type and month.")`    
```{r em.summary.table, echo=FALSE, tab.cap=""}
for.em.summary.table <- EM.review %>% 
                        filter(TRIP_STATUS == "COMPLETED" & 
                               (year(ACTUAL_EM_TRIP_START_DATE_TIME) != 2020 | #Excluding 2019 data trips
                               is.na(ACTUAL_EM_TRIP_START_DATE_TIME))
                                ) %>%
                        group_by(GEAR_TYPE_LOGGED, EM_DATA_REVIEWED, MONTH = paste0(month.abb[month(DECLARED_TRIP_START_DATE)], ".")) %>% 
                        summarize(MONTH_TOTAL = length(EM_DATA_REVIEWED))

for.em.summary.table[is.na(for.em.summary.table)] <- 0

em.summary.table <- dcast(for.em.summary.table, GEAR_TYPE_LOGGED + EM_DATA_REVIEWED ~ MONTH, value.var = "MONTH_TOTAL") %>% 
                    select(GEAR_TYPE_LOGGED, EM_DATA_REVIEWED, Jan., Feb., Mar., Apr., May., Jun., Jul., Aug., Sep., Oct., Nov., Dec.) %>% 
                    arrange(GEAR_TYPE_LOGGED, desc(EM_DATA_REVIEWED))

em.summary.table[is.na(em.summary.table)] <- 0  

em.summary.table <- em.summary.table %>% 
                    mutate(GEAR_TYPE_LOGGED = ifelse(GEAR_TYPE_LOGGED == "LONGLINE", "EM HAL", GEAR_TYPE_LOGGED)) %>% 
                    mutate(GEAR_TYPE_LOGGED = ifelse(GEAR_TYPE_LOGGED == "POT", "EM POT", GEAR_TYPE_LOGGED)) %>% 
                    mutate(EM_DATA_REVIEWED = ifelse(EM_DATA_REVIEWED == "YES", "Yes", EM_DATA_REVIEWED)) %>% 
                    mutate(EM_DATA_REVIEWED = ifelse(EM_DATA_REVIEWED == "NO", "No", EM_DATA_REVIEWED)) %>% 
                    mutate(Total = rowSums(.[3:14])) %>% 
                    rename(Strata = GEAR_TYPE_LOGGED,
                           `Data reviewed?` = EM_DATA_REVIEWED)

kable(em.summary.table)

```

#####

####`r tbl_nums('em.times.table', caption = "The mean number of days taken for fixed gear EM data review by gear type. Columns are not additive, and instead represent two different ways of measuring review time, starting from either the end of the trip or from the date at which the hard drive was received.")`  
```{r em.times.table, echo=FALSE, tab.cap=""}
kable(em_times)
```

#####

####`r tbl_nums('Pollock.observed.table', caption = "The number of *TRW - No Tender* pollock deliveries by port and coverage category.")`  

```{r Pollock.observed.table, echo=FALSE, tab.cap=""}
Pollock.observed.table[c(4:5)] <- lapply(Pollock.observed.table[,4:5], prettyNum, trim=TRUE, big.mark=",")

kable(Pollock.observed.table)
```

#####

####`r tbl_nums('OBSERVED_FLAG.Ntable', caption = paste0('Number of trips by observation status in the ', year, ' trip-selection strata.'))`

```{r OBSERVED_FLAG.Ntable, echo=FALSE, tab.cap=""}
OBSERVED_FLAG.Ntable[c(2:3)] <- lapply(OBSERVED_FLAG.Ntable[,2:3], prettyNum, trim=TRUE, big.mark=",")

kable(OBSERVED_FLAG.Ntable)
```

#####

####`r tbl_nums('OBSERVED_FLAG.results', caption = paste0('Results of permutation tests between monitored and unmonitored trips in the ', year, ' trip-selection strata. OD: Observed difference (monitored - unmonitored). A Bonferroni adjustment has been applied to p-values.'))`  

```{r OBSERVED_FLAG.results, echo=FALSE, tab.cap=""}
kable(OBSERVED_FLAG.results)
```

#####

`r if(tech.memo){'# Figures'}`

```{r outcomes, echo = FALSE, warning = FALSE, fig.width = 7.5, fig.height = 9, dpi = 600}
print(grid.arrange(outcomes.plot, costs.plot, nrow=2))
```

####`r fig_nums('outcomes.plot', caption = paste0('Total number of observer sea days purchased (top panel) and total cost of observing those sea days (bottom panel). Vertical bars signify the range of potential outcomes predicted by the ', year, ' Annual Deployment Plan. Dashed lines signify expected outcomes. Solid lines signify what actually occurred in ', year, '.'))`  

#####

```{r odds.by.date.plot, echo=FALSE, fig.width=7.5, fig.height=8, dpi=600}
suppressWarnings(print(odds.by.date.plot))   
```

####`r fig_nums('odds.by.date.plot', caption = paste0('Rate of selected trips logged into ODDS organized by original date entered for all trips (grey line and grey text), and final date considering only non-cancelled trips (black line and black text). The programmed selection rate is depicted as the dotted line. Grey shaded areas denote the range of coverage rate corresponding to the 95% confidence intervals expected from the binomial distribution. The final coverage rates were higher than if trip dates had not been altered and/or cancelled. Vertical tick marks on the horizontal axis depict dates when an ODDS trip was selected due to a prior trip being cancelled that was selected for observer coverage (grey on the bottom for originally logged trips, and black on the top for trips after user manipulation).'))`  

#####

```{r Temporal.plot, echo=FALSE, warning=FALSE, fig.width=7.5, fig.height=8, dpi=600}
print(Temporal.plot)
```

####`r fig_nums('Temporal.plot', caption = paste0('Cumulative number of trips monitored during ', year, ' (black line) compared to the expected range of observed trips (shaded area) given fishing effort and sampling rates. Dates where the monitored number of trips is outside of expected (less or more than the range) are depicted as tick marks on the horizontal x-axis. The results of tests that the observed rate derived from a binomial distribution sampled at the selection rate are denoted as p-values.'))`  

#####

```{r cell.plot, echo=FALSE, warning=FALSE, fig.width=7.5, fig.height=8, dpi=600} 
suppressMessages(print(cell.plot))
```

####`r fig_nums('cell.plot', caption = paste0('Comparison plots depicting the number of monitored sample units compared to the number of expected monitored sample units for each partial coverage stratum. Each point on a plot represents a NMFS Area. The darker the point, the more unusual the result.'))`  

####

```{r probability_EM HAL, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=10, dpi=600}
```
![](probability_EM HAL.png)

####`r fig_nums('probability_EM HAL', caption = paste0('Probability of monitoring the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *EM HAL* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`

####

```{r probability_EM POT, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=10, dpi=600}
```
![](probability_EM POT.png)

####`r fig_nums('probability_EM POT', caption = paste0('Probability of monitoring the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *EM POT* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`  

####

```{r probability_HAL, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=10, dpi=600}
```
![](probability_HAL.png)

####`r fig_nums('probability_HAL', caption = paste0('Probability of observing the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *HAL* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`

```{r probability_POT - No Tender, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=10, dpi=600}
```
![](probability_POT - No Tender.png)

####`r fig_nums('probability_POT - No Tender', caption = paste0('Probability of observing the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *POT - No Tender* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`

```{r probability_TRW - No Tender, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=10, dpi=600}
```
![](probability_TRW - No Tender.png)

####`r fig_nums('probability_TRW - No Tender', caption = paste0('Probability of observing the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *TRW - No Tender* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`
  
```{r probability_POT - Tender, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=5, dpi=600}
```
![](probability_POT - Tender.png)

####`r fig_nums('probability_POT - Tender', caption = paste0('Probability of observing the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *POT - Tender* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`

```{r probability_TRW - Tender, echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=5, dpi=600}
```
![](probability_TRW - Tender.png)

####`r fig_nums('probability_TRW - Tender', caption = paste0('Probability of observing the realized or more extreme outcome (coverage rate) in a NMFS Reporting Area in the *TRW - Tender* stratum. Reporting Areas where unlikely outcomes occurred are shaded in darker colors.'))`

```{r Obs.perm.plot, echo=FALSE, fig.height=11, fig.width=8, message=FALSE, warning=FALSE, dpi=600}
suppressMessages(print(Obs.perm.plot))
```

####`r fig_nums('Obs.perm.plot', caption = paste0('Example of results from permutation tests depicting percent differences between observed and unobserved trips for observer pool strata in the partial coverage category. Grey bars depict the distribution of differences between observed and unobserved trips where the assignment of observed status has been randomized (this represents the sampling distribution under the null hypothesis that observed and unobserved trips are the same). The vertical line denotes the actual difference between observed and unobserved trips. Values on the x-axis have been scaled to reflect the relative (%) differences in each metric. The p-value for each test is denoted in the upper left corner. Low p-values are reason to reject the null hypothesis and conclude that there is an observer effect. Results from all permutation tests can be found in the Tables section of this report.'))`  

#####

```{r freq_geartender_plot, echo=FALSE, fig.height=6, fig.width=6, message=FALSE, warning=FALSE, dpi=600}
suppressMessages(print(freq_geartender))
```

####`r fig_nums('freq_geartender', caption = paste0('Distribution of trip durations for vessels in the partial coverage category by gear and observation status. Observed trips are depicted as transparent white bars overtop of solid black bars for unobserved trips. Trip durations where both observed and unobserved status exist are depicted in gray (This is not the same as a stacked bar chart, in which the height of the bar would reflect observed and unobserved on top of one another- this plot has each observation status in front of the other).'))`

#####

```{r prob.bynumber, echo=FALSE, warning=FALSE, fig.width=6, fig.height=6, dpi=600}
suppressMessages(print(prob.bynumber.plot))
```

####`r fig_nums('prob.bynumber.plot', caption = paste0('Probability of monitoring no trips in a NMFS Area and stratum given fishing effort and sampling rate. The x-axis has been truncated to increase resolution at low levels of fishing effort. The likelihood of having no monitoring data decreases with increasing total fishing effort and selection rate. The selection rate is ', wordlist(partial$txt), '.'))`  

#####

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
save.image(file="4_AR_report.Rdata")
```
