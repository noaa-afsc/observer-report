---
title: "Deployment Performance Review of the 2020 North Pacific Observer Program"
author: "Fishery Monitoring Science Committee"
always_allow_html: true
output:
  word_document:
    reference_docx: docs/word-styles-reference-01.docx
  pdf_document: default
---

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
# Once report has been run and 4_AR_report.Rdata has been created,
# skip running the code below and load all packages and objects here:
# load("4_AR_report.Rdata")
# source("3_helper.R")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load data
#load("2_AR_data.RData") # This includes the .Random.seed set in 1_AR_data.R
load("G:\\FMGROUP\\Observer Program Annual Report\\2022_Annual_Report\\2_AR_data.RData") # This includes the .Random.seed set in 1_AR_data.R



# Load packages and functions 
source("3_helper.R")

# Saving original partial object from work.data for strata will different selection rates at different time periods
#partial_og <- partial 

# Create a version of the partial coverage programmed rate table that only includes the initial programmed rates  
#partial <- partial[1:6,]

# Create a version of the partial coverage programmed rate table that includes all time periods    
partial_time <- partial %>% 
                filter(Effective_Date == min(Effective_Date)) %>% 
                mutate(Effective_Date = as.Date(Effective_Date), Expire_After = as.Date(c("2022-12-31", "2022-12-31", "2022-12-31", "2022-12-31", "2022-12-31", "2022-12-31"))) %>% 
                select(Effective_Date, Expire_After, STRATA, Rate, descriptions, formatted_strat, txt)

#partial_time <- rbind(partial_time,
#                      partial_time %>% 
#                      filter(STRATA %in% c("HAL", "POT", "TRW")) %>% 
#                      mutate(Effective_Date = as.Date("2021-09-01"), Expire_After = as.Date("2021-12-31")))


# The partial coverage programmed rate was never set equal to those in the ADP (like it was in 2020).  Hardcode some corrections:
#     The monitoring rates for the first time period come from Table 1 (page 14) of the 2021 ADP and the monitoring rates for the second time-period come 
#     from a Geoff Mayhew memo dated 8/26/2021:
# Also... according to the EA, "Under the EFP, the goal has been to achieve observer monitoring at a rate of 1 in every 3 trips (33%)."

# partial_time_hardcoded <- partial_time %>% 
#   mutate(Rate = ifelse(STRATA == 'EM TRW EFP', 0.3333, Rate)) %>% 
#   mutate(Rate = ifelse(STRATA == 'HAL' & Effective_Date == as.Date("2021-01-01"), 0.1513, Rate)) %>%
#   mutate(Rate = ifelse(STRATA == 'POT' & Effective_Date == as.Date("2021-01-01"), 0.1504, Rate)) %>% 
#   mutate(Rate = ifelse(STRATA == 'TRW' & Effective_Date == as.Date("2021-01-01"), 0.1612, Rate)) %>% 
#   mutate(Rate = ifelse(STRATA == 'HAL' & Effective_Date == as.Date("2021-09-01"), 0.1790, Rate)) %>%
#   mutate(Rate = ifelse(STRATA == 'POT' & Effective_Date == as.Date("2021-09-01"), 0.1760, Rate)) %>% 
#   mutate(Rate = ifelse(STRATA == 'TRW' & Effective_Date == as.Date("2021-09-01"), 0.2100, Rate))


# Avoid scientific notation
options(scipen=10000)

# Avoid dplyr summarise warnings
options(dplyr.summarise.inform = FALSE)

# Is this the annual report or the tech memo?
# This will control whether certain text chunks are included and formatting of table/figure captions.
annual.report <- TRUE
tech.memo     <- FALSE

if(annual.report){
  fig_nums <- captioner(prefix = "Figure 3-", auto_space=FALSE)  # In Annual report, deployment analyses make up Chapter 3. 
  tbl_nums <- captioner(prefix = "Table 3-", auto_space=FALSE)
}
```

```{r set-options, echo=FALSE, message=FALSE, warning=FALSE}
#Total deployment strata:
# 2 full coverage (FULL, EM TRW EFP)
# 3 partial coverage observed (HAL, POT, TRW)
# 3 partial coverage EM (EM HAL, EM POT, EM TRW EFP) + 
# 0 zero coverage EM research (Zero EM Research) +   ## Not this in 2022
# 1 zero coverage (ZERO)
#total.strat <- nrow(unique(work.data[, .(COVERAGE_TYPE, STRATA)]))
total.strat <- nrow(unique(work.data[, c("COVERAGE_TYPE", "STRATA")]))
```


# Introduction  
`r if(tech.memo){'## Background of the North Pacific Groundfish and Halibut Observer Program'}`  
`r if(tech.memo){'Fisheries observers and electronic monitoring (EM) systems collect independent information that is used to determine the effects of fishing on natural resources. The National Marine Fisheries Service (NMFS) uses its observer program in Alaska to enable the use of tools such as catch quotas to manage against the over- or under-harvest of fishes. Observers and EM are two verifiable methods for collecting fishery discard information used to estimate total catch. Observers (but not the EM systems currently used in the North Pacific) are able to record seabird and marine mammal interactions with fisheries as well. Observers also collect biological information such as length, sex, weight, ageing structures (e.g., otoliths, spines, scales, and vertebrae), and stomachs to support ecosystem studies and stock assessments.'}`

`r if(tech.memo){'The observer program in the North Pacific has a long history. Observers were first deployed onto fishing vessels in the Bering Sea in 1973 and into the remainder of the North Pacific in 1975 (Nelson et al. 1981, Wall et al. 1981). Fisheries in the North Pacific were initially prosecuted exclusively by foreign and later by "joint venture"'}` `r if(tech.memo){"operations where a developing domestic fleet of catcher vessels delivered to foreign-owned processing vessels. During the foreign and joint venture operations, foreign vessels carried fisheries observers at their expense, while domestic vessels were exempted from this observer coverage. As foreign vessels' rights to fish in the U.S. Exclusive Economic Zone (EEZ) were reduced over time and the domestic fishery grew, it became obvious to managers that observer coverage would be necessary for the emerging domestic fleet. At the onset of fully domestic fishery operations in 1990, the North Pacific Groundfish Observer Program was established as an interim observer program with rules governing observer coverage codified in regulations. This interim program would be extended four times over the next 20 years by the North Pacific Fishery Management Council (Council) - the last without a sunset date."}`

`r if(tech.memo){'The regulations established in 1990 required vessels 60-125 feet in length (overall) and all vessels fishing pot gear to carry observers at their own cost for 30% of their fishing days in a calendar quarter plus at least one trip in each fishery they participate in (termed the "30% fleet"), and vessels greater than 125 feet in length to carry an observer for 100% of their fishing days at their expense. Some vessels were not required to carry observers. These included vessels less than 60 feet, vessels fishing jig gear or vessels fishing with trawl gear that deliver unsorted codends to processing vessels (termed "catcher processors" or CPs if the vessel also has catching ability and "mothership" or M if the vessel does not) and vessels that fished for Pacific halibut (*Hippoglossus stenolepis*). For shoreside processors, the rules governing observer coverage were based on the estimated tonnage processed in a calendar month: plants that processed less than 500 metric tons (t) a month were exempted from coverage, those that processed between 500 t and 1,000 t a month were required to be observed for 30% of the calendar days, and those that processed more than 1,000 t a month were required to be observed for each day in the month.'}`

`r if(tech.memo){'Soon after the establishment of the domestic observer program, concerns over the ability and incentive for fishers to manipulate observer coverage in a way that might bias catch estimates and other analytic products prompted efforts by NMFS and the Council to provide a mechanism for NMFS to gain control over where and when observers were deployed (Faunce and Barbeaux 2011). From 1992 to 2008, several attempts to “restructure” the program were made. In 2010, the Council unanimously decided to move forward with the restructured observer program. In 2012, the Final Rule 77 FR 70062 was published to implement Amendment 86 to the Fishery Management Plan for Groundfish of the Bering Sea and Aleutian Islands (BSAI) Management Area and Amendment 76 to the Fishery Management Plan for Groundfish of the Gulf of Alaska (GOA). Amendments 86/76 added a funding and deployment system for observer coverage to the existing North Pacific Groundfish Observer Program and amended existing observer coverage requirements for vessels and processing plants. The “restructured” North Pacific Groundfish and Halibut Observer Program (hereafter termed “Observer Program”) began in 2013 with the randomization of deployments among trips and vessels. In 2018, the use of EM was added as an additional catch monitoring tool, with the understanding that some data elements collected by observers would not be collected using EM systems.'}`

`r if(tech.memo){'# The Annual Deployment Plan and Review'}`  
`r if(tech.memo){"Analysis and evaluation of the data collected by observers is an ongoing process. The NMFS considers Council input in making decisions as to the amount of coverage (i.e., selection probabilities that are assigned to each partial-coverage category). These decisions are based on available funding, the cost of observer coverage, and anticipated effort. The restructure of the Observer Program established new annual reporting processes. Each June, the NMFS provides the Council with a comprehensive evaluation of past years' observer deployments, costs, sampling levels, and implementation issues as well as recommended changes for the coming year. The June deployment performance review aims to identify areas where improvements are needed to 1) collect the data necessary to manage the groundfish and halibut fisheries; 2) maintain the scientific goals of unbiased data collection; and 3) accomplish the most effective and efficient use of the funds collected through the observer fee. The annual deployment performance review is an opportunity to inform the Council and the public of how well various aspects of the program are working, and consequently lead to recommendations for improvement as appropriate. The NMFS also prepares the Observer Program Annual Deployment Plan (ADP) each fall. The ADP defines deployment strata and establishes selection rates given available budgets and anticipated fishing effort. A draft ADP is released by September of each year to allow review by the Council's Groundfish Plan Teams, as well as the Council and its Scientific and Statistical Committee (SSC). Based on input from its advisory bodies and the public, the Council may choose to clarify objectives and provide recommendations to NMFS for the ADP. Upon analysis of the Council recommendations, NMFS will make any necessary adjustments to finalize the ADP and release it to the public. The ADP is released to the public prior to the December Council meeting."}`    

`r if(tech.memo){'## Fishery Monitoring Science Committee'}`  
`r if(tech.memo){'Each year the Alaska Fisheries Science Center’s (AFSC) Fisheries Monitoring and Analysis (FMA) Division establishes a committee to review the scientific elements of the North Pacific Observer Program. This committee, formerly referred to as the Observer Science Committee (OSC), was renamed in 2020 as the Fishery Monitoring Science Committee (FMSC), in order to reflect the addition of EM as a tool being used to monitor fisheries in the North Pacific. Similarly, we use the term ‘monitoring’ in this chapter when referencing fishing activity that has been monitored either by an observer or with EM.'}`  

`r if(annual.report){'Each year the Alaska Fisheries Science Center’s (AFSC) Fisheries Monitoring and Analysis (FMA) Division establishes a committee to review the scientific elements of the North Pacific Observer Program. This committee, formerly referred to as the Observer Science Committee (OSC), was renamed in 2020 as the Fishery Monitoring Science Committee (FMSC), in order to reflect the addition of electronic monitoring (EM) as a tool being used to monitor fisheries in the North Pacific. Similarly, we use the term ‘monitoring’ in this chapter when referencing fishing activity that has been monitored either by an observer or with EM.'}`  

The FMSC provides scientific advice in the areas of regulatory management, natural science, mathematics, and statistics as they relate to observer deployment and sampling in the groundfish and Halibut fisheries of the BSAI and the GOA. The FMSC members have analytical and scientific expertise relating to observer sampling of groundfish and halibut fisheries of the BSAI and GOA and use of the collected data. If possible, the FMSC is represented by at least one member of the AFSC/FMA (Observer Program) Division, one member of the AFSC/Stock Assessment and Multispecies Assessments Program, one member of the Alaska Regional Office (AKRO) Sustainable Fisheries Division, and one member of the International Pacific Halibut Commission (IPHC).

`r if(annual.report){'This chapter contains the FMSC review of the deployment of observers and EM in'}` `r if(annual.report){year}` `r if(annual.report){'relative to the intended sampling plan and goals of the'}` `r if(annual.report){year}` `r if(annual.report){'Annual Deployment Plan (ADP, NMFS'}` `r if(annual.report){year-1}` `r if(annual.report){'a). This review identifies where possible biases exist and provides recommendations for further evaluation, including potential improvements to the observer deployment process that should be considered during the development of the'}` `r if(annual.report){year+2}` `r if(annual.report){'ADP.'}`    

`r if(annual.report){'The goal of the Observer Program is to achieve a random deployment of observers and EM into fisheries to collect representative data used to estimate catch and bycatch, assess stock status, collect fishery-dependent biological information used in population and ecosystem modeling efforts, and make salmon bycatch stock-of-origin determinations, among other objectives. Therefore, this evaluation focuses on the randomization of observer and EM deployments into primary sampling units, and how departures from a random sample affect data quality.'}`  

## The Sampling Design of the Observer Program  
Since 2013, the Observer Program has used a stratified hierarchical sampling design with randomization at all levels. Stratification is used to increase the efficiency of sampling by observers and to address logistical issues associated with deployment. By grouping similar fishing activities into strata and sampling those strata appropriately, sampling efficiency is increased and the variance of resulting estimates may also be decreased. Sampling strata are defined in the ADP and are designed such that each unit of deployment (e.g., trip) is assigned to only one stratum.

Within a stratum, observers are deployed randomly to either vessels for a predetermined period of time (termed vessel-selection), or to individual fishing trips (termed trip-selection). In both cases, this initial deployment to the fishery is the first level of the sampling hierarchy and defines the primary sampling unit (PSU; either vessel-periods or individual trips). The list of all PSUs in a stratum defines the sampling frame and should equate to the population of interest for that sampling stratum (e.g., all trips taken by trawl vessels fishing in the Alaska EEZ).  If the sampling frame does not contain all elements of the stratum, the resulting information may be biased.  The magnitude and direction of the bias will depend on how different the fishing activities in the sample frame are from actual fishing activity.

Although this report evaluates whether monitoring goals were met, we include a brief summary of the full sampling hierarchy here for context.  For each observed trip, if all hauls cannot be sampled for logistical reasons, hauls are randomly selected to be sampled. This is the next level in the hierarchy; the secondary sampling units are defined as hauls within a trip. Randomization of haul selection is designed to allow observers to record and transmit data, attend to other non-sampling responsibilities, and to allow observers time to sleep and eat. Randomization of haul selection also gives EM video reviewers the ability to optimize the amount of video that can be reviewed from each trip. Haul selection is determined using the random sampling tables and random break tables provided by NMFS. For each haul, fishing location and effort (e.g., number of hooks) are recorded, while marine mammal and seabird interactions are primarily recorded on randomly selected hauls. The ability of EM to capture marine mammal and seabird interactions is less than that of observers due to the fixed location in which EM equipment is placed.

For the randomly selected hauls, a random sample of the catch is collected (observers) or selected for video review (EM), and data from those samples are used to determine the species composition and amount of discarded catch. These samples of catch within each haul are the third level of the sampling hierarchy. While observers are trained to collect multiple large samples of catch, the number and size of samples taken from each haul will depend on the vessel configuration, fishing operations, and diversity of catch. The size of EM samples is largely determined by the number of video reviewers available relative to the amount of video to be reviewed.

At the fourth level of the sampling hierarchy, a predetermined number of individual fish of predetermined species is randomly selected from the species composition sample and measured. Lastly, at the fifth sampling level, a random selection of fish is used to collect otoliths, reproductive maturity assessments, stomach contents, genetic tissues, and other biological specimens. The number and species of fish selected for measurement and biological specimen collection is specified each year by the AFSC’s stock assessment scientists. Sampling rates for genetic tissue collection by observers (e.g., 1 of 10 Chinook salmon caught as bycatch) are set each year by the AFSC’s Auke Bay Laboratory. Sampling at the fourth and fifth levels of the sampling hierarchy does not occur with EM. 

More information on the sampling design used by observers and the relationship between the sample design and catch estimation can be found in Cahalan and Faunce (2020) and the `r year` Observer Sampling Manual (AFSC `r year-1`). `r if(annual.report){'A summary of the'}` `r if(annual.report){year}` `r if(annual.report){'ADP can be found in Section 1.3. The focus of this report is related to deployment, and the evaluation is at the primary level of the sampling hierarchy.'}` `r if(tech.memo){'A summary of the'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP is included below. The focus of this report is related to deployment, and the evaluation is at the first level of the sampling hierarchy.'}`

`r if(tech.memo){'# The'}` `r if(tech.memo){year}` `r if(tech.memo){'Annual Deployment Plan'}`    
`r if(tech.memo){'The following briefly summarizes the final'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP (NMFS '}` `r if(tech.memo){year-1}``r if(tech.memo){'). In general, all vessels that participate in cooperatives or act as catcher-processors or motherships are fully observed at the trip-level and constitute the full-coverage category of the fleet. In 2016, NMFS published new regulations to allow the owner of a trawl catcher vessel to annually request that NMFS place requesting vessels in the full coverage category for all directed fishing for groundfish using trawl gear in the Bering Sea and Aleutian Islands management area (BSAI) in the following calendar year. This regulated process has replaced an interim policy. For the '}` `r if(tech.memo){year}` `r if(tech.memo){'calendar year, NMFS received and approved requests and has placed'}` `r if(tech.memo){'32'}` `r if(tech.memo){'catcher vessels in the full coverage category for all directed fishing for groundfish using trawl gear in the BSAI management area (NMFS'}` `r if(tech.memo){year-1}``r if(tech.memo){'). The partial-coverage category includes vessels greater than or equal to 40 feet (ft) length overall (LOA) and not in the full coverage category. The following sampling strata comprised the partial coverage category in'}` `r if(tech.memo){year}` `r if(tech.memo){':'}`  

`r if(tech.memo){'1. Hook-and-line vessels (*HAL* stratum).'}`    
`r if(tech.memo){'2. Hook-and-line vessels with EM (*EM HAL* stratum).'}`     
`r if(tech.memo){'3. Pot vessels with EM (*EM POT* stratum).'}`  
`r if(tech.memo){'4. Trawl vessels (*TRW* stratum).'}`  
`r if(tech.memo){'5. Trawl vessels participating in an exempted fishing permit (*EM TRW EFP* stratum).'}`  

`r if(tech.memo){'In this report we attempt to evaluate the deployment of EM onto fixed gear vessels to the same degree as we evaluate the deployment of observers since catch accounting has used data collected through the *EM HAL* stratum since 2018 and the *EM POT* stratum since 2019. NMFS also sought vessels to participate in EM research and development activities. Vessels that volunteered for the fixed gear EM Program or EM research activities and were selected by the NMFS were not required to carry observers but were required to continue to log their fishing trips into the Observer Declare and Deploy System (ODDS).'}`

`r if(tech.memo){'The *EM TRW EFP* stratum is represented by vessels participating in an Exempted Fishing Permit (EFP) to evaluate the efficacy of EM on pollock catcher vessels using pelagic trawl gear in the Bering Sea and Gulf of Alaska. The EFP allows pollock catcher vessels using pelagic trawl gear to use EM systems *in lieu* of at-sea observers.  While we report some findings on these vessel activities here, we do not evaluate them fully sine the EFP is not part of the regulated fishery monitoring program.'}`

`r if(tech.memo){'The NMFS used only the trip-selection method (i.e., no vessel-selection) to assign observers and EM to vessels in the partial-coverage category for 2020. However, revisions to observer deployment were enacted in 2020 due to COVID-19. Starting in March, 2020, the COVID-19 pandemic created limitations on available air travel and “shelter in place” restrictions, particularly in many remote Alaskan communities. Under the emergency rule signed on March 24, 2020, NMFS temporarily waived the requirement for vessels in the Partial Coverage Category to carry a fishery observer from March 27 through April 19, 2020. On April 18, 2020, NMFS announced a limited extension of the temporary waiver of observer requirements, which narrowed the scope and reinitiated deployment of observers on trips departing from the port of Kodiak, Alaska (the majority of GOA trawl fisheries occurred out of Kodiak during this timeframe). On June 28, 2020, NMFS expanded observer deployment in the partial coverage category to include 13 ports in addition to Kodiak, which further reduced the scope of waivers issued. Observers were to be deployed on randomly selected trips from the following ports: (1) Akutan, (2) Dutch Harbor/Unalaska, (3) False Pass, (4) Homer, (5) Juneau, (6) Ketchikan, (7) King Cove, (8) Kodiak, (9) Nome, (10) Petersburg, (11) Sand Point, (12) Seward, (13) Sitka, and (14) Yakutat.  These ports were identified because travel and lodging conditions allow observers to meet and maintain applicable health mandates for deployment into the commercial fisheries and because of the volume of fishing trips that are expected to originate and end in these locations.'}` 

`r if(tech.memo){'The largest component of the Alaskan groundfish fisheries, vessels, and processors in the full coverage category (including catcher processors and participants in limited access privilege programs), were not issued waivers in 2020. Additionally, requirements for deployment of EM was not waived for trawl catcher vessels fishing under the trawl EM exempted fishing permit and only a few trips were released from coverage under the fixed gear EM portion of the partial coverage category for circumstances when an EM service technician was unable to travel.'}`

`r if(tech.memo){'These changes to the original deployment plan resulted in three time periods to evaluate fishery monitoring deployment for each partial coverage stratum.'}`

# Performance Review Objectives   
`r if(tech.memo){'The following sections contain the FMSC review of the deployment of observers in'}` `r if(tech.memo){year}` `r if(tech.memo){'relative to the intended sampling plan and goals of the'}` `r if(tech.memo){year}` `r if(tech.memo){'ADP (NMFS'}` `r if(tech.memo){year-1}` `r if(tech.memo){'). This report identifies where potential mechanisms for biases exist and provides recommendations for further evaluation, including potential improvements to the observer deployment process that should be considered during the development of the'}` `r if(tech.memo){year+2}` `r if(tech.memo){'ADP.'}`  
The following items from the `r year` ADP have been identified as objectives for evaluation in this report:  


* Deploy for the planned number of sea days. This objective will be considered to be met if the actual number of sea days expended falls within the range of values from simulated sampling provided in the `r year` ADP. The Observer Program’s budget was expected to cover `r formatC(AvailableYR, format="d", big.mark=",")` days in `r year`.      
  
* Deploy at the coverage rates specified in the `r year` ADP. Following the `r year` ADP, ODDS was programmed to randomly select logged trips at a rate of 23.70% in the *TRW - No Tender* stratum, 17.71% in the *HAL* stratum, 15.43% in the *POT - No Tender* stratum, 27.12% in the *TRW - Tender* stratum, 16.11% in the *POT - Tender* stratum, and 30% in the EM strata. Under a randomized deployment scheme, these partial coverage selection rates are expected to be within a 95% confidence interval computed from the realized coverage rates (under the assumption of a binomial distribution for observed trips).    
  
* Collect tissue samples from Chinook and chum salmon as specified in the `r year` Observer Sampling Manual to support the goal of collecting genetic samples from salmon caught as bycatch in groundfish fisheries to identify stock of origin. The sampling protocol established in the 2014 ADP (NMFS 2013) was used in `r year`. Under this protocol, observers on vessels delivering to shoreside processors in the GOA trawl walleye pollock (*Gadus chalcogrammus*, hereafter referred to as simply ‘pollock’) fishery monitor the offload to enumerate salmon bycatch and obtain tissues for genetic analysis from the salmon bycatch. For trips that are delivered to tender vessels and trips outside of the pollock fishery, observers obtain salmon counts and tissue samples from all salmon found within at-sea samples of the total catch.    
  
* Randomize deployment of observers into the partial coverage category of fishing activities. This randomization is used to collect observer and EM samples that are representative of the entire fishing fleet (observed and monitored trips are equivalent to unobserved and unmonitored trips within a stratum). Evaluation of this objective is focused on the randomization of observer and EM deployments into primary sampling units, and how departures from a random sample affect data quality.      
  
## Observer Deployment Performance Metrics  
Performance metrics have been developed to assess whether the trip-selection process (through the implementation of the `r year` ADP) provides a representative sample of fishing trips in the North Pacific in `r year`. These metrics reflect four mechanisms that can impact the quality of the data: sample frame discrepancies, non-response, differences in trip characteristics, and sample size.        

The performance metrics used in this evaluation are as follows:  

1. Deployment rates for each stratum: This is the basic level of evaluation for comparing targeted and achieved sampling rates, where sampling strata are partitions of the entire population about which we want to make inferences (e.g., generate estimates of catch). Implementation challenges can be identified in this step, such as sample frame inadequacy, selection biases, and issues with sample unit definitions. Specifically, this section assesses the following:        

+ a.  Sample rates and number of samples relative to intended values.   
  
+ b.  Quantification of under- and over-coverage rates (sample frame discrepancies). Over-coverage of a population occurs when the sample frame includes elements that are not part of the target population. When these elements are included in the random sample, effort (time, cost) is expended needlessly. Under-coverage results from having a sample frame that does not include a portion of the target population which can lead to biased data if that portion of the population differs from the population included in the sample frame.   
  
+ c.  Non-response rates. Non-response occurs when randomly selected elements (trips or vessels) are not actually sampled. If these trips or vessels have different fishing behavior (e.g., catch, areas fished) than the rest of the population, the data collected will not represent the entire fleet (non-response bias).  
  
2.  Representativeness of the sample: Randomized sampling is a method used to ensure that the results of sampling reflect the underlying population. Departures from randomization can lead to non-representative data and hence potential bias in estimates of the parameters of interest. A randomized sample design is expected to achieve a rate of monitored events that is similar across both space and time. Representativeness of the sample was divided into three separate components:   

+ a.	Temporal representativeness
  
+ + i.	Effort plots: plots of expected and actual monitoring effort over time. Areas where these two lines deviate from each other are indicative of periods with differential realized sample rates (and potential temporal bias).  
    
+ b.	Spatial representativeness
  
+ + i.	Maps: Maps provide a visual depiction of the spatial distribution of monitoring coverage relative to effort in each partial coverage stratum, as well as where low or high coverage rates occurred.  
    
+ + ii.	Probability of monitoring a fewer or greater number of trips within an area than would be expected given the realized sample rate for the entire stratum. These data are used to identify departures from anticipated sampling rates.  
    
+ c.	Representativeness of trip characteristics
  
+ + i.	Consistency of trip characteristics for monitored and unmonitored portions of the stratum. These metrics are based, in part, on the availability of data for both monitored and unmonitored fishing activities; for example, data that are reported for all trips on landing reports. Attributes tested in this report include the following:     
    
+ + + * Trip duration (days).
        
+ + + * Vessel length (feet).
        
+ + + * The number of NMFS Areas visited during the trip.
        
+ + + * The amount of landed catch (metric tons).
        
+ + + * The number of species in the landed catch (also known as species richness).
        
+ + + * The proportion of the total landed catch that was due to the most prevalent species (pMax, an inverse a measure of species diversity where an increase in pMax indicates a decline in diversity).  
        
3.  Adequacy of sample size: A well-designed sampling program will have a sample large enough to reasonably ensure that the characteristics of interest in the entire target population are represented in the data. Whether the sample size collected was adequate was determined through an examination of the probability of deploying observers at the implemented rate and having no monitoring coverage in one or more cells (e.g., defined by NMFS Reporting Area and strata).     

Although these metrics can identify places where observed results differ from expectations, it is ultimately a subjective decision as to whether or not these differences are substantial enough to have management implications. This holds true even for tests that have associated *p*-values. Additionally, our focus on landed catch is due to the fact that total catch is comprised of retained and discarded portions, and since discarded catch is not available from unmonitored trips, landed catch represents the only portion of the catch that is available from all trips.  

# Changes to This Report from Last Year  
<!-- Manually update this section -->  
Changes to our analyses were necessary to properly address the changes to the deployment of observers caused by COVID-19.  Effectively, the necessary policy changes made throughout the year by NMFS created three separate time periods that needed to be considered.  In the first time period, deployment was based on trips among all ports of departure, and followed the 2020 ADP.  During the second time period, there is no expectation of monitoring.  During the third time period, there was an expectation of monitoring at a certain rate measured in trips across all ports, but the sampling frame was reduced to thirteen ports of departure, and only included those trips with the same departure and arrival port.  Unfortunately, the information necessary to identify the group of trips belonging to the third time period sampling frame is not available in any database except ODDS.  However ODDS does not directly link to actual fishing activities such as those used in this report.  Therefore, after review by the Fisheries Monitoring Science Committee (FMSC), it was decided that we could not perform a statistical review of whether or not fisheries monitoring in the third time period met the expectations of the sampling design in terms of evaluating spatial bias.  Therefore this chapter does not include any spatial maps nor accompanying spatial analyses. Nonetheless, the FMSC agreed that promotion of past analyses showing overlap in time and space between total fishing effort and monitored fishing effort was appropriate as originally proposed in Chapter 3 of the 2019 Annual Report.  The methods used in this analysis are similar to those employed in the gap analysis in Appendix C of the 2020 Draft Annual Deployment Plan and Appendix B of the 2019 Annual Report and are published in Ganz et al. (2020). Partial coverage fishing effort data from 2020 was used to quantify the degree to which data from monitored trips are available within specified spatiotemporal distances to unmonitored fishing trips.  Prior versions of this analysis had quantified the degree of overlap in terms of an index.  Here, we only use presence and absence of fishing effort and monitored fishing effort in each week, each NMFS area, and each stratum.  More detailed versions of these plots with species target are planned to be available to stock assessment authors separate from this document.  One additional change was made to the presentation of the likelihood of having no observed trips within a NMFS Area and partial coverage stratum combination; they are now presented in their entirety as a histogram to show relative proportions and not as a line plot to show trends.

# Evaluation of Deployment in `r year`  
The deployment of observers into the `r year` Federal fisheries in Alaska is primarily evaluated at the level of the deployment stratum because each stratum is defined by a different sampling rate or by a different monitoring method (e.g., observers and EM). In this document, trips in the *EM HAL* and *EM POT* strata are considered successfully monitored if at least some video was reviewed from a trip. The rationale for defining monitored trips this way is that it is most similar to the way in which trips in other strata are considered observed (i.e., irrespective of whether or not haul information or usable species composition data were collected).                
## Evaluating Effort Predictions  

Each year, the NMFS sets an annual budget for the Observer Program in terms of cost and observer days. The partial coverage observer day budget for `r year` was set at \$`r formatC(BUDGET, format="d", big.mark=",")` and `r formatC(AvailableYR, format="d", big.mark=",")` days in the `r year` ADP, and the NMFS expected to spend \$`r formatC(days_paid_sum$Total.Dollars, format="d", big.mark=",")` observing `r formatC(PredictedYR, format="d", big.mark=",")` days (NMFS `r year-1`). The expected number of observer days is determined by the expected number of fishing days and the rate at which trips are selected for coverage. The number of fishing days expected to occur in `r year` was estimated using data on annual fishing effort from 2013 to 2018 (Ganz and Faunce 2019). Based on simulations using trip durations from 2017 and 2018, the NMFS then set selection rates so that the average cost from simulations was equal to the available budget (NMFS `r year-1`).  

In `r year`, the FMA paid for `r formatC(round(ActualYR), format="d", big.mark=",")` observer days, which was `r ifelse(eval$pct.budget.remain != 0, abs(eval$pct.budget.remain), " ")` `r ifelse(eval$pct.budget.remain != 0, "%", "")` `r eval$more.or.less` predicted by the average simulation, but well within the range of possibilities predicted in the `r year` ADP (`r fig_nums('outcomes.plot', display = "cite")`, top panel). This is explained by the fact that there was more effort in *HAL*, *POT – Tender*, and *TRW – Tender* than expected (`r tbl_nums('trip.budget.table', display="cite")`). Despite observing more days than predicted, expenditures for partial observer coverage were under budget (`r fig_nums('outcomes.plot', display = "cite")`, bottom panel). This resulted because the cost of a partial coverage observer day in `r year` was less than the expected cost that was estimated in the `r year` ADP.     

# Performance of the Observer Declare and Deploy System in Trip-Selection  
The random selection of trips for monitoring is made by the ODDS for logged trips within the observer and EM trip selection pools. The ODDS generates a random number according to the pre-determined rates and assigns each logged trip to either “selected to be monitored” (selected) or “not selected to be monitored” (not selected) categories.       

```{r odds.performance, warning=FALSE, include=FALSE}
# Calculate a test metric for the random number process in ODDS
# Trips outside of trip-selection do not have random numbers in ODDS_MONITOR (e.g. voluntary 100%)
# There may or may not be NAs in RANDOM_NUMBER_USED, depending on the stratification used
# This analysis needs to be done regardless of whether there are NAs in RANDOM_NUMBER_USED

# Convert PLANNED_EMBARK_DATE to as.Date(), which is easier to work with than POSIXct  
odds.dat <- mutate(odds.dat, PLANNED_EMBARK_DATE = as.Date(PLANNED_EMBARK_DATE))

# 2021-ONLY: define time periods
#date_cuts <- c(as.Date(unique(partial_og$Effective_Date)), as.Date("2021-09-01"), max(odds.dat$PLANNED_EMBARK_DATE))  # this resulted in a duplicated 9/1/2021
#date_cuts <- c(as.Date(unique(partial_og$Effective_Date)), max(odds.dat$PLANNED_EMBARK_DATE))
#date_cuts <- date_cuts[order(date_cuts)] 

odds.dat <- mutate(odds.dat, random.assign = NA) %>% 
            #mutate(PERIOD = cut(PLANNED_EMBARK_DATE, breaks=date_cuts, labels=F, ordered_result = T, right=F, include.lowest = T)) %>%  # 2020-ONLY: Adding period to odds.dat
            #mutate(PERIOD := ifelse(STRATA %like% "EM",1, PERIOD)) %>% # Don't split EM strata by period; make period = 1
            mutate(random.assign = ifelse(!is.na(RANDOM_NUMBER_USED), 0, random.assign)) %>% 
            mutate(random.assign = ifelse(!is.na(RANDOM_NUMBER_USED) & RANDOM_NUMBER_USED < (ODDS_SELECTION_PCT / 100), 1, random.assign)) 


# Are assignments being performed as programmed?
# ND = Not observed (Provider Defaulted)
# RO = Observer Trip (Require Observer)
# OA = Observed Trip (Observer Assigned)
# RL = Not Observed (Provider Release)
# NO = Not Observed Trip (Observer Not Required or Waiver Granted)
# SAMPLE_PLAN_SEQ == 98 are EM trips that were marked "OA" only because they fished IFQ in more than one area 
odds.dat <- mutate(odds.dat, random.test = 0) %>% 
            mutate(random.test = ifelse(TRIP_OBS_CODE %in% c("ND", "RO", "OA", "RL") & SAMPLE_PLAN_SEQ != 98, 1, random.test)) %>% 
            mutate(random.test = ifelse(!is.na(WAIVER_TYPE), 1, random.test)) %>%  # Waived trips
            mutate(random.test = ifelse(!is.na(INHERIT_OBS_TRIP_SEQ), NA, random.test)) %>% # Inherited trips aren't truely 'selected'
            mutate(random.test = ifelse(TRIP_STATUS_CODE == "CC", NA, random.test)) %>% # CC = 'cascade cancel'
            mutate(random.test = ifelse(is.na(RANDOM_NUMBER_USED), NA, random.test))
            
# Make NA all 1) RANDOM_NUMBER_USED = NA or 2) INHERIT_OBS_TRIP_SEQ is not an NA OR the trip was a 'cascade cancel'
# odds.dat$random.test[is.na(odds.dat$RANDOM_NUMBER_USED) | !is.na(odds.dat$INHERIT_OBS_TRIP_SEQ) | odds.dat$TRIP_STATUS_CODE == "CC"] <- NA

#Perform the test
odds.dat <- mutate(odds.dat, random.test = random.test - random.assign) %>% 
            mutate(random.test.result = ifelse(random.test == 0, "PASS", "FAIL"))

filter(odds.dat, random.test.result == "FAIL")

table(odds.dat$random.assign, useNA = "always")
```

```{r disposition.tbl, warning=FALSE, include=FALSE}
# Table 3-2 ----
# Disposition of trips in the ODDS. This table summarizes the frequency of trip activities.  
# It does not represent the actual trips expected on the grounds. That is the next table.
disposition <- # Merging two elements:
  merge(
    # The first is by strata
    odds.dat %>%  
      select(STRATA, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, WAIVER_TYPE, TRIP_PLAN_NUMBER) %>%
      #select(STRATA, PERIOD, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, WAIVER_TYPE, TRIP_PLAN_NUMBER) %>%
      filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>% 
      group_by(STRATA, random.assign) %>%
      #group_by(STRATA, PERIOD, random.assign) %>%
      summarize(Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
                Trips.cancelled.bysystem = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE=="CS"]),
                Trips.remaining = Trips.logged.ODDS - Trips.cancelled.bysystem,
                Trips.cancelled.byusers = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE %in% c("CN", "CC")]),
                # Trips.waived= length(TRIP_PLAN_LOG_SEQ[!is.na(WAIVER_TYPE)]),
                Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)])) %>%
      mutate(Cancellation.Pct = format(round((Trips.cancelled.byusers / Trips.remaining) * 100, 1), nsmall=1)) %>% 
                # Waiver.Pct = format(round((Trips.waived / Trips.remaining) * 100, 1), nsmall=1)) %>%
      data.frame(),
     # The second is the grand total
     # odds.dat %>%
     #   filter(STRATA %in% partial$STRATA) %>% 
     #   summarize(STRATA = "Total",
     #             Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
     #             # Only include "Selected" for cancellations summaries
     #             Trips.cancelled.bysystem = length(unique(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE=="CS" & random.assign==1])),
     #             Trips.selected = length(unique(TRIP_PLAN_LOG_SEQ[random.assign==1])),
     #             Trips.remaining = Trips.logged.ODDS - Trips.cancelled.bysystem,
     #             # Only include "Selected" for cancellations summaries
     #             Trips.cancelled.byusers = length(TRIP_PLAN_LOG_SEQ[(TRIP_STATUS_CODE %in% c("CN", "CC")) & random.assign==1]),
     #             # Trips.waived = length(TRIP_PLAN_LOG_SEQ[!is.na(WAIVER_TYPE)]),
     #             Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)]),
     #             random.assign = "") %>%
     #    mutate(Cancellation.Pct = format(round((Trips.cancelled.byusers / Trips.selected) * 100, 1), nsmall=1)) %>% 
     #    select(-Trips.selected) %>% 
     #    data.frame(), 
    odds.dat %>%  
      select(STRATA, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, WAIVER_TYPE, TRIP_PLAN_NUMBER) %>%
      #select(STRATA, PERIOD, random.assign, TRIP_STATUS_CODE, TRIP_PLAN_LOG_SEQ, WAIVER_TYPE, TRIP_PLAN_NUMBER) %>%
      filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>% 
      group_by(random.assign) %>%
      #group_by(PERIOD, random.assign) %>%
      summarize(STRATA = "Total",
                Trips.logged.ODDS = length(unique(TRIP_PLAN_LOG_SEQ)),
                Trips.cancelled.bysystem = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE=="CS"]),
                Trips.remaining = Trips.logged.ODDS - Trips.cancelled.bysystem,
                Trips.cancelled.byusers = length(TRIP_PLAN_LOG_SEQ[TRIP_STATUS_CODE %in% c("CN", "CC")]),
                # Trips.waived= length(TRIP_PLAN_LOG_SEQ[!is.na(WAIVER_TYPE)]),
                Paper.tickets = length(TRIP_PLAN_LOG_SEQ[!is.na(TRIP_PLAN_NUMBER)])) %>%
      mutate(Cancellation.Pct = format(round((Trips.cancelled.byusers / Trips.remaining) * 100, 1), nsmall=1)) %>% 
                # Waiver.Pct = format(round((Trips.waived / Trips.remaining) * 100, 1), nsmall=1)) %>%
      data.frame(),
     # Merge type
     all=T)

# Don't include Not Selected trips (random.assign==0) in cancellation summaries since its not required by user. 
disposition$Trips.cancelled.bysystem[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""
disposition$Trips.remaining[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""
disposition$Trips.cancelled.byusers[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""
disposition$Cancellation.Pct[is.na(disposition$random.assign) | disposition$random.assign == 0] <- ""

#define values in the random.assign  
disposition$random.assign[is.na(disposition$random.assign) | disposition$random.assign == 1] <- "Selected"
disposition$random.assign[disposition$random.assign == 0] <- "Not Selected"

# Then rename some columns for the table
disposition.table <- 
  disposition %>%
  arrange(match(STRATA, c("HAL", "EM HAL", "POT", "EM POT", "TRW", "Total"))) %>% 
  rename('Strata' = STRATA, 
         #'Period' = PERIOD,
         'Random number outcomes' = random.assign, 
         'Logged (*a*)' = Trips.logged.ODDS, 
         'Cancelled by system (*b*)' = Trips.cancelled.bysystem,
         'Trips remaining (*c* = *a*-*b*)' = Trips.remaining, 
         'Cancelled by user (*d*)' = Trips.cancelled.byusers, 
         #'Waived' = Trips.waived, 
         'Paper' = Paper.tickets, 
         '% User cancellation (*d*/*c* * 100)' = Cancellation.Pct)
         #'Waiver (%)' = Waiver.Pct)
```

```{r odds.logged.tbl, warning=FALSE, include=FALSE}
# Table 3-3 ---- 
#Disposition of trips - showing only valid trips and categories are exclusive
logged <-
  odds.dat %>% 
  # only pull in partial coverage
  filter(!ODDS_SELECTION_PCT %in% c(0, 100), !is.na(TRIP_SELECTED_OBS)) %>%  
  filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>% 
  group_by(STRATA) %>%
  #group_by(STRATA, PERIOD) %>%                                                 # 2020-ONLY: Added period to group
  summarize(Total.trips = length(unique(TRIP_PLAN_LOG_SEQ)),
            Random.selected = sum(random.assign, na.rm = TRUE), 
            # Number of trips that are not selected by a random number but were 
            # selected by inherits instead and were not subsequently waived
            # (EXTRA TRIPS BEYOND RANDOM SELECTION DUE TO INHERITS)
            Inherit.selected = length(unique(TRIP_PLAN_LOG_SEQ[random.assign == 0 & 
                                                               !is.na(INHERIT_OBS_TRIP_SEQ) &
                                                                is.na(WAIVER_TYPE)])),
            # Randomly selected trips that were waived.
            Waivers.selected = length(unique(TRIP_PLAN_LOG_SEQ[random.assign == 1 & 
                                                               !is.na(WAIVER_TYPE)])),
            # Below are the outcomes of inherits and waivers
            Total.final.selected = length(unique(TRIP_PLAN_LOG_SEQ[TRIP_SELECTED_OBS == "Y"])),
            # Percent of total selected trips due to inherits
            Pct.selected.from.inherit = format(round((Inherit.selected / Total.final.selected) * 100, 1), nsmall = 1),
            # % Reduction in Selected Trips due to Waivers
            Pct.allselected.from.waiver = format(round((Waivers.selected / (Total.final.selected + Waivers.selected)) * 100, 1), nsmall = 1)) %>% 
  arrange(match(STRATA, c("HAL", "EM HAL", "POT ", "EM POT", "TRW")))

logged.table <- bind_rows(logged, 
                      logged %>% 
                      #group_by(PERIOD) %>%          # 2020-ONLY: Added period
                      summarise(STRATA = "Total",
                                Total.trips = sum(Total.trips),
                                Random.selected = sum(Random.selected),
                                Inherit.selected = sum(Inherit.selected),
                                Waivers.selected = sum(Waivers.selected),
                                Total.final.selected = sum(Total.final.selected)) %>% 
                      mutate(Pct.selected.from.inherit = format(round((Inherit.selected / Total.final.selected) * 100, 1), nsmall = 1),
                             Pct.allselected.from.waiver = format(round((Waivers.selected / (Total.final.selected + Waivers.selected)) * 100, 1), nsmall = 1))) %>% 
                      select(`Strata`=STRATA, `Total Trips`=Total.trips,
                      #select(`Strata`=STRATA, `Period`=PERIOD, `Total Trips`=Total.trips,
                             `Random number selection (*r*)`=Random.selected, 
                             `Inherited selection** (*i*)`=Inherit.selected,
                             `Randomly selected but waived (*w*)`=Waivers.selected, 
                             `Total final selected (*T*=*r*+*i*-*w*)`=Total.final.selected,
                             `% Selected from inherits ((*i*/*T*)*100)`=Pct.selected.from.inherit, 
                             `% Reduction of selected trips due to waivers (*w*/(*T*+*w*)*100)`=Pct.allselected.from.waiver)
```

```{r selection.tbl, warning=FALSE, include=FALSE}
# Table 3-4 ----
# This table will show probabilities that selection rates = programmed rates
# under various assumptions
for.p.wide <- merge(
  logged %>% 
  #group_by(STRATA, PERIOD) %>%              # 2020-ONLY: Added period to group
  group_by(STRATA) %>%              
  summarize(random.n = Random.selected,
            inherit.n = Total.final.selected,
            inherit.butnowaiver.n = (Total.final.selected + Waivers.selected),
            Total.n = Total.trips,
            Source = "Valid trips only"
            ),
  # Now add in the total trips for the random number only
  odds.dat %>% 
  filter(STRATA %in% partial$STRATA & STRATA != "EM TRW EFP") %>%
  filter(!is.na(random.assign)) %>% 
  #group_by(STRATA, PERIOD) %>%              # 2020-ONLY: Added period to group
  group_by(STRATA) %>%             
  summarize(random.n = length(unique(TRIP_PLAN_LOG_SEQ[random.assign == 1])),
            Total.n = length(unique(TRIP_PLAN_LOG_SEQ)),
            Source = "ODDS random number"), 
  all = TRUE) %>% 
  arrange(Source, STRATA)

# Need to merge in the selection rates for calculating p-values later
# for.p.wide <- merge(
#   for.p.wide, 
#   merge(partial_og %>%                             # 2020-ONLY: Replacing 'partial' object with this ugly mess
#         filter(STRATA != "EM TRW EFP") %>%
#         distinct(STRATA) %>%   # This doesn't work for 2021
#         crossing(data.frame(PERIOD = 1:3)),
#       partial_og %>% filter(STRATA != "EM TRW EFP") %>% 
#         distinct(STRATA, ODDS_SELECTION_PCT = Rate * 100) %>%
#         group_by(STRATA) %>%
#         mutate(PERIOD = seq_len(n())) %>%
#         mutate(PERIOD = ifelse(PERIOD==2, PERIOD+1, PERIOD)), all=T
#       )  %>% 
#   group_by(STRATA) %>%
#   mutate(ODDS_SELECTION_PCT = ifelse(PERIOD == 2, ODDS_SELECTION_PCT[PERIOD==1], 
#                                      ifelse(STRATA %like% "EM", ODDS_SELECTION_PCT[PERIOD==1], 
#                                             ifelse(is.na(ODDS_SELECTION_PCT), ODDS_SELECTION_PCT[PERIOD==1], ODDS_SELECTION_PCT)))), 
#   by=c("STRATA", "PERIOD"), all = TRUE)

# Need to merge in the selection rates for calculating p-values later
for.p.wide <- merge(
  for.p.wide, 
  partial %>% 
  #partial_og %>%                             # 2020-ONLY: Replacing 'partial' object with this ugly mess
        filter(STRATA != "EM TRW EFP") %>%
        mutate(#PERIOD = ifelse(Effective_Date == as.Date("2022-01-01"), 1, 2),
               ODDS_SELECTION_PCT = Rate * 100) %>% 
        select(-c(Effective_Date, descriptions, formatted_strat, txt, Rate)),
  by = c("STRATA"), all = TRUE)
  #by = c("STRATA", "PERIOD"), all = TRUE)
  

# Put into long format
p.table <- gather(data = for.p.wide, key, value, -STRATA, -Total.n, -ODDS_SELECTION_PCT, -Source)
#p.table <- gather(data = for.p.wide, key, value, -STRATA, -PERIOD, -Total.n, -ODDS_SELECTION_PCT, -Source)   # 2020-ONLY: Adding period

# Omit records with missing values
p.table <- p.table[!is.na(p.table$value), ]

#p.table <- p.table %>%            # 2020-ONLY: Making programmed rates for Periods 3 match those of period 1.  This didn't happen in 2021
  # group_by(STRATA) %>%
  # mutate(ODDS_SELECTION_PCT = ifelse(!(STRATA %like% "EM") & key=="inherit.n", 
  #                                    ODDS_SELECTION_PCT[PERIOD==1 & key=="inherit.butnowaiver.n"], 
  #                                    ODDS_SELECTION_PCT)) %>%
  # ungroup()

for(i in 1:nrow(p.table)){
  p.table$pct[i] = round((p.table$value[i] / p.table$Total.n[i]) * 100, 2)
  # Check out this format - forces digits even if zero value!
  p.table$p[i] = format(round(stats::binom.test(p.table$value[i], p.table$Total.n[i], 
                        p = p.table$ODDS_SELECTION_PCT[i] / 100, 
                        alternative = "two.sided")$p.value, 3), nsmall = 3)}

# Format percentages with the same nuber of significant figures as 
p.table <- p.table %>% 
           mutate(ODDS_SELECTION_PCT = format(ODDS_SELECTION_PCT, nsmall=1), pct = format(pct, nsmall=1))

# Cleanup
#rm(for.p.wide)

# rename values for one column
p.table$key[p.table$key == "inherit.n"] <- "Expected"
p.table$key[p.table$key == "random.n"] <- "Random Selection Only"
p.table$key[p.table$key == "inherit.butnowaiver.n"] <- "Expected if no waivers"

# Create table
Selection.table <- p.table %>%
                   mutate(p = ifelse(p < 0.05, paste0(p, "*"), p)) %>%
                   arrange( STRATA, Source, desc(key)) %>%
                   arrange(match(STRATA, c("HAL", "EM HAL", "POT", "EM POT", "TRW"))) %>% 
                   mutate(new_trip_type = 
                          derivedFactor('Initial Random Selection, *a*'= Source=="ODDS random number",
                                        'After Cancellations, *b* (*a*-*b*)' = key=="Random Selection Only" & Source=="Valid trips only",
                                        'With Inherits, *c* (*a*-*b*+*c*)' = key=="Expected if no waivers",
                                        'After Waivers, *d* (*a*-*b*+*c*-*d*)' = key=="Expected",
                                        .ordered=TRUE, .method="unique")) %>% 
                   select("Strata" = STRATA, 
                          #"Period" = PERIOD,
                          "Trip disposition" = new_trip_type,   # UPDATE THESE NAMES
                          "n" = value,  # "Selected trips"
                          "N" = Total.n,   # "Total trips"
                          "Actu" = pct,   # "Actual selection (%)"
                          "Prog" = ODDS_SELECTION_PCT,  # "Programmed selection (%)"
                          "*p*" = p)    # "*p*-value (H0: Actual = Programmed)"
```

```{r odds.ts.daily.cuml.fig, warning=FALSE, eval=FALSE, echo = FALSE}
odds.ts.daily.cuml <- odds.dat %>% # These are all logged trips
     filter(!ODDS_SELECTION_PCT %in% c(0, 100)) %>%
     transform(Date = as.Date(ORIGINAL_EMBARK_DATE, format="%Y-%m-%d")) %>% 
     filter(STRATA %in% partial$STRATA) %>% 
     group_by(STRATA, Date) %>%
     summarize(n = sum(random.assign, na.rm=TRUE),
               ni = length(unique(TRIP_PLAN_LOG_SEQ[!is.na(INHERIT_OBS_TRIP_SEQ)])),
               N = length(unique(TRIP_PLAN_LOG_SEQ)),
               TYPE="Original date: All logged trips") %>% 
     arrange(Date) %>% 
     ungroup() %>% 
     bind_rows(
          odds.dat %>% # These are the 'valid trips' only
               filter(!ODDS_SELECTION_PCT %in% c(0, 100), !is.na(TRIP_SELECTED_OBS)) %>%
               transform(Date = as.Date(PLANNED_EMBARK_DATE, format="%Y-%m-%d")) %>% 
               filter(STRATA %in% partial$STRATA) %>% 
               group_by(STRATA, Date) %>%
               summarize(n = length(unique(TRIP_PLAN_LOG_SEQ[TRIP_SELECTED_OBS == "Y"])),
                         ni = length(unique(TRIP_PLAN_LOG_SEQ[!is.na(INHERIT_OBS_TRIP_SEQ)])),
                         N = length(unique(TRIP_PLAN_LOG_SEQ)),
                         TYPE = "Adjusted date: Valid trips only") %>% 
               arrange(Date) %>% 
               ungroup()) %>% 
     mutate(TYPE = as.factor(TYPE)) %>% 
     group_by(STRATA, TYPE) %>%
     mutate(running.n = order_by(Date, cumsum(n)),
            running.N = order_by(Date, cumsum(N)), 
            rug_ni = if_else(ni != 0, Date, as.Date(NA)),
            running.pct = round((running.n / running.N) * 100, 2)) %>% 
     arrange(STRATA, TYPE, Date) %>%
     right_join(
          partial %>%
          filter(Effective_Date == min(Effective_Date) & STRATA != "EM TRW EFP") %>% 
          distinct(STRATA, ODDS_SELECTION_PCT = Rate * 100), 
          by = "STRATA") %>% 
     ungroup()

# reorder strata for plot
odds.ts.daily.cuml <- transform(odds.ts.daily.cuml,
                                STRATA = factor(STRATA, levels=c("HAL", "EM HAL", "POT", "EM POT", "TRW")))

# Generate data for ribbon plots for the random data only.
odds.ts.daily.cuml$L95 <- ifelse(
                          odds.ts.daily.cuml$TYPE=="Adjusted date: Valid trips only", 
                          NA, 
                          round((qbinom(0.025, 
                                        odds.ts.daily.cuml$running.N, 
                                        odds.ts.daily.cuml$ODDS_SELECTION_PCT / 100)) / odds.ts.daily.cuml$running.N, 3))

odds.ts.daily.cuml$H95 <- ifelse(
                          odds.ts.daily.cuml$TYPE=="Adjusted date: Valid trips only", 
                          NA, 
                          round((qbinom(0.975,
                                        odds.ts.daily.cuml$running.N,
                                        odds.ts.daily.cuml$ODDS_SELECTION_PCT / 100)) /
                                        odds.ts.daily.cuml$running.N, 3))

for(i in 1:nrow(odds.ts.daily.cuml)){
  odds.ts.daily.cuml$test_stat_random[i] <- ifelse(
    odds.ts.daily.cuml$running.n[i] < 1, NA,
    round(binom.test(odds.ts.daily.cuml$running.n[i],
                     odds.ts.daily.cuml$running.N[i],
                     odds.ts.daily.cuml$ODDS_SELECTION_PCT[i] / 100,
                     alternative='two.sided')$p.value, 3))
}

rm(i)

# Text to annotage figure
for.plot.text <- left_join(
                 odds.ts.daily.cuml %>% 
                 group_by(STRATA, TYPE) %>% 
                 filter(Date == max(Date)) %>%
                 group_by(STRATA) %>% 
                 mutate(label.original = format(running.pct[TYPE=="Original date: All logged trips"], digits = 4, nsmall = 2),
                        label.adjusted = format(running.pct[TYPE=="Adjusted date: Valid trips only"], digits = 4, nsmall = 2)) %>% 
                 distinct(STRATA, label.original, label.adjusted)
                 ,
                 partial %>% 
                 filter(Effective_Date == min(Effective_Date) & STRATA != "EM TRW EFP") %>%
                 select(STRATA, label.programmed = Rate) %>% 
                 mutate(STRATA = as.character(STRATA), 
                        label.programmed = format(label.programmed * 100, digits = 4, nsmall = 2))
                 , by="STRATA")

odds.ts.daily.cuml <- merge(odds.ts.daily.cuml, for.plot.text)

#ODDS by date plot (Cumulative coverage percent by strata over the year)
odds.by.date.plot <- 
  ggplot(odds.ts.daily.cuml, aes(Date, running.pct, col=TYPE)) +
      # Add waiver period
     geom_rect(data=filter(odds.ts.daily.cuml, STRATA %in% c("HAL", "POT", "TRW")), aes(xmin=as.Date("2020-03-26"), xmax = as.Date("2020-07-01"), ymin=0, ymax=Inf), alpha = 0.005, col = "gray") +
     # Add lines for selection rates  
     geom_hline(aes(yintercept = ODDS_SELECTION_PCT), lty=3, size=1) +
     geom_ribbon(aes(ymin=L95 * 100, ymax=H95 * 100), alpha=0.1) +
     geom_line(size = 1.5) +
     scale_color_manual(name="Rate Type", values=c("black", "gray70")) +
     ylab('Cumulative Coverage Percent\n') +
     coord_cartesian(ylim=c(0, 70)) +
     xlab('\nDate') +
     geom_rug(data = odds.ts.daily.cuml %>% filter(TYPE=="Original date: All logged trips"),
                 aes(x = rug_ni), length = unit(0.1, "npc"), sides = "b") +
     geom_rug(data = odds.ts.daily.cuml %>% filter(TYPE!="Original date: All logged trips"),
                 aes(x = rug_ni), length = unit(0.1, "npc"), sides = "t") +
     facet_wrap(~ STRATA, ncol = 2) +
     geom_text(aes(x = as.Date(paste(year, "-8-01", sep = "")), y = 60, 
                   label = paste("Programmed (%) = ", label.programmed, sep = "")), size = 3, color = "black") + 
     geom_text(aes(x = as.Date(paste(year, "-8-01", sep = "")), y = 54, 
                   label = paste("Original (%) = ", label.original, sep = "")), size = 3, color = "gray70") + 
     geom_text(aes(x = as.Date(paste(year, "-8-01", sep = "")), y = 48, 
                   label = paste("Final (%) = ", label.adjusted, sep = "")), size = 3, color = "black") + 
     fig.theme + 
     theme_bw() +
     theme(axis.text.x = element_text(angle = 90),
           strip.text.x = element_text(size = 10),
           legend.position = "none")
```

```{r odds_paragraph, warning=FALSE, include=FALSE}
# Objects that help increase readability of in-text calcs in the following paragraphs

#Total cancelled trips (both by ODDS or by users)
totl.canc <- disposition %>% 
             filter(STRATA=="Total" & random.assign == "Selected") %>% 
             summarize(totl.canc = sum(as.numeric(Trips.cancelled.bysystem)) + sum(as.numeric(Trips.cancelled.byusers))) %>% 
             as.numeric()

#Percent of total trips cancelled by the ODDS system
perc.syst.canc <- disposition %>% 
                  filter(STRATA=="Total" & random.assign == "Selected") %>% 
                  summarize(perc.syst.canc = round((sum(as.numeric(Trips.cancelled.bysystem)) / sum(as.numeric(Trips.logged.ODDS))) * 100, 1)) %>% 
                  as.numeric()

#Percent of total trips cancelled by users
perc.user.canc <- disposition %>% 
                  filter(STRATA=="Total" & random.assign == "Selected") %>% 
                  summarize(perc.syst.canc = format((sum(as.numeric(Trips.cancelled.byusers)) / sum(as.numeric(Trips.logged.ODDS))) * 100, digits=1, nsmall=1)) %>% 
                  as.character()

# Lowest and highest cancellation rate/stratum for selected trips by strata
sel.min.canc <- disposition %>% 
                filter(STRATA!="Total" & random.assign == "Selected") %>%
                group_by(STRATA) %>% 
                summarize(Cancellation.Pct = (sum(as.numeric(Trips.cancelled.byusers)) / sum(as.numeric(Trips.remaining))) * 100) %>% 
                slice_min(as.numeric(Cancellation.Pct)) %>% 
                mutate(Cancellation.Pct = round(Cancellation.Pct, 1))

sel.max.canc <- disposition %>% 
                filter(STRATA!="Total" & random.assign == "Selected") %>%
                group_by(STRATA) %>% 
                summarize(Cancellation.Pct = (sum(as.numeric(Trips.cancelled.byusers)) / sum(as.numeric(Trips.remaining))) * 100) %>% 
                slice_max(as.numeric(Cancellation.Pct)) %>% 
                mutate(Cancellation.Pct = round(Cancellation.Pct, 1))
```


```{r odds_paragraph2, warning=FALSE, include=FALSE}
# Lowest and highest percentages of valid trips that were selected from the inherit process. 
inherit.min <- logged %>% 
               group_by(STRATA) %>% 
               summarize(Pct.selected.from.inherit = (sum(Inherit.selected) / sum(Total.final.selected)) * 100) %>% 
               ungroup() %>% 
               slice_min(as.numeric(Pct.selected.from.inherit)) %>% 
               mutate(Pct.selected.from.inherit = format(round(Pct.selected.from.inherit, 1), nsmall = 1)) %>% 
               select(STRATA, Pct.selected.from.inherit)

inherit.max <- logged %>% 
               group_by(STRATA) %>% 
               summarize(Pct.selected.from.inherit = (sum(Inherit.selected) / sum(Total.final.selected)) * 100) %>% 
               ungroup() %>% 
               slice_max(as.numeric(Pct.selected.from.inherit)) %>% 
               mutate(Pct.selected.from.inherit = format(round(Pct.selected.from.inherit, 1), nsmall = 1)) %>% 
               select(STRATA, Pct.selected.from.inherit)


# Waiver impact
waiver.min <- logged %>% 
              group_by(STRATA) %>% 
              summarize(Pct.allselected.from.waiver = (sum(Waivers.selected) / (sum(Total.final.selected) + sum(Waivers.selected))) * 100) %>% 
              ungroup() %>% 
              slice_min(as.numeric(Pct.allselected.from.waiver)) %>% 
              mutate(Pct.allselected.from.waiver = format(round(Pct.allselected.from.waiver, 1), nsmall = 1)) %>% 
              select(STRATA, Pct.allselected.from.waiver)

waiver.max <- logged %>% 
              group_by(STRATA) %>% 
              summarize(Pct.allselected.from.waiver = (sum(Waivers.selected) / (sum(Total.final.selected) + sum(Waivers.selected))) * 100) %>% 
              ungroup() %>% 
              slice_max(as.numeric(Pct.allselected.from.waiver)) %>% 
              mutate(Pct.allselected.from.waiver = format(round(Pct.allselected.from.waiver, 1), nsmall = 1)) %>% 
              select(STRATA, Pct.allselected.from.waiver)
```

```{r odds_paragraph3, warning=FALSE, include=FALSE}
#Text strings for reporting on the observered initial selection rates by strata
pct_txt <- p.table %>% 
           filter(Source=="ODDS random number") %>% 
           mutate(pct_txt = paste0(pct, "% for the *", STRATA, "* stratum")) %>% 
           distinct(pct_txt) 

#Extract p-values associated with random selection (H0: observed=expected
#rates). Merge to the partial look up table to ensure that things stay in order.
random_pvals <- merge(p.table
                      , 
                      partial %>% 
                      filter(STRATA != "EM TRW EFP") %>% 
                      distinct(STRATA, formatted_strat)) %>% 
                filter(Source=="ODDS random number") %>% 
                select(p, formatted_strat)
 
#Text strings for reporting on the observered FINAL selection rates by strata
final_pct_txt <- p.table %>% 
                 filter(key=="Expected") %>% 
                 mutate(pct_txt = paste0(pct, "% for the *", STRATA, "* stratum")) %>% 
                 distinct(pct_txt) 

#Extract p-values associated with FINAL selection (H0: final observed=expected
#rates).
final_pvals <- merge(p.table
                      , 
                      partial %>% 
                      filter(STRATA != "EM TRW EFP") %>% 
                      distinct(STRATA, formatted_strat)) %>% 
               filter(key=="Expected") %>% 
               select(p, formatted_strat)
```

The extent to which trip-selections are changed from the time they are entered can be determined by comparing the rate of trip observation expected from 1) random selection of all logged trips (initial random selection) and 2) random selection of remaining trips after cancellations, waivers, and inherited trips. In any case, the proportion of trips selected to be observed should fall within what would be expected given the binomial distribution (since each trip is either selected or not selected). The rates obtained (%, with associated p-value based on the binomial distribution) in the initial selection process were within expected ranges with the following exceptions – the initial selection rate was 33.91% (*p*-value = 0.011) for the *EM HAL* stratum, and 39.47% (*p*-value = 0.020) for the *TRW - Tender* stratum (`r tbl_nums('Selection.table', display = "cite")`). This means that the *EM HAL* and *TRW - Tender* strata were being over-selected in ODDS, and that we should interpret high final coverage rates in these strata with caution.  

The final selection rate after trips were closed, cancelled, or waived were within expected bounds with the exception of the *HAL* stratum 20.47% (*p*-value = 0.006), the *EM HAL* stratum, 34.80% (*p*-value = 0.002)  and the *TRW - Tender* stratum 46.55% (*p*-value = 0.002; `r tbl_nums('Selection.table', display = "cite")`). Given the high initial selection rates, we can safely disregard these final selection rates with the exception of the *HAL* stratum.    

In addition to the inherit process, the lack of linkage between the ODDS and eLandings contributes to the differences between programmed selection rates in ODDS and trips that are ultimately observed. Currently, ODDS provides users with a list of Report IDs from eLandings from which to close their logged trips. However, these data are not validated, or error checked, making them unreliable in their current state. This linkage between the logged (ODDS) trip (with its selection probability) and its associated landing information is necessary to evaluate potential improvements in deployment efficiency within the partial coverage fleet.            

## Evaluation of Deployment Rates  
This section compares the coverage rate achieved against the expected coverage rates. Data used in this evaluation are stored within the Catch Accounting System (CAS, managed by the AKRO), the Observer Program database (NORPAC, managed by the AFSC), and eLandings (under joint management by Alaska Department of Fish and Game - ADF&G; the International Pacific Halibut Commission - IPHC; and the NMFS). Separate rate evaluations are conducted depending on whether the unit of observer deployment was at-sea fishing trips or dockside deliveries of pollock.            

### At-sea Deployments  
```{r Coverage.tbl, message=FALSE, warning=FALSE, include=FALSE}
# Coverage table has number of total vessels (V), sampled vessels (v), total trips (N), sampled trips (n), and percent observed by deployment method (trip vs. vessel-selection):


#FULL COVERAGE
Coverage.Table.full <- plyr::rbind.fill(
  #Coverage rates for vessels in the full coverage category (both regulator full
  #cov or voluntary)
  work.data %>%
    dplyr::filter(COVERAGE_TYPE == "FULL") %>% 
    group_by(COVERAGE_TYPE, STRATA) %>%
    summarize(V=length(unique(VESSEL_ID)),
                     v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                     N=length(unique(TRIP_ID)),
                     n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(Pct.obs= format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection",
           Rate = 1,
           meets.expected = "") %>% 
    select(COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, meets.expected) %>% 
    arrange(desc(STRATA))
    ,
    # Totals for vessels in the full coverage category
    work.data %>%
      filter(COVERAGE_TYPE == "FULL") %>%
      summarize(V=length(unique(VESSEL_ID)),
                v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                N=length(unique(TRIP_ID)),
                n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
      mutate(COVERAGE_TYPE = "Full Coverage Total",
             Pct.obs=format((n/N)*100, digits=1, nsmall=1),
             deployment.method = "Trip-Selection")
)

#PARTIAL COVERAGE TRIP-SELECTION
Coverage.Table.partial <- plyr::rbind.fill(
  #By strata for vessels in the partial coverage category (trip-selection)
  work.data %>% 
    filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>%
    group_by(TRIP_ID) %>% 
    mutate(START = min(TRIP_TARGET_DATE)) %>% 
    ungroup() %>% 
    left_join(partial_time[, .(STRATA, Effective_Date, Expire_After, Rate)], on = "STRATA") %>% 
    #left_join(partial_time_hardcoded[, .(STRATA, Effective_Date, Expire_After, Rate)], on = "STRATA") %>% 
    filter(START >= Effective_Date & START <= Expire_After) %>% 
    group_by(COVERAGE_TYPE, STRATA, Effective_Date, Expire_After) %>%
    summarize(V=length(unique(VESSEL_ID[START >= Effective_Date & START <= Expire_After])),
              v=length(unique(VESSEL_ID[START >= Effective_Date & START <= Expire_After & OBSERVED_FLAG=="Y"])),
              N=length(unique(TRIP_ID[START >= Effective_Date & START <= Expire_After])),
              n=length(unique(TRIP_ID[START >= Effective_Date & START <= Expire_After & OBSERVED_FLAG=="Y"])),
              Rate = unique(Rate)) %>%
    mutate(Pct.obs = format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection") %>% 
    # Add binomial distribution upper and lower 95th percentiles to for each partial coverage stratum
    mutate(
      min.expected = round(
        stats::binom.test(x = n, n = N, p = Rate, 
                          alternative = "two.sided")$conf.int[1], 3)*100,
      max.expected = round(
        stats::binom.test(x = n, n = N, p = Rate,
                          alternative = "two.sided")$conf.int[2], 3)*100,
      meets.expected = ifelse(Rate*100 > min.expected & Rate*100 < max.expected,
                              "Yes", "No")) %>% 
    select(COVERAGE_TYPE, STRATA, Effective_Date, Expire_After, deployment.method, 
           V, v, N, n, Pct.obs, Rate, min.expected, max.expected, meets.expected) %>% 
    arrange(Effective_Date, match(STRATA, c("EM HAL", "EM POT", "EM TRW EFP", "HAL", "POT", "TRW")), Expire_After)
  ,
  # Totals for partial coverage category
  Coverage.Table.partial.total <- work.data %>%
    filter(COVERAGE_TYPE == "PARTIAL" & STRATA %in% partial$STRATA) %>% 
    summarize(V=length(unique(VESSEL_ID)),
              v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
              N=length(unique(TRIP_ID)),
              n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(COVERAGE_TYPE = "Gear-based Total",
           Pct.obs=format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection") 
) %>% 
# Nullify hypothesis test for any time periods with a programmed rate of 0  (Note: this does not apply in 2021)
  mutate(min.expected = ifelse(Effective_Date == as.Date("2020-03-26"), NA, min.expected),
         max.expected = ifelse(Effective_Date == as.Date("2020-03-26"), NA, max.expected),
         meets.expected = ifelse(Effective_Date == as.Date("2020-03-26"), NA, meets.expected))

#ZERO COVERAGE 
Coverage.Table.zero <- # plyr::rbind.fill(Coverage.Table.zero <-
    work.data %>%
    filter(STRATA %in% c("ZERO", "Zero EM Research")) %>% 
    mutate(STRATA=as.character(STRATA)) %>% 
    mutate(STRATA=ifelse(STRATA=="ZERO", "Zero Coverage", STRATA)) %>% 
    group_by(COVERAGE_TYPE, STRATA) %>%
    summarize(V=length(unique(VESSEL_ID)),
                     v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                     N=length(unique(TRIP_ID)),
                     n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))) %>%
    mutate(Pct.obs=format((n/N)*100, digits=1, nsmall=1),
           deployment.method = "Trip-Selection",
           Rate = 0,
           meets.expected = "") %>%  
    select(COVERAGE_TYPE, STRATA, deployment.method, 
           V, v, N, n, Pct.obs, Rate, meets.expected)

# Totals with EM (number of vessels is not additive)
Coverage.Table.TOTALS <- work.data %>%
  summarize(V=length(unique(VESSEL_ID)),
                   v=length(unique(VESSEL_ID[OBSERVED_FLAG=="Y"])),
                   N=length(unique(TRIP_ID)),
                   n=length(unique(TRIP_ID[OBSERVED_FLAG=="Y"]))
  ) %>%
  mutate(COVERAGE_TYPE = "Total",
         STRATA = "Total",
         Pct.obs.trips = format((n/N)*100, digits=1, nsmall=1),
         Pct.obs.vessels = format((v/V)*100, digits=1, nsmall=1),
         Pct.obs = paste0( Pct.obs.trips, "% Trips; ", Pct.obs.vessels, "% Vessels")) 

#Combine all the coverage tables
Coverage.Table <- plyr::rbind.fill(Coverage.Table.full, 
                                   Coverage.Table.partial,
                                   Coverage.Table.zero,
                                   Coverage.Table.TOTALS # ,
                                   # Coverage.Table.TOTALS.sansEM
                                   ) %>% 
  #Formatting (change things to characters so they knit to Word without weird
  #formatting issues)
  mutate(V = as.character(V),
         v = as.character(v),
         N = as.character(N),
         n = as.character(n),
         #*FLAG* binom.test method
         #Rate = ifelse(is.na(Rate), NA, format(Rate*100, digits=1, nsmall=1)),
         
         #*FLAG* qbinom method
         Rate = ifelse(is.na(Rate), NA, 
                       ifelse(deployment.method=="Trip-Selection", 
                              format(Rate*100, digits=1, nsmall=1),
                              format(Rate, digits=0, nsmall=0))),
         min.expected = ifelse(is.na(min.expected), NA, 
                               ifelse(deployment.method=="Trip-Selection", 
                                      format(min.expected, digits=1, nsmall=1),
                                      format(min.expected, digits=0, nsmall=0))),
         max.expected = ifelse(is.na(max.expected), NA, 
                               ifelse(deployment.method=="Trip-Selection", 
                                      format(max.expected, digits=1, nsmall=1),
                                      format(max.expected, digits=0, nsmall=0))),
          # 
         COVERAGE_TYPE = fct_recode(factor(COVERAGE_TYPE), 
                                    Full = "FULL",
                                    Partial = "PARTIAL"),
         STRATA = fct_recode(factor(STRATA),
                             Full = "FULL"),
         Effective_Date = ifelse(is.na(Effective_Date) & !is.na(Rate), format(as.Date("2020-01-01"), "%b-%d"), format(Effective_Date, "%b-%d")),
         Expire_After = ifelse(is.na(Expire_After) & !is.na(Rate), format(as.Date("2020-12-31"), "%b-%d"), format(Expire_After, "%b-%d"))) %>% 
  select(`Coverage` = COVERAGE_TYPE, Strata = STRATA, 
         `Start date` = Effective_Date, `End date` = Expire_After,
         `*V*` = V, `*v*` = v, `*N*` = N, `*n*` = n,
         `Expected` = Rate,
         `Realized` = Pct.obs,
         `Lower limit`= min.expected,
         `Upper limit` = max.expected, 
         `Realized meets expected?` = meets.expected)

#Create an empty factor level so that you can get rid of NAs in the table.
Coverage.Table$Coverage = factor(Coverage.Table$Coverage, levels=c(levels(Coverage.Table$Coverage), " "))
Coverage.Table$Strata = factor(Coverage.Table$Strata, levels=c(levels(Coverage.Table$Strata), " "))
Coverage.Table <- replace(Coverage.Table, is.na(Coverage.Table), " ")

rm(Coverage.Table.full, Coverage.Table.partial, Coverage.Table.TOTALS, Coverage.Table.zero)
```

```{r coverage_paragraph, message=FALSE, warning=FALSE, include=FALSE}
# Objects referenced in-text:

#Coverage trip and vessel totals (including EM)
totl_obs_trips <- Coverage.Table %>% filter(Strata == "Total" & Coverage == "Total") %>% select(`*n*`) %>% as.numeric()

perc_trips_obs <- Coverage.Table %>% 
  filter(Strata == "Total" & Coverage == "Total") %>% 
    transmute(percent.obs = format(as.numeric(`*n*`)/as.numeric(`*N*`) * 100, 
                                   digits=1, nsmall=1)) %>% 
  as.numeric()

totl_obs_vessels <- Coverage.Table %>% filter(Strata == "Total" & Coverage == "Total") %>% select(`*v*`) %>% as.numeric()

perc_vessels_obs <- Coverage.Table %>% 
  filter(Strata == "Total" & Coverage == "Total") %>%
  transmute(percent.obs = format(as.numeric(`*v*`)/as.numeric(`*V*`) * 100, 
                                 digits=1, nsmall=1)) %>% 
  as.numeric()

```

The `r year` Observer Program had `r total.strat` different deployment strata to be evaluated (`r tbl_nums('Coverage.Table', display = "cite")`). There was one *Full* coverage stratum comprised of trips taken both by vessels that were required to have full coverage (e.g., AFA vessels) and those fishing in the BSAI that opted into full coverage. There were seven partial coverage strata: five observed strata defined by gear and tender designation and two EM strata defined by gear designation. There were also two zero coverage strata: one zero coverage EM research stratum and one *Zero Coverage* stratum for jig vessels and vessels under 40 ft. length overall.      

```{r em_times, message=FALSE, warning=FALSE, include=FALSE}
em_times <- EM.review %>% 
            filter(EM_DATA_REVIEWED=="YES") %>% 
            distinct(EM_REVIEWED_TRIP_NUMBER, 
                     GEAR_TYPE_LOGGED, 
                     ACTUAL_EM_TRIP_END_DATE_TIME = as.Date(ACTUAL_EM_TRIP_END_DATE_TIME), 
                     DATE_HD_RECEIVED_BY_PSMFC = as.Date(DATE_HD_RECEIVED_BY_PSMFC), 
                     DATE_EXPORTED_TO_AFSC = as.Date(DATE_EXPORTED_TO_AFSC)) %>% 
            mutate(REVIEW_TIME_FROM_LANDING = as.numeric(DATE_EXPORTED_TO_AFSC - ACTUAL_EM_TRIP_END_DATE_TIME),
                   REVIEW_TIME_FROM_HD_RECEIVED = as.numeric(DATE_EXPORTED_TO_AFSC - DATE_HD_RECEIVED_BY_PSMFC)) %>% 
            mutate(GEAR_TYPE_LOGGED = ifelse(GEAR_TYPE_LOGGED=="LONGLINE", "EM HAL", GEAR_TYPE_LOGGED)) %>% 
            mutate(GEAR_TYPE_LOGGED = ifelse(GEAR_TYPE_LOGGED=="POT", "EM POT", GEAR_TYPE_LOGGED)) %>% 
            rename(Strata = GEAR_TYPE_LOGGED,
                   `End of trip and data exported to NMFS` = REVIEW_TIME_FROM_LANDING,
                   `Hard drive received and data exported to NMFS` = REVIEW_TIME_FROM_HD_RECEIVED) %>%
            melt(id.vars=c("Strata"), 
                 measure.vars = c("End of trip and data exported to NMFS", "Hard drive received and data exported to NMFS"), 
                 variable.name="metric")

em_times_smry <- em_times %>% 
  group_by(Strata, metric) %>% 
  summarise('25th percentile' = round(as.vector(quantile(value, 0.25))),
            median = round(as.vector(quantile(value, 0.50))), 
            '75th percentile' = round(as.vector(quantile(value, 0.75))),
            mean = round(mean(value))) %>%
  ungroup() %>%
  melt(id.vars=c("Strata", "metric"), measure.vars=c("25th percentile", "median", "75th percentile", "mean")) %>%
  mutate(label = formatC(value, width=max(nchar(value))))

em.times.figure <- ggplot(em_times, aes(x=value)) + 
  facet_grid(Strata ~ metric, scales="free_y") + 
  geom_histogram(bins=20, fill="gray70") + 
  geom_vline(data=em_times_smry, aes(xintercept=value), linetype=2) + 
  geom_text(data=em_times_smry, aes(x=value, y=Inf, label=paste0(variable, ": ", label, "  ")), angle=90, hjust=1, vjust=-.25) +
  labs(x="Days", y="Count") +
  theme_bw() 
```

Evaluations for the full coverage category and zero-selection pool are straightforward - either the coverage achieved was equal to 100% or 0%, respectively, or it was not. The program achieved 99.9% coverage in its full coverage category (`r tbl_nums('Coverage.Table', display = "cite")`). Five trips were not monitored in the full coverage category – four of these occurred on a single catcher vessel fishing CDQ halibut with hook and line gear that retained Pacific cod above the Maximum Retainable Amount and therefore met the criteria for full coverage fishing but failed to obtain a full coverage observer. The program achieved perfect compliance with the *Zero Coverage* stratum (`r tbl_nums('Coverage.Table', display = "cite")`). Under the assumption that the deployment was randomized, a 95% confidence interval computed from the realized coverage rates (under the assumption of a binomial distribution for observed trips) will contain the actual deployment rate 95% percent of the time.  If expected coverage levels were within the 95% confidence intervals, then we conclude that realized and expected coverage rates were equal. Coverage rates were consistent with expected values in six of the seven partial coverage strata, but were higher than expected within the *POT - Tender* stratum (`r tbl_nums('Coverage.Table', display = "cite")`). There are two reasons why this result is of little concern.  First, there is no clear evidence of trip manipulation in ODDS data from this stratum.  Secondly, the achieved rate was only slightly outside of the 95% range of expected outcomes (16.1% achieved vs. a lower bound of 16.8%).  Given the low number of total trips in this stratum (44), a change in a single observed trip, from 13 observed to 12 would have resulted in an expected result for this stratum since new confidence bounds would have included the expected rate.  

Unlike observed trips, the coverage rate for EM is based on information provided from the Pacific States Marine Fisheries Commission (PSMFC) that is available to analysts in the NORPAC database. In `r year`, the median time between receipt and completion of review was 24 days for *EM HAL* and 60 days for *EM POT* (`r fig_nums('em.times.figure', display = "cite")`). This is compared to a median of 7 days during pre-implementation in 2016 (NMFS 2017a, p. 87).  

In combination across all strata, coverage levels, and fishery monitoring tools, 4,497 trips (43.3%) and 510 vessels (47.0%) were successfully monitored at-sea among all fishing in Federal fisheries of Alaska in 2019 (`r tbl_nums('Coverage.Table', display = "cite")`).  


#####  

```{r disposition.table, echo=FALSE}
# Table 2 from 2019 Annual Report
####`r tbl_nums('disposition.table' , caption = paste0('Trip cancellation rates in the ODDS for ', year, '. A trip is cancelled by the system if the user did not identify whether fishing had occurred by the end of the year. “Paper” indicates that a trip was logged when the ODDS was not available.'))`  

disposition.table[c(4,6,7)] <- lapply(disposition.table[,c(4,6,7)], prettyNum, trim=TRUE, big.mark=",")
disposition.table$`Trips remaining (*c* = *a*-*b*)`[disposition.table$`Trips remaining (*c* = *a*-*b*)`==" NA"] <- " "
disposition.table$`Cancelled by user (*d*)`[disposition.table$`Cancelled by user (*d*)`=="NA"] <- " "
disposition.table$Strata <- cell_spec(disposition.table$Strata, italic = ifelse(disposition.table$Strata != "Total", TRUE, FALSE))    # Italicize strata

kable(disposition.table, escape=F)
```

#####  

```{r logged.table, echo=FALSE, tab.cap=""}
# Table 3 from 2019 Annual Report
####`r tbl_nums('logged.table', caption = paste0('Number of remaining trips after cancellation in each trip-selection stratum that were selected using the initial random number generator (Random Number Selection) and those that remained after user manipulation (Total Final Selected). The relative impact of waivers in trip-selection is also shown (% Reduction of Selected Trips due to Waivers). **Not from random numbers.'))`  

logged.table[c(3:7)] <- lapply(logged.table[,3:7], prettyNum, trim=TRUE, big.mark=",")
logged.table$Strata <- cell_spec(logged.table$Strata, italic=TRUE) # Italicize strata

kable(logged.table, escape=F)
```

#####  

`r tbl_nums('Selection.table', caption = paste0('Number of logged trips in each partial coverage stratum that were selected using the initial random number generator (Initial Random Selection) and those that remained after user manipulation (After Cancellations). The relative impact of inherits and waivers in trip-selection is also shown (With Inherits, After Waivers). Note that observer strata were split into three separate time periods to reflect when waivers were put in place and when ODDS selection rates were adjusted to account for changes to the sample frame from port-based trip deployment'))`  

```{r Selection.table, echo=FALSE, tab.cap="", tab.width=11}
Selection.table[c(4:5)] <- lapply(Selection.table[,4:5], prettyNum, trim=TRUE, big.mark=",")
# For the period when waivers were in place, remove p-values for 'After Waivers' # I DON'T THINK THIS APPLIED IN 2021
#Selection.table <- Selection.table %>%
#  mutate(`*p*` = ifelse(Period==2 & !(Strata %like% "EM") & `Trip disposition` %like% "After Waivers", "", `*p*`))   
Selection.table$Strata <- cell_spec(Selection.table$Strata, italic = TRUE)    # Italicize strata

kable(Selection.table %>% 
        #arrange(Period, Strata, `Trip disposition`) %>%
        arrange(Strata, `Trip disposition`), 
        #select(-Period), 
      col.names=c("Strata", "Trip disposition", "Selected<br>trips", "Total<br>trips", "Actual<br>(%)", "Programmed<br>(%)", "*p*-value"), 
      escape=F, align="llrrrrr") %>%
  kable_paper() %>%
  pack_rows(index = c("Fixed-gear EM strata : full year"=8, 
                      "Observer strata : Jan. 1 - Aug. 31"=12,
                      #"Observer strata : Mar. 25 - Jun. 30"=12,
                      "Observer strata : Sep. 1 - Dec. 31"=12), indent=F) 
```

#####  

`r tbl_nums('Coverage.Table', caption = paste0('Number of total vessels (V), sampled vessels (v), total trips (N), sampled trips (n) for each stratum in ', year, '. The coverage and 95% confidence interval columns are expressed as percentages of the total number of trips taken within each stratum.'))`  

```{r Coverage.Table, echo=FALSE, tab.cap=""}
Coverage.Table[c(5:8)] <- lapply(Coverage.Table[,5:8], prettyNum, trim=TRUE, big.mark=",")

# For 2020, shift totals over so that coverage column can be eliminated later
Coverage.Table <- Coverage.Table %>% 
  mutate(Strata = as.character(Strata)) %>% 
  mutate(Strata = ifelse(Coverage %in% c("Full Coverage Total", "Gear-based Total"), as.character(Coverage), Strata))

# Italicize strata
Coverage.Table$Strata <- cell_spec(Coverage.Table$Strata, italic = ifelse(Coverage.Table$Strata != "Total", TRUE, FALSE))

# Print table
kbl(Coverage.Table, escape = FALSE) %>% 
  kable_paper() %>% 
  # Remove columns
  remove_column(c(1,3,4)) %>% 
  # Group columns
  add_header_above(c(" " = 5, "Coverage" = 2, "95% Confidence interval" = 2, " " = 1)) %>% 
  # Group rows
  pack_rows("Full coverage", 1, 3, label_row_css = "text-align: center") %>% 
  pack_rows("Partial coverage EM", 4, 6, label_row_css = "text-align: center") %>% 
  pack_rows("Partial coverage observed", 7, 10, label_row_css = "text-align: center") %>% 
  pack_rows("Zero coverage", 11, 11, label_row_css = "text-align: center")
```



```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
save.image(file="4_AR_report.Rdata")
```
