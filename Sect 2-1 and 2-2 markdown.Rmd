---
output: word_document
title: "Annual Report Fee Summary Draft"
---
```{r setup, include=FALSE}

# --------------------------------------------------------------------------------------------------------------- #
# Program:Sect_2-1and2-2markdown.Rmd                                                                              #
# Project:Observer Program Annual Report                                                                          #
# Location: S:\Observer Program Annual Report\2020_Annual_Report\Chapt2_Fees&Budget\                              #
# Location: H:\Observer Program\Annual Report Local GIT Projects\Obs Fee Summary\                                 #
# Objective:                                                                                                      #
#   - Summarize fee liability by area, gear, vessel length, and species for 2020 Annual Report                    #
#   - This code was brainstormed in "2020 Fee Query - DRAFT based on warehouse.sql"                               #
#     1) it doesn't appear that any fee liabilities were waived by OMD                                            #
#                                                                                                                 #
#   Note: Do not include administrative fees or interest for late payments.                                       #
#                                                                                                                 # 
#   23,644 records for $2,469,241.17                                                                              #
#                                                                                                                 #
# Input:                                                                                                          #
#   - akfish_crf.fee_detail_gf                                                                                    #
#   - akfish_crf.fee_detail_ifq                                                                                   #
#   - akfish_report.catch_report_source                                                                           #
#   - akfish_report.catch_report_species_fact                                                                     #
#   - akfish_report.area and akfish.management_area                                                               #
#   - akfish_report.vessel and akfish.v_vessel                                                                    #
#   - akfish_report.gear                                                                                          # 
#   - akfish.ifq_landing_transaction                                                                              #
#   - akfish_crf.v_fee_transaction                                                                                # 
#                                                                                                                 #
# Output:                                                                                                         #
#   - Sect_2-1and2-2markdown.docx is automatically generated when this program is compiled.  It is still          # 
#     missing some formatting and needs to be hand edited.                                                        #
#                                                                                                                 #
# --------------------------------------------------------------------------------------------------------------- #

#setwd("C:\\Teleworking\\Obs Annual Report\\Ch 2")

library('ROracle')
#library('toOrdinal')
library(dplyr)
library(tidyr)
library(stringr)
library(flextable)
library(officer)
library(scales)
library(ggplot2)
library(viridis)
library(lubridate)
library(cowplot)

# ROracle connection inputs:
channel_cas <- dbConnect(drv = dbDriver('Oracle'), 
                         username =paste(Sys.getenv('CASid')), 
                         password =paste(Sys.getenv('CASpw')), 
                         dbname = Sys.getenv("myCASConnStr"))

```


```{r inputs, include = FALSE}
# Identify some inputs for the text:

# Publication date of the Federal Register notice for Standard Prices:
std_price_notice_date <- 'December 18, 2020'

# Federal Register reference for the Federal Register notice for Standard Prices:  
std_price_cfr <- '85 FR 82447'

# Note: URL needs to be updated in footnote 2 below

```

```{r mailing_date, include=FALSE}

#Identify when and how many Observer Fee invoices were sent:
invoice_date <- "SELECT TRUNC (a.transaction_date) as invoice_date, 
                      TRUNC (a.transaction_date) + 1 as mail_date,
                      TO_CHAR(a.transaction_date,'Month') AS invoice_month,
                      COUNT(*) as invoice_count            
                 FROM akfish_crf.v_fee_transaction a
                WHERE a.year = extract(year from sysdate) - 1   
                  AND a.management_program_id = 12 
                  AND a.item = 'ACT'
             GROUP BY TRUNC(a.transaction_date), TO_CHAR(a.transaction_date,'Month')"

# Query the invoice data from database directly:
mailing_date <- dbGetQuery(channel_cas, invoice_date) 

# Convert the invoice mailing date to usable format for markdown:
mailing_date$MAIL_DATE2 <- as.character(mailing_date$MAIL_DATE, format = "%B %d, %Y")
mailing_date$MAIL_DATE3 <- as.character(mailing_date$MAIL_DATE, format = "%B %Y")

# Summarize the late notices:
late_notice <- "SELECT  a.item, 
                        a.item_description,
                        TO_CHAR(a.transaction_date,'Month') AS notice_month,
                        COUNT(*) as notice_count            
                 FROM akfish_crf.v_fee_transaction a
                WHERE a.year = extract(year from sysdate) - 1   
                  AND a.management_program_id = 12 
                  AND a.item IN('30','60','90','120')
             GROUP BY a.item, a.item_description, TO_CHAR(a.transaction_date,'Month')"

# Query the late notices directly from the database:
notice_date <- dbGetQuery(channel_cas, late_notice) 

```

```{r fee_calculation, include=FALSE}

#Sets SQL code as object used to query the data: 
# (C:\Teleworking\Obs Annual Report\Ch 2\2021 Fee Query - DRAFT based on warehouse.sql)
load_fee_detail <- "SELECT gf.year, 'GF' AS report_source, 
       gf.category,
       gf.processor_permit_id as processor_permit,
       gf.vessel_id, gf.adfg_number, --gf.vessel_name, 
       v.length_overall, 
       
       -- summarize the vessels by vessel length category:
       CASE WHEN v.length_overall < 40                              THEN '<40'
            WHEN (v.length_overall >= 40 and v.length_overall < 58) THEN '40 - 57.5'  
                                                                    ELSE '>57.5'
       END AS LOA_GROUP,
     
       gf.report_id, NULL AS confirmation_number, NULL AS ifq_permit_number, 
       NULL as area, fmp.area_code as area_code,
       fmp.area_code AS fmp_area,
       gf.fish_ticket_number, gf.catch_activity_date, 
       gf.catch_report_source_pk, gf.catch_report_species_fact_pk,
       gf.agency_species_id, gf.species_group_id,
       gf.agency_species_name, gf.agency_species_code,
       
       -- Aggregate the species in some cases: 
       CASE WHEN gf.agency_species_code = '110' THEN 'Pacific Cod'
            WHEN gf.agency_species_code = '710' THEN 'Sablefish'
            WHEN gf.agency_species_code = '270' THEN 'Pollock'
            WHEN gf.agency_species_code = '200' THEN 'Halibut'
                                                ELSE 'All Other Species'
       END AS species_group,
       
       gf.gear_group_id, gf.gear_group_description, 
       -- Differentiate HAL/POT/JIG as separate gear types:
       --(SELECT MAX (agency_gear_code) FROM ellr_report z WHERE z.report_id = lp.report_id and z.current_version_flag = 'Y') as gear_code, 
       g.gear_code,       
       gf.weight_pounds, gf.price_per_pound, gf.fee_amount,  gf.fee_person_year_id
  FROM akfish_crf.fee_detail_gf gf -- The table that contains the detailed records which are subject to fees for GF transactions
  -- Join to the catch_report_species_fact tables in order to pull FMP area and gear information from the ELLR and ELPR:
  JOIN akfish_report.catch_report_species_fact crsf ON gf.catch_report_species_fact_pk = crsf.catch_report_species_fact_pk
  -- Join to the area table to pick up FMP area:
  JOIN akfish_report.area fmp ON crsf.fmp_area_pk = fmp.area_pk 
  -- Join to the vessel table in the warehouse from the ELLR/ELPR (catch_report_species_fact table) instead of from v_obsfee_gf_fee: 
  JOIN akfish_report.vessel v ON crsf.catcher_vessel_pk = v.vessel_pk  
  -- Join to the gear table in the warehouse from the ELLR/ELPR (catch_report_species_fact table):
  JOIN akfish_report.gear g ON crsf.gear_pk = g.gear_pk 
 WHERE gf.year = extract(year from sysdate) - 1             -- previous year
   and gf.management_program_id = 12                        -- observer fees (this excludes cost recovery records)
   and gf.fee_person_year_id IS NOT NULL                    -- to only pick up invoiced fees and not ones in final status  
   and gf.person_id <> 1653                                 -- OMD waived the $1.32 fees for HILLSTRAND, JOHN W (person ID 1653)
   and (gf.fee_person_year_id IS NULL or gf.fee_person_year_id != 7458346)  -- Correction: Beauty Bay Seafoods fees were incorrectly charged because of a bad port code (SEA) instead of FCP and corrected ($296.18)
                                                                            
    
              
UNION ALL 

-- IFQ landings, area information obtained from IFQ account data:
SELECT ifq.year, 'IFQ' AS report_source, 
       ifq.category,
       ifq.registered_buyer_number as processor_permit, 
       ifq.vessel_id, ifq.adfg_number, --ifq.vessel_name, 
       v.length_overall, 
       
       -- summarize the vessels by vessel length category:
       CASE WHEN v.length_overall < 40                              THEN '<40'
            WHEN (v.length_overall >= 40 and v.length_overall < 58) THEN '40 - 57.5' 
                                                                    ELSE '>57.5'
       END AS LOA_GROUP,
      
       ifq.report_id, ifq.confirmation_number, ifq.ifq_permit_number, 
       ifq.area, ma.code, 
       
       -- Aggregate area as BSAI or GOA:
       CASE WHEN ma.code in ('4A', '4B', '4C', '4D', '4E', 'AI', 'BS') THEN 'BSAI'        
            WHEN ma.code IN ('2C', '3A', '3B', 'CG', 'SE', 'WG', 'WY') THEN 'GOA'
                                                                       ELSE 'UHOH'
       END AS FMP_AREA,  
        
       ifq.fish_ticket_number, ifq.catch_activity_date, 
       NULL AS catch_report_source_pk, NULL AS catch_report_species_fact_pk, 
       ifq.agency_species_id, NULL AS species_group_id,
       ifq.agency_species_name, ifq.agency_species_code,
       
       -- Aggregate the species in some cases: 
       CASE WHEN ifq.agency_species_code = '110' THEN 'Pacific Cod'
            WHEN ifq.agency_species_code = '710' THEN 'Sablefish'
            WHEN ifq.agency_species_code = '270' THEN 'Pollock'
            WHEN ifq.agency_species_code = '200' THEN 'Halibut'
                                               ELSE 'All Other Species'
       END AS species_group,
       
       ifq.gear_group_id, ifq.gear_group_description, 
            -- Note: ObsFee IFQ data contains gear information as FIXED. Use landing report data (stored in catch_report_species_fact) to distinguish types of fixed gear. 
       --       Use MAX(g.gear_code) to identify the only gear on each landing report because catch_report_species_fact has a record for each species catch transaction. 
       --       In the event of a manual landing and the landing report is not available, translate the IFQ gear code from akfish.ifq_landing_transaction:
       NVL((SELECT MAX(g.gear_code) 
              FROM akfish_report.catch_report_source crs
              JOIN akfish_report.catch_report_species_fact crsf ON crs.catch_report_source_pk = crsf.catch_report_source_pk 
              JOIN akfish_report.gear g ON crsf.gear_pk = g.gear_pk 
             WHERE ifq.report_id = crs.el_report_id and crs.expire_date IS NULL), decode(ilt.ifq_gear_code, '61', 'HAL', '91', 'POT', '05', 'JIG', '26', 'JIG')) as GEAR_CODE,  --15 and 25?  JIG?                                           
       ifq.weight_pounds, ifq.price_per_pound, ifq.fee_amount,  ifq.fee_person_year_id
  FROM akfish_crf.fee_detail_ifq ifq
   -- join to management area to translate area IDs:
  JOIN akfish.management_area ma ON ifq.area = ma.id        
  -- join to the vessel file so we can summarize fees by vessel length:
  JOIN akfish.v_vessel v ON ifq.vessel_id = v.id             
  -- join to the PNOL/landing data to pick up gear when there isn't a corresponding landing report (ie out of state landings?):
  JOIN akfish.ifq_landing_transaction ilt ON ifq.confirmation_number = ilt.confirmation_number 
 WHERE ifq.year = extract(year from sysdate) - 1             -- previous year
   and ifq.management_program_id = 12                        -- observer fees
   and ifq.person_id <> 1653                                 -- OMD waived the $1.32 fees for HILLSTRAND, JOHN W
   and (ifq.fee_person_year_id IS NULL or ifq.fee_person_year_id != 7458346)  -- Correction: Beauty Bay Seafoods fees were incorrectly charged because of a bad port code (SEA) instead of FCP and corrected ($296.18)
        "

# Query the fees directly from the database:
fee_detail <- dbGetQuery(channel_cas, load_fee_detail) 

# Summarize fee totals for the year:
fee_total <- fee_detail %>% 
  group_by(YEAR) %>% 
  summarize(FEE_TOTAL = sum(FEE_AMOUNT), .groups = 'drop')  # .groups = 'drop'  gets rid of annoying warning

```



```{r toOrdinal_bit, eval=FALSE, include=FALSE}

# This was removed from the text below.  WIth time and pateience in 2023 for 2022 Annual Report, debug this and replace XXXth text below:

#`r toOrdinal((as.numeric(format(Sys.Date(), "%Y")))-2013,language="English",convert_to = "ordinal_number")`

```

# 2  FEES AND BUDGET
 

### 2.1	Budget for Partial Coverage Category in `r as.numeric(format(Sys.Date(), "%Y"))-1`

Section 313(d) of the Magnuson-Stevens Act authorizes the creation of the North Pacific Fishery Observer Fund ("Observer Fund") within the U.S. Treasury. This was the XXXth year that fees were collected from the partial coverage fleet.  The following section provides information on the amount of fees that accrued on landings made in `r as.numeric(format(Sys.Date(), "%Y"))-1` that are anticipated to be collected in `r as.numeric(format(Sys.Date(), "%Y"))`, as well as the amount of fees collected in `r as.numeric(format(Sys.Date(), "%Y"))-2` that were obligated to the partial coverage contract to pay for sea days in `r as.numeric(format(Sys.Date(), "%Y"))-1`.   

Fee billing statements for `r as.numeric(format(Sys.Date(), "%Y"))-1` were mailed to `r mailing_date$INVOICE_COUNT` processors and registered buyers in `r mailing_date$INVOICE_MONTH` `r as.numeric(format(Sys.Date(), "%Y"))`. <!-- All but `r notice_date[notice_date$ITEM=='30', "NOTICE_COUNT"]` bills were paid in full by February 15. -->  A total of `r paste0('$',formatC(fee_total$FEE_TOTAL, format="d", big.mark=','))` in observer fees were billed.  At the time of this publication, XXX processors had not yet paid observer fees totaling XX,XXX.  In order to collect delinquent fees, `r notice_date[notice_date$ITEM=='30', "NOTICE_COUNT"]` 30-day notices were mailed in `r notice_date[notice_date$ITEM=='30', "NOTICE_MONTH"]` <!--and `r notice_date[notice_date$ITEM=='60', "NOTICE_COUNT"]` 60-day notices were mailed in `r notice_date[notice_date$ITEM=='60', "NOTICE_MONTH"]` `r as.numeric(format(Sys.Date(), "%Y"))`.  90-Day notices will be mailed as needed.--> Additional notices will be mailed as needed.  Processors submitting late fee payments were charged a one time administrative fee of $25 plus interest on the observer fees with each notice. 





*There is additional text for Section 2-1 (provided by Jennifer F)*




### 2.2	Fees Collected from `r as.numeric(format(Sys.Date(), "%Y"))-1`, Summarized by Species, Gear, and Area

Observer coverage for the partial coverage category is funded through a system of fees based on the ex-vessel value of groundfish and Pacific halibut, with potential supplements from Federal appropriations. The observer fee is assessed on landings accruing against a Federal total allowable catch (TAC) for groundfish or a commercial halibut quota made by vessels that are subject to Federal regulations and not included in the full coverage category. Therefore, a fee is only assessed on landings of groundfish from vessels designated on a Federal Fisheries Permit or from vessels landing IFQ or CDQ halibut or IFQ sablefish. Within the subset of vessels subject to the observer fee, only landings accruing against the Federal TAC are included in the fee assessment.[^1]

The observer fee was 1.25% of the ex-vessel value of the groundfish and halibut subject to the fee through December 31, 2020.  Beginning January 1, 2021 a fee equal to 1.65% of the ex-vessel value is assessed on the landings of groundfish and halibut subject to the fee.[^2]  Ex-vessel value is determined by multiplying the standard price for groundfish by the round weight equivalent for each species, gear, and port combination, and the standard price for halibut by the headed and gutted weight equivalent. The standard ex-vessel prices used for `r as.numeric(format(Sys.Date(), "%Y"))-1` fee assessments were published in the *Federal Register* on `r std_price_notice_date` (`r std_price_cfr`).[^3]  Table 2-2, Table 2-3, and Table 2-4 summarize the observer fees that accrued for `r as.numeric(format(Sys.Date(), "%Y"))-1`.




[^1]:A table with additional information about which landings are and are not subject to the observer fee is in NMFS regulations at 679.55(c) ([CFR 679.55(c) Observer Fees](https://www.ecfr.gov/cgi-bin/text-idx?SID=e928699f8903a416bed34b9bcaae6903&mc=true&node=pt50.13.679&rgn=div5#se50.13.679_155)) and shown on page 2 of an informational bulletin available online at: [Observer Fee Collection](https://media.fisheries.noaa.gov/dam-migration/observerfees.pdf).

[^2]:Final Rule: Fee Adjustment to 1.65% (85 FR 41424, July 10, 2020).  Available online at: [85 FR 41424](https://www.federalregister.gov/documents/2020/07/10/2020-13775/fisheries-of-the-exclusive-economic-zone-off-alaska-adjust-the-north-pacific-observer-program-fee)

[^3]:Available online at: [`r std_price_cfr`](https://www.federalregister.gov/documents/2019/12/16/2019-27064/fisheries-of-the-exclusive-economic-zone-off-alaska-north-pacific-observer-program-standard). 



**INSERT SECTION PAGE BREAK HERE:**

Table 2-2. -- Observer fees [^3] in `r as.numeric(format(Sys.Date(), "%Y"))-1` by gear, vessel size category, and species or species group for _all areas combined_.

```{r table1_prep, echo=FALSE, message=FALSE, warning=FALSE}

# Table prep work: 

# Relabel some of the fee detail information:
fee_detail <- fee_detail %>% 
  # Consolidate Trawl gear codes (NPT and PTR), spell out HAL, and change capitalization for JIG and POT:
  mutate(TABLE_GEAR = as.factor(ifelse(GEAR_CODE %in% c('PTR', 'NPT'), 'Trawl',
                                       ifelse(GEAR_CODE == 'HAL', 'Hook and Line', str_to_title(GEAR_CODE))))) %>% 
  # Convert species_group to a factor:
  mutate(SPECIES_GROUP = as.factor(str_remove(SPECIES_GROUP, " "))) %>% 
  mutate(SPECIES_GROUP = as.factor(str_remove(SPECIES_GROUP, " "))) %>%  # repeat to remove second space in AllOther Species
  #Convert loa_group to a factor:
  mutate(LOA_GROUP = as.factor(LOA_GROUP)) 
  

# Summarize fee totals by gear, vessel length, and species for Table 2-2 (all areas) 
all_areas_summary <- fee_detail %>% 
  group_by(YEAR, TABLE_GEAR, LOA_GROUP, SPECIES_GROUP) %>% 
  summarize(FEE = sum(FEE_AMOUNT), .groups = 'drop') %>% 
  # Convert from long format to wide format:
  pivot_wider(names_from = SPECIES_GROUP, values_from = FEE) %>% 
  # Set NAs to 0:
  replace_na(list(AllOtherSpecies = 0, Halibut = 0, PacificCod = 0, Pollock = 0, Sablefish = 0))


# Calculate the 'Vessel length' subtotals:
vessel_subtotal <- fee_detail %>% 
  group_by(YEAR, TABLE_GEAR, SPECIES_GROUP) %>% 
  summarize(LOA_GROUP = 'Gear Subtotal',
            FEE = sum(FEE_AMOUNT), .groups = 'drop') %>% 
  # Convert from long format to wide format:
  pivot_wider(id_cols = c(YEAR, TABLE_GEAR, LOA_GROUP), names_from = SPECIES_GROUP, values_from = FEE) %>% 
  # Set NAs to 0:
  replace_na(list(AllOtherSpecies = 0, Halibut = 0, PacificCod = 0, Pollock = 0, Sablefish = 0))


# Calculate 'All Gear' subtotals:
gear_subtotal <- fee_detail %>% 
  group_by(YEAR, SPECIES_GROUP) %>% 
  summarize(TABLE_GEAR = "Total All Gear",
            LOA_GROUP = as.factor(' '),
            FEE = sum(FEE_AMOUNT), groups. = 'drop') %>% 
  pivot_wider(id_cols = c(YEAR, TABLE_GEAR, LOA_GROUP), names_from = SPECIES_GROUP, values_from = FEE) %>% 
  data.frame()


# Bind the vessel length subtotals, all gear subtotals and vessel length data:
all_areas <- all_areas_summary %>% 
  bind_rows(vessel_subtotal, gear_subtotal) %>% 
  # Calculate 'All Species' subtotals:
  mutate(TOTAL = Halibut + PacificCod + Pollock + Sablefish + AllOtherSpecies) %>% 
  # Reorder the columns:
  select(TABLE_GEAR, LOA_GROUP, Halibut, Sablefish,  PacificCod, Pollock, AllOtherSpecies, TOTAL) %>% 
  # Set order for gear and vessel length categories in table:
  mutate(TABLE_GEAR = as.factor(TABLE_GEAR)) %>% 
  mutate(LOA_GROUP = as.factor(LOA_GROUP)) %>% 
  arrange(factor(TABLE_GEAR, levels = c('Hook and Line', 'Jig', 'Pot', 'Trawl', 'Total All Gear')), 
                 factor(LOA_GROUP, levels = c('<40', '40 - 57.5', '>57.5', 'Gear Subtotal', ' ')))
  
# Calculate percentage of total fees by each species:
pct <- all_areas %>% 
  filter(TABLE_GEAR == 'Total All Gear') %>% 
  mutate(AOS_PCT = round((AllOtherSpecies/TOTAL)*100,0),
         H_PCT   = round((Halibut/TOTAL)*100,0),
         PC_PCT  = round((PacificCod/TOTAL)*100,0),
         P_PCT   = round((Pollock/TOTAL)*100,0),
         S_PCT   = round((Sablefish/TOTAL)*100,0),
         T_PCT   = round((TOTAL/TOTAL)*100,0)) %>% 
  select(H_PCT, S_PCT, PC_PCT, P_PCT, AOS_PCT, T_PCT) %>% 
  # Rename columns so they can append to the columns in the table:
  rename(Halibut = H_PCT,
         Sablefish = S_PCT,
         PacificCod = PC_PCT,
         Pollock = P_PCT,
         AllOtherSpecies = AOS_PCT,
         TOTAL = T_PCT)

# Create labels for footer of table based on percentages: 
pct_labels <- data.frame(
  col_keys = c("TABLE_GEAR", "LOA_GROUP", "Halibut", "Sablefish", "PacificCod", "Pollock", "AllOtherSpecies", "TOTAL"),
  unit = c("Percent by Species", "", paste0(pct$Halibut,'%', sep=""), paste0(pct$Sablefish,'%', sep=""), paste0(pct$PacificCod,'%', sep=""),
           paste0(pct$Pollock,'%', sep=""), paste0(pct$AllOtherSpecies,'%', sep=""), paste0(pct$TOTAL,'%', sep="")),
  stringsAsFactors = FALSE )

```



```{r table1, echo=FALSE}

# Create a table for the Fee Summaries in All Areas:
flextable(all_areas) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(TABLE_GEAR = "Gear",
                    LOA_GROUP = "Vessel Length Category",
                    PacificCod = "Pacific Cod",
                    AllOtherSpecies = "All Other Species",
                    TOTAL = "Total All Species")  %>% 
  # Format the currency columns:
  colformat_double(j = c(3,4,5,6,7, 8), big.mark = ",", prefix = "$", digits = 0) %>% 
  # Bold the headers, gear labels, and all gear totals:
  bold(part = "header") %>% 
  bold(j = 1) %>% 
  bold(i = 15) %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'Total All Gear' label across 2 cells (gear and vessel length category):
  merge_at(i=15, j=c(1:2)) %>% 
  # Add dashed horizontal lines before gear subtotals:
  border(i = c(3,6,10,13), part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  # Add solid horizontal lines after gear subtotals and add "fix" needed because of cell merges:
  border(i = c(4,7,11,14), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  fix_border_issues(part = "body") %>% 
  # Add percentages as a footer hack:
  set_footer_df(mapping = pct_labels, key = "col_keys") %>% 
  align(j = c(3,4,5,6,7,8), align = "right", part = "footer") %>% 
  bold(part = "footer") %>% 
  # Merge 'Percent by Species' label across 2 cells (gear and vessel length category):
  merge_at(j=c(1:2), part = "footer") %>% 
  # Add footer:
  footnote(i = 1, j = 1, part = "header",
           value = as_paragraph("Rounding error sometimes results in slight differences in row and column totals.")) #+
  #fix_border_issues(part = "footer")
  #hline_bottom(part = "footer", border= fp_border(color="black", width = 1))
  #border_outer(border = fp_border(color="black", width = 1), part = "footer")



```


[^3]:The unpaid portion of the observer fees are included. Administrative fees and interest charged for late fee payments are not included.


**INSERT PAGE BREAK HERE:**


Table 2-3. -- Observer fees[^4] in `r as.numeric(format(Sys.Date(), "%Y"))-1` by gear, vessel size category, and species or species group in the _Gulf of Alaska_.[^5]

```{r table2_prep, echo=FALSE, message=FALSE, warning=FALSE}

# GOA Table prep work: 

# Summarize fee totals by gear, vessel length, and species for Table 2-3 (GOA) 
goa_summary <- fee_detail %>% 
  filter(FMP_AREA == 'GOA') %>% 
  group_by(YEAR, TABLE_GEAR, LOA_GROUP, SPECIES_GROUP) %>% 
  summarize(FEE = sum(FEE_AMOUNT), .groups = 'drop') %>% 
  # Convert from long format to wide format:
  pivot_wider(names_from = SPECIES_GROUP, values_from = FEE) %>% 
  # Set NAs to 0:
  replace_na(list(AllOtherSpecies = 0, Halibut = 0, PacificCod = 0, Pollock = 0, Sablefish = 0))


# Calculate the 'Vessel length' subtotals:
goa_vessel_subtotal <- fee_detail %>% 
  filter(FMP_AREA == 'GOA') %>% 
  group_by(YEAR, TABLE_GEAR, SPECIES_GROUP) %>% 
  summarize(LOA_GROUP = 'Gear Subtotal',
            FEE = sum(FEE_AMOUNT), .groups = 'drop') %>% 
  # Convert from long format to wide format:
  pivot_wider(id_cols = c(YEAR, TABLE_GEAR, LOA_GROUP), names_from = SPECIES_GROUP, values_from = FEE) %>% 
  # Set NAs to 0:
  replace_na(list(AllOtherSpecies = 0, Halibut = 0, PacificCod = 0, Pollock = 0, Sablefish = 0))


# Calculate 'All Gear' subtotals:
goa_gear_subtotal <- fee_detail %>% 
  filter(FMP_AREA == 'GOA') %>% 
  group_by(YEAR, SPECIES_GROUP) %>% 
  summarize(TABLE_GEAR = "Total All Gear",
            LOA_GROUP = as.factor(' '),
            FEE = sum(FEE_AMOUNT), groups. = 'drop') %>% 
  pivot_wider(id_cols = c(YEAR, TABLE_GEAR, LOA_GROUP), names_from = SPECIES_GROUP, values_from = FEE) %>% 
  data.frame()


# Bind the vessel length subtotals, all gear subtotals and vessel length data:
goa <- goa_summary %>% 
  bind_rows(goa_vessel_subtotal, goa_gear_subtotal) %>% 
  # Calculate 'All Species' subtotals:
  mutate(TOTAL = Halibut + PacificCod + Pollock + Sablefish + AllOtherSpecies) %>% 
  # Reorder the columns:
  select(TABLE_GEAR, LOA_GROUP, Halibut, Sablefish,  PacificCod, Pollock, AllOtherSpecies, TOTAL) %>% 
  # Set order for gear and vessel length categories in table:
  mutate(TABLE_GEAR = as.factor(TABLE_GEAR)) %>% 
  mutate(LOA_GROUP = as.factor(LOA_GROUP)) %>% 
  arrange(factor(TABLE_GEAR, levels = c('Hook and Line', 'Jig', 'Pot', 'Trawl', 'Total All Gear')), 
                 factor(LOA_GROUP, levels = c('<40', '40 - 57.5', '>57.5', 'Gear Subtotal', ' ')))
  
# Calculate percentage of total fees by each species:
goa_pct <- goa %>% 
  filter(TABLE_GEAR == 'Total All Gear') %>% 
  mutate(AOS_PCT = round((AllOtherSpecies/TOTAL)*100,0),
         H_PCT   = round((Halibut/TOTAL)*100,0),
         PC_PCT  = round((PacificCod/TOTAL)*100,0),
         P_PCT   = round((Pollock/TOTAL)*100,0),
         S_PCT   = round((Sablefish/TOTAL)*100,0),
         T_PCT   = round((TOTAL/TOTAL)*100,0)) %>% 
  select(H_PCT, S_PCT, PC_PCT, P_PCT, AOS_PCT, T_PCT) %>% 
  # Rename columns so they can append to the columns in the table:
  rename(Halibut = H_PCT,
         Sablefish = S_PCT,
         PacificCod = PC_PCT,
         Pollock = P_PCT,
         AllOtherSpecies = AOS_PCT,
         TOTAL = T_PCT)

# Create labels for footer of table based on percentages: 
goa_pct_labels <- data.frame(
  col_keys = c("TABLE_GEAR", "LOA_GROUP", "Halibut", "Sablefish", "PacificCod", "Pollock", "AllOtherSpecies", "TOTAL"),
  unit = c("Percent by Species", "", 
           paste0(goa_pct$Halibut,'%', sep=""), 
           paste0(goa_pct$Sablefish,'%', sep=""), 
           paste0(goa_pct$PacificCod,'%', sep=""),
           paste0(goa_pct$Pollock,'%', sep=""), 
           paste0(goa_pct$AllOtherSpecies,'%', sep=""), 
           paste0(goa_pct$TOTAL,'%', sep="")),
  stringsAsFactors = FALSE )

```


```{r table2, echo=FALSE}

# Create a table for the Fee Summaries in GOA:
flextable(goa) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(TABLE_GEAR = "Gear",
                    LOA_GROUP = "Vessel Length Category",
                    PacificCod = "Pacific Cod",
                    AllOtherSpecies = "All Other Species",
                    TOTAL = "Total All Species")  %>% 
  # Format the currency columns:
  colformat_double(j = c(3,4,5,6,7, 8), big.mark = ",", prefix = "$", digits = 0) %>% 
  # Bold the headers, gear labels, and all gear totals:
  bold(part = "header") %>% 
  bold(j = 1) %>% 
  bold(i = 15) %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'Total All Gear' label across 2 cells (gear and vessel length category):
  merge_at(i=15, j=c(1:2)) %>% 
  # Add dashed horizontal lines before gear subtotals:
  border(i = c(3,6,10,13), part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  # Add solid horizontal lines after gear subtotals and add "fix" needed because of cell merges:
  border(i = c(4,7,11,14), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  fix_border_issues(part = "body") %>% 
  # Add percentages as a footer hack:
  set_footer_df(mapping = goa_pct_labels, key = "col_keys") %>% 
  align(j = c(3,4,5,6,7,8), align = "right", part = "footer") %>% 
  bold(part = "footer") %>% 
  # Merge 'Percent by Species' label across 2 cells (gear and vessel length category):
  merge_at(j=c(1:2), part = "footer") %>% 
  # Add footer:
  footnote(i = 1, j = 1, part = "header",
           value = as_paragraph("Rounding error sometimes results in slight differences in row and column totals.")) #+
  #fix_border_issues(part = "footer")
  #hline_bottom(part = "footer", border= fp_border(color="black", width = 1))
  #border_outer(border = fp_border(color="black", width = 1), part = "footer")



```

[^4]:The unpaid portion of the observer fees are included. Administrative fees and interest charged for late fee payment are not included.

[^5]:The Gulf of Alaska includes Pacific halibut regulatory areas 2C, 3A, and 3B; and sablefish regulatory areas Western GOA, Central GOA, West Yakutat, and Southeast Outside.

**INSERT PAGE BREAK HERE:**

Table 2-4. -- Observer fees[^6] in `r as.numeric(format(Sys.Date(), "%Y"))-1` by gear, vessel size category, and species or species group in the _Bering Sea/Aleutian Islands_.[^7]


```{r table3_prep, echo=FALSE, message=FALSE, warning=FALSE}

# BSAI Table prep work: 

# Summarize fee totals by gear, vessel length, and species for Table 2-4 (BSAI) 
bsai_summary <- fee_detail %>% 
  filter(FMP_AREA == 'BSAI') %>% 
  group_by(YEAR, TABLE_GEAR, LOA_GROUP, SPECIES_GROUP) %>% 
  summarize(FEE = sum(FEE_AMOUNT), .groups = 'drop') %>% 
  # Convert from long format to wide format:
  pivot_wider(names_from = SPECIES_GROUP, values_from = FEE) %>% 
  # Set NAs to 0:
  replace_na(list(AllOtherSpecies = 0, Halibut = 0, PacificCod = 0, Pollock = 0, Sablefish = 0))


# Calculate the 'Vessel length' subtotals:
bsai_vessel_subtotal <- fee_detail %>% 
  filter(FMP_AREA == 'BSAI') %>% 
  group_by(YEAR, TABLE_GEAR, SPECIES_GROUP) %>% 
  summarize(LOA_GROUP = 'Gear Subtotal',
            FEE = sum(FEE_AMOUNT), .groups = 'drop') %>% 
  # Convert from long format to wide format:
  pivot_wider(id_cols = c(YEAR, TABLE_GEAR, LOA_GROUP), names_from = SPECIES_GROUP, values_from = FEE) %>% 
  # Set NAs to 0:
  replace_na(list(AllOtherSpecies = 0, Halibut = 0, PacificCod = 0, Pollock = 0, Sablefish = 0))


# Calculate 'All Gear' subtotals:
bsai_gear_subtotal <- fee_detail %>% 
  filter(FMP_AREA == 'BSAI') %>% 
  group_by(YEAR, SPECIES_GROUP) %>% 
  summarize(TABLE_GEAR = "Total All Gear",
            LOA_GROUP = as.factor(' '),
            FEE = sum(FEE_AMOUNT), groups. = 'drop') %>% 
  pivot_wider(id_cols = c(YEAR, TABLE_GEAR, LOA_GROUP), names_from = SPECIES_GROUP, values_from = FEE) %>% 
  data.frame()


# Bind the vessel length subtotals, all gear subtotals and vessel length data:
bsai <- bsai_summary %>% 
  bind_rows(bsai_vessel_subtotal, bsai_gear_subtotal) %>% 
  # Calculate 'All Species' subtotals:
  mutate(TOTAL = Halibut + PacificCod + Pollock + Sablefish + AllOtherSpecies) %>% 
  # Reorder the columns:
  select(TABLE_GEAR, LOA_GROUP, Halibut, Sablefish,  PacificCod, Pollock, AllOtherSpecies, TOTAL) %>% 
  # Set order for gear and vessel length categories in table:
  mutate(TABLE_GEAR = as.factor(TABLE_GEAR)) %>% 
  mutate(LOA_GROUP = as.factor(LOA_GROUP)) %>% 
  arrange(factor(TABLE_GEAR, levels = c('Hook and Line', 'Jig', 'Pot', 'Trawl', 'Total All Gear')), 
                 factor(LOA_GROUP, levels = c('<40', '40 - 57.5', '>57.5', 'Gear Subtotal', ' ')))
  
# Calculate percentage of total fees by each species:
bsai_pct <- bsai %>% 
  filter(TABLE_GEAR == 'Total All Gear') %>% 
  mutate(AOS_PCT = round((AllOtherSpecies/TOTAL)*100,0),
         H_PCT   = round((Halibut/TOTAL)*100,0),
         PC_PCT  = round((PacificCod/TOTAL)*100,0),
         P_PCT   = round((Pollock/TOTAL)*100,0),
         S_PCT   = round((Sablefish/TOTAL)*100,0),
         T_PCT   = round((TOTAL/TOTAL)*100,0)) %>% 
  select(H_PCT, S_PCT, PC_PCT, P_PCT, AOS_PCT, T_PCT) %>% 
  # Rename columns so they can append to the columns in the table:
  rename(Halibut = H_PCT,
         Sablefish = S_PCT,
         PacificCod = PC_PCT,
         Pollock = P_PCT,
         AllOtherSpecies = AOS_PCT,
         TOTAL = T_PCT)

# Create labels for footer of table based on percentages: 
bsai_pct_labels <- data.frame(
  col_keys = c("TABLE_GEAR", "LOA_GROUP", "Halibut", "Sablefish", "PacificCod", "Pollock", "AllOtherSpecies", "TOTAL"),
  unit = c("Percent by Species", "", 
           paste0(bsai_pct$Halibut,'%', sep=""), 
           paste0(bsai_pct$Sablefish,'%', sep=""), 
           paste0(bsai_pct$PacificCod,'%', sep=""),
           paste0(bsai_pct$Pollock,'%', sep=""), 
           paste0(bsai_pct$AllOtherSpecies,'%', sep=""), 
           paste0(bsai_pct$TOTAL,'%', sep="")),
  stringsAsFactors = FALSE )

```


```{r table3, echo=FALSE}

# Create a table for the Fee Summaries in BSAI:
flextable(bsai) %>% 
  # Adjust column header labels where necessary:
  set_header_labels(TABLE_GEAR = "Gear",
                    LOA_GROUP = "Vessel Length Category",
                    PacificCod = "Pacific Cod",
                    AllOtherSpecies = "All Other Species",
                    TOTAL = "Total All Species")  %>% 
  # Format the currency columns:
  colformat_double(j = c(3,4,5,6,7,8), big.mark = ",", prefix = "$", digits = 0) %>% 
  # Bold the headers, gear labels, and all gear totals:
  bold(part = "header") %>% 
  bold(j = 1) %>% 
  bold(i = 11) %>% 
  # Merge the gear labels into a single cell: 
  merge_v(j = 1, part = "body") %>% 
  # Merge 'Total All Gear' label across 2 cells (gear and vessel length category):
  merge_at(i=11, j=c(1:2)) %>% 
  # Add dashed horizontal lines before gear subtotals:
  #border(i = c(3,5,9,11), part = "body", border.bottom = fp_border(style = "dashed")) %>% 
  border(i = c(3,7,9), part = "body", border.bottom = fp_border(style = "dashed")) %>%     # no jig on 2021
  # Add solid horizontal lines after gear subtotals and add "fix" needed because of cell merges:
  #border(i = c(4,6,10,12), part = "body", border.bottom = fp_border(style = "solid")) %>% 
  border(i = c(4,8,10,11), part = "body", border.bottom = fp_border(style = "solid")) %>%   # no jig on 2021
  fix_border_issues(part = "body") %>% 
  # Add percentages as a footer hack:
  set_footer_df(mapping = bsai_pct_labels, key = "col_keys") %>% 
  align(j = c(3,4,5,6,7,8), align = "right", part = "footer") %>% 
  bold(part = "footer") %>% 
  # Merge 'Percent by Species' label across 2 cells (gear and vessel length category):
  merge_at(j=c(1:2), part = "footer") %>% 
  # Add footer:
  footnote(i = 1, j = 1, part = "header",
           value = as_paragraph("Rounding error sometimes results in slight differences in row and column totals.")) #+
  #fix_border_issues(part = "footer")
  #hline_bottom(part = "footer", border= fp_border(color="black", width = 1))
  #border_outer(border = fp_border(color="black", width = 1), part = "footer")



```
[^6]:The unpaid portion of the observer fees are included. Administrative fees and interest charged for late fee payment are not included.

[^7]:The Bering Sea/Aleutian Islands includes Pacific halibut regulatory areas 4A, 4B, 4C, and 4D; and sablefish regulatory areas Bering Sea and Aleutian Islands.


```{r figure1_dataprep, eval=FALSE, include=FALSE}

# For current year's data:

# Summarize single year fee data by landing ID (report ID or confirmation number), catch_activity_date, and species_group
current_spcs_landing_summary <- fee_detail %>% 
  # Creating a landing ID: either the REPORT_ID or the CONFIRMATION_NUMBER
  mutate(LANDING_ID = ifelse(!is.na(REPORT_ID), REPORT_ID, CONFIRMATION_NUMBER)) %>% 
  mutate(DOY = yday(CATCH_ACTIVITY_DATE)) %>% 
  group_by(YEAR, CATCH_ACTIVITY_DATE, DOY, LANDING_ID, SPECIES_GROUP) %>% 
  summarize(RECORD_COUNT = n(), 
            FEE = sum(FEE_AMOUNT), .groups = 'drop')

# Summarize single year fee data by landing ID (report ID or confirmation number), and catch_activity_date
current_total_landing_summary <- fee_detail %>% 
  # Creating a landing ID: either the REPORT_ID or the CONFIRMATION_NUMBER
  mutate(LANDING_ID = ifelse(!is.na(REPORT_ID), REPORT_ID, CONFIRMATION_NUMBER)) %>% 
  mutate(DOY = yday(CATCH_ACTIVITY_DATE)) %>% 
  group_by(CATCH_ACTIVITY_DATE, LANDING_ID) %>% 
  summarize(SPECIES_GROUP = 'AllSpecies',
            RECORD_COUNT = n(), 
            FEE = sum(FEE_AMOUNT), .groups = 'drop') 

# Consolidate into a single dataset:
current_landing_summary <- current_spcs_landing_summary %>% 
  bind_rows(current_total_landing_summary) %>% 
  mutate(SPECIES_GROUP = factor(SPECIES_GROUP, levels = c('AllSpecies', 'Halibut', 'Sablefish', 'PacificCod', 'Pollock', 'AllOtherSpecies')))


# For all years' data (previous and current)

# Summarize fee data by landing ID (report ID or confirmation number), catch_activity_date, species_group
allyrs_spcs_landing_summary <- previous_fee_detail %>% 
  # Creating a landing ID: either the REPORT_ID or the CONFIRMATION_NUMBER
  mutate(LANDING_ID = ifelse(!is.na(REPORT_ID), REPORT_ID, CONFIRMATION_NUMBER)) %>% 
  group_by(YEAR, CATCH_ACTIVITY_DATE, LANDING_ID, SPECIES_GROUP) %>% 
  summarize(RECORD_COUNT = n(), 
            FEE = sum(FEE_AMOUNT), .groups = 'drop') %>%
  bind_rows(current_spcs_landing_summary) %>% 
  # Create a Day/Month field:
  mutate(DOY = yday(CATCH_ACTIVITY_DATE))

# Summarize inflation adjusted fee data by year, doy, species_group
doy_fee_summary <- allyrs_spcs_landing_summary %>% 
  # Fine tune the species a bit:
  filter(!SPECIES_GROUP == 'AllOtherSpecies') %>% 
  mutate(SPECIES = factor(ifelse(SPECIES_GROUP == 'PacificCod', 'Pacific Cod', SPECIES_GROUP),
                             levels = c("Pollock", "Pacific Cod", "Sablefish", "Halibut"))) %>% 
  # Calculate inflation adjusted fees:
  full_join(cpi) %>% 
  mutate(ADJ_FEE = round((FEE/CPI_FACTOR),2)) %>% 
  group_by(YEAR, DOY, SPECIES) %>% 
  summarize(DOY_ADJ_FEE = sum(ADJ_FEE), .groups = 'drop') %>%
  data.frame()

# Summarize total fees year:
all_year_fee <- allyrs_spcs_landing_summary %>% 
  group_by(YEAR) %>% 
  summarize(TOTAL_FEE = sum(FEE), .groups = 'drop') 

# Summarize daily fee, cumulative fee, and inflation adjusted cumulative fee by year and day of year:
all_year_fee_summary <- allyrs_spcs_landing_summary %>% 
  group_by(YEAR, DOY) %>% 
  summarize(FEE = sum(FEE), .groups = 'drop') %>% 
  group_by(YEAR) %>% 
  mutate(CUM_FEE = cumsum(FEE)) %>% 
  full_join(all_year_fee, by = "YEAR") %>% 
  mutate(CUM_PROP = CUM_FEE/TOTAL_FEE) %>% 
  full_join(cpi) %>% 
  mutate(ADJ_CUM_FEE = round((CUM_FEE/CPI_FACTOR),2)) %>% 
  data.frame()

# Calculate average values for 2013-2019 fees:
avg_doy_summaries <- all_year_fee_summary %>% 
  filter(!YEAR == 2020) %>% 
  group_by(DOY) %>% 
  summarize(AVG_CUM_FEE = mean(CUM_FEE),
            CUM_FEE_SD = sd(CUM_FEE),
            AVG_ADJ_CUM_FEE = mean(ADJ_CUM_FEE),
            ADJ_CUM_FEE_SD = sd(ADJ_CUM_FEE),
            AVG_CUM_PROP = mean(CUM_PROP),
            CUM_PROP_SD = sd(CUM_PROP), .groups = 'drop') %>% 
  data.frame()


# Create a data frame of 1-366 DOY:
all_doy <- data.frame(YEAR = rep(2013:2020, each = 365),
                      DOY = rep(seq(from = 2, to = 366, by = 1),8))


# In an attempt to smooth out those averages for DOYs that don't have activity:
avg_doy_summaries_test <- all_year_fee_summary %>% 
  full_join(all_doy, by = c('YEAR','DOY')) %>% 
  arrange(YEAR, DOY) %>% 
  # On days with 0 fees, convert NA to 0:
  replace_na(list(FEE = 0)) %>% 
  # On days with 0 fees, take the cumulative fee from the day before:
  fill(CUM_FEE, .direction = "down") %>% 
  # Same for the cumulative proportion:
  fill(CUM_PROP, .direction = "down") %>%
  # Same for the inflation adjusted cumulative fee:
  fill(ADJ_CUM_FEE, .direction = "down") %>% 
  # Calculate average values for 2013-2019 fees:
  filter(!YEAR == 2020) %>% 
  group_by(DOY) %>% 
  summarize(AVG_CUM_FEE = mean(CUM_FEE),
            CUM_FEE_SD = sd(CUM_FEE),
            AVG_ADJ_CUM_FEE = mean(ADJ_CUM_FEE),
            ADJ_CUM_FEE_SD = sd(ADJ_CUM_FEE),
            AVG_CUM_PROP = mean(CUM_PROP),
            CUM_PROP_SD = sd(CUM_PROP), .groups = 'drop') %>% 
  data.frame()


# Create nice labels for the day of year (instead of 1-365):
months <- c("Jan", "Apr", "Jul", "Oct", "Jan")
mo_start_doy <- c(1,92,183,275,366)


# Summarize total fees by year and spcs:
allyrs_annual_spcs_fee <- allyrs_spcs_landing_summary %>% 
  group_by(YEAR, SPECIES_GROUP) %>% 
  summarize(SPCS_TOTAL_FEE = sum(FEE), .groups = 'drop') 


# Summarize daily fee, cumulative fee, and inflation adjusted cumulative fee by year and day of year:
allyrs_spcs_fee_summary <- allyrs_spcs_landing_summary %>% 
  group_by(YEAR, DOY, SPECIES_GROUP) %>% 
  summarize(FEE = sum(FEE), .groups = 'drop') %>% 
  full_join(allyrs_annual_spcs_fee, by = c("YEAR", "SPECIES_GROUP")) %>% 
  mutate(FEE_PROP = FEE/SPCS_TOTAL_FEE) 
  data.frame()

  
# Explore the differences between proportions:
prop_differences <- all_year_fee_summary %>% 
  filter(YEAR == 2020) %>% 
  select(DOY, CUM_PROP) %>% 
  full_join(avg_doy_summaries_test, by = "DOY") %>% 
  select(-c(AVG_CUM_FEE, CUM_FEE_SD, AVG_ADJ_CUM_FEE, ADJ_CUM_FEE_SD, CUM_PROP_SD)) %>% 
  arrange(DOY) %>% 
  # On days in 2020 with 0 fees, take the cumulative proportion from the day before:
  fill(CUM_PROP, .direction = "down") %>% 
  # Replace the NA on DOY 1 in 2020 with 0
  replace_na(list(CUM_PROP = 0)) %>% 
  # Calculate the differences between the two proportions:
  mutate(DIFFERENCE = AVG_CUM_PROP - CUM_PROP)
  
#max(prop_differences$DIFFERENCE)
#min(prop_differences$DIFFERENCE)


# Identify some label locations just in case:
label_location <- all_year_fee_summary %>% 
  filter(YEAR == 2020) %>% 
  group_by(YEAR) %>% 
  summarize(LABEL_Y_LOCATION = max(ADJ_CUM_FEE),
            LABEL_X_LOCATION = max(DOY), .groups = 'drop')

avg_label_location <- avg_doy_summaries %>% 
  summarize(LABEL_Y_LOCATION = max(AVG_CUM_FEE),
            LABEL_ADJY_LOCATION = max(AVG_ADJ_CUM_FEE),
            LABEL_X_LOCATION = max(DOY), .groups = 'drop')


```


Figure 2-1. -- Comparison of cumulative observer fees by day in 2020 with the mean cumulative observer fees assessed from 2013 to 2019 in inflation adjusted millions of dolllars (left), as the proportion of overall annual fees (middle), and the difference between the proportions (right). The shading indicates +/- one standard deviation from the 2013-2019 mean. 


```{r fee_comparison_figures, eval=FALSE, include=FALSE}

# Plot of cumulative observer fees by year in inflation adjusted dollars:
infl <- ggplot() +
  # Plot 2020 cumulative fees:
  geom_line(data = all_year_fee_summary %>% filter(YEAR == 2020), 
            aes(x = DOY, y = ADJ_CUM_FEE, group = as.factor(YEAR))) +
  # Plot 2013-2019 average fees:
  geom_line(data = avg_doy_summaries_test, aes(x = DOY, y = AVG_ADJ_CUM_FEE)) +
  # Plot 2013-2019 standard deviations:
  geom_ribbon(data = avg_doy_summaries_test, 
              aes(x = DOY, ymin = AVG_ADJ_CUM_FEE - ADJ_CUM_FEE_SD, ymax = AVG_ADJ_CUM_FEE+ ADJ_CUM_FEE_SD), alpha = 0.5)+
  # Set plot attributes:
  scale_y_continuous(labels = c('0','1','2','3','4','5'), breaks = seq(0,5000000,1000000), limits = c(0,5000000)) +
  scale_x_continuous(breaks = mo_start_doy, labels = months, limits = c(1,366)) +
  labs(x = NULL,
       y = "Cumulative Fees ($M)") +
  # Add a label for the 2020 line:
  annotate("text", 
           #x = 366,
           #y = 2450000,
           x = 350,
           y = 2350000,
           label = label_location$YEAR,
           size = 3, color = "gray28", family = "serif") +
  # Add a label for the 2013-2019 line:
  annotate("text", 
           x = 100,
           y = 2350000,   
           label = "2013-\n2019",
           size = 3, color = "gray28", family= "serif") +
  # AFS themes:
  theme_classic(base_size = 14) +
  theme(axis.title.y = element_text(family = "serif", size = 13)) +
  theme(axis.text = element_text(family = "serif"))


# Plot proportion of cumulative observer fees by year:
prop <- ggplot() +
  # Plot 2020 proportion of cumulative fees:
  geom_line(data = all_year_fee_summary %>% filter(YEAR == 2020), 
            aes(x = DOY, y = CUM_PROP, group = as.factor(YEAR))) +
  # Plot 2013-2019 average fees:
  geom_line(data = avg_doy_summaries_test, aes(x = DOY, y = AVG_CUM_PROP)) +
  # Plot 2013-2019 standard deviations:
  geom_ribbon(data = avg_doy_summaries, 
              aes(x = DOY, ymin = AVG_CUM_PROP - CUM_PROP_SD, ymax = AVG_CUM_PROP + CUM_PROP_SD), alpha = 0.5) +
  # Set plot attributes:
  scale_x_continuous(breaks = mo_start_doy, labels = months, limits = c(1,366)) +
  labs(x = NULL,
       y = "Proportion")    +
  # Add a label for the 2020 line:
   annotate("text", 
            x = 235,
            y = 0.48,
            label = label_location$YEAR,
            size = 3, color = "gray28", family= "serif") +
  # Add a label for the 2013-2019 line:
   annotate("text", 
            x = 90,
            y = 0.48,
            label = "2013-\n2019",
            size = 3, color = "gray28", family= "serif") +
  # AFS type themes:
  theme_classic(base_size = 14) +
  theme(axis.title.y = element_text(family = "serif", size = 13)) +
  theme(axis.text = element_text(family = "serif"))


# Plot difference between the proportions:
diff <- ggplot(data = prop_differences, aes(x = DOY, y = DIFFERENCE)) + 
  geom_path() +
   # Set plot attributes:
  scale_x_continuous(breaks = mo_start_doy, labels = months, limits = c(1,366)) +
  scale_y_continuous(limits = c(-0.01,0.15)) +
  geom_hline(yintercept = 0, linetype = "dashed", show.legend = NA) +
  labs(x = NULL,
       y = "Difference") +
  # AFS type themes:
  theme_classic(base_size = 14) +
  theme(axis.title.y = element_text(family = "serif", size = 13)) +
  theme(axis.text = element_text(family = "serif"))



# Use cowplot to arrange compound figure:
fee_panels3 <- plot_grid(infl, prop, diff, ncol=3, label_x = 0.15, rel_widths = c(1,1.1,1.1)) 
#fee_panels3

# Add space to the bottom for axis label:
fee_pad_bottom3 <- plot_grid(fee_panels3, NULL, ncol = 1, rel_heights = c(9,1))  #Add space to bottom of plot for axis labels

# Add axis labels:
ggdraw(fee_pad_bottom3) + 
  draw_label("Month", fontfamily = "serif", x = 0.55, y = 0.07, size = 14)
  

# Save the plot as a tiff:
#dev.new(width = 5.62, height = 4.22, unit = "in", noRStudioGD = TRUE); last_plot()
#ggsave("Cum_Fee_Comparison3.tiff", width = dev.size()[1], height = dev.size()[2], dpi = 600); dev.off()
#ggsave("Cum_Fee_Comparison3.jpeg", width = dev.size()[1], height = dev.size()[2], dpi = 600); dev.off()


```

Figure 2-2. --  Proportion of each speciesâ€™ annual observer fees by day, 2013-2020. Note: the scale is different for each species.


```{r spcsprop_heat_maps, eval=FALSE, include=FALSE}

for_propheatmap <- allyrs_spcs_fee_summary %>% 
  mutate(YEAR = factor(YEAR, levels = c("2020", "2019", "2018", "2017", "2016", "2015", "2014", "2013")))

prop_limits <- allyrs_spcs_fee_summary %>% 
  group_by(SPECIES_GROUP) %>% 
  summarize(minp = min(FEE_PROP),
            maxp = max(FEE_PROP), .groups = "drop")


hmHLBTp <- ggplot(data = for_propheatmap %>% filter(SPECIES_GROUP == "Halibut"), 
                 aes(x = DOY, y = YEAR, fill = FEE_PROP)) +
  geom_tile() +
  labs(x = NULL, 
       y = NULL,
       fill = "Proportion of\nobserver fees ") +
  scale_x_continuous(expand = c(0,0,0,0), breaks = mo_start_doy, labels = months, limits = c(1,366)) +
  scale_y_discrete(expand = expansion(mult = c(0, 0))) +
  scale_fill_viridis(limits = c(0,0.02), breaks = c(0, 0.01, 0.02), labels = c("0%", "1%", "2%")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "serif", size = 10),
        legend.text = element_text(family = "serif", size = 9),
        legend.key.size = unit(0.4,"cm"),
        legend.margin=margin(0,0,10,0),
        legend.box.margin = margin(-10,-10,-10,0)) +
  theme(axis.text = element_text(family = "serif"))
 
 
hmSABLp <- ggplot(data = for_propheatmap %>% filter(SPECIES_GROUP == "Sablefish"), 
                 aes(x = DOY, y = YEAR, fill = FEE_PROP)) +
  geom_tile() +
  labs(x = NULL, 
       y = NULL,
       fill = "Proportion of\nobserver fees ") +
  scale_x_continuous(expand = c(0,0,0,0), breaks = mo_start_doy, labels = months, limits = c(1,366)) + 
  scale_y_discrete(expand = expansion(mult = c(0, 0))) +
  scale_fill_viridis(limits = c(0,0.03), breaks = c(0, 0.015, 0.03), labels = c("0%", "1.5%", "3%")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "serif", size = 10),
        legend.text = element_text(family = "serif", size = 9),
        legend.key.size = unit(0.4,"cm"),
        legend.margin=margin(0,0,10,0),
        legend.box.margin = margin(-10,-10,-10,0)) +
  theme(axis.text = element_text(family = "serif"))
 

hmPCODp <- ggplot(data = for_propheatmap %>% filter(SPECIES_GROUP == "PacificCod"), 
                 aes(x = DOY, y = YEAR, fill = FEE_PROP)) +
  geom_tile() +
  labs(x = NULL, 
       y = NULL,
       fill = "Proportion of\nobserver fees ") +
  scale_x_continuous(expand = c(0,0,0,0), breaks = mo_start_doy, labels = months, limits = c(1,366)) +
  scale_y_discrete(expand = expansion(mult = c(0, 0))) +
  scale_fill_viridis(limits = c(0,0.05), breaks = c(0,0.025, 0.05), labels = c("0%", "2.5%", "5%")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "serif", size = 10),
        legend.text = element_text(family = "serif", size = 9),
        legend.key.size = unit(0.4,"cm"),
        legend.margin=margin(0,0,10,0),
        legend.box.margin = margin(-10,-10,-10,0)) +
  theme(axis.text = element_text(family = "serif"))
 

hmPLCKp <- ggplot(data = for_propheatmap %>% filter(SPECIES_GROUP == "Pollock"), 
                 aes(x = DOY, y = YEAR, fill = FEE_PROP)) +
  geom_tile() +
  labs(x = NULL, 
       y = NULL,
       fill = "Proportion of\nobserver fees ") +
  scale_x_continuous(expand = c(0,0,0,0), breaks = mo_start_doy, labels = months, limits = c(1,366)) + 
  scale_y_discrete(expand = expansion(mult = c(0, 0))) +
  scale_fill_viridis(limits = c(0,0.04), breaks = c(0,0.02, 0.04), labels = c("0%", "2%", "4%")) +
  theme_classic(base_size = 14) +
  theme(legend.position = "bottom",
        legend.title = element_text(family = "serif", size = 10),
        legend.text = element_text(family = "serif", size = 9),
        legend.key.size = unit(0.4,"cm"),
        legend.margin=margin(0,0,10,0),
        legend.box.margin = margin(-10,-10,-10,0)) +
  theme(axis.text = element_text(family = "serif"))
 

# Use cowplot to arrange compound figure:
spcsprop_heatmaps <- plot_grid(hmHLBTp, hmPCODp, hmSABLp, hmPLCKp, ncol=2,
                           labels = c("Halibut", "Pacific Cod", "Sablefish", "Pollock"),
                           label_size = 11,
                           label_fontfamily = "serif",
                           rel_heights = c(1,1,1,1),
                           label_x = 0,
                           hjust = 0,
                           vjust = 0.5)


# Add space to the left and bottom for axis labels:
hmp_pad_side <- plot_grid(NULL, spcsprop_heatmaps, ncol = 2, rel_widths = c(0.35, 6)) 
hmp_pad_bottom <- plot_grid(NULL, hmp_pad_side, NULL, ncol = 1, rel_heights = c(0.5,9,0.5))  

# Add axis labels:
ggdraw(hmp_pad_bottom) + 
  draw_label("Month", fontfamily = "serif", x = 0.55, y = 0.03, size = 15) +
  draw_label("Year", fontfamily = "serif", angle = 90, x = 0.02, y = 0.57, size = 15) 

# Save the plot as a tiff:
#dev.new(width = 5.62, height = 4.22, unit = "in", noRStudioGD = TRUE); last_plot()
#ggsave("ProportionDailyFees.tiff", width = dev.size()[1], height = dev.size()[2], dpi = 600); dev.off()
#ggsave("ProportionDailyFees.jpeg", width = dev.size()[1], height = dev.size()[2], dpi = 600); dev.off()

```


```{r export, echo=FALSE, message=FALSE, warning=FALSE}

# Clean up workspace (removes everything EXCEPT the objects listed) and save RData file
rm(list= ls()[!(ls() %in% c('fee_detail','fee_total', 'all_areas', 'goa', 'bsai'))])

# Export data file so it can be used for figure development:
#save(fee_detail, fee_total, all_areas, goa, bsai,
#     file = paste0("Observer_Fee_Data_", as.numeric(format(Sys.Date(), "%Y"))-1,".RData"))

```

